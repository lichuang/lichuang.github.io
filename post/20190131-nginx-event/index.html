<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="Nginxæºç é˜…è¯»ç¬”è®°-äº‹ä»¶å¤„ç†æ¨¡å—">




<meta name="keywords" content=" Nginx  è¿›ç¨‹æ¨¡å‹ ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Nginxæºç é˜…è¯»ç¬”è®°-äº‹ä»¶å¤„ç†æ¨¡å—" />
<meta name="twitter:description" content="å¤§æ¦‚åšé«˜æ€§èƒ½æœåŠ¡å™¨çš„ï¼Œéƒ½ç»•ä¸å¼€äº‹ä»¶å¤„ç†æ¨¡å—æ¥ï¼Œä¸€èˆ¬ä¸€ä¸ªäº‹ä»¶æ¨¡å—ï¼Œä¼šåˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š å¦‚ä½•å®šä¹‰ä¸€ä¸ªæè¿°äº‹ä»¶çš„æ•°æ®ç»“æ„ã€‚ å¦‚ä½•åœ¨äº‹ä»¶æ¨¡å—ä¸­æ”¯æŒå®šæ—¶å™¨" />


<link rel="canonical" href="https://www.codedump.info/post/20190131-nginx-event/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>Nginxæºç é˜…è¯»ç¬”è®°-äº‹ä»¶å¤„ç†æ¨¡å— - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>Nginxæºç é˜…è¯»ç¬”è®°-äº‹ä»¶å¤„ç†æ¨¡å—</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/nginx'>#nginx</a>
        
      </div>
      
      <div class="content">
        

<p>å¤§æ¦‚åšé«˜æ€§èƒ½æœåŠ¡å™¨çš„ï¼Œéƒ½ç»•ä¸å¼€äº‹ä»¶å¤„ç†æ¨¡å—æ¥ï¼Œä¸€èˆ¬ä¸€ä¸ªäº‹ä»¶æ¨¡å—ï¼Œä¼šåˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š</p>

<ul>
<li>å¦‚ä½•å®šä¹‰ä¸€ä¸ªæè¿°äº‹ä»¶çš„æ•°æ®ç»“æ„ã€‚</li>
<li>å¦‚ä½•åœ¨äº‹ä»¶æ¨¡å—ä¸­æ”¯æŒå®šæ—¶å™¨ã€‚</li>
<li>å¦‚æœéœ€è¦æ”¯æŒå¤šå¹³å°ï¼Œäº‹ä»¶æ¨¡å—éœ€è¦è€ƒè™‘å¦‚ä½•ç»Ÿä¸€ä»¥åŠåŒºåˆ†å„å¹³å°çš„å…·ä½“å®ç°ã€‚</li>
</ul>

<p>ä¸‹é¢å°±è¿™ä¸‰éƒ¨åˆ†å±•å¼€Nginxäº‹ä»¶å¤„ç†æ¨¡å—çš„åˆ†æã€‚</p>

<h1 id="ngx-event-t">ngx_event_t</h1>

<p>æè¿°äº‹ä»¶çš„æ•°æ®ç»“æ„ï¼Œä¸€èˆ¬è‡³å°‘éœ€è¦ä»¥ä¸‹å‡ éƒ¨åˆ†æ•°æ®ï¼š</p>

<ul>
<li>ç”¨äºä¿å­˜ç”¨æˆ·ç›¸å…³çš„æ•°æ®ã€‚</li>
<li>ç”¨äºä¿å­˜äº‹ä»¶è§¦å‘ä¹‹åçš„å›è°ƒå‡½æ•°ã€‚</li>
<li>ç”¨äºè¡¨ç¤ºäº‹ä»¶çŠ¶æ€ã€ç±»å‹çš„æ•°æ®ã€‚</li>
</ul>

<p>nginxä¸­ï¼Œæè¿°äº‹ä»¶é‡‡ç”¨çš„æ•°æ®ç»“æ„æ˜¯ngx_event_tä¸­ï¼Œå…¶å†…éƒ¨æˆå‘˜å°±æ˜¯æŒ‰ç…§å‰é¢çš„ä¸‰éƒ¨åˆ†æ¥åˆ’åˆ†äº†ã€‚</p>

<ul>
<li>void *dataï¼šäº‹ä»¶ç›¸å…³çš„æ•°æ®ã€‚</li>
<li>ngx_event_handler_pt handlerï¼šäº‹ä»¶è¢«è§¦å‘æ—¶çš„å›è°ƒå‡½æ•°ã€‚</li>
<li>ç¬¬ä¸‰ç±»æ•°æ®ï¼Œngx_event_tä¸­åˆ’åˆ†çš„æ¯”è¾ƒä»”ç»†ï¼š

<ul>
<li>unsigned write:1ï¼šå¯å†™æ ‡å¿—ä½</li>
<li>unsigned active:1ï¼šæ´»è·ƒæ ‡å¿—ä½</li>
<li>unsigned disabled:1ï¼šç¦ç”¨æ ‡å¿—ä½</li>
<li>unsigned eof:1ï¼šä¸º1è¡¨ç¤ºå­—èŠ‚æµå·²ç»ç»“æŸ</li>
<li>unsigned error:1ï¼šå¤„ç†äº‹ä»¶å‡ºé”™</li>
<li>unsigned timedout:1ï¼šäº‹ä»¶è¶…æ—¶</li>
<li>unsigned timer_set:1ï¼šä¸º1è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè¶…æ—¶äº‹ä»¶</li>
<li>unsigned deferred_accept:1ï¼šä¸º1è¡¨ç¤ºéœ€è¦å»¶è¿Ÿæ¥æ”¶TCPè¿æ¥</li>
</ul></li>
<li>é™¤äº†ä»¥ä¸Šä¸‰éƒ¨åˆ†ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›é‡è¦çš„æ•°æ®ï¼š

<ul>
<li>ngx_rbtree_node_t timerï¼šçº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œç”¨äºå®ç°å®šæ—¶å™¨çš„ï¼Œä¸‹é¢è®¨è®ºå®šæ—¶å™¨å†å±•å¼€ã€‚</li>
<li>ngx_queue_t queueï¼šå»¶è¿Ÿé˜Ÿåˆ—ï¼Œå¦‚æœäº‹ä»¶ä¸åœ¨è½®è¯¢å¾ªç¯ä¸­ç›´æ¥å¤„ç†ï¼Œè€Œæ˜¯ä¹‹åè¢«å¤„ç†ï¼Œå°±æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚</li>
</ul></li>
</ul>

<p>æ€»ä½“æ¥çœ‹ï¼Œeventè¿™ä¸ªç»“æ„ä½“ä¸ºäº†æ¶µç›–æ‰€æœ‰å¯èƒ½çš„äº‹ä»¶ï¼Œåšçš„å¤§è€Œå…¨ï¼Œä¸åªæ˜¯ç”¨æ¥æè¿°ä¸€èˆ¬çš„IOäº‹ä»¶ï¼Œè¿˜åŒ…æ‹¬äº†å®šæ—¶å™¨äº‹ä»¶ï¼Œè¿˜åŒ…æ‹¬äº†æ¥æ”¶è¿æ¥ç›¸å…³çš„æ•°æ®ã€‚</p>

<h1 id="å®šæ—¶å™¨çš„å®ç°">å®šæ—¶å™¨çš„å®ç°</h1>

<p>Nginxå†…éƒ¨ä½¿ç”¨çº¢é»‘æ ‘æ¥å®ç°å®šæ—¶å™¨ï¼Œç›®çš„åœ¨äºèƒ½å¤Ÿå¿«é€Ÿçš„æŸ¥è¯¢åˆ°å“ªäº›å®šæ—¶å™¨è¶…æ—¶äº†ã€‚ä¸åŒçš„äº‹ä»¶ç»“æ„ä¸­ï¼Œè¿™éƒ¨åˆ†å®ç°é‡‡ç”¨çš„æ•°æ®ç»“æ„ä¸ä¸€æ ·ï¼Œlibeventã€libuvé‡‡ç”¨çš„æ˜¯æœ€å°å †ï¼Œredisæ¯”è¾ƒæŒ«ï¼Œè¿™éƒ¨åˆ†é‡‡ç”¨çš„æ˜¯é“¾è¡¨ã€‚</p>

<p>åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œå› ä¸ºæ—¢è¦è€ƒè™‘åˆ°ä¸€èˆ¬çš„IOäº‹ä»¶ï¼Œåˆè¦è€ƒè™‘åˆ°å®šæ—¶å™¨äº‹ä»¶ï¼Œæ‰€ä»¥éƒ½ä¼šä»¥ä¸€ä¸ªæœ€è¿‘è¢«è§¦å‘çš„å®šæ—¶å™¨æ¥åšä¸ºæŸ¥è¯¢IOäº‹ä»¶è¢«è§¦å‘çš„æ—¶é—´ï¼Œå³ä»¥ä¸‹çš„ä¼ªä»£ç ï¼š</p>

<pre><code class="language-C">æŸ¥è¯¢æœ€è¿‘å°†è¢«è§¦å‘çš„å®šæ—¶å™¨è¶…æ—¶æ—¶é—´è¿”å›t
å°†tåšä¸ºepoll_waitä¹‹ç±»çš„æŸ¥è¯¢IOäº‹ä»¶çš„è¶…æ—¶æ—¶é—´ï¼Œå³æœ€é•¿ç­‰å¾…tæ—¶é—´çœ‹æœ‰æ²¡æœ‰IOäº‹ä»¶è¢«è§¦å‘
éå†å®šæ—¶å™¨ï¼ŒæŸ¥è¯¢å·²ç»è¶…æ—¶çš„å®šæ—¶å™¨è¿›è¡Œå›è°ƒå¤„ç†
</code></pre>

<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œâ€œè¿…é€ŸæŸ¥è¯¢åˆ°è·ç¦»å½“å‰æœ€è¿‘è¢«è§¦å‘çš„å®šæ—¶å™¨æ—¶é—´â€ä»¥åŠâ€œè¿…é€ŸæŸ¥è¯¢åˆ°å½“å‰å“ªäº›å®šæ—¶å™¨è¶…æ—¶â€ï¼Œæ˜¯è¿™ä¸ªå®šæ—¶å™¨æ¨¡å—é€Ÿåº¦çš„å…³é”®ã€‚</p>

<p>ç”±äºçº¢é»‘æ ‘ã€æœ€å°å †è¿™ç§å¹³è¡¡æ•°æ®ç»“æ„ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½æ’é™¤æ‰å½“å‰ä¸€åŠçš„å…ƒç´ ï¼Œå¯ä»¥åšåˆ°æ—¶é—´å¤æ‚åº¦O(logn)ï¼Œæ‰€ä»¥å°±å¸¸ç”¨æ¥å®ç°å®šæ—¶å™¨äº†ã€‚</p>

<h1 id="äº‹ä»¶æ¨¡å—çš„å®ç°">äº‹ä»¶æ¨¡å—çš„å®ç°</h1>

<p>ç”±äºnginxéœ€è¦è·‘åœ¨å¤šä¸ªå¹³å°ä¸‹é¢ï¼Œè€Œä¸åŒå¹³å°ä½¿ç”¨çš„äº‹ä»¶æœºåˆ¶åˆä¸ä¸€æ ·ï¼Œæ¯”å¦‚linuxæ˜¯epollï¼Œbsdæ˜¯kqueueç­‰ï¼Œéœ€è¦å®ç°äº‹ä»¶æ¨¡å—çš„æ—¶å€™ï¼Œæ—¢éœ€è¦ç»Ÿä¸€äº‹ä»¶æ¨¡å—çš„å…±æ€§éƒ¨åˆ†ï¼Œåˆéœ€è¦åŒºåˆ†ä¸åŒå¹³å°çš„å·®å¼‚éƒ¨åˆ†ã€‚</p>

<p>è¿™çœ‹ä¸Šå»åˆæ˜¯ä¸€ä¸ªé¢å‘å¯¹è±¡çš„è®¾è®¡é—®é¢˜äº†ï¼šåŸºç±»è´Ÿè´£å®ç°å…±æ€§çš„éƒ¨åˆ†ï¼Œå­ç±»å…·ä½“å†æ¥å®ç°å„å¹³å°ç›¸å…³çš„éƒ¨åˆ†ã€‚</p>

<p>å‰é¢<a href="http://localhost:1313/post/20190123-libuv/#%E6%80%BB%E7%BB%93">åˆ†ælibuv</a>çš„æ—¶å€™æåˆ°è¿‡ï¼Œlibuvå¤šä½¿ç”¨å®æ¥æ¨¡æ‹ŸC++ä¸­çš„ç»§æ‰¿ï¼Œä¸æ˜¯å¾ˆè®¤å¯è¿™ä¸ªä»£ç é£æ ¼ï¼Œæ¥çœ‹çœ‹nginxç±»ä¼¼åœºæ™¯çš„å®ç°ã€‚</p>

<p>nginxä¸­ï¼Œå°†äº‹ä»¶ç›¸å…³çš„æ“ä½œå‡½æ•°ç»Ÿä¸€æ”¾åœ¨ç»“æ„ä½“ngx_event_actions_tä¸­ï¼Œå¯ä»¥æŠŠè¿™éƒ¨åˆ†ç±»æ¯”äºå­ç±»éœ€è¦å®ç°çš„å‡½æ•°æ¥å£ï¼š</p>

<pre><code class="language-C">typedef struct {
  ngx_int_t  (*add)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);
  ngx_int_t  (*del)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);

  ngx_int_t  (*enable)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);
  ngx_int_t  (*disable)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);

  ngx_int_t  (*add_conn)(ngx_connection_t *c);
  ngx_int_t  (*del_conn)(ngx_connection_t *c, ngx_uint_t flags);

  ngx_int_t  (*notify)(ngx_event_handler_pt handler);

  ngx_int_t  (*process_events)(ngx_cycle_t *cycle, ngx_msec_t timer,
    ngx_uint_t flags);

  ngx_int_t  (*init)(ngx_cycle_t *cycle, ngx_msec_t timer);
  void       (*done)(ngx_cycle_t *cycle);
} ngx_event_actions_t;
</code></pre>

<p>å‰é¢åœ¨åˆ†æåˆ°nginxå¦‚ä½•è§£æé…ç½®çš„æ—¶å€™æåˆ°è¿‡ï¼Œnginxä¸­çš„é…ç½®æ˜¯åˆ†å±‚æ¬¡çš„ï¼Œeventæ¨¡å—åšä¸ºä¸€ä¸ªé¡¶å±‚çš„coreæ¨¡å—ï¼Œå†…éƒ¨åˆæœ‰å­æ¨¡å—ï¼Œè€Œè¿™é‡Œçš„äº‹ä»¶æ¨¡å—å°±æ˜¯eventæ¨¡å—ä¸­çš„å­æ¨¡å—ï¼š</p>

<pre><code class="language-C">typedef struct {
  ngx_str_t              *name;

  void                 *(*create_conf)(ngx_cycle_t *cycle);
  char                 *(*init_conf)(ngx_cycle_t *cycle, void *conf);

  ngx_event_actions_t     actions;
} ngx_event_module_t;
</code></pre>

<p>åœ¨å…·ä½“å®ç°ä¸­ï¼Œæ¯ä¸ªå¹³å°çš„äº‹ä»¶æ¨¡å—åˆ›å»ºè‡ªå·±çš„ngx_event_module_tç»“æ„ï¼Œåœ¨create_confã€init_confä¸­å®Œæˆå¯¹äº‹ä»¶æ¨¡å—çš„åˆå§‹åŒ–ï¼Œç„¶åå¡«å……æ¨¡å—çš„actionsç»“æ„ä½“ã€‚</p>

<p>æœ€åï¼Œå…·ä½“è°ƒç”¨actionsç»“æ„ä½“ä¸­çš„å‡½æ•°ï¼Œå°è£…åˆ°å®é‡Œé¢ï¼Œæ¯•ç«Ÿè™½ç„¶æœ‰å¤šå¹³å°çš„å®ç°ï¼Œæœ€åä¹Ÿåªèƒ½ç”¨ä¸Šä¸€ä¸ªè€Œå·²ï¼š</p>

<pre><code class="language-C">#define ngx_process_events   ngx_event_actions.process_events
#define ngx_done_events      ngx_event_actions.done

#define ngx_add_event        ngx_event_actions.add
#define ngx_del_event        ngx_event_actions.del
#define ngx_add_conn         ngx_event_actions.add_conn
#define ngx_del_conn         ngx_event_actions.del_conn

#define ngx_notify           ngx_event_actions.notify
</code></pre>

<p>è€Œå‰é¢æåˆ°çš„äº‹ä»¶å¤„ç†éƒ¨åˆ†å…±æ€§çš„åœ°æ–¹ï¼Œå…¨éƒ½æ”¾åœ¨å‡½æ•°ngx_process_events_and_timersé‡Œï¼Œé‚£ä¸ªå‡½æ•°é‡Œé¢å†é€šè¿‡å®ngx_process_eventsè°ƒç”¨å…·ä½“äº‹ä»¶æ¨¡å—çš„å¤„ç†å‡½æ•°ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸ªç»†èŠ‚ï¼Œå…¶å®å‰é¢çš„åˆ†æä¹Ÿæåˆ°è¿‡ï¼Œnginxçš„äº‹ä»¶æ¨¡å—é‡Œï¼Œä¸ä¸€å®šåœ¨æ£€æŸ¥åˆ°äº‹ä»¶è§¦å‘ä¹‹åå°±ä¼šè¢«é©¬ä¸Šè°ƒç”¨å›è°ƒå‡½æ•°æ¥å¤„ç†ï¼Œè€Œæ˜¯å¯èƒ½æ”¾åœ¨ä¸€ä¸ªposté˜Ÿåˆ—ä¸­ï¼Œåœ¨è½®è¯¢å®Œæ‰€æœ‰äº‹ä»¶ä¹‹åå†è¿›è¡Œå›è°ƒï¼š</p>

<pre><code class="language-C">if (flags &amp; NGX_POST_EVENTS) {
		// æœ‰NGX_POST_EVENTSæ ‡å¿—ä½çš„æƒ…å†µï¼Œå°†acceptäº‹ä»¶æ”¾åˆ°ngx_posted_accept_eventsé˜Ÿåˆ—ä¸­
		// ç­‰å¾…åç»­è¢«å›è°ƒ
		queue = rev-&gt;accept ? &amp;ngx_posted_accept_events
												: &amp;ngx_posted_events;

		ngx_post_event(rev, queue);

} else {
		// å¦åˆ™ç›´æ¥å¤„ç†
		rev-&gt;handler(rev);
}
</code></pre>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20190131-nginx-master-worker/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20190131-nginx-read-http-request/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
