<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° ä»¥ä¸Šæè¿°è¿›ç¨‹çš„åˆ›å»ºã€æ‰§è¡Œã€è°ƒåº¦å™¨çš„å·¥ä½œåŸ">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" linux  systemtap ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ä½¿ç”¨systemtapåˆ†æè¿›ç¨‹çš„è¡Œä¸º" />
<meta property="og:description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° ä»¥ä¸Šæè¿°è¿›ç¨‹çš„åˆ›å»ºã€æ‰§è¡Œã€è°ƒåº¦å™¨çš„å·¥ä½œåŸ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20200503-sgfap-process-systemtap/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-03T14:32:57+08:00" />
<meta property="article:modified_time" content="2020-05-03T14:32:57+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20200503-sgfap-process-systemtap/">

  
  
  <meta itemprop="name" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ä½¿ç”¨systemtapåˆ†æè¿›ç¨‹çš„è¡Œä¸º">
<meta itemprop="description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° ä»¥ä¸Šæè¿°è¿›ç¨‹çš„åˆ›å»ºã€æ‰§è¡Œã€è°ƒåº¦å™¨çš„å·¥ä½œåŸ"><meta itemprop="datePublished" content="2020-05-03T14:32:57+08:00" />
<meta itemprop="dateModified" content="2020-05-03T14:32:57+08:00" />
<meta itemprop="wordCount" content="6486">
<meta itemprop="keywords" content="Linuxç³»ç»Ÿ," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ä½¿ç”¨systemtapåˆ†æè¿›ç¨‹çš„è¡Œä¸º - codedumpçš„ç½‘ç»œæ—¥å¿—</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ä½¿ç”¨systemtapåˆ†æè¿›ç¨‹çš„è¡Œä¸º"/>
<meta name="twitter:description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° ä»¥ä¸Šæè¿°è¿›ç¨‹çš„åˆ›å»ºã€æ‰§è¡Œã€è°ƒåº¦å™¨çš„å·¥ä½œåŸ"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">å‘¨åˆŠ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ä½¿ç”¨systemtapåˆ†æè¿›ç¨‹çš„è¡Œä¸º</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/linux%E7%B3%BB%E7%BB%9F'>#Linuxç³»ç»Ÿ</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#off-cpu">off CPU</a></li>
    <li><a href="#on-cpu">on CPU</a></li>
    <li><a href="#off-cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ">off cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ</a></li>
    <li><a href="#on-cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ">on cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ</a></li>
    <li><a href="#ç«ç„°å›¾">ç«ç„°å›¾</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <blockquote>
<p>æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§<a href="https://www.codedump.info/post/20200501-system-guide-for-application-programmer/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®º</a>ã€‚</p>
</blockquote>
<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>
<p>ä»¥ä¸Šæè¿°è¿›ç¨‹çš„åˆ›å»ºã€æ‰§è¡Œã€è°ƒåº¦å™¨çš„å·¥ä½œåŸç†ï¼Œæœ‰äº†è¿™äº›å‡†å¤‡ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨systemtapåœ¨ç³»ç»Ÿä¸­åŸ‹ç‚¹è¿›è¡Œä¸€äº›è·Ÿè¸ªï¼Œä»¥ä¾¿ç†è§£è¿›ç¨‹çš„è¡Œä¸ºã€‚</p>
<h1 id="åˆ†æè¿›ç¨‹å¯¹cpuçš„å ç”¨">åˆ†æè¿›ç¨‹å¯¹CPUçš„å ç”¨</h1>
<p>ç®€å•å›é¡¾ä¸€ä¸‹å‰é¢è¿›ç¨‹è°ƒåº¦ç›¸å…³çš„å†…å®¹ï¼š</p>
<ul>
<li>å†…æ ¸ä¸­ä½¿ç”¨å°±ç»ªé˜Ÿåˆ—æ¥ç»´æŠ¤å½“å‰æ‰€æœ‰å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹ï¼Œå¯è¿è¡ŒçŠ¶æ€ä¸åŒ…æ‹¬ç­‰å¾…IOã€ä¼‘çœ ç­‰çŠ¶æ€çš„è¿›ç¨‹ã€‚</li>
<li>è¿›ç¨‹è°ƒåº¦å™¨è´Ÿè´£ä»å°±ç»ªé˜Ÿåˆ—ä¸­é€‰æ‹©å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹æ¥æ‰§è¡Œã€‚</li>
<li>è€Œæ‰€æœ‰ä¸å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹ï¼Œå¹¶ä¸å ç”¨CPUèµ„æºï¼Œè¿™äº›è¿›ç¨‹éƒ½ç­‰å¾…è¢«ç›¸å…³çš„äº‹ä»¶æ¯”å¦‚ç½‘ç»œIOå”¤é†’ï¼Œå”¤é†’ä¹‹åçš„è¿›ç¨‹æ›´æ”¹çŠ¶æ€ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼ŒåŒæ—¶åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæ‰èƒ½è¢«è°ƒåº¦å™¨ç®—æ³•é€‰æ‹©æ‰§è¡Œã€‚</li>
</ul>
<p>å› æ­¤ï¼Œä¸€ä¸ªè¿›ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè™½ç„¶çœ‹ä¸Šå»è¿›ç¨‹ä¸€ç›´å­˜åœ¨ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰æ—¶å€™éƒ½å ç”¨CPUèµ„æºã€‚æ ¹æ®CPUå ç”¨èµ„æºä¸å¦ï¼Œæˆ–è€…è¯´å½“å‰æ˜¯å¦åœ¨è¿è¡Œï¼Œåˆ†ä¸º<code>on cpu</code>å’Œ<code>off cpu</code>çŠ¶æ€ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-process-systemtap/onoffcpu.png" alt="onoffcpu" title="onoffcpu"></p>
<p>ä¸Šå›¾ä¸­å°±ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œçš„æ—¶é—´çº¿åšäº†ç®€å•çš„é˜¶æ®µåˆ’åˆ†ï¼Œå…¶ä¸­çœç•¥æ‰äº†è¿›ç¨‹è¢«åˆ›å»ºå‡ºæ¥å’Œæœ€åé€€å‡ºæ—¶çš„æƒ…å†µï¼Œä»…åˆ—å‡ºå ç”¨CPUèµ„æºçŠ¶æ€çš„åˆ‡æ¢ã€‚</p>
<ul>
<li>è¿›ç¨‹å ç”¨CPUè·å¾—æ‰§è¡Œæƒçš„æ—¶å€™ï¼Œç§°ä¸º<code>on cpu</code>æ—¶é—´ã€‚</li>
<li>è¿›ç¨‹å› ä¸ºå„ç§åŸå› ï¼ˆè¢«å…¶ä»–è¿›ç¨‹æŠ¢å ã€è‡ªå·±è°ƒç”¨äº†sleepç³»ç»Ÿè°ƒç”¨ä¸»åŠ¨è¿›å…¥ç¡çœ çŠ¶æ€ã€ç­‰å¾…ç½‘ç»œIOç­‰ï¼‰è¢«å‰¥å¤ºäº†æ‰§è¡Œæƒçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨<code>deactivate_task</code>å‡½æ•°ä»å°±ç»ªé˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œæ¥ä¸‹æ¥è°ƒç”¨<code>context_switch</code>å‡½æ•°è¿›è¡Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¸ªæ—¶å€™æ—§çš„è¿›ç¨‹å¤±å»CPUçš„æ‰§è¡Œæƒï¼Œæ­¤æ—¶æ­£å¼è¿›å…¥<code>off cpu</code>æ—¶é—´ä¸­ã€‚</li>
<li>åœ¨æ­¤ä¹‹åï¼Œè¿›ç¨‹ç”±äºå„ç§åŸå› è¢«å”¤é†’ï¼Œå”¤é†’ä¹‹åé¦–å…ˆä¼šè¢«å†æ¬¡è°ƒç”¨<code>activate_task</code>å‡½æ•°åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œè¿›å…¥å°±ç»ªé˜Ÿåˆ—çš„è¿›ç¨‹ä¹Ÿå¹¶ä¸æ˜¯é©¬ä¸Šå°±èƒ½å¤Ÿè·å¾—æ‰§è¡Œæƒçš„ï¼Œæ˜¯ç”±è¿›ç¨‹è°ƒåº¦ç®—æ³•æ¥å†³å®šå“ªä¸€ä¸ªåœ¨å°±ç»ªé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ¥æ‰§è¡Œã€‚è¿™æ®µæ—¶é—´åˆå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š
<ul>
<li>è¿›ç¨‹è¢«åˆ‡æ¢å‡ºå»ç›´åˆ°é‡æ–°è¿›å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œè¿™éƒ¨åˆ†æ—¶é—´å†…è¿›ç¨‹ç­‰å¾…è¢«å”¤é†’ã€‚</li>
<li>è¿›å…¥å°±ç»ªé˜Ÿåˆ—åˆ°è¢«è°ƒåº¦å™¨é€‰ä¸­æ‰§è¡Œï¼Œè¿™éƒ¨åˆ†æ—¶é—´å†…è¿›ç¨‹ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œã€‚</li>
<li>ä»¥ä¸Šä¸¤éƒ¨åˆ†æ—¶é—´çš„æ€»å’Œï¼ŒåŠ èµ·æ¥å°±æ˜¯è¿›ç¨‹ä¼‘çœ çš„æ—¶é—´ï¼Œå³å¤„äº<code>off cpu</code>çŠ¶æ€çš„æ—¶é—´ã€‚</li>
</ul>
</li>
</ul>
<p>ä»è¿™é‡Œçœ‹å‡ºæ¥ï¼Œä¸€ä¸ªè¿›ç¨‹è™½ç„¶çœ‹ä¸Šå»ä¸€ç›´å­˜åœ¨ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰æ—¶é—´éƒ½åœ¨æ‰§è¡Œï¼Œè·Ÿè¿›ä¸€ä¸ªç¨‹åºçš„è¿è¡Œæ—¶é—´æ—¶ï¼Œéœ€è¦åŒºåˆ†å…¶<code>on</code>å’Œ<code>off</code> cpuçš„æ—¶é—´ï¼Œå¦‚æœoffçš„æ—¶é—´è¿‡é•¿ï¼Œé‚£éœ€è¦çœ‹çœ‹æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†è¿›ç¨‹ä¸€ç›´æ²¡æœ‰è¢«å”¤é†’æ‰§è¡Œã€‚</p>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿›ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¹¶ä¸ä¸€å®šå°±æ˜¯åœ¨è¿è¡Œï¼Œæœ‰å¯èƒ½è¿˜åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œï¼›ä½†æ˜¯åä¹‹åˆ™ä¸ç„¶ï¼Œä¸€ä¸ªå ç”¨CPUåœ¨æ‰§è¡Œçš„è¿›ç¨‹ï¼Œå…¶çŠ¶æ€ä¸€å®šæ˜¯å°±ç»ªçŠ¶æ€ã€‚å³ï¼š</p>
<pre tabindex="0"><code>è¿›ç¨‹å¤„äºå°±ç»ªçŠ¶æ€çš„æ—¶é—´ = è¿›ç¨‹åœ¨å°±ç»ªé˜Ÿåˆ—çš„æ—¶é—´ + è¿›ç¨‹åœ¨æ‰§è¡Œçš„æ—¶é—´
</code></pre><p>å…³äº<code>off cpu</code>è¿™ä¸€æ¦‚å¿µï¼Œ<a href="http://www.brendangregg.com/offcpuanalysis.html">Off-CPU Analysis</a>ä¸€æ–‡ä¸­æœ‰æ›´å¤šçš„è®²è¿°ã€‚</p>
<p>æœ‰äº†ä¸Šé¢å¯¹<code>on cpu</code>å’Œ<code>off cpu</code>çš„ä»‹ç»ï¼Œä¸‹é¢æ¥çœ‹çœ‹ä½¿ç”¨systemtapå¦‚ä½•è·Ÿè¸ªè¿™äº›çŠ¶æ€ä»¥åŠæ‰€å¤„çš„æ—¶é—´ã€‚</p>
<h2 id="off-cpu">off CPU</h2>
<p>systemtapä¸­è‡ªå¸¦çš„tapsetä¸­ï¼Œæœ‰ä¸€ä¸ªscheduler.stpæ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº†ä¸è°ƒåº¦å™¨ç›¸å…³çš„ä¸€äº›probeã€‚</p>
<p>å…¶ä¸­è·Ÿè¸ª<code>off cpu</code>çš„probeæ˜¯<code>scheduler.cpu_off</code> ï¼š</p>
<pre tabindex="0"><code>probe scheduler.cpu_off =
	kernel.trace(&#34;sched_switch&#34;) !,
	kernel.function(&#34;context_switch&#34;)
{
    name = &#34;cpu_off&#34;
    task_prev = $prev
    task_next = $next
    idle = __is_idle()
}
</code></pre><p>ç»“åˆä»£ç å’Œæœ€å¼€å§‹çš„ç¤ºæ„å›¾ï¼Œå¯ä»¥çŸ¥é“è¯¥probeäº‹ä»¶æ˜¯é’ˆå¯¹å†…æ ¸traceäº‹ä»¶<code>sched_switch</code>ä»¥åŠå†…æ ¸å‡½æ•°<code>context_switch</code>çš„å°è£…ï¼Œè¿™ä¸¤ä¸ªäº‹ä»¶éƒ½åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶è§¦å‘ã€‚</p>
<p>åœ¨è¯¥probeäº‹ä»¶ä¸­ï¼Œèƒ½è·å–åˆ°çš„å‚æ•°æ˜¯ï¼š</p>
<ul>
<li>task_prevï¼šä¿å­˜åˆ‡æ¢ä¹‹å‰çš„è¿›ç¨‹<code>task_struct</code>ç»“æ„ä½“ã€‚</li>
<li>task_nextï¼šä¿å­˜åˆ‡æ¢ä¹‹åçš„è¿›ç¨‹<code>task_struct</code>ç»“æ„ä½“ã€‚</li>
<li>idleï¼šè¡¨ç¤ºå½“å‰CPUæ˜¯å¦ç©ºé—²ã€‚</li>
</ul>
<p>å› ä¸ºè¿™ä¸ªprobeäº‹ä»¶è®°å½•äº†è¿›ç¨‹åˆ‡æ¢å‰åçš„ä¿¡æ¯ï¼Œå› æ­¤å¯ä»¥ç”¨æ¥å®Œæˆç±»ä¼¼è®°å½•ç³»ç»Ÿåˆ‡æ¢æœ€å¤šçš„è¿›ç¨‹è·Ÿè¸ªçš„åŠŸèƒ½ï¼š</p>
<pre tabindex="0"><code class="language-stp" data-lang="stp">global csw_count
global idle_count
 
probe scheduler.cpu_off {
  csw_count[task_prev, task_next]++
  idle_count+=idle
}

function fmt_task(task_prev, task_next)
{
   return sprintf(&#34;%s(%d)-&gt;%s(%d)&#34;,
                                task_execname(task_prev),
                                task_pid(task_prev),
                                task_execname(task_next),
                                task_pid(task_next))
}
 
function print_cswtop () {
  printf (&#34;%45s %10s\n&#34;, &#34;Context switch&#34;, &#34;COUNT&#34;)
  foreach ([task_prev, task_next] in csw_count- limit 20) {
    printf(&#34;%45s %10d\n&#34;, fmt_task(task_prev, task_next), csw_count[task_prev, task_next])
  }
  printf(&#34;%45s %10d\n&#34;, &#34;idle&#34;, idle_count)
 
  delete csw_count
  delete idle_count
}
 
probe timer.s($1) {
  print_cswtop ()
  printf(&#34;--------------------------------------------------------------\n&#34;)
}
</code></pre><p>ï¼ˆè„šæœ¬å‡ºè‡ªæ–‡ç« <a href="https://blog.yufeng.info/archives/747">Linuxä¸‹è°åœ¨åˆ‡æ¢æˆ‘ä»¬çš„è¿›ç¨‹</a>ï¼‰</p>
<p>è¯¥è„šæœ¬åœ¨<code>scheduler.cpu_off</code>ä¸­ç´¯åŠ è¿›ç¨‹åˆ‡æ¢çš„æ¬¡æ•°ï¼Œç„¶ååœ¨å®šæ—¶å™¨ä¸­æŒ‰ç…§è¿›ç¨‹åˆ‡æ¢æ¬¡æ•°è¿›è¡Œæ’åºè¾“å‡ºï¼š</p>
<pre tabindex="0"><code>$ sudo stap process/cswmon.stp 1 -T 2
                               Context switch      COUNT
           swapper/0(0)-&gt;update-manager(3926)        515
           update-manager(3926)-&gt;swapper/0(0)        514
                     Xorg(1418)-&gt;swapper/2(0)        430
                     swapper/2(0)-&gt;Xorg(1418)        429
                   swapper/1(0)-&gt;compiz(1855)         59
                   compiz(1855)-&gt;swapper/1(0)         59
               swapper/3(0)-&gt;bamfdaemon(1733)         57
               bamfdaemon(1733)-&gt;swapper/3(0)         57
               Xorg(1418)-&gt;kworker/2:0(28665)         51
               kworker/2:0(28665)-&gt;Xorg(1418)         50
                   swapper/3(0)-&gt;rcu_sched(8)         12
                   rcu_sched(8)-&gt;swapper/3(0)         12
                  swapper/2(0)-&gt;dockerd(2449)         12
                  dockerd(2449)-&gt;swapper/2(0)         12
             swapper/2(0)-&gt;kworker/2:0(28665)         11
             kworker/2:0(28665)-&gt;swapper/2(0)         11
          swapper/0(0)-&gt;docker-containe(2563)          8
          docker-containe(2563)-&gt;swapper/0(0)          8
            swapper/1(0)-&gt;kworker/u8:1(28452)          8
            kworker/u8:1(28452)-&gt;swapper/1(0)          8
                                         idle       1202
--------------------------------------------------------------
</code></pre><h2 id="on-cpu">on CPU</h2>
<p>ä¸<code>scheduler.cpu_off</code>ç›¸åçš„æ˜¯ï¼Œ<code>scheduler.cpu_on</code>å°±æ˜¯è¿½è¸ªè¿›ç¨‹è·å¾—CPUæ‰§è¡Œæƒæ—¶çš„probeäº‹ä»¶äº†ï¼š</p>
<pre tabindex="0"><code>probe scheduler.cpu_on = kernel.function(&#34;finish_task_switch&#34;) ?
{
    name = &#34;cpu_on&#34;
    task_prev = $prev
    idle = __is_idle()
}
</code></pre><p>å†…æ ¸å‡½æ•°åœ¨<code>finish_task_switch</code>åœ¨å®Œæˆè¿›ç¨‹åˆ‡æ¢æ—¶è¢«è°ƒç”¨ï¼Œå…¶ä¸­çš„å‚æ•°<code>task_prev</code>è®°å½•çš„æ˜¯è¢«åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹<code>task_struct</code>ç»“æ„ä½“æŒ‡é’ˆã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>scheduler.cpu_off</code>æ˜¯åœ¨<code>context_switch</code>å‡½æ•°ä¸­è¢«è§¦å‘ï¼Œè€Œ<code>scheduler.cpu_on</code>æ˜¯åœ¨<code>finish_task_switch</code>å‡½æ•°ä¸­è¢«è§¦å‘ï¼Œ<code>context_switch</code>å‡½æ•°ä¸­è°ƒç”¨äº†<code>finish_task_switch</code>å‡½æ•°æ¥å®Œæˆè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å·¥ä½œï¼Œè¿™æ—¶å€™æ‰æ„å‘³ç€æ–°çš„è¿›ç¨‹çœŸæ­£è·å¾—äº†æ‰§è¡Œæƒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-process-systemtap/context_switch_probe.png" alt="context_switch_probe" title="context_switch_probe"></p>
<p>å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºï¼š</p>
<ul>
<li><code>scheduler.cpu_off</code>ï¼šåœ¨è¿™ä¸ªè°ƒç”¨ç‚¹ä¸Šä¸€ä¸ªæ‰§è¡Œè¿›ç¨‹å¤±å»æ‰§è¡Œæƒã€‚</li>
<li><code>scheduler.cpu_on</code>ï¼šåœ¨è¿™ä¸ªè°ƒç”¨ç‚¹ä¸‹ä¸€ä¸ªæ‰§è¡Œè¿›ç¨‹å¾—åˆ°æ‰§è¡Œæƒï¼Œæ­£å¼å¼€å§‹æ‰§è¡Œã€‚</li>
</ul>
<p>åˆ©ç”¨<code>scheduler.cpu_on</code> probeäº‹ä»¶ï¼ŒåŒæ—¶æ­é…ä¸Šè¿›ç¨‹è¿›å‡ºå°±ç»ªé˜Ÿåˆ—çš„å‡½æ•°è°ƒç”¨ï¼Œå°±å¯ä»¥çŸ¥é“ä¸€ä¸ªè¿›ç¨‹åœ¨ä»å°±ç»ªé˜Ÿåˆ—ä¸­åˆ é™¤ä»¥åŠé‡æ–°å›åˆ°å°±ç»ªé˜Ÿåˆ—ï¼Œä¸­é—´çš„å»¶è¿Ÿæ—¶é—´æœ‰å¤šå°‘ã€‚</p>
<p>æ¯”å¦‚systemtapå®‰è£…åŒ…ä¸­æä¾›çš„ä¾‹å­è„šæœ¬<a href="https://sourceware.org/systemtap/examples/profiling/latencytap.stp">latencytap.stp</a>ï¼Œå…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>å†…æ ¸å‡½æ•°<code>activate_task</code>å’Œ<code>deactivate_task</code>åˆ†åˆ«æ˜¯è¿›ç¨‹è¿›å‡ºå°±ç»ªé˜Ÿåˆ—çš„å‡½æ•°è°ƒç”¨ç‚¹ï¼Œä¸¤è€…ä¹‹é—´çš„æ—¶é—´å·®å€¼å°±æ˜¯è¿›ç¨‹ç­‰å¾…å°±ç»ªçš„æ—¶é—´å·®ã€‚</li>
<li><code>scheduler.cpu_on</code>ä¸­å°†ä¸Šä¸€æ­¥çš„å°±ç»ªæ—¶é—´å·®è®°å½•åˆ°ç»Ÿè®¡æ•°ç»„ä¸­ã€‚</li>
</ul>
<p>ä¸Šè¿°æ ¸å¿ƒä»£ç ç®€ç•¥å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>probe kernel.trace(&#34;deactivate_task&#34;) !,
      kernel.function(&#34;deactivate_task&#34;) {
  s = task_state($p)
  # åªæœ‰æ»¡è¶³TASK_INTERRUPTIBLEå’ŒTASK_UNINTERRUPTIBLEçŠ¶æ€çš„æ‰è®°å½•
  if (log_event($p) &amp;&amp; (s &amp; 3)) {
    # åœ¨ç¦»é˜Ÿé˜Ÿåˆ—ä¸­è®°å½•ä¸‹æ¥å½“å‰çš„æ—¶é—´
    dequeue[$p] = gettimeofday_us();
  }
}

# activate_taskåœ¨ä¸€ä¸ªä»»åŠ¡ä¸æ´»è·ƒçš„æ—¶å€™è§¦å‘
probe kernel.trace(&#34;activate_task&#34;) !,
      kernel.function(&#34;activate_task&#34;) {
  a = gettimeofday_us()
  # æ‹¿åˆ°å¼€å§‹ä¼‘çœ çš„æ—¶é—´ç‚¹
  d = dequeue[$p]
  # åˆ é™¤è®°å½•
  delete dequeue[$p]
  # å¦‚æœå­˜åœ¨è¿™ä¸ªä¼‘çœ æ—¶é—´ï¼Œå°±å»è®¡ç®—æ—¶é•¿
  if (d) {
    sleep = a - d
    if (sleep &gt; 0) {
       # è®°å½•ä¸‹æ¥ä¼‘çœ çš„æ—¶é•¿
       this_sleep[$p] = sleep
    }
  }
}

probe scheduler.cpu_on {
   p = task_current()
   t = this_sleep[p]
   if (t){
     delete this_sleep[p]
     # å°†ä¼‘çœ æ—¶é—´ä»¥è¿›ç¨‹è°ƒç”¨æ ˆä¸ºé”®å€¼è®°å½•åˆ°ç»Ÿè®¡æ•°ç»„ä¸­
     sleep_time[backtrace()] &lt;&lt;&lt; t
   }
}
</code></pre><p>å…¶å®è¿™ä¸ªä»¥è°ƒç”¨æ ˆä¸ºé”®å€¼è®°å½•æ—¶é—´åˆ°ç»Ÿè®¡æ•°ç»„çš„å·¥ä½œï¼Œå®Œå…¨å¯ä»¥åŒæ ·æ”¾åœ¨<code>activate_task</code>å‡½æ•°ä¸­ï¼Œå®˜æ–¹çš„è§£é‡Šæ˜¯ï¼Œåœ¨<code>activate_task</code>å‡½æ•°ä¸­åšè¿™ä¸ªæ“ä½œä¼šå¢å¤§è¿™ä¸ªç›‘æ§åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶çš„å½±å“ï¼Œæ‰€ä»¥å°±æ”¾åœ¨<code>scheduler.cpu_on</code>è¿™ä¸ªprobeä¸­æ¥å®Œæˆäº†ï¼š</p>
<pre tabindex="0"><code>#FIXME: It would be nicer to get backtrace information in activate_task probe.
# This would eliminate the overhead of probing every context switch
# and this_sleep associate array. However, this needs a properly working
# task_backtrace() to eliminate this probe.
</code></pre><h2 id="off-cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ">off cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ</h2>
<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå°†è¿›ç¨‹çš„æ—¶é—´æŒ‰ç…§æŒ‰ç…§å…¶æ˜¯å¦å ç”¨CPUæ¥æ‰§è¡Œçš„æ—¶é—´æ¥åˆ’åˆ†ï¼Œå¯ä»¥åˆ†ä¸º<code>on cpu</code>å’Œ<code>off cpu</code>æ—¶é—´ã€‚è§‚å¯Ÿä¸€ä¸ªæœåŠ¡è¿›ç¨‹ï¼Œå¦‚æœå…¶åœ¨ç¹å¿™çš„æ—¶å€™ï¼ŒCPUæ—¶é—´ä¸€ç›´ä¸Šä¸å»ï¼Œè¯´æ˜æŸäº›åŸå› å¯¼è‡´å…¶<code>off cpu</code>æ—¶é—´è¿‡å¤šï¼Œè¿™æ—¶å€™å°±éœ€è¦æŸ¥çœ‹åŸå› äº†ã€‚</p>
<p><code>scheduler.cpu_off</code>å’Œ<code>scheduler.cpu_on</code>è¿™ä¸¤ä¸ªprobeäº‹ä»¶ï¼Œåœ¨è¿›ç¨‹è¢«è°ƒåº¦è¿›å‡ºCPUèµ„æºçš„æ—¶å€™è§¦å‘ï¼Œåœ¨è¿™é‡Œå¯ä»¥è®°å½•ç­‰å¾…CPUæ—¶é—´ä»¥åŠè°ƒç”¨å †æ ˆã€‚</p>
<p><a href="https://github.com/openresty/openresty-systemtap-toolkit">openresty-systemtap-toolkit</a>é¡¹ç›®ä¸­çš„<a href="https://github.com/openresty/openresty-systemtap-toolkit/blob/master/sample-bt-off-cpu">sample-bt-off-cpu</a>è„šæœ¬ï¼Œå¯ä»¥ç”¨æ¥è§‚æµ‹å¹¶æ‰“å°è¿›ç¨‹<code>off cpu</code>æ—¶é—´çš„è°ƒç”¨æ ˆï¼Œè¯¥è„šæœ¬ç”±perlè¯­è¨€å®ç°ï¼Œå¦‚æœå¸¦ä¸Š<code>-d</code>å‚æ•°å¯ä»¥è¾“å‡ºæˆsystemtapçš„stapè„šæœ¬å†…å®¹ï¼Œå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>sudo ./sample-bt-off-cpu -p `pidof top` -t 2 -u -d
</code></pre><p>è¿™é‡Œå‡ ä¸ªå‚æ•°çš„å«ä¹‰ï¼š</p>
<ul>
<li>-pï¼šå¾…è§‚æµ‹çš„è¿›ç¨‹pidï¼Œè¿™é‡Œä¸ºäº†ç¤ºèŒƒå°±é€‰æ‹©topå‘½ä»¤ã€‚</li>
<li>-tï¼šé‡‡é›†å¤šå°‘ç§’çš„æ•°æ®ä¹‹åå°±é€€å‡ºã€‚</li>
<li>-dï¼šå¹¶ä¸å®é™…å·¥ä½œï¼Œè€Œæ˜¯è¾“å‡ºsystemtapçš„stpè„šæœ¬æ–‡ä»¶å†…å®¹ã€‚</li>
<li>-uï¼šæ‰“å°çš„è°ƒç”¨æ ˆæ˜¯ç”¨æˆ·å±‚è°ƒç”¨æ ˆï¼Œåä¹‹å¦‚æœä½¿ç”¨<code>-k</code>å°±æ˜¯è¾“å‡ºçš„å†…æ ¸è°ƒç”¨æ ˆã€‚</li>
</ul>
<p>ä»¥ä¸Šå‘½ä»¤åœ¨æˆ‘æœºå™¨ä¸Šè¾“å‡ºçš„stpè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>global bts
global start_time

global quit = 0;
global found

probe begin {
    warn(sprintf(&#34;Tracing %d (/usr/bin/top)...\n&#34;, target()))
}


probe scheduler.cpu_off {
    if (pid() == target()) {
        if (!quit) {
            start_time[tid()] = gettimeofday_us()

        } else {
            foreach (bt in bts- limit 1024) {
                print_ustack(bt)
                printf(&#34;\t%d\n&#34;, @sum(bts[bt]))
            }

            exit()
        }
    }
}

probe scheduler.cpu_on {
    if (pid() == target() &amp;&amp; !quit) {
        t = tid()
        begin = start_time[t]
        if (begin &gt; 0) {
            elapsed = gettimeofday_us() - begin
            if (elapsed &gt;= 4) {
                bts[ubacktrace()] &lt;&lt;&lt; elapsed
                found = 1
            }
            delete start_time[t]
        }
    }
}

probe timer.s(2) {
    if (!found) {
        warn(&#34;No backtraces found. Quitting now...\n&#34;)
        exit()

    } else {
        warn(&#34;Time&#39;s up. Quitting now...(it may take a while)\n&#34;)
        quit = 1
    }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µè„šæœ¬æœ‰åœ¨ä¸¤ä¸ªprobeäº‹ä»¶ä¸ŠåŠ äº†å¤„ç†å‡½æ•°ï¼š</p>
<ul>
<li>scheduler.cpu_offï¼šè¿›ç¨‹å¤±å»cpuæ—¶ï¼Œè®°å½•æ­¤æ—¶çš„æ—¶é—´ã€‚</li>
<li>scheduler.cpu_onï¼šè¿›ç¨‹è·å–åˆ°cpuèµ„æºå‡†å¤‡æ‰§è¡Œæ—¶ï¼Œæ‹¿åˆ°æ­¤æ—¶çš„æ—¶é—´ï¼Œå¦‚æœä¸off cpuçš„æ—¶é—´ç›¸å·®äº†è¶…è¿‡4usï¼Œå°±è®°å½•ä¸‹æ­¤æ—¶çš„ç”¨æˆ·å±‚è°ƒç”¨æ ˆä»¥åŠæ—¶é—´å·®ã€‚</li>
<li>å½“è®¾ç½®çš„è„šæœ¬é€€å‡ºæ—¶é—´åˆ°æ¥æ—¶ï¼ŒæŒ‰ç…§å‰é¢ç»Ÿè®¡æ—¶é—´ä»åˆ°åˆ°å°‘æ‰“å°è¿›ç¨‹çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚</li>
</ul>
<h2 id="on-cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ">on cpuçš„æ—¶é—´è®¡ç®—ä»¥åŠè°ƒç”¨æ ˆ</h2>
<p>è¿›ç¨‹é™¤äº†åœ¨<code>off cpu</code>æ—¶é—´ä¸Šç­‰å¾…è¢«å”¤é†’ä¹‹å¤–ï¼Œå°±æ˜¯åœ¨<code>on cpu</code>æ—¶é—´ä¸Šä¸€ç›´æ‰§è¡Œäº†ã€‚ä¸<code>off cpu</code>æµ‹é‡æ‰€ä¸åŒçš„æ˜¯ï¼Œ<code>on cpu</code>çš„æ—¶é—´ä¸Šå¯ä»¥çœ‹å‡ºç¨‹åºæ‰§è¡Œçš„çƒ­ç‚¹ï¼Œè¿™éƒ¨åˆ†è°ƒç”¨æ ˆçš„è§‚å¯Ÿä½¿ç”¨çš„æ˜¯é‡‡æ ·çš„æ–¹å¼ã€‚å³ï¼šå®šæ—¶æ‰“å°è¿›ç¨‹è°ƒç”¨æ ˆçš„ä¿¡æ¯ã€‚</p>
<p><a href="https://github.com/openresty/openresty-systemtap-toolkit">openresty-systemtap-toolkit</a>é¡¹ç›®ä¸­çš„<a href="https://github.com/openresty/openresty-systemtap-toolkit/blob/master/sample-bt">sample-bt</a>è„šæœ¬ï¼Œå…¶ä½¿ç”¨æ—¶çš„å‘½ä»¤è¡Œå‚æ•°ä¸å‰é¢çš„<code>sample-bt-off-cpu</code>å¹¶æ— ä¸åŒï¼Œè¿™ä¸ªè„šæœ¬æ‰“å°çš„æ˜¯è¿›ç¨‹åœ¨<code>on cpu</code>çŠ¶æ€ä¸‹çš„è°ƒç”¨æ ˆï¼Œè¿™æ ·å°±å¯ä»¥è§‚å¯Ÿå‡ºç¨‹åºçš„æ‰§è¡Œçƒ­ç‚¹æ¥ï¼š</p>
<pre tabindex="0"><code>sudo ./sample-bt -p `pidof top` -t 2 -u -d
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>probe begin {
    warn(sprintf(&#34;Tracing %d (/usr/bin/top) in user-space only...\n&#34;, target()))
}


global bts;
global quit = 0;

probe timer.profile {
    if (pid() == target()) {
        if (!quit) {
            bts[ubacktrace()] &lt;&lt;&lt; 1;

        } else {

            foreach (bt in bts- limit 1024) {
                print_ustack(bt);
                printf(&#34;\t%d\n&#34;, @count(bts[bt]));
            }

            exit()
        }
    }
}

probe timer.s(2) {
    nstacks = 0
    foreach (bt in bts limit 1) {
        nstacks++
    }

    if (nstacks == 0) {
        warn(&#34;No backtraces found. Quitting now...\n&#34;)
        exit()

    } else {
        warn(&#34;Time&#39;s up. Quitting now...(it may take a while)\n&#34;)
        quit = 1
    }
}
</code></pre><p>è¿™æ®µè„šæœ¬çš„å·¥ä½œåŸç†æ˜¯ï¼šåœ¨<code>timer.profile</code>è¿™ä¸ªprobeäº‹ä»¶ä¸­ï¼Œåˆ¤æ–­å½“å‰æ‰§è¡Œçš„pidå¦‚æœæ˜¯æ‰€è¦è§‚å¯Ÿçš„pidï¼Œå°±è®°å½•å…¶è°ƒç”¨æ ˆä¿¡æ¯åˆ°ç»Ÿè®¡æ•°ç»„é‡Œï¼Œåœ¨æœ€åè„šæœ¬åˆ°æœŸçš„æ—¶å€™æŒ‰ç…§ç»Ÿè®¡æ•°ç»„çš„é™åºæ’åˆ—æ‰“å°è°ƒç”¨æ ˆå³å¯ã€‚</p>
<h2 id="ç«ç„°å›¾">ç«ç„°å›¾</h2>
<p>ä»¥ä¸Šï¼Œè§£é‡Šäº†å¦‚ä½•æ‰“å°è¿›ç¨‹åœ¨<code>off cpu</code>å’Œ<code>on cpu</code>ä¸¤ç§çŠ¶æ€ä¸‹çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œç”±äºè¿™äº›ä¿¡æ¯éƒ½æ˜¯ä½¿ç”¨é‡‡æ ·çš„æ–¹å¼è¿›è¡Œæ”¶é›†çš„ï¼Œå› æ­¤è¿˜ç»Ÿè®¡å¹¶ä¸”è¾“å‡ºè¿›ç¨‹åœ¨è¿™äº›çŠ¶æ€ä¸‹åˆ°åº•æ¶ˆè€—åœ¨å“ªäº›åœ°æ–¹ã€‚</p>
<p>æ­¤æ—¶ï¼Œå°±éœ€è¦å¬å”¤â€œç«ç„°å›¾â€äº†ã€‚ç«ç„°å›¾æ˜¯ä¸€ç§æ ¹æ®è¾“å…¥çš„é‡‡æ ·ä¿¡æ¯ï¼Œç»Ÿè®¡ç”Ÿæˆçƒ­ç‚¹çš„å›¾ç‰‡ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„çœ‹åˆ°ä»é‡‡é›†çš„æ•°æ®ä¸­ï¼Œè¿›ç¨‹éƒ½æ¶ˆè€—åœ¨å“ªäº›å‡½æ•°è°ƒç”¨é‡Œã€‚</p>
<p>ç”Ÿæˆç«ç„°å›¾çš„å·¥å…·ç”±<code>brendangregg</code>æä¾›çš„é¡¹ç›®<a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a>ç”Ÿæˆï¼Œè¯¥é¡¹ç›®æä¾›å¤šç§Perlè¯­è¨€ç¼–å†™çš„è„šæœ¬ï¼Œæ•°æ®æºå¯ä»¥æ¥è‡ªPerfã€systemtapç­‰å¤šç§Linuxä¸‹é¢çš„profileå·¥å…·ï¼Œsystemtapçš„è¾“å‡ºå¯ä»¥ç”±é¡¹ç›®ä¸­çš„stackcollapse-stap.plè„šæœ¬æ¥ç”Ÿæˆç«ç„°å›¾ã€‚</p>
<p>ä»¥ä½¿ç”¨å‰é¢çš„<code>openresty-systemtap-toolkit</code>é¡¹ç›®ä¸­çš„<code>sample-bt</code>è„šæœ¬ä¸ºä¾‹ï¼Œæ­é…ç«ç„°å›¾ä½¿ç”¨çš„æ­¥éª¤å¤§ä½“å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code># è·Ÿè¸ªpidä¸º22222çš„è¿›ç¨‹ï¼Œé‡‡æ ·æ—¶é—´20ç§’ï¼Œåªé‡‡ç”¨ç”¨æˆ·å±‚ä¿¡æ¯ï¼Œè¾“å‡ºåˆ°tmp.btæ–‡ä»¶ä¸­
./sample-bt -p 22222 -t 20 -u &gt; tmp.bt

# è°ƒç”¨stackcollapse-stap.plæ–‡ä»¶ï¼Œå°†ç¬¬ä¸€æ­¥é‡‡æ ·çš„æ•°æ®ç”Ÿæˆcbtæ ¼å¼æ–‡ä»¶
./stackcollapse-stap.pl flame.bt &gt; flame.cbt

# ç”Ÿæˆç«ç„°å›¾çš„svgæ–‡ä»¶
./flamegraph.pl flame.cbt &gt; flame.svg
</code></pre><p>ä»¥ä¸Šçš„æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-process-systemtap/hotpot.png" alt="hotpot" title="hotpot"></p>
<p>ä¸‹å›¾æ˜¯ç«ç„°å›¾çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œç«ç„°å›¾åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>æ¨ªè½´ï¼šå‡½æ•°è°ƒç”¨çš„æ—¶é—´å æ¯”ã€‚ç›´è§‚æ¥çœ‹ï¼Œæ¨ªè½´ä¸Šè¶Šå®½çš„å‡½æ•°è°ƒç”¨ï¼Œå…¶é‡‡æ ·åˆ°çš„æ•°æ®å°±è¶Šå¤šï¼Œè¿™æ ·æ‰èƒ½ç›´è§‚çš„çœ‹åˆ°â€œçƒ­ç‚¹â€åœ¨å“ªäº›å‡½æ•°è°ƒç”¨ä¸Šã€‚</li>
<li>çºµè½´ï¼šå‡½æ•°çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-process-systemtap/hotpot-example.svg" alt="hotpot-example" title="hotpot-example"></p>
<h1 id="è¿›ç¨‹çŠ¶æ€çš„åˆ‡æ¢">è¿›ç¨‹çŠ¶æ€çš„åˆ‡æ¢</h1>
<p>å‰é¢å‡ ä¸ªéƒ¨åˆ†ï¼Œå·²ç»å¯ä»¥è§‚æµ‹å‡ºæ¥è¿›ç¨‹åœ¨<code>on cpu</code>å’Œ<code>off cpu</code>ä¸Šé¢èŠ±è´¹çš„æ—¶é—´ã€æ‰§è¡Œçƒ­ç‚¹ã€è°ƒç”¨æ ˆç­‰ä¿¡æ¯äº†ï¼Œä½†æ˜¯ç¨‹åºåœ¨éæ‰§è¡Œæ—¶é—´ï¼Œå…¶å®è¿˜å¯ä»¥ç»†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªçŠ¶æ€ï¼š</p>
<ul>
<li>è¿›ç¨‹çš„æ‰§è¡Œæƒæ˜¯è¢«æŠ¢å çš„ï¼Œæœ¬èº«å¹¶æ²¡æœ‰ä»»ä½•æ”¾å¼ƒæ‰§è¡Œæƒçš„æ“ä½œã€‚æ­¤æ—¶å°±æ„å‘³ç€ï¼Œè¿›ç¨‹è¿˜ä¸€ç›´åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œåªä¸è¿‡è¢«ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹æŠ¢å äº†æ‰§è¡Œæƒã€‚</li>
<li>è¿›ç¨‹å› ä¸ºç­‰å¾…IOã€ä¸»åŠ¨ä¼‘çœ ç­‰åŸå› ï¼Œè®©å‡ºäº†æ‰§è¡Œæƒï¼Œæ­¤æ—¶è¿˜å¯ä»¥ç»†åˆ†ä¸ºè¿›ç¨‹æ˜¯ä¼‘çœ è¿˜æ˜¯åœ¨ç­‰å¾…IOäº‹ä»¶å®Œæˆåå†å”¤é†’è¿›ç¨‹æ‰§è¡Œã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-process-systemtap/offcpu.png" alt="offcpu" title="offcpu"></p>
<p>æœ¬èŠ‚ä¸­æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨systemtapè„šæœ¬æ¥å…·ä½“ç»Ÿè®¡ç¨‹åºåœ¨è¿™å‡ ä¸ªç»†åˆ†çŠ¶æ€ä¸­çš„æ‰§è¡Œæ—¶é—´ã€‚</p>
<p>å…ˆä»æè¿°è¿›ç¨‹çš„<code>task_struct</code>ç»“æ„ä½“ä¿¡æ¯è¯´èµ·ï¼Œè¿™éƒ¨åˆ†åœ¨å‰é¢ä¸“é—¨è®²è§£<code>task_struct</code>ç»“æ„ä½“çš„éƒ¨åˆ†æœ‰ä¸“é—¨ä»‹ç»ï¼Œè¿™é‡Œä»…ä½œç®€å•çš„å›é¡¾ã€‚</p>
<p><code>task_struct</code>ç»“æ„ä½“ä¸­ï¼Œæˆå‘˜<code>state</code>ç”¨æ¥è¡¨ç¤ºè¿›ç¨‹å½“å‰çš„çŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªäº’æ–¥çš„å€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080">#define TASK_RUNNING			0x0000
</span></span></span><span style="display:flex;"><span><span style="color:#080">#define TASK_INTERRUPTIBLE		0x0001
</span></span></span><span style="display:flex;"><span><span style="color:#080">#define TASK_UNINTERRUPTIBLE		0x0002
</span></span></span></code></pre></div><p>å…¶ä¸­ï¼Œ<code>TASK_RUNNING</code>çŠ¶æ€å°±æ˜¯å°±ç»ªçŠ¶æ€ã€‚å¯ä»¥è®¤ä¸ºï¼Œåªè¦<code>state</code>å€¼ä¸º0ï¼ˆå³TASK_RUNNINGï¼‰çš„æƒ…å†µä¸‹ï¼Œè¿›ç¨‹å°±æ˜¯å°±ç»ªçŠ¶æ€çš„ï¼Œæ­¤æ—¶åªå¯èƒ½å¤„äºä¸¤ç§çŠ¶æ€ï¼š</p>
<ul>
<li>å ç”¨CPUåœ¨æ‰§è¡Œã€‚</li>
<li>åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«å”¤é†’æ‰§è¡Œï¼Œè¿™ç§è¿›ç¨‹è¿˜æ˜¯å°±ç»ªçŠ¶æ€å´è¢«è°ƒåº¦å‡ºCPUçš„æƒ…å†µï¼Œä¸€èˆ¬éƒ½æ˜¯è¢«ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹æŠ¢å äº†æ‰§è¡Œæƒã€‚</li>
</ul>
<p>å› æ­¤ï¼Œå½“è¿›ç¨‹è¢«è°ƒåº¦è®©å‡ºcpuæ‰§è¡Œæƒæ—¶ï¼Œå¦‚æœ<code>state</code>ä¸º0è¯´æ˜æ­¤æ—¶è¿˜åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œå¦åˆ™å°±ä¸æ˜¯å°±ç»ªçŠ¶æ€ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>task_struct</code>ç»“æ„ä½“ä¸­è¿˜æœ‰å¦ä¸€ä¸ªæˆå‘˜<code>in_iowait</code>ï¼Œç”¨äºè¡¨ç¤ºå½“å‰è¿›ç¨‹æ˜¯å¦åœ¨ç­‰å¾…IOã€‚å› æ­¤ï¼Œæ ¹æ®è¿™ä¸ªæˆå‘˜æ˜¯å¦ä¸º1ï¼Œå°±å¯ä»¥çŸ¥é“éå°±ç»ªçŠ¶æ€çš„è¿›ç¨‹æ˜¯åœ¨ç­‰å¾…IOè¿˜æ˜¯åœ¨ä¼‘çœ ã€‚</p>
<p>æ€»ç»“ä¸Šé¢çš„å†…å®¹å¦‚ä¸‹ï¼Œå½“è¿›ç¨‹è¢«å‰¥å¤ºæ‰§è¡Œæƒçš„æ—¶å€™ï¼š</p>
<ul>
<li>å¦‚æœå½“å‰è¿›ç¨‹çŠ¶æ€è¿˜æ˜¯<code>TASK_RUNNING</code>ï¼Œè¯´æ˜è¿™æ—¶å€™å›åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…è°ƒåº¦æ‰§è¡Œã€‚</li>
<li>å¦‚æœè¿›ç¨‹çŠ¶æ€å¤§äº0ï¼Œæ­¤æ—¶ä¼šåŒºåˆ†ä¸¤ç§æƒ…å†µï¼š
<ul>
<li>å¦‚æœ<code>in_iowait</code>ä¸º1ï¼šè¯´æ˜åœ¨ç­‰å¾…IOã€‚</li>
<li>å¦åˆ™è¯´æ˜åœ¨ä¼‘çœ ã€‚</li>
</ul>
</li>
<li>ç¬¬ä¸‰ç§æƒ…å†µå°±æ˜¯è¿›ç¨‹çŠ¶æ€å°äº0çš„çŠ¶æ€ï¼Œæ­¤æ—¶è¿›ç¨‹å·²ç»æ­»äº¡ã€‚</li>
</ul>
<p>systemtapä¸­è‡ªå¸¦çš„ä¾‹å­è„šæœ¬<a href="https://sourceware.org/systemtap/examples/process/schedtimes.stp">schedtimes</a>æä¾›äº†ç»Ÿè®¡ä»¥ä¸Šä¸‰ç§æ—¶é—´çš„ä¾‹å­ï¼š</p>
<pre tabindex="0"><code>$ sudo stap schedtimes.stp -T 10

        execname:    pid    run(us)  sleep(us) iowait(us) queued(us)  total(us)

         systemd:      1         29   10034958          0          5   10034992
       rcu_sched:      8        632   10030313          0       1432   10032377
      watchdog/0:     11         49    8284090          0        102    8284241
      watchdog/1:     14         47    8284082          0        102    8284231
     ksoftirqd/1:     16         50   10028298          0          9   10028357
      watchdog/2:     20         68    8280096          0         76    8280240
     ksoftirqd/2:     22         97    7916416          0        141    7916654
</code></pre><p>è„šæœ¬ä¸­èƒ½ç»Ÿè®¡å‡ºç¨‹åºåœ¨æ‰§è¡ŒçŠ¶æ€ï¼ˆrunï¼‰ã€ä¼‘çœ çŠ¶æ€ï¼ˆsleepï¼‰ã€ç­‰å¾…IOçŠ¶æ€ï¼ˆiowaitï¼‰ã€åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦çŠ¶æ€ï¼ˆqueuedï¼‰çš„æ—¶é—´ã€‚</p>
<p>è¿™ä¸ªè„šæœ¬çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>kernel.trace(&quot;sched_switch&quot;)</code>äº‹ä»¶ä¸­ï¼šè¿™ä¸ªäº‹ä»¶åœ¨è¿›ç¨‹è¢«åˆ‡æ¢å‡ºå»cpuæ—¶è¢«è§¦å‘ï¼Œæ­¤æ—¶å¯ä»¥æ‹¿åˆ°è¿›ç¨‹<code>task_struct</code>ç»“æ„ä½“çš„<code>state</code>æˆå‘˜ï¼Œæ ¹æ®ä¸Šé¢æè¿°è¿›ç¨‹çŠ¶æ€åˆ¤æ–­ï¼Œå°±å¯ä»¥çŸ¥é“æ˜¯ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒã€æ’åœ¨å°±ç»ªé˜Ÿåˆ—ç­‰å¾…ã€è¿˜æ˜¯æ­»äº¡çŠ¶æ€äº†ã€‚</li>
<li><code>kernel.trace(&quot;sched_wakeup&quot;)</code>äº‹ä»¶ä¸­ï¼šè¿™ä¸ªäº‹ä»¶åœ¨è¿›ç¨‹è¢«å†æ¬¡æ‰§è¡Œæ—¶è§¦å‘ï¼Œæ­¤æ—¶åˆ¤æ–­è¿›ç¨‹åœ¨åˆ‡æ¢å‡ºå»æ—¶çš„çŠ¶æ€å¦‚æœæ˜¯ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒçš„è¯ï¼Œé‚£ä¹ˆå¦‚æœè¿™æ—¶<code>task_struct-&gt;in_iowait</code>ä¸º1ï¼Œè¯´æ˜åœ¨ç­‰å¾…IOï¼Œå¦åˆ™å°±æ˜¯åœ¨ä¼‘çœ çŠ¶æ€ã€‚</li>
</ul>
<p>è¿™éƒ¨åˆ†ç›¸å…³ä»£ç åŠæ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// è¿›ç¨‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘ï¼Œç”¨äºæ›´æ–°è¿›ç¨‹å„ç§çŠ¶æ€çš„ç»Ÿè®¡æ—¶é—´
function update_times(pid, now)
{
  delta = now - previous_timestamp[pid]
  // é¦–å…ˆæ›´æ–°è¿™ä¸€æ¬¡ç»Ÿè®¡çš„æ—¶é—´æˆ³
  previous_timestamp[pid] = now

  if ((state = pid_state[pid]) &gt; 0) {
    // è¿›ç¨‹çŠ¶æ€å¤§äº0ï¼Œè¯´æ˜è¿›ç¨‹æ²¡æœ‰å°±ç»ª
    if (state == SLEEPING)
      // æ›´æ–°ä¼‘çœ æ—¶é—´
      sleep_time[pid] += delta
    else if (state == QUEUED)
      // æ›´æ–°æ’é˜Ÿæ—¶é—´
      queued_time[pid] += delta
    else if (state == RUNNING)
      // æ›´æ–°è¿è¡Œæ—¶é—´
      run_time[pid] += delta
  }

  return delta
}

probe kernel.trace(&#34;sched_switch&#34;)
{
  // Task $prev is scheduled off this cpu
  if (task_targeted($prev)) {
    pid = $prev-&gt;pid
    state = $prev-&gt;state
    update_times(pid, timestamp())

    // æ ¹æ®è¿›ç¨‹çŠ¶æ€æ¥åˆ¤æ–­
    if (state &gt; 0) {
      // å¤§äº0è¯´æ˜ä¸åœ¨è¿è¡ŒçŠ¶æ€ï¼Œåœ¨ä¼‘çœ 
      @set_iowait($rq, $prev)
      pid_state[pid] = SLEEPING
    } else if (state == 0) {
      // =0è¯´æ˜åœ¨è¿è¡ŒçŠ¶æ€ï¼Œåªä¸è¿‡è¢«æŠ¢å äº†æ‰§è¡Œæƒ
      pid_state[pid] = QUEUED
    } else {
      // å°äº0è¯´æ˜è¿›ç¨‹æ­»äº†
      pid_state[pid] = DEAD
    }
  }

  // Task $next is scheduled onto this cpu
  if (task_targeted($next)) {
    pid = $next-&gt;pid
    update_times(pid, timestamp())

    @clear_iowait($rq, $next)
    pid_state[pid] = RUNNING
  }
}

// è¿›ç¨‹è¢«å”¤é†’æ—¶è§¦å‘
probe kernel.trace(&#34;sched_wakeup&#34;)
{
  // Task $p is awakened
  if (@choose_defined($success, 1) &amp;&amp; task_targeted($p)) {
    pid = $p-&gt;pid
    delta = update_times(pid, timestamp())
    // åœ¨ä¼‘çœ åŒæ—¶åœ¨iowaitï¼Œå¢åŠ iowaitæ—¶é—´
    if (pid_state[pid] == SLEEPING &amp;&amp; @in_iowait($p)) {
      iowait_time[pid] += delta
    }
    // çŠ¶æ€æ˜¯å°±ç»ªé˜Ÿåˆ—çŠ¶æ€
    pid_state[pid] = QUEUED
  }
}
</code></pre><h1 id="å°ç»“">å°ç»“</h1>
<p>æ€»ç»“ä¸€ä¸‹è¿™ä¸€èŠ‚æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>è¿›ç¨‹çš„æ‰§è¡Œåˆ’åˆ†ä¸º<code>on cpu</code>å’Œ<code>off cpu</code>ä¸¤éƒ¨åˆ†æ—¶é—´ã€‚å‰è€…è¡¨ç¤ºè¿›ç¨‹åœ¨å ç”¨CPUæ‰§è¡Œçš„æ—¶é—´ï¼Œåè€…æ˜¯é™¤æ­¤ä¹‹å¤–çš„è¿›ç¨‹æ—¶é—´ã€‚</li>
<li>å¦‚æœè¿›ç¨‹çš„CPUä¸€ç›´ä¸Šä¸å»ï¼Œå¯ä»¥çœ‹çœ‹è¿›ç¨‹çš„<code>off cpu</code>æ—¶é—´éƒ½åˆ†å¸ƒåœ¨å“ªäº›å‡½æ•°è°ƒç”¨ä¸Šï¼›åä¹‹ï¼Œå¯ä»¥ä»è¿›ç¨‹çš„<code>on cpu</code>æ—¶é—´ä¸­çœ‹åˆ°è¿›ç¨‹æ‰§è¡Œæ—¶çš„çƒ­ç‚¹å‡½æ•°ã€‚</li>
<li>æœ‰äº†ä¸åŒçŠ¶æ€ä¸‹çš„å‡½æ•°è°ƒç”¨æ ˆé‡‡æ ·æ•°æ®ä¹‹åï¼Œå¯ä»¥ç”Ÿæˆç«ç„°å›¾ç›´è§‚æŸ¥çœ‹é‡‡æ ·æ•°æ®ã€‚</li>
<li>ä½¿ç”¨systemtapè„šæœ¬å¯ä»¥è·Ÿè¿›è¿™ä¸¤éƒ¨åˆ†æ—¶é—´ã€è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€è¿›ç¨‹çŠ¶æ€åˆ‡æ¢çš„æƒ…å†µã€‚</li>
</ul>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20200503-sgfap-process-schedule/">â† prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20200516-sgfap-syscall/">next â†’</a>
    
  </div>

    
<h1>ç›¸å…³æ–‡ç« </h1>
<li><strong> 20069-06-20: </strong> <a href="https://www.codedump.info/post/20200620-sgfap-loadavg/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹Linuxç³»ç»Ÿå¹³å‡è´Ÿè½½</a>  </li><li><strong> 22059-05-22: </strong> <a href="https://www.codedump.info/post/20200522-sgfap-softirq/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è½¯ä¸­æ–­</a>  </li><li><strong> 16059-05-16: </strong> <a href="https://www.codedump.info/post/20200516-sgfap-syscall/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ç³»ç»Ÿè°ƒç”¨</a>  </li><li><strong> 3059-05-03: </strong> <a href="https://www.codedump.info/post/20200503-sgfap-process-schedule/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è¿›ç¨‹è°ƒåº¦</a>  </li><li><strong> 2059-05-02: </strong> <a href="https://www.codedump.info/post/20200502-sgfap-process/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è¿›ç¨‹</a>  </li>
<h1>é‚®ä»¶è®¢é˜…</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="é‚®ä»¶è®¢é˜…æœ¬ç«™æ›´æ–°" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="ç‚¹å‡»è®¢é˜…" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revueâ€™s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux%E7%B3%BB%E7%BB%9F/">Linuxç³»ç»Ÿ</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    
    
        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  
    
  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
