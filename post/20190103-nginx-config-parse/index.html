<!DOCTYPE html>
<html lang="zh"
  dir="ltr">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://www.codedump.info//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.codedump.info//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.codedump.info//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://www.codedump.info//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://www.codedump.info//apple-touch-icon.png">

<meta name="description" content="Nginx源码阅读笔记-配置解析流程"/>



<title>
    
    Nginx源码阅读笔记-配置解析流程 | codedump notes
    
</title>

<link rel="canonical" href="https://www.codedump.info/post/20190103-nginx-config-parse/"/>

<meta property="og:url" content="https://www.codedump.info/post/20190103-nginx-config-parse/">
  <meta property="og:site_name" content="codedump notes">
  <meta property="og:title" content="Nginx源码阅读笔记-配置解析流程">
  <meta property="og:description" content="Nginx源码阅读笔记-配置解析流程">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2019-01-03T08:41:44+08:00">
    <meta property="article:modified_time" content="2019-01-03T08:41:44+08:00">
    <meta property="article:tag" content="Nginx">













<link rel="stylesheet" href="/assets/combined.min.1356e1c8842105762b945263595323c16a5ce093eb9455a22e7910868b90a5c5.css" media="all">









</head>







<body class="typo">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="https://www.codedump.info/">codedump notes</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/" >
                /home
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/zh" >
                /中文
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/en" >
                /en
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/tags" >
                /tags
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/page/about" >
                /about
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      




<div class="breadcrumbs"><a href="/">Home</a><span class="breadcrumbs-separator">/</span><a href="/post/">Posts</a><span class="breadcrumbs-separator">/</span>
        <a href="/post/20190103-nginx-config-parse/">Nginx源码阅读笔记-配置解析流程</a></div>


<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">Nginx源码阅读笔记-配置解析流程</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2019-01-03T08:41:44&#43;08:00">2019年1月3日</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <p>本系列文章基于openresty-1.13.6.1版本的代码做的笔记，其对应的nginx源码版本是nginx-1.13.6。</p>
<h1 class="heading" id="模块与配置值解析相关数据结构">
  模块与配置值解析相关数据结构
  <a class="anchor" href="#%e6%a8%a1%e5%9d%97%e4%b8%8e%e9%85%8d%e7%bd%ae%e5%80%bc%e8%a7%a3%e6%9e%90%e7%9b%b8%e5%85%b3%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84">#</a>
</h1>
<p>整个Nginx是以模块的方式来组织的，即使是核心的组件如epoll之类的，最终也是以模块的方式注册到nginx中的。所以先了解整个nginx模块的结构很有必要。</p>
<p>与模块相关的核心数据结构有以下这几个。</p>
<p>ngx_module_t结构体用于定义nginx模块相关的数据结构，其中包括几个核心的数据：</p>
<ul>
<li>void *ctx：用于存储每个模块相关的context数据。</li>
<li>ngx_command_t *commands：用于存储与该模块相关的配置命令解析数据。所谓的配置命令，就是对应的nginx配置文件中的语句，如”event“、”include“等，每个配置语句最终一定有一个相关的ngx_command_t数据与之对应，负责解析这个命令。</li>
<li>ngx_uint_t type：用于保存模块的类型，目前包括NGX_HTTP_MODULE，NGX_CORE_MODULE，NGX_CONF_MOULE，NGX_EVENT_MODULE，NGX_MAIL_MODULE这几种类型。</li>
<li>一组回调函数：用于在解析配置的时候进行回调。</li>
</ul>
<p>而上面的ngx_command_t结构体又有以下成员：</p>
<ul>
<li>ngx_str_t name：配置文件里对应的配置项名称。如前面提到的nginx配置文件中的”event“、”include“等。</li>
<li>ngx_uint_t type：配置项类型，这里会存储如该配置项应该出现在什么位置（http块、server块、location块等），以及配置项参数数量，以便于解析过程中进行合法性的判断。
<ul>
<li>命令的作用域，即该命令能够出现在什么位置（http块、server块、location块等），这些与作用域相关的类型有NGX_MAIN_CONF、NGX_EVENT_CONF、NGX_HTTP_MAIN_CONF、NGX_HTTP_SRV_CONF、 NGX_HTTP_LOC_CONF、NGX_MAIL_MAIN_CONF、NGX_MAIL_SRV_CONF 等。</li>
<li>命令能够接受的参数数量，如NGX_CONF_NOARGS、NGX_CONF_TAKE1等。</li>
</ul>
</li>
<li>ngx_uint_t offset：该配置命令所要修改的配置项在该模块配置结构体中的偏移量。</li>
<li>ngx_uint_t conf：该配置在子模块配置项中的索引。</li>
<li>回调函数set：在解析到配置项的时候进行回调。</li>
</ul>
<p>下图中给出一个简单的nginx配置文件的作用域示意图：</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="ngx-conf-scope" src="/media/imgs/20190103-nginx-config-parse/ngx-conf-scope.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> ngx-conf-scope </figcaption>
    </div>
    
</figure>
</p>
<p>有了以上两个核心数据结构，可以知道每个nginx模块注册时的方式：</p>
<ul>
<li>定义一组与本模块相关的ngx_command_t，用于定义本模块相关的配置项信息。</li>
<li>定义一个与本模块相关的数据结构，注册为ngx_module_t的ctx指针，用于保存本模块相关的数据结构。</li>
<li>最后，将上面的数据放到ngx_module_t中，nginx解析配置的时候会自动回调对应的处理函数了。</li>
</ul>
<p>以epoll模块来说，其ngx_module_t结构体是如下组织的。</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="epoll-module" src="/media/imgs/20190103-nginx-config-parse/epoll-module.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> epoll-module </figcaption>
    </div>
    
</figure>
</p>
<p>根据上面的图示，不难想象，nginx在配置解析的时候是如何解析epoll相关的配置的：</p>
<ul>
<li>首先解析到event模块，也就是nginx配置文件中的event{}部分，此时会把对用的context指针指向ngx_epoll_module_ctx，开始进行event模块的解析工作。</li>
<li>如果在event块中遇到名为“epoll_events”或者“worker_aio_requests”开始的配置，那么就知道是上面ngx_epoll_commands数组中定义的配置命令，nginx首先会根据这里定义的type来分析其出现的位置（是否出现在event块）以及参数数量（NGX_CONF_TAKE1）是否正确，都检测通过之后，才会调用ngx_command_t中set回调函数进行配置解析。</li>
</ul>
<h1 class="heading" id="解析配置流程">
  解析配置流程
  <a class="anchor" href="#%e8%a7%a3%e6%9e%90%e9%85%8d%e7%bd%ae%e6%b5%81%e7%a8%8b">#</a>
</h1>
<h2 class="heading" id="相关核心函数">
  相关核心函数
  <a class="anchor" href="#%e7%9b%b8%e5%85%b3%e6%a0%b8%e5%bf%83%e5%87%bd%e6%95%b0">#</a>
</h2>
<p>上面分析到ngx_module_t结构体的时候曾经提到过，当前的type有如下类型：NGX_HTTP_MODULE，NGX_CORE_MODULE，NGX_CONF_MOULE，NGX_EVENT_MODULE，NGX_MAIL_MODULE。</p>
<p>实际上，nginx的模块类型是一个树形结构，最顶层的是NGX_CORE_MODULE，它下面的子类型是NGX_HTTP_MODULE、NGX_EVENT_MODULE等。</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="module-tree" src="/media/imgs/20190103-nginx-config-parse/module-tree.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> module-tree </figcaption>
    </div>
    
</figure>
</p>
<p>如果一个结构体是使用树形结构来进行组织的，那么首先会想到的是“递归算法”。</p>
<p>实际上nginx配置解析，确实也是以递归的方式来进行解析的。仍然是以前面的epoll模块解析为例来说明这个流程：</p>
<ul>
<li>首先解析类型为NGX_CORE_MODULE的顶层模块，由于event模块（即event{}配置块）也是NGX_CORE_MODULE，因此解析到event{}块时会进入event模块相关的配置解析中。</li>
<li>下面开始进入NGX_EVENT_MODULE这个二层模块的解析中，当遇到epoll相关的指令时，进入epoll模块的解析。</li>
</ul>
<p>上面可以看到，既然是递归方式来解析的，那么意味着解析配置使用的解析函数是可以被递归调用的，在nginx中这个会被递归调用的核心函数是core/ngx_conf_file.c中的ngx_conf_parse函数。</p>
<p>在ngx_conf_parse中，会根据传入的filename来区分几种情况：</p>
<ul>
<li>filename不为空：说明是首次调用该函数，此时会打开filename指定的文件名开始解析。</li>
<li>cf-&gt;conf_file-&gt;file.fd != NGX_INVALID_FILE：说明此时是被递归调用的情况，用于分析一个{}block的内容。</li>
<li>如果以上情况都不是，说明也是被递归调用的情况，而这时是分析一个参数的情况。</li>
</ul>
<p>另外，既然ngx_conf_parse会被递归调用，每次传入的参数就都是一个类型的，被递归调用的时候就需要相应的做修改。</p>
<p>ngx_conf_parse的函数原型如下：</p>
<pre tabindex="0"><code>char*
ngx_conf_parse(ngx_conf_t *cf, ngx_str_t *filename);
</code></pre><p>可以看到其中有两个入参，其中之一的filename前面已经介绍过了，下面来介绍ngx_conf_t结构体。这个结构体可以认为是解析配置文件过程中为了保存数据的中间数据结构，其重要的几个成员是：</p>
<ul>
<li>ngx_uint_t module_type：模块类型，即前面提到的NGX_HTTP_MODULE，NGX_CORE_MODULE，NGX_CONF_MOULE，NGX_EVENT_MODULE，NGX_MAIL_MODULE。</li>
<li>ngx_uint_t cmd_type：命令类型，表示指令的作用域。有NGX_MAIN_CONF、NGX_EVENT_CONF、NGX_HTTP_MAIN_CONF、NGX_HTTP_SRV_CONF、 NGX_HTTP_LOC_CONF、NGX_MAIL_MAIN_CONF、NGX_MAIL_SRV_CONF 等。</li>
</ul>
<p>因此，在每次递归调用ngx_conf_parse函数之前，调用方都要相应的设置ngx_conf_t结构体这两个成员，好让ngx_conf_parse函数知道当前解析的是哪个模块、在哪个配置作用域中。</p>
<p>在ngx_conf_parse内部，又会调用ngx_conf_handler来做配置的解析，其主体的代码流程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>-------------core/ngx_conf_file.c-------------
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_int_t</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">ngx_conf_handler</span>(<span style="font-weight:bold;text-decoration:underline">ngx_conf_t</span> *cf, <span style="font-weight:bold;text-decoration:underline">ngx_int_t</span> last)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;text-decoration:underline">for</span> (i = 0; ngx_modules[i]; i++) {
</span></span><span style="display:flex;"><span>    <span style="color:#888;font-style:italic">/* module type checking */</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    cmd = ngx_modules[i]-&gt;commands;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">for</span> ( <span style="color:#888;font-style:italic">/* void */</span> ; cmd-&gt;name.len; cmd++) {
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">/* name comparison */</span>
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">/* namespace checking */</span>
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">/* checking argument numbers */</span>
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">/* set up the directive&#39;s configuration context */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      conf = <span style="font-weight:bold;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold;text-decoration:underline">if</span> (cmd-&gt;type &amp; NGX_DIRECT_CONF) {
</span></span><span style="display:flex;"><span>        conf = ((<span style="font-weight:bold;text-decoration:underline">void</span> **) cf-&gt;ctx)[ngx_modules[i]-&gt;index];
</span></span><span style="display:flex;"><span>      } <span style="font-weight:bold;text-decoration:underline">else</span> <span style="font-weight:bold;text-decoration:underline">if</span> (cmd-&gt;type &amp; NGX_MAIN_CONF) {
</span></span><span style="display:flex;"><span>        conf = &amp;(((<span style="font-weight:bold;text-decoration:underline">void</span> **) cf-&gt;ctx)[ngx_modules[i]-&gt;index];
</span></span><span style="display:flex;"><span>      } <span style="font-weight:bold;text-decoration:underline">else</span> <span style="font-weight:bold;text-decoration:underline">if</span> (cf-&gt;ctx) {
</span></span><span style="display:flex;"><span>        confp = *(<span style="font-weight:bold;text-decoration:underline">void</span> **) ((<span style="font-weight:bold;text-decoration:underline">char</span> *) cf-&gt;ctx + cmd-&gt;conf);
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;text-decoration:underline">if</span> (confp) {
</span></span><span style="display:flex;"><span>          conf = confp[ngx_modules[i]-&gt;ctx_index];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      rc = cmd-&gt;<span style="color:#666;font-weight:bold;font-style:italic">set</span>(cf, cmd, conf);
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个函数做的主要事情是：</p>
<ol>
<li>读取到一条配置指令后，将使用指令名在所有指令中查找对应的ngx_command_t结构体，找到对应的ngx_command_t结构体之后，将进行校验工作：检查模块的类型和当前解析函数上下文的类型是否一致、检查指令的作用域是否包含当前解析函数上下文记录中的作用域、检查参数数量是否和指令中定义的一致。</li>
<li>校验工作完成后，根据指令类型来找到配置项。</li>
</ol>
<p>第二步值得好好分析一下，毕竟这里是很多人读到这部分代码的困惑。</p>
<p>前面讲到ngx_module_t结构体的时候，提到其成员ctx用来保存模块相关的context数据。最终这些数据创建成功之后，是保存在ngx_cycle_t.conf_ctx，注意到这是一个void ****类型的指针。</p>
<p>为什么这是一个四级的void指针？原因在于，nginx模块之间也是分层次的。比如前面提到的模块分层，最顶层是NGX_CORE_MODULE，然后如果解析到event块就到了NGX_EVENT_MODULE模块，如果在event块中再解析到epoll命令，就到了epoll模块中。</p>
<p>而这些所有的模块，不管在哪一层，最终都是存储在这个ngx_cycle_t.conf_ctx中的，四级指针是它能够接受的最大模块层级。</p>
<p>但是呢，所有模块都存储在这个数据中，存储读写的时候却不一样：有的配置是有子项目的，比如http块、event块，内部都还有别的指令
，所以在操作这些有子项的指令时，应该拿到它的指针，再到子项中修改指针中的某个成员；有的配置项只顾着自己就好，能从这个conf_ctx中读到自己模块的上下文指针就可以进行操作了。</p>
<p>从上面的代码里面，可以看到根据命令类型的不同，区分三种不同的配置项存储位置：</p>
<ul>
<li>NGX_DIRECT_CONF类型的配置指令：这类型的命令，一定在类型中同时和NGX_MAIN_CONF一起出现，即一个配置命令如果是NGX_DIRECT_CONF类型的，那么它一定也是NGX_MAIN_CONF类型的，反之不然。这类型的指令，指的是在nginx配置文件中只出现在顶层作用域，但是又没有单独block即没有子项目的配置项，比如daemon，master_process这样的指令。这种就是前面提到的只需要顾着自己配置的模块，因此从ctx中提取的时候直接拿出来就好了。</li>
<li>NGX_MAIN_CONF：在顶层模块而且有子项的配置，都有这个类型，比如http块、event块。因为这些模块还有内部的子项，提取出来的时候要提取出的是指针，内部再解析它们的子项时使用指针来读写操作。</li>
<li>除了以上两种类型之外，剩下的就是第三种类型的配置命令了。从代码中可以看出，读取这种类型的配置是，首先取出来对应的配置项（没有取配置项的指针），然后在配置中根据配置上下文索引ctx_index再取出对应的配置。</li>
</ul>
<p>上面的说明还是有些抽象，所以还是以例子来进行说明。</p>
<h2 class="heading" id="解析ngx_direct_conf类型指令的例子">
  解析NGX_DIRECT_CONF类型指令的例子
  <a class="anchor" href="#%e8%a7%a3%e6%9e%90ngx_direct_conf%e7%b1%bb%e5%9e%8b%e6%8c%87%e4%bb%a4%e7%9a%84%e4%be%8b%e5%ad%90">#</a>
</h2>
<p>从最简单的解析NGX_DIRECT_CONF类型的指令开始说起，以daemon指令为例。</p>
<p>daemon指令属于core模块，因此是首先解析到core模块才到这个模块中的daemon指令的。</p>
<p>先看core模块的定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_command_t</span>  ngx_core_commands[] = {
</span></span><span style="display:flex;"><span>{ <span style="color:#666;font-weight:bold;font-style:italic">ngx_string</span>(<span style="color:#666;font-style:italic">&#34;daemon&#34;</span>),
</span></span><span style="display:flex;"><span>  NGX_MAIN_CONF|NGX_DIRECT_CONF|NGX_CONF_FLAG,
</span></span><span style="display:flex;"><span>  ngx_conf_set_flag_slot,
</span></span><span style="display:flex;"><span>  0,
</span></span><span style="display:flex;"><span>  <span style="color:#666;font-weight:bold;font-style:italic">offsetof</span>(<span style="font-weight:bold;text-decoration:underline">ngx_core_conf_t</span>, daemon),
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span> },
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_core_module_t</span>  ngx_core_module_ctx = {
</span></span><span style="display:flex;"><span>  <span style="color:#666;font-weight:bold;font-style:italic">ngx_string</span>(<span style="color:#666;font-style:italic">&#34;core&#34;</span>),
</span></span><span style="display:flex;"><span>  ngx_core_module_create_conf,
</span></span><span style="display:flex;"><span>  ngx_core_module_init_conf
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">ngx_module_t</span>  ngx_core_module = {
</span></span><span style="display:flex;"><span>  NGX_MODULE_V1,
</span></span><span style="display:flex;"><span>  &amp;ngx_core_module_ctx,                  <span style="color:#888;font-style:italic">/* module context */</span>
</span></span><span style="display:flex;"><span>  ngx_core_commands,                     <span style="color:#888;font-style:italic">/* module directives */</span>
</span></span><span style="display:flex;"><span>  NGX_CORE_MODULE,                       <span style="color:#888;font-style:italic">/* module type */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init master */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init module */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init process */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init thread */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* exit thread */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* exit process */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* exit master */</span>
</span></span><span style="display:flex;"><span>  NGX_MODULE_V1_PADDING
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>可以看到其对应的context是ngx_core_module_t类型的指针，首先会调用ngx_core_module_create_conf函数创建这个模块对应的配置数据，这个数据结构就是ngx_core_conf_t，因此在ngx_init_cycle函数中，首先解析core类型模块时，会调用create_conf函数指针创建该模块的上下文数据并且保存下来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">ngx_cycle_t</span> *
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">ngx_init_cycle</span>(<span style="font-weight:bold;text-decoration:underline">ngx_cycle_t</span> *old_cycle)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold;text-decoration:underline">for</span> (i = 0; cycle-&gt;modules[i]; i++) {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold;text-decoration:underline">if</span> (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) {
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold;text-decoration:underline">continue</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		module = cycle-&gt;modules[i]-&gt;ctx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold;text-decoration:underline">if</span> (module-&gt;create_conf) {
</span></span><span style="display:flex;"><span>			rv = module-&gt;<span style="color:#666;font-weight:bold;font-style:italic">create_conf</span>(cycle);
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold;text-decoration:underline">if</span> (rv == <span style="font-weight:bold;font-style:italic">NULL</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#666;font-weight:bold;font-style:italic">ngx_destroy_pool</span>(pool);
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold;text-decoration:underline">return</span> <span style="font-weight:bold;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index] = rv;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到，cycle-&gt;conf_ctx数组存储的关于core模块的context数据，就是前面ngx_core_module_create_conf函数返回的ngx_core_conf_t结构体。</p>
<p>接着进入core模块中配置命令的解析。当解析到daemon命令时，因为这个命令的类型是NGX_DIRECT_CONF，因此在ngx_conf_handler函数中，其对应的获取配置存储位置的代码是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">if</span> (cmd-&gt;type &amp; NGX_DIRECT_CONF) {
</span></span><span style="display:flex;"><span>	conf = ((<span style="font-weight:bold;text-decoration:underline">void</span> **) cf-&gt;ctx)[ngx_modules[i]-&gt;index];
</span></span></code></pre></div><p>这里取出来的conf指针，就是core模块最开始创建的ngx_core_conf_t结构体指针。</p>
<p>而daemon指令的ngx_command_t是这样的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>{ <span style="color:#666;font-weight:bold;font-style:italic">ngx_string</span>(<span style="color:#666;font-style:italic">&#34;daemon&#34;</span>),
</span></span><span style="display:flex;"><span>	NGX_MAIN_CONF|NGX_DIRECT_CONF|NGX_CONF_FLAG,
</span></span><span style="display:flex;"><span>	ngx_conf_set_flag_slot,
</span></span><span style="display:flex;"><span>	0,
</span></span><span style="display:flex;"><span>	<span style="color:#666;font-weight:bold;font-style:italic">offsetof</span>(<span style="font-weight:bold;text-decoration:underline">ngx_core_conf_t</span>, daemon),
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold;font-style:italic">NULL</span> }
</span></span></code></pre></div><p>这说明：</p>
<ol>
<li>daemon指令对应的set函数是ngx_conf_set_flag_slot。</li>
<li>该指令修改的数据，在ngx_core_conf_t结构体的daemon成员，即用offsetof(ngx_core_conf_t, daemon)来表示这个数据在该结构体中的偏移量。</li>
</ol>
<p>把以上的分析总结下来就是下图所示的结构：</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="core-daemon" src="/media/imgs/20190103-nginx-config-parse/core-daemon.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> core-daemon </figcaption>
    </div>
    
</figure>
</p>
<h2 class="heading" id="解析ngx_main_conf类型指令的例子">
  解析NGX_MAIN_CONF类型指令的例子
  <a class="anchor" href="#%e8%a7%a3%e6%9e%90ngx_main_conf%e7%b1%bb%e5%9e%8b%e6%8c%87%e4%bb%a4%e7%9a%84%e4%be%8b%e5%ad%90">#</a>
</h2>
<p>以event命令为例，来说明NGX_MAIN_CONF类型指令的解析。</p>
<p>event命令对应的模块相关结构体如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_command_t</span>  ngx_events_commands[] = {
</span></span><span style="display:flex;"><span>  { <span style="color:#666;font-weight:bold;font-style:italic">ngx_string</span>(<span style="color:#666;font-style:italic">&#34;events&#34;</span>),
</span></span><span style="display:flex;"><span>    NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,
</span></span><span style="display:flex;"><span>    ngx_events_block,
</span></span><span style="display:flex;"><span>    0,
</span></span><span style="display:flex;"><span>    0,
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">NULL</span> },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ngx_null_command
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_core_module_t</span>  ngx_events_module_ctx = {
</span></span><span style="display:flex;"><span>  <span style="color:#666;font-weight:bold;font-style:italic">ngx_string</span>(<span style="color:#666;font-style:italic">&#34;events&#34;</span>),
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>  ngx_event_init_conf
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">ngx_module_t</span>  ngx_events_module = {
</span></span><span style="display:flex;"><span>  NGX_MODULE_V1,
</span></span><span style="display:flex;"><span>  &amp;ngx_events_module_ctx,                <span style="color:#888;font-style:italic">/* module context */</span>
</span></span><span style="display:flex;"><span>  ngx_events_commands,                   <span style="color:#888;font-style:italic">/* module directives */</span>
</span></span><span style="display:flex;"><span>  NGX_CORE_MODULE,                       <span style="color:#888;font-style:italic">/* module type */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init master */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init module */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init process */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* init thread */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* exit thread */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* exit process */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                  <span style="color:#888;font-style:italic">/* exit master */</span>
</span></span><span style="display:flex;"><span>  NGX_MODULE_V1_PADDING
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>可以看到，该模块对应的create_conf函数为NULL，而其取配置的存储位置是取其指针：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">if</span> (cmd-&gt;type &amp; NGX_MAIN_CONF) {
</span></span><span style="display:flex;"><span>	conf = &amp;(((<span style="font-weight:bold;text-decoration:underline">void</span> **) cf-&gt;ctx)[ngx_modules[i]-&gt;index];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在event命令的回调set函数ngx_events_block，就将event模块对应的ctx存入进来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">char</span> *
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">ngx_events_block</span>(<span style="font-weight:bold;text-decoration:underline">ngx_conf_t</span> *cf, <span style="font-weight:bold;text-decoration:underline">ngx_command_t</span> *cmd, <span style="font-weight:bold;text-decoration:underline">void</span> *conf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold;text-decoration:underline">if</span> (*(<span style="font-weight:bold;text-decoration:underline">void</span> **) conf) {
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold;text-decoration:underline">return</span> <span style="color:#666;font-style:italic">&#34;is duplicate&#34;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#888;font-style:italic">/* count the number of the event modules and set up their indices */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ngx_event_max_module = <span style="color:#666;font-weight:bold;font-style:italic">ngx_count_modules</span>(cf-&gt;cycle, NGX_EVENT_MODULE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ctx = <span style="color:#666;font-weight:bold;font-style:italic">ngx_pcalloc</span>(cf-&gt;pool, <span style="font-weight:bold;text-decoration:underline">sizeof</span>(<span style="font-weight:bold;text-decoration:underline">void</span> *));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	*ctx = <span style="color:#666;font-weight:bold;font-style:italic">ngx_pcalloc</span>(cf-&gt;pool, ngx_event_max_module * <span style="font-weight:bold;text-decoration:underline">sizeof</span>(<span style="font-weight:bold;text-decoration:underline">void</span> *));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	*(<span style="font-weight:bold;text-decoration:underline">void</span> **) conf = ctx; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>该函数的主要工作是：</p>
<ol>
<li>既然前面conf = &amp;(((void **) cf-&gt;ctx)[ngx_modules[i]-&gt;index]传入了模块ctx的指针，所以首先判断该指针存放值是否为空，不为空意味着前面已经解析过event命令了，因此这是一个重复配置，将报错退出。</li>
<li>ctx初始化为一个void<em>型数据的指针，而该指针保存的是一个有ngx_event_max_module个void</em>型数据的数组。</li>
<li>最后将ctx写入传入的event模块配置context中。</li>
</ol>
<p>同样的，将以上分析event模块的流程总结下来，形成的就是下面的数据结构图：












<figure class="">

    <div>
        <img loading="lazy" alt="event-module" src="/media/imgs/20190103-nginx-config-parse/event-module.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> event-module </figcaption>
    </div>
    
</figure>
</p>
<p>可以看到event模块的context最终是一个存储void*数据的指针。原因在于：event模块中又会存储一些不同的数据类型，这些数据最终都保存在这个数组中。</p>
<p>不仅是event模块是这样，http模块的上下文结构存储的也是一个数组，都是因为这些模块都还有从属于它们的子模块。</p>
<h2 class="heading" id="解析其它类型指令的例子">
  解析其它类型指令的例子
  <a class="anchor" href="#%e8%a7%a3%e6%9e%90%e5%85%b6%e5%ae%83%e7%b1%bb%e5%9e%8b%e6%8c%87%e4%bb%a4%e7%9a%84%e4%be%8b%e5%ad%90">#</a>
</h2>
<p>有了以上的准备，最后来讲解最后一种类型指令的解析，这种类型既不是NGX_DIRECT_CONF类型，也不是NGX_MAIN_CONF类型，因为这类型指令属于从属于某个NGX_CORE_MODULE内部的配置命令，如epoll模块，下面就以这个模块做为例子来分析。</p>
<p>而这个类型是这样来读取配置项存储位置的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>confp = *(<span style="font-weight:bold;text-decoration:underline">void</span> **) ((<span style="font-weight:bold;text-decoration:underline">char</span> *) cf-&gt;ctx + cmd-&gt;conf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">if</span> (confp) {
</span></span><span style="display:flex;"><span>  conf = confp[ngx_modules[i]-&gt;ctx_index];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>说明一下上面的代码：</p>
<ol>
<li>首先使用confp = *(void **) ((char *) cf-&gt;ctx + cmd-&gt;conf);取到该模块的配置，注意这里取的并不是指针而是指针存储的数据位置，以event模块来说，就是前面在ngx_events_block函数中创建的数组。另外需要注意的是，这里是使用cmd-&gt;conf做为该数组的索引，ngx_command_t的conf成员就是存储某一个子模块（这里是epoll模块）在所属模块（这里是event模块，epoll模块从属于event模块）配置数组中的索引的。</li>
<li>接下来，根据模块的ctx_index索引在该数组中找到该模块真正的存储位置。</li>
</ol>
<p>以该模块的epoll_events命令为例，其与配置解析相关的数据如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_command_t</span>  ngx_epoll_commands[] = {
</span></span><span style="display:flex;"><span>  { <span style="color:#666;font-weight:bold;font-style:italic">ngx_string</span>(<span style="color:#666;font-style:italic">&#34;epoll_events&#34;</span>),
</span></span><span style="display:flex;"><span>    NGX_EVENT_CONF|NGX_CONF_TAKE1,
</span></span><span style="display:flex;"><span>    ngx_conf_set_num_slot,
</span></span><span style="display:flex;"><span>    0,
</span></span><span style="display:flex;"><span>    <span style="color:#666;font-weight:bold;font-style:italic">offsetof</span>(<span style="font-weight:bold;text-decoration:underline">ngx_epoll_conf_t</span>, events),
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">NULL</span> },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">static</span> <span style="font-weight:bold;text-decoration:underline">ngx_event_module_t</span>  ngx_epoll_module_ctx = {
</span></span><span style="display:flex;"><span>  &amp;epoll_name,
</span></span><span style="display:flex;"><span>  ngx_epoll_create_conf,               <span style="color:#888;font-style:italic">/* create configuration */</span>
</span></span><span style="display:flex;"><span>  ngx_epoll_init_conf,                 <span style="color:#888;font-style:italic">/* init configuration */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">ngx_module_t</span>  ngx_epoll_module = {
</span></span><span style="display:flex;"><span>  NGX_MODULE_V1,
</span></span><span style="display:flex;"><span>  &amp;ngx_epoll_module_ctx,               <span style="color:#888;font-style:italic">/* module context */</span>
</span></span><span style="display:flex;"><span>  ngx_epoll_commands,                  <span style="color:#888;font-style:italic">/* module directives */</span>
</span></span><span style="display:flex;"><span>  NGX_EVENT_MODULE,                    <span style="color:#888;font-style:italic">/* module type */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* init master */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* init module */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* init process */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* init thread */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* exit thread */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* exit process */</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">NULL</span>,                                <span style="color:#888;font-style:italic">/* exit master */</span>
</span></span><span style="display:flex;"><span>  NGX_MODULE_V1_PADDING
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>从以上结构体可以看出：</p>
<ol>
<li>create_conf回调函数是ngx_epoll_create_conf，该函数创建了ngx_epoll_conf_t类型的结构存储起来，这个类型就是epoll模块的context数据。该数据最终就是存储到event模块数组中，其索引是ctx_index。</li>
<li>epoll_events命令通过offsetof(ngx_epoll_conf_t, events)来做为ngx_epoll_conf_t类型中的偏移量来修改该类型中的成员，对应的修改函数是ngx_conf_set_num_slot。</li>
</ol>
<p>同样的，将以上分析epoll模块的流程总结下来，形成的就是下面的数据结构图：












<figure class="">

    <div>
        <img loading="lazy" alt="epoll-module-struct" src="/media/imgs/20190103-nginx-config-parse/epoll-module-struct.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> epoll-module-struct </figcaption>
    </div>
    
</figure>
</p>
<p>而在最顶层，开始从NGX_CORE_MODULE类型模块进行解析的解析配置入口函数则是core/ngx_cycle.c中的ngx_init_cycle函数，其做的事情最核心的就是初始化ngx_conf_t结构体，将module_type设置为最顶层的模块NGX_CORE_MODULE，cmd_type设置为NGX_MAIN_CONF，接着就调用ngx_conf_parse函数进行配置解析了，这就开启了整个解析Nginx配置的流程。</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="config-parse" src="/media/imgs/20190103-nginx-config-parse/config-parse.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> config-parse </figcaption>
    </div>
    
</figure>
</p>
<p>从上图中可以看到：</p>
<ol>
<li>在解析配置的入口函数ngx_init_cycle中，将ngx_conf_t的module_type类型初始化为NGX_CORE_MODULE，而cmd_type初始化为NGX_MAIN_CONF，这就是解析配置的起点。在接下来对ngx_conf_parse函数的调用中，该函数就会查找module_type和cmd_type都对应的模块，比如event、http这样的模块。</li>
<li>解析到event命令时，进入event模块的解析，此时就会将module_type变成NGX_EVENT_MODULE，以及把cmd_type变为NGX_EVENT_CONF
，这样再调用ngx_conf_parse函数时就只会查询event模块的配置命令了。</li>
<li>http模块的解析过程类似，不再阐述。</li>
</ol>
<p>所有的模块信息，保存在ngx_cycle_t结构体的conf_ctx中，从类型来看是一个void****的四级指针，如果解析到的模块又有自己内部的子模块ctx数据，那么就会继续存放到这个模块之中，比如epoll模块就是event模块的子模块。总体来看结构图如下：</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="ngx-conf-chart" src="/media/imgs/20190103-nginx-config-parse/ngx-conf-chart.png" >
    </div>

    
    <div class="caption-container">
        <figcaption> ngx-conf-chart </figcaption>
    </div>
    
</figure>
</p>
<h1 class="heading" id="参考资料">
  参考资料
  <a class="anchor" href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99">#</a>
</h1>
<ul>
<li><a href="https://ialloc.org/blog/ngx-notes-conf-parsing/">Nginx 源代码笔记 - 配置文件解析</a></li>
</ul>

    
    
    <script src="https://giscus.app/client.js"
        data-repo="lichuang/lichuang.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNDk2MzEzMjU="
        data-category=""
        data-category-id="DIC_kwDOCOsxXc4Crotc"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

    
    
  </div>

  

  

  

  

  

</div>


    </main>
  </div>

  <footer>
    <div class="footer-social-icons">

    <a href="https://github.com/lichuang" target="_blank"
        rel="noopener noreferrer me"
        class="me-2"
        title="Github">
        <svg role="img" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
    </a>
    <a href="https://x.com/lichuang" target="_blank"
        rel="noopener noreferrer me"
        class="me-2"
        title="Twitter">
        <svg role="img" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="m 20.808145,8.2320672 c 0.0097,0.2043875 0.0097,0.418508 0.0097,0.632628 0,6.2873468 -4.788505,13.5285018 -13.5285014,13.5285018 v 0 c -2.5791818,0 -5.1096931,-0.759154 -7.28982572375,-2.141201 0.37957667375,0.04867 0.75915336375,0.06813 1.12899732375,0.06813 2.1412017,0 4.224007,-0.720223 5.9077703,-2.043875 -2.0341418,0 -3.8152323,-1.362583 -4.4381274,-3.30913 0.7104897,0.136259 1.4501775,0.10706 2.1412018,-0.08759 -2.209331,-0.447712 -3.80549947,-2.384527 -3.80549947,-4.632788 v -0.0584 C 1.5957264,10.558191 2.3354143,10.782044 3.0945676,10.811242 1.206417,8.1542054 0.63218569,4.971601 2.4035435,2.4800207 c 2.4039856,2.9684842 5.9661667,4.7787731 9.7911305,4.9734277 -0.379576,-1.654565 0.136259,-3.3869919 1.372317,-4.5451873 1.927081,-1.8102888 4.953962,-1.7226943 6.754518,0.2043873 1.0706,-0.2141202 2.092538,-0.6131622 3.036613,-1.1581954 -0.360111,1.1095318 -1.109532,2.0536071 -2.102271,2.6570367 0.953808,-0.1167928 1.868685,-0.369844 2.744631,-0.7786188 -0.64236,0.9635408 -1.450177,1.8005561 -2.38452,2.4818475 z"/></svg>
    </a>
    <a href="https://www.douban.com/people/Lichuang" target="_blank"
        rel="noopener noreferrer me"
        class="me-2"
        title="Douban">
        <svg role="img" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Douban</title><path d="M.51 3.06h22.98V.755H.51V3.06Zm20.976 2.537v9.608h-2.137l-1.669 5.76H24v2.28H0v-2.28h6.32l-1.67-5.76H2.515V5.597h18.972Zm-5.066 9.608H7.58l1.67 5.76h5.501l1.67-5.76ZM18.367 7.9H5.634v5.025h12.733V7.9Z"/></svg>
    </a>
    <a href="t.me/codedump_notes" target="_blank"
        rel="noopener noreferrer me"
        class="me-2"
        title="Telegram">
        <svg role="img" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Telegram</title><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
    </a>







<div class="text-center">
    <p class="text-sm text-tertiary-text"> @2018 codedump <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="noopener noreferrer" target="_blank">CC BY-SA</a>Powered by<a href="https://gohugo.io/">Hugo</a>and<a href="https://github.com/tomfran/typo">typo</a>

</div>

</div>

  </footer>

  
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
<script defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>

<script defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body);"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false }
      ]
    });
  });
</script>
  

</body>

<script src="/js/theme-switch.js"></script>
<script defer src="/js/copy-code.js"></script>
</html>
