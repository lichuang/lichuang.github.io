<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="Nginxæºç é˜…è¯»ç¬”è®°-æŸ¥è¯¢HTTPé…ç½®æµç¨‹">




<meta name="keywords" content=" Nginx  HTTP ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Nginxæºç é˜…è¯»ç¬”è®°-æŸ¥è¯¢HTTPé…ç½®æµç¨‹" />
<meta name="twitter:description" content="æ¦‚è¿° å‰é¢å·²ç»åˆ†æè¿‡nginxè§£æé…ç½®æ–‡ä»¶çš„æ•´ä½“æµç¨‹ï¼Œæ¥ä¸‹æ¥çœ‹æŸ¥è¯¢HTTPé…ç½®çš„æµç¨‹ã€‚ HTTPå±äºnginxçš„coreé¡¶å±‚æ¨¡å—ï¼Œä¸‹é¢åˆåŒ…æ‹¬äº†ä¸‰" />


<link rel="canonical" href="https://www.codedump.info/post/20190212-nginx-http-config/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>Nginxæºç é˜…è¯»ç¬”è®°-æŸ¥è¯¢HTTPé…ç½®æµç¨‹ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>Nginxæºç é˜…è¯»ç¬”è®°-æŸ¥è¯¢HTTPé…ç½®æµç¨‹</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/nginx'>#nginx</a>
        
      </div>
      
      <div class="content">
        

<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>å‰é¢å·²ç»åˆ†æè¿‡<a href="https://www.codedump.info/post/20190103-nginx-config-parse/#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">nginxè§£æé…ç½®æ–‡ä»¶çš„æ•´ä½“æµç¨‹</a>ï¼Œæ¥ä¸‹æ¥çœ‹æŸ¥è¯¢HTTPé…ç½®çš„æµç¨‹ã€‚</p>

<p>HTTPå±äºnginxçš„coreé¡¶å±‚æ¨¡å—ï¼Œä¸‹é¢åˆåŒ…æ‹¬äº†ä¸‰éƒ¨åˆ†ï¼š</p>

<ul>
<li>mainéƒ¨åˆ†é…ç½®ï¼šå³åœ¨HTTPå—ä½†æ˜¯åˆä¸åœ¨ä»»ä½•serverã€locationå—ä¸­çš„é…ç½®ï¼Œå¦‚ä¸‹å›¾ä¸­çš„sendfileé…ç½®æŒ‡ä»¤ã€‚</li>
<li>serverå—ï¼šåœ¨serverå—å†…éƒ¨çš„é…ç½®ã€‚</li>
<li>locationå—ï¼šåœ¨locationå—å†…éƒ¨åˆ†é…ç½®ã€‚</li>
</ul>

<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190212-nginx-http-config/http_config.jpg" alt="http_config" title="http_config" /></p>

<p>è§£æHTTPæ¨¡å—çš„å…¥å£å‡½æ•°æ˜¯ngx_http_blockï¼Œè¿™ä¸€ç‚¹å¯ä»¥ä»httpæŒ‡ä»¤ç›¸å…³çš„é…ç½®çœ‹å‡ºï¼š</p>

<pre><code class="language-C">{ ngx_string(&quot;http),
  NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,
  ngx_http_block,
  0,
  0,
  NULL }
</code></pre>

<p>åœ¨è¿™ä¸ªè§£æå‡½æ•°çš„å¼€å§‹ï¼Œå°±åˆ›å»ºäº†ngx_http_conf_ctx_tç»“æ„ä½“ï¼Œæ‰€ä»¥çœ‹çš„å‡ºæ¥è¿™ä¸ªç»“æ„ä½“æ˜¯HTTPæ¨¡å—çš„ç¬¬ä¸€çº§é…ç½®ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">typedef struct {
  void        **main_conf;
  void        **srv_conf;
  void        **loc_conf;
} ngx_http_conf_ctx_t;
</code></pre>

<p>ä¸‹é¢åˆ—ä¸¾å‡ºæ¥è¿™å‡ éƒ¨åˆ†ç›¸å…³çš„å‡½æ•°ä»¥åŠæ•°æ®ç»“æ„ï¼š</p>

<table>
<thead>
<tr>
<th>å—</th>
<th>å…¥å£å‡½æ•°</th>
<th>æ•°æ®ç»“æ„</th>
</tr>
</thead>

<tbody>
<tr>
<td>http</td>
<td>ngx_http_block</td>
<td>ngx_http_conf_ctx_t</td>
</tr>

<tr>
<td>main</td>
<td></td>
<td>ngx_http_core_main_conf_t</td>
</tr>

<tr>
<td>server</td>
<td>ngx_http_core_server</td>
<td>ngx_http_core_srv_conf_t</td>
</tr>

<tr>
<td>location</td>
<td>ngx_http_core_location</td>
<td>ngx_http_core_loc_conf_t</td>
</tr>
</tbody>
</table>

<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190212-nginx-http-config/ngx_http_module.png" alt="ngx_http_module" title="ngx_http_module" /></p>

<p>å¦å¤–ï¼Œç”±äºHTTPå—å†…çš„ä¸€äº›é…ç½®ï¼Œä½œç”¨åŸŸå¯ä»¥åœ¨å¤šç§å—ä¸­ï¼Œå› æ­¤éœ€è¦æ¶‰åŠåˆ°åˆå¹¶é…ç½®çš„æµç¨‹ï¼Œå³ï¼š</p>

<ul>
<li>å¦‚æœå­ä½œç”¨åŸŸæŸé…ç½®é¡¹åœ¨è§£æè¿‡ç¨‹ä¸­æœªè¢«èµ‹å€¼ï¼Œåˆ™å°†çˆ¶ä½œç”¨åŸŸçš„ ç›¸åŒçš„é…ç½®é¡¹å€¼æ‹·è´è‡³æ­¤é…ç½®é¡¹é‡Œï¼›</li>
<li>å¦‚æœå­ä½œç”¨åŸŸé…ç½®é¡¹åœ¨è§£æè¿‡ç¨‹ä¸­è¢«èµ‹å€¼äº†ï¼Œåˆ™ä¿ç•™åŸ æ ·ï¼›å¦‚æœå­ä½œç”¨åŸŸé…ç½®é¡¹å’Œçˆ¶ä½œç”¨åŸŸé…ç½®é¡¹éƒ½æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™å¡«å…¥ä»£ç ä¸­é¢„è®¾çš„é»˜è®¤å€¼ã€‚</li>
</ul>

<p>ç›¸å…³çš„åˆå¹¶é…ç½®å‡½æ•°åˆ—ä¸¾å¦‚ä¸‹ï¼š</p>

<table>
<thead>
<tr>
<th>å—</th>
<th>åˆå¹¶å‡½æ•°</th>
</tr>
</thead>

<tbody>
<tr>
<td>server</td>
<td>ngx_http_merge_servers</td>
</tr>

<tr>
<td>location</td>
<td>ngx_http_merge_locations</td>
</tr>
</tbody>
</table>

<p>ä»¥ä¸‹å…·ä½“çœ‹çœ‹ä¸€æ¬¡HTTPè¯·æ±‚å¦‚ä½•æŸ¥æ‰¾åˆ°ç›¸å…³HTTPé…ç½®çš„æµç¨‹ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼š</p>

<ul>
<li>æ ¹æ®HostæŸ¥æ‰¾serverå—</li>
<li>æ ¹æ®URIæŸ¥æ‰¾locationå—</li>
</ul>

<h1 id="æ ¹æ®hostæŸ¥æ‰¾serverå—æµç¨‹">æ ¹æ®HostæŸ¥æ‰¾serverå—æµç¨‹</h1>

<p>å‰é¢åˆ†æ<a href="https://www.codedump.info/post/20190131-nginx-read-http-request/">nginxæ¥æ”¶HTTPè¯·æ±‚æµç¨‹</a>ä¸­åˆ†æåˆ°ï¼Œnginxåœ¨æ¥æ”¶HTTPè¯·æ±‚æµç¨‹ä¸­ï¼Œå°†è°ƒç”¨ngx_http_process_request_headerså‡½æ•°æ¥å¤„ç†è¯·æ±‚å¤´ã€‚</p>

<p>nginxä½¿ç”¨ä¸€ä¸ªngx_http_header_tç»“æ„ä½“ï¼Œå®šä¹‰äº†å“ªäº›è¯·æ±‚å¤´éœ€è¦è¿›è¡Œç‰¹å®šçš„å‡½æ•°å›è°ƒå¤„ç†ï¼Œå‡½æ•°ngx_http_process_request_headersä¼šæ ¹æ®è¿™ä¸ªè¡¨æ¥æŸ¥è¯¢æ¥æ”¶åˆ°çš„è¯·æ±‚å¤´éƒ½éœ€è¦å“ªäº›å›è°ƒå‡½æ•°æ¥å¤„ç†ï¼š</p>

<pre><code class="language-C">ngx_http_header_t  ngx_http_headers_in[] = {
  { ngx_string(&quot;Host&quot;), offsetof(ngx_http_headers_in_t, host),
    ngx_http_process_host },

  { ngx_string(&quot;Connection&quot;), offsetof(ngx_http_headers_in_t, connection),
    ngx_http_process_connection },
  ....
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œé’ˆå¯¹Hostè¿™ä¸ªheaderï¼Œä¼šè°ƒç”¨ngx_http_process_hostå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ngx_http_set_virtual_serverå‡½æ•°æ¥æ ¹æ®Hostå¤´ç¡®å®šå¯¹åº”çš„serverå—ã€‚</p>

<p>nginxä¸­ï¼Œä¸åŒçš„serverå—å¯ä»¥ç›‘å¬åŒä¸€ä¸ªåœ°å€ç«¯å£ï¼Œåªè¦å¯¹åº”çš„server_nameä¸ä¸€æ ·å°±å¯ä»¥äº†ã€‚</p>

<p>è€Œç›¸åŒçš„åœ°å€ç«¯å£ï¼Œåœ¨nginxä¸­å¯¹åº”çš„æ˜¯ngx_http_addr_conf_tï¼Œå†…éƒ¨å°†åŒæ ·åœ°å€ç«¯å£çš„å¤šä¸ªä¸åŒserver_nameå†ç»„ç»‡åˆ°ä¸€èµ·æ¥ï¼š</p>

<pre><code class="language-C">typedef struct {
  ngx_hash_combined_t        names;

  ngx_uint_t                 nregex;
  ngx_http_server_name_t    *regex;
} ngx_http_virtual_names_t;

struct ngx_http_addr_conf_s {
  /* the default server configuration for this address:port */
  ngx_http_core_srv_conf_t  *default_server;

  ngx_http_virtual_names_t  *virtual_names;

  unsigned                   ssl:1;
  unsigned                   http2:1;
  unsigned                   proxy_protocol:1;
};
</code></pre>

<p>æ˜¾ç„¶ï¼Œå¦‚æœç›¸åŒåœ°å€ç«¯å£çš„serverå¦‚æœä½¿ç”¨é“¾è¡¨ç»„ç»‡åœ¨ä¸€èµ·ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯çº¿æ€§æ—¶é—´çš„æŸ¥æ‰¾å¤æ‚åº¦ï¼Œè¿™å°±å¤ªæ…¢äº†ã€‚å› æ­¤nginxå®šä¹‰äº†ngx_hash_combined_tè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå°†ç›¸åŒåœ°å€ç«¯å£çš„server_nameç»„ç»‡åˆ°ä¸€èµ·æ¥ï¼š</p>

<pre><code class="language-C">typedef struct {
  ngx_hash_t            hash;
  ngx_hash_wildcard_t  *wc_head;
  ngx_hash_wildcard_t  *wc_tail;
} ngx_hash_combined_t;
</code></pre>

<p>è¯¥ç»“æ„ä½“ä¸­æœ‰ä¸‰ä¸ªæˆå‘˜ï¼ŒåŒºåˆ†ä¸åŒçš„server_nameæ ¼å¼ï¼š</p>

<ul>
<li>ngx_hash_t hashï¼šç²¾ç¡®åŒ¹é…çš„å“ˆå¸Œè¡¨ï¼Œç”¨äºå­˜å‚¨æ²¡æœ‰ä½¿ç”¨é€šé…ç¬¦çš„è™šæ‹Ÿä¸»æœºåï¼Œå¦‚â€www.example.comâ€œã€‚</li>
<li>ngx_hash_wildcard_t  <em>wc_headï¼šå‰ç½®é€šé…ç¬¦å“ˆå¸Œè¡¨ï¼Œç”¨äºå­˜å‚¨å¦‚â€</em>.example.orgâ€œå’Œâ€.example.orgâ€œè¿™æ ·çš„å‰ç½®é€šé…ç¬¦è™šæ‹Ÿä¸»æœºåã€‚</li>
<li>ngx_hash_wildcard_t  *wc_tailï¼šåç½®é€šé…ç¬¦å“ˆå¸Œè¡¨ï¼Œç”¨äºå­˜å‚¨å¦‚â€example.*â€œè¿™æ ·çš„åç½®é€šé…ç¬¦è™šæ‹Ÿä¸»æœºåã€‚</li>
</ul>

<p>å…·ä½“è¿™ä¸ªæ”¯æŒé€šé…ç¬¦çš„hashè¡¨ï¼Œä¸åœ¨è¿™é‡Œè®²è§£ï¼Œåªè°ˆhostçš„æŸ¥æ‰¾é¡ºåºï¼š</p>

<ul>
<li>é¦–å…ˆæŸ¥æ‰¾ç²¾ç¡®åŒ¹é…hashè¡¨ï¼ŒæŸ¥æ‰¾åˆ°åˆ™è¿”å›ï¼›</li>
<li>æ¥ç€æŸ¥æ‰¾å‰ç½®é€šé…ç¬¦hashè¡¨ï¼ŒæŸ¥æ‰¾åˆ°åˆ™è¿”å›ï¼›</li>
<li>æœ€åæŸ¥æ‰¾åç½®é€šé…ç¬¦hashè¡¨ï¼ŒæŸ¥æ‰¾åˆ°åˆ™è¿”å›ï¼›</li>
<li>å¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œè½åˆ°default_serverçš„serverå—è¿›è¡Œå¤„ç†ã€‚</li>
</ul>

<h1 id="æ ¹æ®uriæŸ¥æ‰¾locationå—æµç¨‹">æ ¹æ®URIæŸ¥æ‰¾locationå—æµç¨‹</h1>

<p>æ ¹æ®HostæŸ¥æ‰¾åˆ°äº†serverå—ï¼Œç´§è·Ÿç€å°±æ˜¯æ ¹æ®URIæ¥æŸ¥æ‰¾locationå—äº†ã€‚</p>

<p>locationåŒºåˆ†å‡ ç§æ ¼å¼ï¼š</p>

<pre><code class="language-C">location = / {
    [ configuration A ]
}

location / {
    [ configuration B ]
}

location /documents/ {
    [ configuration C ]
}

location ^~ /images/ {
    [ configuration D ]
}

location ~* \.(gif|jpg|jpeg)$ {
    [ configuration E ]
}

</code></pre>

<p>åœ¨ä¸Šé¢çš„é…ç½®ä¾‹å­ä¸­ï¼š</p>

<ul>
<li>é…ç½®Aï¼šç²¾ç¡®åŒ¹é…&rdquo;/&rdquo; URIï¼Œä¸»æœºååé¢ä¸èƒ½å¸¦ä»»ä½•å­—ç¬¦ä¸²ã€‚</li>
<li>é…ç½®Bï¼šå› ä¸ºæ‰€æœ‰çš„åœ°å€éƒ½ä»¥ / å¼€å¤´ï¼Œæ‰€ä»¥è¿™æ¡è§„åˆ™å°†åŒ¹é…åˆ°æ‰€æœ‰è¯·æ±‚ï¼Œä½†æ˜¯æ­£åˆ™å’Œæœ€é•¿å­—ç¬¦ä¸²ä¼šä¼˜å…ˆåŒ¹é…ã€‚</li>
<li>é…ç½®Cï¼šåŒ¹é…ä»»ä½•ä»¥ /documents/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œè¿˜è¦ç»§ç»­å¾€ä¸‹æœç´¢ï¼Œåªæœ‰åé¢çš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œè¿™ä¸€æ¡æ‰ä¼šé‡‡ç”¨è¿™ä¸€æ¡ã€‚</li>
<li>é…ç½®Dï¼šåŒ¹é…ä»»ä½•ä»¥ /images/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œåœæ­¢å¾€ä¸‹æœç´¢æ­£åˆ™ï¼Œé‡‡ç”¨è¿™ä¸€æ¡ã€‚</li>
<li>é…ç½®Eï¼šåŒ¹é…æ‰€æœ‰ä»¥ gif,jpgæˆ–jpeg ç»“å°¾çš„è¯·æ±‚ï¼Œç„¶è€Œï¼Œæ‰€æœ‰è¯·æ±‚ /images/ ä¸‹çš„å›¾ç‰‡ä¼šè¢« config D å¤„ç†ï¼Œå› ä¸º ^~ åˆ°è¾¾ä¸äº†è¿™ä¸€æ¡æ­£åˆ™ã€‚</li>
</ul>

<p>å…·ä½“æ ¹æ®URIåŒ¹é…locationçš„æµç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
<li>é¦–å…ˆå…ˆæ£€æŸ¥ä½¿ç”¨å‰ç¼€å­—ç¬¦å®šä¹‰çš„locationï¼Œé€‰æ‹©æœ€é•¿åŒ¹é…çš„é¡¹å¹¶è®°å½•ä¸‹æ¥ï¼›</li>
<li>å¦‚æœæ‰¾åˆ°äº†ç²¾ç¡®åŒ¹é…çš„locationï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†=ä¿®é¥°ç¬¦çš„locationï¼Œç»“æŸæŸ¥æ‰¾ï¼Œä½¿ç”¨å®ƒçš„é…ç½®ã€‚</li>
<li>ç„¶åæŒ‰é¡ºåºæŸ¥æ‰¾ä½¿ç”¨æ­£åˆ™å®šä¹‰çš„locationï¼Œå¦‚æœåŒ¹é…åˆ™åœæ­¢æŸ¥æ‰¾ï¼Œä½¿ç”¨å®ƒå®šä¹‰çš„é…ç½®ã€‚</li>
<li>å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ­£åˆ™locationï¼Œåˆ™ä½¿ç”¨å‰é¢è®°å½•çš„æœ€é•¿åŒ¹é…å‰ç¼€å­—ç¬¦locationã€‚</li>
</ul>

<p>å¯ä»¥çœ‹åˆ°ï¼š</p>

<ul>
<li>ä¸åŒ…å«æ­£åˆ™çš„ location åœ¨é…ç½®æ–‡ä»¶ä¸­çš„é¡ºåºä¸ä¼šå½±å“åŒ¹é…é¡ºåºã€‚è€ŒåŒ…å«æ­£åˆ™è¡¨è¾¾å¼çš„ location ä¼šæŒ‰ç…§é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºè¿›è¡ŒåŒ¹é…ã€‚</li>
<li>è®¾ç½®ä¸ºç²¾ç¡®åŒ¹é… (with = prefix) çš„ location å¦‚æœåŒ¹é…è¯·æ±‚ URI çš„è¯ï¼Œæ­¤ location è¢«é©¬ä¸Šä½¿ç”¨ï¼ŒåŒ¹é…è¿‡ç¨‹ç»“æŸã€‚</li>
<li>åœ¨å…¶å®ƒåªåŒ…å«æ™®é€šå­—ç¬¦çš„ location ä¸­ï¼Œæ‰¾åˆ°å’Œè¯·æ±‚ URI æœ€é•¿çš„åŒ¹é…ã€‚å¦‚æœæ­¤ server {} æ²¡æœ‰åŒ…å«æ­£åˆ™çš„ location æˆ–è€…è¯¥ location å¯ç”¨äº† ^~ çš„è¯ï¼Œè¿™ä¸ªæœ€ é•¿åŒ¹é…çš„ location ä¼šè¢«ä½¿ç”¨ã€‚å¦‚æœæ­¤ server {} ä¸­åŒ…å«æ­£åˆ™çš„ locationï¼Œåˆ™å…ˆåœ¨ è¿™äº›æ­£åˆ™ location ä¸­è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…ï¼Œåˆ™ä½¿ç”¨åŒ¹é…çš„æ­£åˆ™ locationï¼Œå¦‚æœ æ²¡æ‰¾åˆ°åŒ¹é…ï¼Œä¾ç„¶ä½¿ç”¨æœ€å¤§åŒ¹é…çš„ locationã€‚</li>
</ul>

<p>æœ‰äº†ä»¥ä¸Šçš„å‡†å¤‡ï¼Œå¼€å§‹çœ‹å…·ä½“çš„ä»£ç å®ç°ã€‚</p>

<h2 id="ngx-http-core-loc-conf-sç»“æ„ä½“">ngx_http_core_loc_conf_sç»“æ„ä½“</h2>

<p>ngx_http_core_loc_conf_sç»“æ„ä½“å¯¹åº”ä¸€ä¸ªlocationå—çš„é…ç½®ï¼Œç›¸å…³çš„æˆå‘˜å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">struct ngx_http_core_loc_conf_s {
  ngx_str_t           name;   /* URI éƒ¨åˆ†å­—ç¬¦ä¸² */
  ngx_http_regex_t    *regex; /* æ­£åˆ™å¼•æ“ç¼–è¯‘è¿‡çš„ æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡ */
  ...
  unsigned            named:1;        /* @ ä¿®é¥°ç¬¦ */
  unsigned            noname:1;       /* if () {} */
  unsigned            exact_match:1;  /* = ä¿®é¥°ç¬¦ */
  unsigned            noregex:1;      /* ^= ä¿®é¥°ç¬¦ */

  ...
  ngx_http_location_tree_node_t   *static_location;
  ngx_http_core_loc_conf_t        **regex_location;
  void                **loc_conf;
  ...
  ngx_queue_t         *locations; /* è¿æ¥ `location` ä½œç”¨åŸŸï¼Œç”±
                                     ngx_http_location_queue_t å¼ºåˆ¶è½¬
                                     æ¢è€Œæ¥ */
};
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ngx_http_core_loc_conf_sä¸­ä½¿ç”¨äº†å‡ ä¸ªæˆå‘˜namedã€nonameã€exact_matchã€noregexåŒºåˆ†äº†ä»¥ä¸Šçš„æƒ…å†µã€‚</p>

<h2 id="ngx-http-location-queue-t">ngx_http_location_queue_t</h2>

<p>ç»“æ„ä½“ngx_http_location_queue_tç”¨äºä¸´æ—¶ä¿å­˜locationçš„é˜Ÿåˆ—ï¼š</p>

<pre><code class="language-C">typedef struct {
  ngx_queue_t                 queue;
  ngx_http_core_loc_conf_t    *exact; /* exact_match, regex, named, noname */
  ngx_http_core_loc_conf_t    *inclusive; /* é exact çš„ location */
  ngx_str_t                   *name;
} ngx_http_location_queue_t;
</code></pre>

<h2 id="ngx-http-location-tree-node-t">ngx_http_location_tree_node_t</h2>

<p>ngx_http_location_tree_node_tç»“æ„ä½“æ˜¯æœ€ç»ˆå­˜å‚¨locationçš„ç»“æ„ä½“ï¼Œå°†locationä»¥æ ‘çŠ¶ç»„ç»‡åœ¨ä¸€èµ·ï¼Œå®ç°locationçš„å¿«é€ŸæŸ¥æ‰¾ï¼š</p>

<pre><code class="language-C">struct ngx_http_location_tree_node_s {
  ngx_http_location_tree_node_t   *left;
  ngx_http_location_tree_node_t   *right;
  ngx_http_location_tree_node_t   *tree;

  ngx_http_core_loc_conf_t        *exact;     // ç²¾ç¡®åŒ¹é…çš„locationé…ç½®
  ngx_http_core_loc_conf_t        *inclusive; // inclusiveåŒ¹é…çš„locationé…ç½®

  u_char                          auto_redirect;
  u_char                          len;
  u_char                          name[1];
};
</code></pre>

<h2 id="æ„å»ºlocationæŸ¥æ‰¾æ ‘çš„æµç¨‹">æ„å»ºlocationæŸ¥æ‰¾æ ‘çš„æµç¨‹</h2>

<p>åœ¨å‡½æ•°ngx_http_blockä¸­ï¼ˆè¯¥å‡½æ•°å³HTTPå—çš„å…¥å£å‡½æ•°ï¼‰ï¼Œå°†è°ƒç”¨ä¸¤ä¸ªå‡½æ•°è¿›è¡Œlocationçš„åˆå§‹åŒ–ï¼š</p>

<ul>
<li>ngx_http_init_locationsï¼šç”¨äºå®Œæˆlocationçš„æ’åºä»¥åŠåˆ†ç±»å­˜æ”¾ã€‚</li>
<li>ngx_http_init_static_location_treesï¼šç”¨äºå°†exactä»¥åŠinclusiveç±»å‹çš„locationè¿›ä¸€æ­¥å¤„ç†ï¼Œæ„é€ å‡ºå¯ä»¥å¿«é€Ÿè®¿é—®çš„æ ‘çŠ¶ç»“æ„ã€‚</li>
</ul>

<h3 id="ngx-http-init-locations">ngx_http_init_locations</h3>

<ul>
<li>é¦–å…ˆè°ƒç”¨ngx_queue_sort(locations, ngx_http_cmp_locations)å‡½æ•°å¯¹locationé˜Ÿåˆ—è¿›è¡Œæ’åºï¼Œæ’åºçš„ç»“æœä¸ºï¼šexact(sorted) -&gt; inclusive(sorted) -&gt; regex -&gt; named -&gt; nonameï¼Œè¿™é‡Œè¯´æ˜ä¸€ä¸‹inclusiveï¼Œå®ƒè¡¨ç¤ºURIä¹‹é—´çš„åŒ…å«å…³ç³»ï¼Œå³â€/abc/aâ€œè¿™ä¸ªURIæ˜¯åŒ…å«â€/abcâ€œçš„ã€‚</li>
<li>éå†æ’åºè¿‡åçš„locationé˜Ÿåˆ—ï¼Œå°†å…¶ä¸­çš„nonameç±»å‹çš„locationåˆ†ç¦»å‡ºé˜Ÿåˆ—ã€‚</li>
<li>å°†namedç±»å‹çš„locationåˆ†ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°é…ç½®çš„named_locationsä¸­ã€‚</li>
<li>å°†å«æœ‰æ­£åˆ™çš„locationåˆ†ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°é…ç½®çš„regex_locationsä¸­ã€‚</li>
</ul>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä»¥ä¸Šæµç¨‹å®Œæˆä¹‹åï¼ŒåŸå…ˆçš„locationé˜Ÿåˆ—å°±åªå‰©ä¸‹exactä»¥åŠinclusiveç±»å‹çš„locationäº†ã€‚æ¥ç€è°ƒç”¨ngx_http_init_static_location_treeså‡½æ•°åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚</p>

<h3 id="ngx-http-init-static-location-trees">ngx_http_init_static_location_trees</h3>

<p>æœ‰ä»¥ä¸‹å‡ ä¸ªæµç¨‹ï¼š</p>

<ul>
<li>ngx_http_join_exact_locationsï¼šå°†å½“å‰è™šæ‹Ÿä¸»æœºä¸­ uri å­—ç¬¦ä¸²å®Œå…¨ä¸€è‡´çš„ exact å’Œ inclusive ç±»å‹çš„ location è¿›è¡Œåˆå¹¶ã€‚</li>
<li>ngx_http_create_locations_listï¼šå°†å‰ç¼€ä¸€è‡´çš„locationæ”¾åˆ°listé“¾è¡¨ä¸­ã€‚</li>
<li>ngx_http_create_locations_treeï¼šæ„é€ locationçš„æ ‘ç»“æ„ã€‚</li>
</ul>

<h4 id="ngx-http-create-locations-list">ngx_http_create_locations_list</h4>

<pre><code class="language-C">static void
ngx_http_create_locations_list(ngx_queue_t *locations, ngx_queue_t *q)
{
  u_char                     *name;
  size_t                      len;
  ngx_queue_t                *x, tail;
  ngx_http_location_queue_t  *lq, *lx;

  // ç”±äºæœ¬å‡½æ•°å­˜åœ¨é€’å½’è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ä¸ªåˆ¤æ–­æ˜¯é€’å½’çš„ç»ˆæ­¢æ¡ä»¶
  if (q == ngx_queue_last(locations)) {
    return;
  }

  lq = (ngx_http_location_queue_t *) q;

  if (lq-&gt;inclusive == NULL) {
    // å¦‚æœä¸æ˜¯inclusiveç±»å‹çš„locationï¼Œç›´æ¥è·³è¿‡ï¼Œç»§ç»­é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªlocationçš„å¤„ç†
    ngx_http_create_locations_list(locations, ngx_queue_next(q));
    return;
  }

  len = lq-&gt;name-&gt;len;
  name = lq-&gt;name-&gt;data;

  // ä»è¯¥locationçš„ä¸‹ä¸€ä¸ªå…ƒç´ å¼€å§‹éå†é˜Ÿåˆ—
  for (x = ngx_queue_next(q);
    x != ngx_queue_sentinel(locations);
    x = ngx_queue_next(x))
  {
    lx = (ngx_http_location_queue_t *) x;

    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸ä»¥qçš„locationåšä¸ºå‰ç¼€çš„locationå°±é€€å‡ºå¾ªç¯
    // æ¯”å¦‚å½“å‰é˜Ÿåˆ—locationä¸ºï¼š/a /ab /abc /b
    // è¿™é‡Œçš„qå°±æ˜¯/aï¼Œxå°±æ˜¯/bï¼Œä¸­é—´çš„/abå’Œ/abcéƒ½æ˜¯ä»¥/aä¸ºå‰ç¼€çš„ï¼Œä¸ä¼šç»ˆæ­¢å¾ªç¯
    if (len &gt; lx-&gt;name-&gt;len
      || ngx_filename_cmp(name, lx-&gt;name-&gt;data, len) != 0)
    {
      break;
    }
  }

  q = ngx_queue_next(q);

  if (q == x) { // å¦‚æœxå°±æ˜¯qçš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°å‰ç¼€åŒ¹é…çš„ï¼Œé‚£ä¹ˆç›´æ¥è¿›å…¥xè¿›è¡Œä¸‹æ¬¡é€’å½’è°ƒç”¨
    ngx_http_create_locations_list(locations, x);
    return;
  }

  // åˆ°äº†è¿™é‡Œè¯´æ˜å‰é¢æ‰¾åˆ°æœ‰å‰ç¼€åŒ¹é…çš„locationäº†

  // è¿™é‡Œå°†ä¸qç›¸åŒå‰ç¼€çš„èŠ‚ç‚¹ï¼Œåˆ†ç¦»å‡ºé˜Ÿåˆ—
  ngx_queue_split(locations, q, &amp;tail);
  // ç„¶ååŠ å…¥åˆ°qçš„listé“¾è¡¨ä¸­
  ngx_queue_add(&amp;lq-&gt;list, &amp;tail);

  if (x == ngx_queue_sentinel(locations)) {
    ngx_http_create_locations_list(&amp;lq-&gt;list, ngx_queue_head(&amp;lq-&gt;list));
    return;
  }

  // å°†xä»é˜Ÿåˆ—ä¸­åˆ†ç¦»å‡ºæ¥
  ngx_queue_split(&amp;lq-&gt;list, x, &amp;tail);
  // æ”¾å›åˆ°locationé˜Ÿåˆ—ä¸­
  ngx_queue_add(locations, &amp;tail);

  // å¯¹lq-&gt;liståšç›¸åŒçš„æ“ä½œ
  ngx_http_create_locations_list(&amp;lq-&gt;list, ngx_queue_head(&amp;lq-&gt;list));

  // å¯¹ä»xå¼€å§‹çš„å‰©ä½™èŠ‚ç‚¹åšç›¸åŒçš„æ“ä½œ
  ngx_http_create_locations_list(locations, x);
}
</code></pre>

<p>å¯¹è¯¥å‡½æ•°çš„å‡ ä¸ªè¯´æ˜ï¼š</p>

<ul>
<li>ç”±äºå­˜åœ¨é€’å½’è°ƒç”¨ï¼Œæ‰€ä»¥å‡½æ•°å¼€å§‹è¦åšq == ngx_queue_last(locations)çš„åˆ¤æ–­ï¼Œåšä¸ºé€’å½’çš„ç»ˆæ­¢æ¡ä»¶ã€‚</li>
<li>å¯¹äºé inclusive ç±»å‹ (æ­¤æ—¶ locations é˜Ÿåˆ—ä¸­ä¹ŸåªåŒ…å« exact å’Œ inclusive ç±»å‹çš„ location èŠ‚ç‚¹) çš„ location èŠ‚ç‚¹ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸åšä»»ä½•æ•´ç†ã€‚</li>
<li>ä»lqå¼€å§‹éå†é˜Ÿåˆ—ï¼Œç›´åˆ°æŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸ä»¥qåšä¸ºå‰ç¼€çš„locationæ‰é€€å‡ºå¾ªç¯ï¼Œé€€å‡ºå¾ªç¯æ—¶ä¿å­˜å½“å‰ä½ç½®ä¸ºxã€‚æ¯”å¦‚å½“å‰é˜Ÿåˆ—locationä¸ºï¼š/a /ab /abc /bï¼Œè¿™é‡Œçš„qå°±æ˜¯/aï¼Œxå°±æ˜¯/bï¼Œä¸­é—´çš„/abå’Œ/abcéƒ½æ˜¯ä»¥/aä¸ºå‰ç¼€çš„ï¼Œä¸ä¼šç»ˆæ­¢å¾ªç¯ã€‚</li>
<li>å°†ä¸lqå‰ç¼€åŒ¹é…çš„é˜Ÿåˆ—å…ƒç´ ï¼Œæ”¾åˆ°lqçš„listä¸­ï¼ŒåŒæ—¶é’ˆå¯¹è¿™ä¸ªlisté€’å½’è°ƒç”¨ngx_http_create_locations_listå‡½æ•°ã€‚</li>
<li>ç»§ç»­é’ˆå¯¹xå¼€å§‹çš„å‰©ä½™é˜Ÿåˆ—èŠ‚ç‚¹é€’å½’è°ƒç”¨ngx_http_create_locations_listå‡½æ•°ã€‚</li>
</ul>

<p>å¦‚ä¸‹å›¾æ‰€ç¤ºå°±æ˜¯ngx_http_create_locations_listè°ƒç”¨å‰åçš„æ•ˆæœï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190212-nginx-http-config/ngx-location-create-locations-list.png" alt="ngx-location-create-locations-list" title="ngx-location-create-locations-list" /></p>

<h4 id="ngx-http-create-location-trees">ngx_http_create_location_trees</h4>

<p>ngx_http_create_location_treesåœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šæ„é€ locationæŸ¥æ‰¾æ ‘</p>

<pre><code class="language-C">static ngx_http_location_tree_node_t *
  ngx_http_create_locations_tree(ngx_conf_t *cf, ngx_queue_t *locations,
  size_t prefix)
{
  size_t                          len;
  ngx_queue_t                    *q, tail;
  ngx_http_location_queue_t      *lq;
  ngx_http_location_tree_node_t  *node;

  // å¿«é€Ÿç¡®å®šä¸­é—´èŠ‚ç‚¹çš„ä½ç½®ï¼Œä¿å­˜åˆ°qä¸­
  q = ngx_queue_middle(locations);

  lq = (ngx_http_location_queue_t *) q;
  // å·¦è¾¹å…ƒç´ çš„æ•°é‡
  len = lq-&gt;name-&gt;len - prefix;

  node = ngx_palloc(cf-&gt;pool,
    offsetof(ngx_http_location_tree_node_t, name) + len);
  if (node == NULL) {
    return NULL;
  }

  node-&gt;left = NULL;
  node-&gt;right = NULL;
  node-&gt;tree = NULL;
  node-&gt;exact = lq-&gt;exact;
  node-&gt;inclusive = lq-&gt;inclusive;

  node-&gt;auto_redirect = (u_char) ((lq-&gt;exact &amp;&amp; lq-&gt;exact-&gt;auto_redirect)
    || (lq-&gt;inclusive &amp;&amp; lq-&gt;inclusive-&gt;auto_redirect));

  node-&gt;len = (u_char) len;
  ngx_memcpy(node-&gt;name, &amp;lq-&gt;name-&gt;data[prefix], len);

  // ä»ä¸­é—´èŠ‚ç‚¹å°†locationåˆ†ä¸ºä¸¤éƒ¨åˆ†
  ngx_queue_split(locations, q, &amp;tail);

  // å¦‚æœåˆ†ç¦»å®Œæ¯•locationé˜Ÿåˆ—ä¸ºç©º
  if (ngx_queue_empty(locations)) {
    /*
     * ngx_queue_split() insures that if left part is empty,
     * then right one is empty too
     */
    // ç›´æ¥è·³åˆ°æ„é€ inclusiveç±»å‹çš„å­æ ‘
    goto inclusive;
  }

  // æ„é€ å·¦å­æ ‘
  node-&gt;left = ngx_http_create_locations_tree(cf, locations, prefix);
  if (node-&gt;left == NULL) {
    return NULL;
  }

  ngx_queue_remove(q);

  if (ngx_queue_empty(&amp;tail)) {
    goto inclusive;
  }

  // æ„é€ å³å­æ ‘
  node-&gt;right = ngx_http_create_locations_tree(cf, &amp;tail, prefix);
  if (node-&gt;right == NULL) {
    return NULL;
  }

inclusive:
  // åˆ°è¿™é‡Œæ„é€ inclusiveç±»å‹çš„æ ‘ä¿å­˜åˆ°treeæˆå‘˜ä¸­

  // listä¸ºç©ºè¯´æ˜æ²¡æœ‰inclusiveç±»å‹çš„locationäº†
  if (ngx_queue_empty(&amp;lq-&gt;list)) {
    return node;
  }

  node-&gt;tree = ngx_http_create_locations_tree(cf, &amp;lq-&gt;list, prefix + len);
  if (node-&gt;tree == NULL) {
    return NULL;
  }

  return node;
}
</code></pre>

<p>è¯´æ˜ï¼š</p>

<ul>
<li>è°ƒç”¨ngx_queue_middleå¿«é€Ÿç¡®å®šlocaitoné˜Ÿåˆ—çš„ä¸­é—´èŠ‚ç‚¹ã€‚</li>
<li>ä»ä¸­é—´èŠ‚ç‚¹å°†locationåˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚</li>
<li>åˆ†åˆ«æ„é€ å·¦å³å­æ ‘æ”¾åˆ°æˆå‘˜leftå’Œrightä¸­ã€‚</li>
<li>å°†inclusiveç±»å‹çš„locationæ”¾å…¥åˆ°æˆå‘˜treeä¸­ã€‚</li>
</ul>

<p>å¦‚ä¸‹å›¾æ‰€ç¤ºå°±æ˜¯ngx-location-create-locations-treeè°ƒç”¨å‰åçš„æ•ˆæœï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190212-nginx-http-config/ngx-location-create-locations-tree.png" alt="ngx-location-create-locations-tree" title="ngx-location-create-locations-tree" /></p>

<h2 id="æŸ¥æ‰¾locationæµç¨‹">æŸ¥æ‰¾locationæµç¨‹</h2>

<p>è¯·æ±‚çš„ location åŒ¹é…ï¼Œåœ¨è¯·æ±‚å¤„ç†çš„ FIND_CONFIG é˜¶æ®µç›¸å¯¹åº”çš„ checker ngx_http_core_find_config_phase å‡½æ•°ä¸­å®Œæˆã€‚ngx_http_core_find_config_phase å‡½æ•°è°ƒç”¨ ngx_http_core_find_location å‡½æ•°å®Œæˆå®é™…çš„åŒ¹é…å·¥ä½œã€‚</p>

<p>æœ¬è´¨ä¸Šå°±æ˜¯æ ¹æ®å‰é¢æ„å»ºå¥½çš„æ ‘ç»“æ„ï¼Œè¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œä¸å†é˜è¿°ã€‚</p>

<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>

<ul>
<li><a href="https://ialloc.org/blog/ngx-notes-conf-parsing/">Nginx æºä»£ç ç¬”è®° - é…ç½®æ–‡ä»¶è§£æ</a></li>
<li><a href="https://ialloc.org/blog/ngx-notes-http-location/">Nginx æºä»£ç ç¬”è®° - URI åŒ¹é…</a></li>
<li><a href="https://ialloc.org/blog/ngx-notes-hashtable-2/">Nginx æºä»£ç ç¬”è®° - å“ˆå¸Œè¡¨ [2]</a></li>
</ul>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20190209-zeromq-lockfree-queue/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20190213-nginx-process-http-request/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
