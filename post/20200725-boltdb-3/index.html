<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="boltdb 1.3.0å®ç°åˆ†æ">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" boltdb  å­˜å‚¨å¼•æ“ ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰" />
<meta property="og:description" content="boltdb 1.3.0å®ç°åˆ†æ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20200725-boltdb-3/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-07-25T11:26:33+08:00" />
<meta property="article:modified_time" content="2020-07-25T11:26:33+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20200725-boltdb-3/">

  
  
  <meta itemprop="name" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰">
<meta itemprop="description" content="boltdb 1.3.0å®ç°åˆ†æ"><meta itemprop="datePublished" content="2020-07-25T11:26:33+08:00" />
<meta itemprop="dateModified" content="2020-07-25T11:26:33+08:00" />
<meta itemprop="wordCount" content="4127">
<meta itemprop="keywords" content="å­˜å‚¨,å­˜å‚¨å¼•æ“," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰"/>
<meta name="twitter:description" content="boltdb 1.3.0å®ç°åˆ†æ"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å‘è¡¨</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">å‘¨åˆŠ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8'>#å­˜å‚¨</a>
    
    <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E'>#å­˜å‚¨å¼•æ“</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#bæ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚">B+æ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚</a></li>
    <li><a href="#è°ƒæ•´freelisté¡µé¢ä¿¡æ¯">è°ƒæ•´freelisté¡µé¢ä¿¡æ¯</a></li>
    <li><a href="#å°†metaä¿¡æ¯å†™å›ç£ç›˜">å°†metaä¿¡æ¯å†™å›ç£ç›˜</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <blockquote>
<p>æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ä½“ã€‚å…³äºetcdã€raftåè®®ä»¥åŠB+æ ‘ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p>
</blockquote>
<blockquote>
<ul>
<li><a href="https://www.codedump.info/post/20180921-raft/">Raftç®—æ³•åŸç†</a></li>
<li><a href="https://www.codedump.info/post/20180922-etcd-raft/">etcd Raftåº“è§£æ</a></li>
<li><a href="https://www.codedump.info/post/20181125-etcd-server/">Etcdå­˜å‚¨çš„å®ç°</a></li>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>
</blockquote>
<blockquote>
<p>æœ¬æ–‡çš„å†™ä½œï¼Œä¸»è¦å‚è€ƒäº†<a href="https://www.jianshu.com/p/b86a69892990">ã€ŠåŒºå—çš„æŒä¹…åŒ–ä¹‹BoltDBã€‹ç³»åˆ—æ–‡ç« </a>ä»¥åŠ<a href="https://youjiali1995.github.io/storage/boltdb">boltdb æºç åˆ†æ</a></p>
</blockquote>
<p>åœ¨å‰é¢çš„æ–‡ç« é‡Œï¼Œåˆ†åˆ«ä»‹ç»äº†boltdbçš„å‡ ç§é¡µé¢æ ¼å¼ã€Bucketä»¥åŠCursorç»“æ„ï¼Œæœ¬æ–‡ä»‹ç»boltdbçš„äº‹åŠ¡ï¼ˆTransactionï¼‰ã€‚</p>
<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>
<p>boltdbæ”¯æŒäº‹åŠ¡çš„<code>ACID</code>ç‰¹æ€§ï¼Œä½¿ç”¨<code>MVCC</code>æ¥åšå¹¶å‘æ§åˆ¶ï¼ŒåŒæ—¶å¯ä»¥æ‰§è¡Œä¸€ä¸ªå†™äº‹åŠ¡å’Œå¤šä¸ªè¯»äº‹åŠ¡ï¼š</p>
<ul>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šæœªæäº¤çš„å†™äº‹åŠ¡æ“ä½œéƒ½åœ¨å†…å­˜ä¸­ã€‚åœ¨æäº¤å†™äº‹åŠ¡çš„æ—¶å€™ï¼ŒæŒ‰ç…§B+æ ‘æ•°æ®ã€freelistã€metaå…ƒæ•°æ®çš„é¡ºåºå†™å…¥æ–‡ä»¶ã€‚åœ¨metaå…ƒä¿¡æ¯å†™å…¥ä¹‹å‰ï¼Œéƒ½å¯ä»¥è¿›è¡Œå›æ»šï¼ˆrollbackï¼‰æ“ä½œï¼Œåªæœ‰metaå…ƒä¿¡æ¯å†™å…¥æˆåŠŸæ‰èƒ½è®¤ä¸ºå†™æ“ä½œæ‰§è¡ŒæˆåŠŸã€‚</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ¯ä¸ªè¯»äº‹åŠ¡å¼€å§‹çš„æ—¶å€™è·å¾—ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œè¯»äº‹åŠ¡æ¶‰åŠåˆ°çš„é¡µé¢ä¸ä¼šè¢«åŒæ—¶è¿›è¡Œçš„å†™äº‹åŠ¡æ‰€è¦†ç›–ï¼›è€Œæ¯æ¬¡å†™äº‹åŠ¡éƒ½ä¼šæ›´æ–°ä¸€ä¸ªç‰ˆæœ¬å·ã€‚</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šå†™äº‹åŠ¡åœ¨æäº¤çš„æ—¶å€™ï¼Œä¼šå°†è¿™æ¬¡å†™æ“ä½œä¿®æ”¹çš„æ•°æ®ï¼ˆdirty pageï¼‰åˆ†é…æ–°çš„é¡µé¢ï¼Œå†™å…¥æ–‡ä»¶æŒä¹…åŒ–ã€‚</li>
</ul>
<p>æœ¬èŠ‚é¦–å…ˆè®²è§£boltdbçš„äº‹åŠ¡åŸºæœ¬å®ç°ï¼Œä¸‹ä¸€èŠ‚è®²è§£boltdbäº‹åŠ¡å¦‚ä½•å®ç°<code>MVCC</code>ã€‚</p>
<h1 id="äº‹åŠ¡åˆå§‹åŒ–">äº‹åŠ¡åˆå§‹åŒ–</h1>
<p>boltdbä¸­ï¼Œä»»ä½•ä¸€æ¬¡è¯»å†™æ“ä½œï¼Œéƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡ä¸ä¹‹å¯¹åº”ã€‚è¿™æ—¶å€™é¦–å…ˆä¼šè°ƒç”¨<code>DB.Begin</code>å‡½æ•°è¿”å›ä¸€ä¸ªäº‹åŠ¡ï¼Œè€Œä¼ å…¥çš„å‚æ•°ä¼šæ ¹æ®æƒ…å†µåˆ†åˆ«åˆ›å»ºå†™å’Œè¯»äº‹åŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (db <span style="color:#666">*</span>DB) <span style="color:#00a000">Begin</span>(writable <span style="color:#0b0;font-weight:bold">bool</span>) (<span style="color:#666">*</span>Tx, <span style="color:#0b0;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">if</span> writable {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> db.<span style="color:#00a000">beginRWTx</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> db.<span style="color:#00a000">beginTx</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®æ˜¯å¦æ˜¯å†™äº‹åŠ¡ï¼Œä¼šåˆ†åˆ«è°ƒç”¨<code>beginRWTx</code>å’Œ<code>beginTx</code>æ¥åˆ›å»ºè¯»å†™äº‹åŠ¡å’Œåªè¯»äº‹åŠ¡ã€‚</p>
<p><code>DB</code>ç»“æ„ä½“ä¸­ï¼Œä»…æœ‰ä¸€ä¸ªå†™äº‹åŠ¡æˆå‘˜ï¼Œè€Œè¯»äº‹åŠ¡åˆ™å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªï¼Œå› æ­¤åŒä¸€ä¸ªæ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå†™äº‹åŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> DB <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	rwtx     <span style="color:#666">*</span>Tx				<span style="color:#080;font-style:italic">// åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæœªå®Œæˆçš„å†™äº‹åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	txs      []<span style="color:#666">*</span>Tx			<span style="color:#080;font-style:italic">// ä¿å­˜æœªå®Œæˆçš„è¯»äº‹åŠ¡çš„ï¼Œè¯»äº‹åŠ¡å¯ä»¥æœ‰å¤šä¸ªï¼Œå†™äº‹åŠ¡ä¸€ä¸ªæ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªï¼Œå°±åœ¨rwtxé‡Œé¢
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}  
</span></span></code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200725-boltdb-3/beginTx.png" alt="beginTx" title="beginTx"></p>
<p>äº†è§£äº†åœ¨<code>DB</code>ä¸­å¦‚ä½•ä½¿ç”¨äº‹åŠ¡ï¼Œä¸‹é¢æ¥çœ‹äº‹åŠ¡ç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> Tx <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	writable       <span style="color:#0b0;font-weight:bold">bool</span>	<span style="color:#080;font-style:italic">// æ˜¯å¦å†™äº‹åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	managed        <span style="color:#0b0;font-weight:bold">bool</span>	<span style="color:#080;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	db             <span style="color:#666">*</span>DB	<span style="color:#080;font-style:italic">// å¯¹åº”çš„db
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	meta           <span style="color:#666">*</span>meta	<span style="color:#080;font-style:italic">// å¯¹åº”çš„metaæ•°æ®æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	root           Bucket	
</span></span><span style="display:flex;"><span>	pages          <span style="color:#a2f;font-weight:bold">map</span>[pgid]<span style="color:#666">*</span>page	<span style="color:#080;font-style:italic">// æ¶‰åŠåˆ°çš„page
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	stats          TxStats
</span></span><span style="display:flex;"><span>	commitHandlers []<span style="color:#a2f;font-weight:bold">func</span>()	<span style="color:#080;font-style:italic">// commitå›è°ƒå‡½æ•°æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	WriteFlag <span style="color:#0b0;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆå‘˜é‡Šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>writableï¼šæ˜¯å¦æ˜¯å¯å†™çš„äº‹åŠ¡ã€‚</li>
<li>managedï¼šè¡¨ç¤ºå½“å‰çš„äº‹åŠ¡æ“ä½œæ˜¯å¦è¢«dbæ‰˜ç®¡ï¼Œå³é€šè¿‡dbçš„æˆå‘˜å‡½æ•°æ¥è¯»å†™æ•°æ®åº“ã€‚boltdbè¿˜æ”¯æŒç›´æ¥è°ƒç”¨äº‹åŠ¡ç›¸å…³çš„æˆå‘˜å‡½æ•°æ¥è¯»å†™çš„ï¼Œæ­¤æ—¶managedå­—æ®µä¸ºfalseã€‚</li>
<li>dbï¼šæŒ‡å‘å½“å‰è¯»å†™æ“ä½œçš„dbå¯¹è±¡ã€‚</li>
<li>metaï¼šå¼€å§‹äº‹åŠ¡æ—¶ï¼Œä¼šé¦–å…ˆä»dbä¸­åˆå§‹åŒ–metaä¿¡æ¯ã€‚</li>
<li>rootï¼šäº‹åŠ¡å¼€å§‹æ—¶çš„æ ¹Bucketï¼Œ<a href="https://www.codedump.info/post/20200711-boltdb-2/">ä¸Šä¸€èŠ‚</a>ä¸­ä»‹ç»äº†Bucketç›¸å…³ä¿¡æ¯ã€‚</li>
<li>pagesï¼šå­˜å‚¨è¯¥äº‹åŠ¡æ“ä½œä¸­è¯»å†™æ‰€æ¶‰åŠåˆ°pageã€‚</li>
<li>statsï¼šäº‹åŠ¡æ“ä½œç»Ÿè®¡ç›¸å…³ã€‚</li>
<li>commitHandlersï¼šå­˜å‚¨äº‹åŠ¡åœ¨æäº¤ä¹‹åçš„å›è°ƒå‡½æ•°ã€‚</li>
<li>WriteFlag: å¤åˆ¶æˆ–ç§»åŠ¨æ•°æ®åº“æ–‡ä»¶æ—¶ï¼ŒæŒ‡å®šçš„æ–‡ä»¶æ‰“å¼€æ¨¡å¼ã€‚</li>
</ul>
<p>ä¸Šé¢è¿™äº›æˆå‘˜ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯<code>meta</code>å’Œ<code>root</code>å­—æ®µï¼Œä¸‹é¢æ¥ç€çœ‹çœ‹äº‹åŠ¡çš„åˆå§‹åŒ–æµç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (tx <span style="color:#666">*</span>Tx) <span style="color:#00a000">init</span>(db <span style="color:#666">*</span>DB) {
</span></span><span style="display:flex;"><span>	tx.db = db
</span></span><span style="display:flex;"><span>	tx.pages = <span style="color:#a2f;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Copy the meta page since it can be changed by the writer.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	tx.meta = <span style="color:#666">&amp;</span>meta{}
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// txçš„metaæ•°æ®æ‹·è´å½“å‰çš„db metaæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	db.<span style="color:#00a000">meta</span>().<span style="color:#a2f">copy</span>(tx.meta)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Copy over the root bucket.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	tx.root = <span style="color:#00a000">newBucket</span>(tx)
</span></span><span style="display:flex;"><span>	tx.root.bucket = <span style="color:#666">&amp;</span>bucket{}
</span></span><span style="display:flex;"><span>	<span style="color:#666">*</span>tx.root.bucket = tx.meta.root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Increment the transaction id and add a page cache for writable transactions.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> tx.writable {
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// å¦‚æœæ˜¯å†™æ“ä½œï¼Œéœ€è¦åˆ†é…é¡µé¢æ•°ç»„å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		tx.pages = <span style="color:#a2f">make</span>(<span style="color:#a2f;font-weight:bold">map</span>[pgid]<span style="color:#666">*</span>page)
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// é€’å¢ä¸€ä¸ªäº‹åŠ¡id
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		tx.meta.txid <span style="color:#666">+=</span> <span style="color:#00a000">txid</span>(<span style="color:#666">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆæ¥çœ‹<code>meta</code>çš„åˆå§‹åŒ–æµç¨‹ã€‚å‰é¢æåˆ°ï¼Œ<code>db</code>æ•°æ®ç»“æ„ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ª<code>meta</code>ä¿¡æ¯åˆ†åˆ«å­˜å‚¨åœ¨æ•°æ®åº“æ–‡ä»¶çš„ç¬¬ä¸€å’Œç¬¬äºŒä¸ªé¡µé¢ï¼Œåœ¨<code>db.meta</code>å‡½æ•°ä¸­ï¼Œå°†é€‰æ‹©ä¸¤è€…ä¸­æ ¡éªŒæœ‰æ•ˆä¸”äº‹åŠ¡IDæ›´å¤§çš„<code>meta</code>è¿”å›ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (db <span style="color:#666">*</span>DB) <span style="color:#00a000">meta</span>() <span style="color:#666">*</span>meta {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// We have to return the meta with the highest txid which doesn&#39;t fail
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// validation. Otherwise, we can cause errors when in fact the database is
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// in a consistent state. metaA is the one with the higher txid.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	metaA <span style="color:#666">:=</span> db.meta0
</span></span><span style="display:flex;"><span>	metaB <span style="color:#666">:=</span> db.meta1
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">if</span> db.meta1.txid &gt; db.meta0.txid {
</span></span><span style="display:flex;"><span>		metaA = db.meta1
</span></span><span style="display:flex;"><span>		metaB = db.meta0
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Use higher meta page if valid. Otherwise fallback to previous, if valid.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">:=</span> metaA.<span style="color:#00a000">validate</span>(); err <span style="color:#666">==</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> metaA
</span></span><span style="display:flex;"><span>	} <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">:=</span> metaB.<span style="color:#00a000">validate</span>(); err <span style="color:#666">==</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> metaB
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// This should never be reached, because both meta1 and meta0 were validated
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// on mmap() and we do fsync() on every write.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f">panic</span>(<span style="color:#b44">&#34;bolt.DB.meta(): invalid meta pages&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª<code>meta</code>é¡µé¢çš„åŸå› åœ¨äºï¼šç”±äºè½®æ¢ä½¿ç”¨ä¸¤ä¸ª<code>meta</code>é¡µé¢ï¼Œè¿™æ ·ä¸¤æ¬¡ä¸åŒçš„å†™äº‹åŠ¡æ“ä½œï¼Œåˆ†åˆ«å¯¹åº”è¿™ä¸¤ä¸ª<code>meta</code>é¡µé¢ä¸­çš„ä¸€ä¸ªï¼Œå‡å¦‚å…¶ä¸­ä¸€æ¬¡å¤±è´¥äº†ï¼Œä¹Ÿåªæ˜¯å½±å“äº†å…¶ä¸­ä¸€ä¸ªé¡µé¢ã€‚</p>
<p>æ‹¿åˆ°äº†è¿™ä¸€æ¬¡æ“ä½œçš„<code>meta</code>ä¿¡æ¯ä¹‹åï¼Œå°±æ˜¯æ ¹æ®è¿™äº›ä¿¡æ¯æ¥åˆå§‹åŒ–<code>root</code>çš„Bucketä¿¡æ¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (tx <span style="color:#666">*</span>Tx) <span style="color:#00a000">init</span>(db <span style="color:#666">*</span>DB) {
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  tx.root = <span style="color:#00a000">newBucket</span>(tx)
</span></span><span style="display:flex;"><span>  tx.root.bucket = <span style="color:#666">&amp;</span>bucket{}
</span></span><span style="display:flex;"><span>  <span style="color:#666">*</span>tx.root.bucket = tx.meta.root
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼Œæ ¹æ®æ‹·è´å‡ºæ¥çš„<code>meta</code>ä¿¡æ¯ï¼Œè°ƒç”¨<code>newBucket</code>å‡½æ•°åˆ›å»ºäº†<code>Bucket</code>è¿”å›åˆ°<code>tx.root</code>ä¸­ã€‚ä¸€ä¸ª<code>Bucket</code>çš„<code>bucket</code>æˆå‘˜ï¼Œå…¶å†…å®¹æ˜¯<code>Bucket</code>çš„æ ¹èŠ‚ç‚¹page idä»¥åŠåºåˆ—å·ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> bucket <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// æ ¹èŠ‚ç‚¹çš„page id
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	root pgid <span style="color:#080;font-style:italic">// page id of the bucket&#39;s root-level page
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å•è°ƒé€’å¢çš„åºåˆ—å·
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	sequence <span style="color:#0b0;font-weight:bold">uint64</span> <span style="color:#080;font-style:italic">// monotonically incrementing, used by NextSequence()
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>å› æ­¤ä¸Šé¢çš„æµç¨‹å°±æ˜¯ï¼šä½¿ç”¨å½“å‰çš„<code>meta</code>å…ƒä¿¡æ¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ª<code>Bucket</code>ï¼Œè¯¥<code>Bucket</code>çš„æ ¹èŠ‚ç‚¹page idä»¥åŠåºåˆ—å·ä¹Ÿéƒ½æ˜¯ä»å½“å‰dbçš„æ ¹<code>Bucket</code>ä¸­æ‹·è´çš„ã€‚</p>
<p><code>tx.init</code>å‡½æ•°çš„æœ€åï¼Œæ ¹æ®æ˜¯å¦å†™äº‹åŠ¡ï¼Œå°†æ‹·è´å›æ¥çš„<code>meta</code>ä¿¡æ¯çš„äº‹åŠ¡idé€’å¢1ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (tx <span style="color:#666">*</span>Tx) <span style="color:#00a000">init</span>(db <span style="color:#666">*</span>DB) {
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// Increment the transaction id and add a page cache for writable transactions.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> tx.writable {
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// å¦‚æœæ˜¯å†™æ“ä½œï¼Œéœ€è¦åˆ†é…é¡µé¢æ•°ç»„å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		tx.pages = <span style="color:#a2f">make</span>(<span style="color:#a2f;font-weight:bold">map</span>[pgid]<span style="color:#666">*</span>page)
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// é€’å¢ä¸€ä¸ªäº‹åŠ¡id
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		tx.meta.txid <span style="color:#666">+=</span> <span style="color:#00a000">txid</span>(<span style="color:#666">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>è¿™æ ·ï¼Œåœ¨æœ€åå†™äº‹åŠ¡å®Œæˆä¹‹åï¼Œå°†<code>meta</code>ä¿¡æ¯å†™å›ç£ç›˜æ—¶ï¼Œå°±æ¯”åŸå…ˆçš„äº‹åŠ¡IDåŠ ä¸€ã€‚</p>
<h1 id="äº‹åŠ¡æäº¤">äº‹åŠ¡æäº¤</h1>
<p>å‰é¢ä»‹ç»äº†äº‹åŠ¡çš„åˆå§‹åŒ–æµç¨‹ï¼Œç”±äºboltdbå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ï¼Œæ‰€ä»¥boltdbä¸­æ¶‰åŠåˆ°è¯»å†™çš„æµç¨‹å°±ä¸å†é˜è¿°ï¼ŒåŸºæœ¬å°±æ˜¯ä¸€ä¸ªB+æ ‘çš„è¯»å†™æµç¨‹ï¼Œå¦‚æœä¸æ¸…æ¥šè¿™éƒ¨åˆ†çš„åŸç†ï¼Œå¯ä»¥å»è¡¥å……ä¸€ä¸‹B+æ ‘ç›¸å…³çš„çŸ¥è¯†ï¼š</p>
<blockquote>
<ul>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>
</blockquote>
<p>åœ¨è¿™ä¸€å°èŠ‚ï¼Œåªä»‹ç»è¯»å†™æµç¨‹å®Œæ¯•ä¹‹åçš„äº‹åŠ¡æäº¤æµç¨‹ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨<code>Tx.Commit</code>å‡½æ•°ä¸­å®ç°ã€‚boltdbçš„äº‹åŠ¡æäº¤æµç¨‹å¤§ä½“åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ul>
<li>B+æ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚ã€‚</li>
<li>è°ƒæ•´freelisté¡µé¢ä¿¡æ¯ã€‚</li>
<li>å°†metaä¿¡æ¯å†™å›ç£ç›˜ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200725-boltdb-3/commitTx.png" alt="commitTx" title="commitTx"></p>
<h2 id="bæ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚">B+æ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚</h2>
<p>åœ¨å†™æ“ä½œè¿‡ç¨‹ä¸­ï¼Œä¸­é—´å¯èƒ½ä¼šé€ æˆæ ‘çš„ä¸å¹³è¡¡ï¼Œå› æ­¤åœ¨æ“ä½œå®Œæ¯•ä¹‹åï¼Œéœ€è¦å¯¹æ•´ä¸ªB+æ ‘è¿›è¡Œé‡å¹³è¡¡ï¼ˆrebalanceï¼‰æ“ä½œã€‚é‡å¹³è¡¡æ“ä½œçš„åŸç†æ¯”è¾ƒå¤æ‚ï¼Œæ˜¯ä¸€ä¸ªä»å¶å­èŠ‚ç‚¹ä¸€ç›´å¾€ä¸Šè¿›è¡Œé‡å¹³è¡¡æ“ä½œï¼Œç›´åˆ°æ»¡è¶³B+æ ‘å¹³è¡¡æ¡ä»¶çš„æµç¨‹ã€‚ç®—æ³•çš„åŸç†ä¸åœ¨è¿™é‡Œé˜è¿°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://www.codedump.info/post/20200615-btree-2/#%E5%88%A0%E9%99%A4%E7%AE%97%E6%B3%95">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰#åˆ é™¤ç®—æ³•</a>ã€‚åŸºæœ¬ä¸Šboltdbçš„é‡å¹³è¡¡æ“ä½œä¹Ÿæ˜¯è¿™ä¸ªæµç¨‹ï¼Œä¹Ÿå°±ä¸åœ¨è¿™é‡Œå±•å¼€äº†ã€‚</p>
<p>é‡å¹³è¡¡å®Œæ¯•ä¹‹åï¼Œboltdbè¿˜ä¼šå°†å¤§å°è¶…è¿‡é˜ˆå€¼çš„èŠ‚ç‚¹ï¼Œåˆ†è£‚æˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå…¶å¤§ä½“æµç¨‹æ˜¯ï¼š</p>
<ul>
<li>Bucketéå†è‡ªå·±çš„æ‰€æœ‰å­Bucketï¼Œè¿›è¡Œ<code>spill</code>åˆ†è£‚æ“ä½œã€‚å¦‚æœåˆ†è£‚æˆåŠŸï¼Œå°±éœ€è¦åœ¨çˆ¶Bucketä¸­æ›´æ–°è¯¥å­Bucketçš„ä¿¡æ¯ã€‚</li>
<li>Bucketä»è‡ªå·±çš„æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œè¿›è¡Œ<code>spill</code>åˆ†è£‚æ“ä½œã€‚</li>
<li>èŠ‚ç‚¹çš„<code>spill</code>æ“ä½œï¼Œå°†éå†è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¦‚æœä¸€ä¸ªå­èŠ‚ç‚¹å¤§å°è¶…è¿‡é˜ˆå€¼å°±è¿›è¡Œåˆ†è£‚ï¼›å¦åˆ™åˆ†è£‚ç»“æŸã€‚</li>
</ul>
<p>å¦‚æœåœ¨åˆ†è£‚æ“ä½œä¸­ï¼Œäº§ç”Ÿäº†æ–°çš„é¡µé¢ï¼Œåˆ™è¿™ä¸ªæ—¶å€™å°±ä¼šåœ¨<code>freelist</code>ä¸­åˆ†é…é¡µé¢ç»™è¿™äº›æ–°çš„é¡µé¢ã€‚ç”±äºæ¯æ¬¡å†™äº‹åŠ¡çš„<code>freelist</code>ä¿¡æ¯ï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹å‰æ˜¯åœ¨å†…å­˜é‡Œçš„ï¼Œæ‰€ä»¥ä¸€æ—¦å†™å¤±è´¥ï¼Œè¿™äº›<code>freelist</code>ä¿¡æ¯å°±å›é€€ï¼Œå¹¶ä¸å½±å“å…¶ä»–çš„æ“ä½œã€‚</p>
<h2 id="è°ƒæ•´freelisté¡µé¢ä¿¡æ¯">è°ƒæ•´freelisté¡µé¢ä¿¡æ¯</h2>
<p>åˆ°äº†è¿™ä¸€æ­¥ï¼Œå‰é¢çš„ä¸¤ä¸ªè°ƒæ•´ï¼šé‡å¹³è¡¡å’Œåˆ†è£‚é¡µé¢æ“ä½œå·²ç»å®Œæˆï¼Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿäº†æ–°çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯<code>freelist</code>ä¿¡æ¯ä¼šæœ‰æ”¹å˜ï¼Œå› æ­¤è¦ç›¸åº”çš„è°ƒæ•´<code>freelist</code>é¡µé¢ä¿¡æ¯ã€‚</p>
<p>åœ¨è¿™é‡Œé¦–å…ˆæ¥çœ‹çœ‹<code>freelist</code>ä¸­å¦‚ä½•ç»´æŠ¤é¡µé¢çš„åˆ†é…ä¿¡æ¯ï¼Œ<code>freelist</code>ä¸­åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæˆå‘˜ï¼š</p>
<ul>
<li>idsï¼šä¿å­˜å½“å‰å¯ç”¨çš„é¡µé¢IDæ•°ç»„ã€‚</li>
<li>pendingï¼špendingæ˜¯ä¸€ä¸ªmapï¼Œé”®æ˜¯äº‹åŠ¡idï¼Œå€¼ä¸ºé¡µé¢IDæ•°ç»„ï¼Œå­˜å‚¨çš„æ˜¯æ¯ä¸ªäº‹åŠ¡æ“ä½œæ—¶å€™æ¶‰åŠåˆ°çš„é¡µé¢IDã€‚</li>
<li>cacheï¼šcacheæ˜¯ä¸€ä¸ªmapï¼Œé”®ä¸ºé¡µé¢IDï¼Œå€¼ä¸ºå¸ƒå°”å€¼ï¼Œå¯ä»¥ä»è¿™é‡Œå¿«é€ŸæŸ¥çœ‹ä¸€ä¸ªé¡µé¢å½“å‰æ˜¯å¦ç©ºé—²ã€‚</li>
</ul>
<p>ä»¥ä¸Šä¸‰ä¸ªæˆå‘˜ä¸­ï¼Œ<code>cache</code>æ˜¯æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾é¡µé¢ç©ºé—²æƒ…å†µçš„æ•°æ®ï¼Œå¯ä»¥ç†è§£ä¸ºå¯ç”¨é¡µé¢çš„ç´¢å¼•ï¼›<code>ids</code>æ˜¯å­˜å‚¨å¯ç”¨é¡µé¢IDçš„æ•°ç»„ï¼Œæ¯æ¬¡åˆ†é…ä¸€ä¸ªé¡µé¢å‡ºå»å°±è¦å¯¹åº”çš„ä¿®æ”¹è¿™ä¸ªæ•°ç»„ï¼›æœ€åï¼Œ<code>pending</code>å°±æ˜¯å­˜å‚¨ä¸€ä¸ªäº‹åŠ¡æ“ä½œè¿‡ç¨‹ä¸­é—´çš„æ•°æ®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200725-boltdb-3/freelist.png" alt="freelist" title="freelist"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œ<code>freelist</code>é¡µé¢åœ¨ç£ç›˜ä¸­å­˜å‚¨çš„å½“å‰é¡µé¢<code>id</code>çš„åˆ†é…æ•°ç»„ï¼Œæ¯ä¸€æ¬¡åˆå§‹åŒ–æ—¶å°†å¯ç”¨é¡µé¢IDè¯»å…¥<code>ids</code>æ•°ç»„ä¹‹åï¼Œéƒ½ä¼šå†è°ƒç”¨<code>freelist.reindex</code>å‡½æ•°æ¥é‡å»ºç´¢å¼•æ•°æ®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (f <span style="color:#666">*</span>freelist) <span style="color:#00a000">reindex</span>() {
</span></span><span style="display:flex;"><span>	f.cache = <span style="color:#a2f">make</span>(<span style="color:#a2f;font-weight:bold">map</span>[pgid]<span style="color:#0b0;font-weight:bold">bool</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">for</span> _, id <span style="color:#666">:=</span> <span style="color:#a2f;font-weight:bold">range</span> f.ids {
</span></span><span style="display:flex;"><span>		f.cache[id] = <span style="color:#a2f;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">for</span> _, pendingIDs <span style="color:#666">:=</span> <span style="color:#a2f;font-weight:bold">range</span> f.pending {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">for</span> _, pendingID <span style="color:#666">:=</span> <span style="color:#a2f;font-weight:bold">range</span> pendingIDs {
</span></span><span style="display:flex;"><span>			f.cache[pendingID] = <span style="color:#a2f;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œå®é™…ä¸Šæ˜¯å°†<code>pending</code>ä¸­çš„é¡µé¢è¿”è¿˜å›å»ï¼Œé‡æ–°å˜æˆç©ºé—²é¡µé¢ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// rollback removes the pages from a given pending tx.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">func</span> (f <span style="color:#666">*</span>freelist) <span style="color:#00a000">rollback</span>(txid txid) {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Remove page ids from cache.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å›æ»šå°±æ˜¯æŠŠæ‰€æœ‰å¾…é‡Šæ”¾çš„idåˆ é™¤ï¼Œè¡¨ç¤ºä¸é‡Šæ”¾äº†
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">for</span> _, id <span style="color:#666">:=</span> <span style="color:#a2f;font-weight:bold">range</span> f.pending[txid] {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f">delete</span>(f.cache, id)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Remove pages from pending list.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// ç„¶ååˆ é™¤è¿™ä¸ªäº‹åŠ¡çš„pendingæ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f">delete</span>(f.pending, txid)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æœ‰äº†å¯¹<code>freelist</code>ç›¸å…³çš„äº†è§£ï¼Œå›åˆ°äº‹åŠ¡æäº¤æ“ä½œä¿®æ”¹<code>freelist</code>éƒ¨åˆ†ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (tx <span style="color:#666">*</span>Tx) <span style="color:#00a000">Commit</span>() <span style="color:#0b0;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">// é‡Šæ”¾freelist
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	tx.db.freelist.<span style="color:#00a000">free</span>(tx.meta.txid, tx.db.<span style="color:#00a000">page</span>(tx.meta.freelist))
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// åˆ†é…ä¸€ä¸ªfreelist
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	p, err <span style="color:#666">:=</span> tx.<span style="color:#00a000">allocate</span>((tx.db.freelist.<span style="color:#00a000">size</span>() <span style="color:#666">/</span> tx.db.pageSize) <span style="color:#666">+</span> <span style="color:#666">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		tx.<span style="color:#00a000">rollback</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">:=</span> tx.db.freelist.<span style="color:#00a000">write</span>(p); err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		tx.<span style="color:#00a000">rollback</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}  
</span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼š</p>
<ul>
<li>é¦–å…ˆæ ¹æ®äº‹åŠ¡IDå°†åŸæœ‰å­˜å‚¨<code>freelist</code>é¡µé¢ä¿¡æ¯çš„é¡µé¢é‡Šæ”¾æ‰ã€‚</li>
<li>åˆ†é…å­˜å‚¨è¿™ä¸€æ¬¡å†™äº‹åŠ¡çš„é¡µé¢ä¿¡æ¯é¡µé¢ã€‚</li>
<li>å†™å…¥è¿™ä¸€æ¬¡çš„é¡µé¢ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="å°†metaä¿¡æ¯å†™å›ç£ç›˜">å°†metaä¿¡æ¯å†™å›ç£ç›˜</h2>
<p>æœ€åï¼Œåœ¨æ›´æ–°å®Œæ¯•æ–°çš„<code>freelist</code>é¡µé¢ä¿¡æ¯ä¹‹åï¼Œå°±å¯ä»¥æŠŠæœ¬æ¬¡æ“ä½œä¹‹åçš„<code>meta</code>å…ƒä¿¡æ¯ä¹Ÿå†™å›ç£ç›˜äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// writeMeta writes the meta to the disk.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// æ›´æ–°metaæ•°æ®åˆ°ç£ç›˜
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">func</span> (tx <span style="color:#666">*</span>Tx) <span style="color:#00a000">writeMeta</span>() <span style="color:#0b0;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Create a temporary buffer for the meta page.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// åˆ†é…ç¼“å†²åŒºï¼Œå¤§å°ä¸ºä¸€ä¸ªé¡µé¢
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	buf <span style="color:#666">:=</span> <span style="color:#a2f">make</span>([]<span style="color:#0b0;font-weight:bold">byte</span>, tx.db.pageSize)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// è½¬æ¢æˆpageç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	p <span style="color:#666">:=</span> tx.db.<span style="color:#00a000">pageInBuffer</span>(buf, <span style="color:#666">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// å°†äº‹åŠ¡çš„metaæ•°æ®å†™å…¥pageä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	tx.meta.<span style="color:#00a000">write</span>(p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Write the meta page to file.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// ç¼“å†²çš„æ•°æ®å†™å…¥æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> _, err <span style="color:#666">:=</span> tx.db.ops.<span style="color:#00a000">writeAt</span>(buf, <span style="color:#a2f">int64</span>(p.id)<span style="color:#666">*</span><span style="color:#a2f">int64</span>(tx.db.pageSize)); err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">if</span> !tx.db.NoSync <span style="color:#666">||</span> IgnoreNoSync {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">:=</span> <span style="color:#00a000">fdatasync</span>(tx.db); err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a2f;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Update statistics.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	tx.stats.Write<span style="color:#666">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>æ€»ç»“ä¸‹æ¥ï¼Œboltdbçš„å†™äº‹åŠ¡æ“ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨å½“å‰dbæ•°æ®æ¥åˆå§‹åŒ–äº‹åŠ¡ï¼šå¤åˆ¶ä¸€ä»½å½“å‰çš„metaå…ƒä¿¡æ¯ã€åˆå§‹åŒ–æ ¹Bucketä¿¡æ¯ã€è‡ªå¢äº‹åŠ¡IDã€‚</li>
<li>å¯¹B+æ ‘è¿›è¡Œå†™æ“ä½œï¼Œè¿™éƒ¨åˆ†åœ¨æœªæäº¤ä¹‹å‰éƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ•°æ®ã€‚</li>
<li>å†™æ“ä½œå®Œæˆä¹‹åï¼Œæäº¤å†™äº‹åŠ¡ï¼š
<ul>
<li>å¹³è¡¡B+æ ‘ã€å¯¹è¶…è¿‡é˜ˆå€¼çš„èŠ‚ç‚¹è¿›è¡Œåˆ†è£‚æ“ä½œã€‚åˆ†è£‚è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°é¡µé¢å°†ä»<code>freelist</code>ä¸­åˆ†é…å‡ºæ¥ã€‚</li>
<li>ç»™<code>freelist</code>åˆ†é…æ–°çš„é¡µé¢ã€‚</li>
<li>åˆ°äº†è¿™é‡Œï¼Œå°†B+æ ‘å’Œ<code>freelist</code>æ•°æ®å†™å…¥æ–‡ä»¶ã€‚</li>
<li>æ›´æ–°metaå…ƒä¿¡æ¯å†™å…¥æ–‡ä»¶ã€‚</li>
</ul>
</li>
</ul>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20200711-boltdb-2/">â† prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20200726-boltdb-4/">next â†’</a>
    
  </div>

    
<h1>ç›¸å…³æ–‡ç« </h1><li><strong> 1029-02-01: </strong> <a href="https://www.codedump.info/post/20220201-sqlite-btree-5-btree/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆäº”ï¼‰- Btreeçš„å®ç°</a>  </li><li><strong> 6019-01-06: </strong> <a href="https://www.codedump.info/post/20220106-sqlite-btree-4-wal/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆå››ï¼‰- WALçš„å®ç°</a>  </li><li><strong> 22129-12-22: </strong> <a href="https://www.codedump.info/post/20211222-sqlite-btree-3-journal/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆä¸‰ï¼‰- journalæ–‡ä»¶å¤‡ä»½æœºåˆ¶</a>  </li><li><strong> 18129-12-18: </strong> <a href="https://www.codedump.info/post/20211218-sqlite-btree-2-concurrency-control/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆäºŒï¼‰- å¹¶å‘æ§åˆ¶æ¡†æ¶</a>  </li><li><strong> 17129-12-17: </strong> <a href="https://www.codedump.info/post/20211217-sqlite-btree-1-pagecache/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆä¸€ï¼‰- ç®¡ç†é¡µé¢ç¼“å­˜</a>  </li><li><strong> 17129-12-17: </strong> <a href="https://www.codedump.info/post/20211217-sqlite-btree-0/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆé›¶ï¼‰- èµ·æ­¥åŠæ¦‚è¿°</a>  </li><li><strong> 26079-07-26: </strong> <a href="https://www.codedump.info/post/20200726-boltdb-4/">boltdb 1.3.0å®ç°åˆ†æï¼ˆå››ï¼‰</a>  </li><li><strong> 11079-07-11: </strong> <a href="https://www.codedump.info/post/20200711-boltdb-2/">boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰</a>  </li><li><strong> 25069-06-25: </strong> <a href="https://www.codedump.info/post/20200625-boltdb-1/">boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸€ï¼‰</a>  </li><li><strong> 15069-06-15: </strong> <a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B&#43;æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a>  </li><li><strong> 9069-06-09: </strong> <a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B&#43;æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a>  </li><li><strong> 15029-02-15: </strong> <a href="https://www.codedump.info/post/20190215-leveldb/">Leveldbä»£ç é˜…è¯»ç¬”è®°</a>  </li>

<h1>é‚®ä»¶è®¢é˜…</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="é‚®ä»¶è®¢é˜…æœ¬ç«™æ›´æ–°" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="ç‚¹å‡»è®¢é˜…" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revueâ€™s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%AD%98%E5%82%A8/">å­˜å‚¨</a>
          <a href="/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">å­˜å‚¨å¼•æ“</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    
    
        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  
    
  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
