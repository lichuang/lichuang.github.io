<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="boltdb 1.3.0å®ç°åˆ†æ">




<meta name="keywords" content=" boltdb  å­˜å‚¨å¼•æ“ ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰" />
<meta name="twitter:description" content="æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB&#43;æ ‘ç»“" />


<link rel="canonical" href="https://www.codedump.info/post/20200725-boltdb-3/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8'>#å­˜å‚¨</a>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E'>#å­˜å‚¨å¼•æ“</a>
        
      </div>
      
      <div class="content">
        

<blockquote>
<p>æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ä½“ã€‚å…³äºetcdã€raftåè®®ä»¥åŠB+æ ‘ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p>

<ul>
<li><a href="https://www.codedump.info/post/20180921-raft/">Raftç®—æ³•åŸç†</a></li>
<li><a href="https://www.codedump.info/post/20180922-etcd-raft/">etcd Raftåº“è§£æ</a></li>
<li><a href="https://www.codedump.info/post/20181125-etcd-server/">Etcdå­˜å‚¨çš„å®ç°</a></li>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>

<p>æœ¬æ–‡çš„å†™ä½œï¼Œä¸»è¦å‚è€ƒäº†<a href="https://www.jianshu.com/p/b86a69892990">ã€ŠåŒºå—çš„æŒä¹…åŒ–ä¹‹BoltDBã€‹ç³»åˆ—æ–‡ç« </a>ä»¥åŠ<a href="https://youjiali1995.github.io/storage/boltdb">boltdb æºç åˆ†æ</a></p>
</blockquote>

<p>åœ¨å‰é¢çš„æ–‡ç« é‡Œï¼Œåˆ†åˆ«ä»‹ç»äº†boltdbçš„å‡ ç§é¡µé¢æ ¼å¼ã€Bucketä»¥åŠCursorç»“æ„ï¼Œæœ¬æ–‡ä»‹ç»boltdbçš„äº‹åŠ¡ï¼ˆTransactionï¼‰ã€‚</p>

<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>boltdbæ”¯æŒäº‹åŠ¡çš„<code>ACID</code>ç‰¹æ€§ï¼Œä½¿ç”¨<code>MVCC</code>æ¥åšå¹¶å‘æ§åˆ¶ï¼ŒåŒæ—¶å¯ä»¥æ‰§è¡Œä¸€ä¸ªå†™äº‹åŠ¡å’Œå¤šä¸ªè¯»äº‹åŠ¡ï¼š</p>

<ul>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šæœªæäº¤çš„å†™äº‹åŠ¡æ“ä½œéƒ½åœ¨å†…å­˜ä¸­ã€‚åœ¨æäº¤å†™äº‹åŠ¡çš„æ—¶å€™ï¼ŒæŒ‰ç…§B+æ ‘æ•°æ®ã€freelistã€metaå…ƒæ•°æ®çš„é¡ºåºå†™å…¥æ–‡ä»¶ã€‚åœ¨metaå…ƒä¿¡æ¯å†™å…¥ä¹‹å‰ï¼Œéƒ½å¯ä»¥è¿›è¡Œå›æ»šï¼ˆrollbackï¼‰æ“ä½œï¼Œåªæœ‰metaå…ƒä¿¡æ¯å†™å…¥æˆåŠŸæ‰èƒ½è®¤ä¸ºå†™æ“ä½œæ‰§è¡ŒæˆåŠŸã€‚</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ¯ä¸ªè¯»äº‹åŠ¡å¼€å§‹çš„æ—¶å€™è·å¾—ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œè¯»äº‹åŠ¡æ¶‰åŠåˆ°çš„é¡µé¢ä¸ä¼šè¢«åŒæ—¶è¿›è¡Œçš„å†™äº‹åŠ¡æ‰€è¦†ç›–ï¼›è€Œæ¯æ¬¡å†™äº‹åŠ¡éƒ½ä¼šæ›´æ–°ä¸€ä¸ªç‰ˆæœ¬å·ã€‚</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šå†™äº‹åŠ¡åœ¨æäº¤çš„æ—¶å€™ï¼Œä¼šå°†è¿™æ¬¡å†™æ“ä½œä¿®æ”¹çš„æ•°æ®ï¼ˆdirty pageï¼‰åˆ†é…æ–°çš„é¡µé¢ï¼Œå†™å…¥æ–‡ä»¶æŒä¹…åŒ–ã€‚</li>
</ul>

<p>æœ¬èŠ‚é¦–å…ˆè®²è§£boltdbçš„äº‹åŠ¡åŸºæœ¬å®ç°ï¼Œä¸‹ä¸€èŠ‚è®²è§£boltdbäº‹åŠ¡å¦‚ä½•å®ç°<code>MVCC</code>ã€‚</p>

<h1 id="äº‹åŠ¡åˆå§‹åŒ–">äº‹åŠ¡åˆå§‹åŒ–</h1>

<p>boltdbä¸­ï¼Œä»»ä½•ä¸€æ¬¡è¯»å†™æ“ä½œï¼Œéƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡ä¸ä¹‹å¯¹åº”ã€‚è¿™æ—¶å€™é¦–å…ˆä¼šè°ƒç”¨<code>DB.Begin</code>å‡½æ•°è¿”å›ä¸€ä¸ªäº‹åŠ¡ï¼Œè€Œä¼ å…¥çš„å‚æ•°ä¼šæ ¹æ®æƒ…å†µåˆ†åˆ«åˆ›å»ºå†™å’Œè¯»äº‹åŠ¡ï¼š</p>

<pre><code class="language-Go">func (db *DB) Begin(writable bool) (*Tx, error) {
	if writable {
		return db.beginRWTx()
	}
	return db.beginTx()
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®æ˜¯å¦æ˜¯å†™äº‹åŠ¡ï¼Œä¼šåˆ†åˆ«è°ƒç”¨<code>beginRWTx</code>å’Œ<code>beginTx</code>æ¥åˆ›å»ºè¯»å†™äº‹åŠ¡å’Œåªè¯»äº‹åŠ¡ã€‚</p>

<p><code>DB</code>ç»“æ„ä½“ä¸­ï¼Œä»…æœ‰ä¸€ä¸ªå†™äº‹åŠ¡æˆå‘˜ï¼Œè€Œè¯»äº‹åŠ¡åˆ™å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªï¼Œå› æ­¤åŒä¸€ä¸ªæ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå†™äº‹åŠ¡ï¼š</p>

<pre><code class="language-Go">type DB struct {
  // ...
	rwtx     *Tx				// åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæœªå®Œæˆçš„å†™äº‹åŠ¡
	txs      []*Tx			// ä¿å­˜æœªå®Œæˆçš„è¯»äº‹åŠ¡çš„ï¼Œè¯»äº‹åŠ¡å¯ä»¥æœ‰å¤šä¸ªï¼Œå†™äº‹åŠ¡ä¸€ä¸ªæ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªï¼Œå°±åœ¨rwtxé‡Œé¢
}  
</code></pre>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200725-boltdb-3/beginTx.png" alt="beginTx" title="beginTx" />
</center></p>

<p>äº†è§£äº†åœ¨<code>DB</code>ä¸­å¦‚ä½•ä½¿ç”¨äº‹åŠ¡ï¼Œä¸‹é¢æ¥çœ‹äº‹åŠ¡ç»“æ„ä½“çš„å®šä¹‰ï¼š</p>

<pre><code class="language-Go">type Tx struct {
	writable       bool	// æ˜¯å¦å†™äº‹åŠ¡
	managed        bool	//
	db             *DB	// å¯¹åº”çš„db
	meta           *meta	// å¯¹åº”çš„metaæ•°æ®æŒ‡é’ˆ
	root           Bucket	
	pages          map[pgid]*page	// æ¶‰åŠåˆ°çš„page
	stats          TxStats
	commitHandlers []func()	// commitå›è°ƒå‡½æ•°æ•°ç»„

	WriteFlag int
}
</code></pre>

<p>æˆå‘˜é‡Šä¹‰å¦‚ä¸‹ï¼š</p>

<ul>
<li>writableï¼šæ˜¯å¦æ˜¯å¯å†™çš„äº‹åŠ¡ã€‚</li>
<li>managedï¼šè¡¨ç¤ºå½“å‰çš„äº‹åŠ¡æ“ä½œæ˜¯å¦è¢«dbæ‰˜ç®¡ï¼Œå³é€šè¿‡dbçš„æˆå‘˜å‡½æ•°æ¥è¯»å†™æ•°æ®åº“ã€‚boltdbè¿˜æ”¯æŒç›´æ¥è°ƒç”¨äº‹åŠ¡ç›¸å…³çš„æˆå‘˜å‡½æ•°æ¥è¯»å†™çš„ï¼Œæ­¤æ—¶managedå­—æ®µä¸ºfalseã€‚</li>
<li>dbï¼šæŒ‡å‘å½“å‰è¯»å†™æ“ä½œçš„dbå¯¹è±¡ã€‚</li>
<li>metaï¼šå¼€å§‹äº‹åŠ¡æ—¶ï¼Œä¼šé¦–å…ˆä»dbä¸­åˆå§‹åŒ–metaä¿¡æ¯ã€‚</li>
<li>rootï¼šäº‹åŠ¡å¼€å§‹æ—¶çš„æ ¹Bucketï¼Œ<a href="https://www.codedump.info/post/20200711-boltdb-2/">ä¸Šä¸€èŠ‚</a>ä¸­ä»‹ç»äº†Bucketç›¸å…³ä¿¡æ¯ã€‚</li>
<li>pagesï¼šå­˜å‚¨è¯¥äº‹åŠ¡æ“ä½œä¸­è¯»å†™æ‰€æ¶‰åŠåˆ°pageã€‚</li>
<li>statsï¼šäº‹åŠ¡æ“ä½œç»Ÿè®¡ç›¸å…³ã€‚</li>
<li>commitHandlersï¼šå­˜å‚¨äº‹åŠ¡åœ¨æäº¤ä¹‹åçš„å›è°ƒå‡½æ•°ã€‚</li>
<li>WriteFlag: å¤åˆ¶æˆ–ç§»åŠ¨æ•°æ®åº“æ–‡ä»¶æ—¶ï¼ŒæŒ‡å®šçš„æ–‡ä»¶æ‰“å¼€æ¨¡å¼ã€‚</li>
</ul>

<p>ä¸Šé¢è¿™äº›æˆå‘˜ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯<code>meta</code>å’Œ<code>root</code>å­—æ®µï¼Œä¸‹é¢æ¥ç€çœ‹çœ‹äº‹åŠ¡çš„åˆå§‹åŒ–æµç¨‹ã€‚</p>

<pre><code class="language-Go">func (tx *Tx) init(db *DB) {
	tx.db = db
	tx.pages = nil

	// Copy the meta page since it can be changed by the writer.
	tx.meta = &amp;meta{}
	// txçš„metaæ•°æ®æ‹·è´å½“å‰çš„db metaæ•°æ®
	db.meta().copy(tx.meta)

	// Copy over the root bucket.
	tx.root = newBucket(tx)
	tx.root.bucket = &amp;bucket{}
	*tx.root.bucket = tx.meta.root

	// Increment the transaction id and add a page cache for writable transactions.
	if tx.writable {
		// å¦‚æœæ˜¯å†™æ“ä½œï¼Œéœ€è¦åˆ†é…é¡µé¢æ•°ç»„å†…å­˜
		tx.pages = make(map[pgid]*page)
		// é€’å¢ä¸€ä¸ªäº‹åŠ¡id
		tx.meta.txid += txid(1)
	}
}
</code></pre>

<p>é¦–å…ˆæ¥çœ‹<code>meta</code>çš„åˆå§‹åŒ–æµç¨‹ã€‚å‰é¢æåˆ°ï¼Œ<code>db</code>æ•°æ®ç»“æ„ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ª<code>meta</code>ä¿¡æ¯åˆ†åˆ«å­˜å‚¨åœ¨æ•°æ®åº“æ–‡ä»¶çš„ç¬¬ä¸€å’Œç¬¬äºŒä¸ªé¡µé¢ï¼Œåœ¨<code>db.meta</code>å‡½æ•°ä¸­ï¼Œå°†é€‰æ‹©ä¸¤è€…ä¸­æ ¡éªŒæœ‰æ•ˆä¸”äº‹åŠ¡IDæ›´å¤§çš„<code>meta</code>è¿”å›ï¼š</p>

<pre><code class="language-Go">func (db *DB) meta() *meta {
	// We have to return the meta with the highest txid which doesn't fail
	// validation. Otherwise, we can cause errors when in fact the database is
	// in a consistent state. metaA is the one with the higher txid.
	metaA := db.meta0
	metaB := db.meta1
	if db.meta1.txid &gt; db.meta0.txid {
		metaA = db.meta1
		metaB = db.meta0
	}

	// Use higher meta page if valid. Otherwise fallback to previous, if valid.
	if err := metaA.validate(); err == nil {
		return metaA
	} else if err := metaB.validate(); err == nil {
		return metaB
	}

	// This should never be reached, because both meta1 and meta0 were validated
	// on mmap() and we do fsync() on every write.
	panic(&quot;bolt.DB.meta(): invalid meta pages&quot;)
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª<code>meta</code>é¡µé¢çš„åŸå› åœ¨äºï¼šç”±äºè½®æ¢ä½¿ç”¨ä¸¤ä¸ª<code>meta</code>é¡µé¢ï¼Œè¿™æ ·ä¸¤æ¬¡ä¸åŒçš„å†™äº‹åŠ¡æ“ä½œï¼Œåˆ†åˆ«å¯¹åº”è¿™ä¸¤ä¸ª<code>meta</code>é¡µé¢ä¸­çš„ä¸€ä¸ªï¼Œå‡å¦‚å…¶ä¸­ä¸€æ¬¡å¤±è´¥äº†ï¼Œä¹Ÿåªæ˜¯å½±å“äº†å…¶ä¸­ä¸€ä¸ªé¡µé¢ã€‚</p>

<p>æ‹¿åˆ°äº†è¿™ä¸€æ¬¡æ“ä½œçš„<code>meta</code>ä¿¡æ¯ä¹‹åï¼Œå°±æ˜¯æ ¹æ®è¿™äº›ä¿¡æ¯æ¥åˆå§‹åŒ–<code>root</code>çš„Bucketä¿¡æ¯ï¼š</p>

<pre><code class="language-Go">func (tx *Tx) init(db *DB) {
  // ....
  tx.root = newBucket(tx)
  tx.root.bucket = &amp;bucket{}
  *tx.root.bucket = tx.meta.root
  // ...
}
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œæ ¹æ®æ‹·è´å‡ºæ¥çš„<code>meta</code>ä¿¡æ¯ï¼Œè°ƒç”¨<code>newBucket</code>å‡½æ•°åˆ›å»ºäº†<code>Bucket</code>è¿”å›åˆ°<code>tx.root</code>ä¸­ã€‚ä¸€ä¸ª<code>Bucket</code>çš„<code>bucket</code>æˆå‘˜ï¼Œå…¶å†…å®¹æ˜¯<code>Bucket</code>çš„æ ¹èŠ‚ç‚¹page idä»¥åŠåºåˆ—å·ï¼š</p>

<pre><code class="language-Go">type bucket struct {
	// æ ¹èŠ‚ç‚¹çš„page id
	root pgid // page id of the bucket's root-level page
	// å•è°ƒé€’å¢çš„åºåˆ—å·
	sequence uint64 // monotonically incrementing, used by NextSequence()
}
</code></pre>

<p>å› æ­¤ä¸Šé¢çš„æµç¨‹å°±æ˜¯ï¼šä½¿ç”¨å½“å‰çš„<code>meta</code>å…ƒä¿¡æ¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ª<code>Bucket</code>ï¼Œè¯¥<code>Bucket</code>çš„æ ¹èŠ‚ç‚¹page idä»¥åŠåºåˆ—å·ä¹Ÿéƒ½æ˜¯ä»å½“å‰dbçš„æ ¹<code>Bucket</code>ä¸­æ‹·è´çš„ã€‚</p>

<p><code>tx.init</code>å‡½æ•°çš„æœ€åï¼Œæ ¹æ®æ˜¯å¦å†™äº‹åŠ¡ï¼Œå°†æ‹·è´å›æ¥çš„<code>meta</code>ä¿¡æ¯çš„äº‹åŠ¡idé€’å¢1ï¼š</p>

<pre><code class="language-Go">func (tx *Tx) init(db *DB) {
  // ....
	// Increment the transaction id and add a page cache for writable transactions.
	if tx.writable {
		// å¦‚æœæ˜¯å†™æ“ä½œï¼Œéœ€è¦åˆ†é…é¡µé¢æ•°ç»„å†…å­˜
		tx.pages = make(map[pgid]*page)
		// é€’å¢ä¸€ä¸ªäº‹åŠ¡id
		tx.meta.txid += txid(1)
	}
  // ...
}
</code></pre>

<p>è¿™æ ·ï¼Œåœ¨æœ€åå†™äº‹åŠ¡å®Œæˆä¹‹åï¼Œå°†<code>meta</code>ä¿¡æ¯å†™å›ç£ç›˜æ—¶ï¼Œå°±æ¯”åŸå…ˆçš„äº‹åŠ¡IDåŠ ä¸€ã€‚</p>

<h1 id="äº‹åŠ¡æäº¤">äº‹åŠ¡æäº¤</h1>

<p>å‰é¢ä»‹ç»äº†äº‹åŠ¡çš„åˆå§‹åŒ–æµç¨‹ï¼Œç”±äºboltdbå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ï¼Œæ‰€ä»¥boltdbä¸­æ¶‰åŠåˆ°è¯»å†™çš„æµç¨‹å°±ä¸å†é˜è¿°ï¼ŒåŸºæœ¬å°±æ˜¯ä¸€ä¸ªB+æ ‘çš„è¯»å†™æµç¨‹ï¼Œå¦‚æœä¸æ¸…æ¥šè¿™éƒ¨åˆ†çš„åŸç†ï¼Œå¯ä»¥å»è¡¥å……ä¸€ä¸‹B+æ ‘ç›¸å…³çš„çŸ¥è¯†ï¼š</p>

<blockquote>
<ul>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>
</blockquote>

<p>åœ¨è¿™ä¸€å°èŠ‚ï¼Œåªä»‹ç»è¯»å†™æµç¨‹å®Œæ¯•ä¹‹åçš„äº‹åŠ¡æäº¤æµç¨‹ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨<code>Tx.Commit</code>å‡½æ•°ä¸­å®ç°ã€‚boltdbçš„äº‹åŠ¡æäº¤æµç¨‹å¤§ä½“åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>

<ul>
<li>B+æ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚ã€‚</li>
<li>è°ƒæ•´freelisté¡µé¢ä¿¡æ¯ã€‚</li>
<li>å°†metaä¿¡æ¯å†™å›ç£ç›˜ã€‚</li>
</ul>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200725-boltdb-3/commitTx.png" alt="commitTx" title="commitTx" />
</center></p>

<h2 id="b-æ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚">B+æ ‘çš„é‡å¹³è¡¡åŠèŠ‚ç‚¹åˆ†è£‚</h2>

<p>åœ¨å†™æ“ä½œè¿‡ç¨‹ä¸­ï¼Œä¸­é—´å¯èƒ½ä¼šé€ æˆæ ‘çš„ä¸å¹³è¡¡ï¼Œå› æ­¤åœ¨æ“ä½œå®Œæ¯•ä¹‹åï¼Œéœ€è¦å¯¹æ•´ä¸ªB+æ ‘è¿›è¡Œé‡å¹³è¡¡ï¼ˆrebalanceï¼‰æ“ä½œã€‚é‡å¹³è¡¡æ“ä½œçš„åŸç†æ¯”è¾ƒå¤æ‚ï¼Œæ˜¯ä¸€ä¸ªä»å¶å­èŠ‚ç‚¹ä¸€ç›´å¾€ä¸Šè¿›è¡Œé‡å¹³è¡¡æ“ä½œï¼Œç›´åˆ°æ»¡è¶³B+æ ‘å¹³è¡¡æ¡ä»¶çš„æµç¨‹ã€‚ç®—æ³•çš„åŸç†ä¸åœ¨è¿™é‡Œé˜è¿°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://www.codedump.info/post/20200615-btree-2/#%E5%88%A0%E9%99%A4%E7%AE%97%E6%B3%95">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰#åˆ é™¤ç®—æ³•</a>ã€‚åŸºæœ¬ä¸Šboltdbçš„é‡å¹³è¡¡æ“ä½œä¹Ÿæ˜¯è¿™ä¸ªæµç¨‹ï¼Œä¹Ÿå°±ä¸åœ¨è¿™é‡Œå±•å¼€äº†ã€‚</p>

<p>é‡å¹³è¡¡å®Œæ¯•ä¹‹åï¼Œboltdbè¿˜ä¼šå°†å¤§å°è¶…è¿‡é˜ˆå€¼çš„èŠ‚ç‚¹ï¼Œåˆ†è£‚æˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå…¶å¤§ä½“æµç¨‹æ˜¯ï¼š</p>

<ul>
<li>Bucketéå†è‡ªå·±çš„æ‰€æœ‰å­Bucketï¼Œè¿›è¡Œ<code>spill</code>åˆ†è£‚æ“ä½œã€‚å¦‚æœåˆ†è£‚æˆåŠŸï¼Œå°±éœ€è¦åœ¨çˆ¶Bucketä¸­æ›´æ–°è¯¥å­Bucketçš„ä¿¡æ¯ã€‚</li>
<li>Bucketä»è‡ªå·±çš„æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œè¿›è¡Œ<code>spill</code>åˆ†è£‚æ“ä½œã€‚</li>
<li>èŠ‚ç‚¹çš„<code>spill</code>æ“ä½œï¼Œå°†éå†è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¦‚æœä¸€ä¸ªå­èŠ‚ç‚¹å¤§å°è¶…è¿‡é˜ˆå€¼å°±è¿›è¡Œåˆ†è£‚ï¼›å¦åˆ™åˆ†è£‚ç»“æŸã€‚</li>
</ul>

<p>å¦‚æœåœ¨åˆ†è£‚æ“ä½œä¸­ï¼Œäº§ç”Ÿäº†æ–°çš„é¡µé¢ï¼Œåˆ™è¿™ä¸ªæ—¶å€™å°±ä¼šåœ¨<code>freelist</code>ä¸­åˆ†é…é¡µé¢ç»™è¿™äº›æ–°çš„é¡µé¢ã€‚ç”±äºæ¯æ¬¡å†™äº‹åŠ¡çš„<code>freelist</code>ä¿¡æ¯ï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹å‰æ˜¯åœ¨å†…å­˜é‡Œçš„ï¼Œæ‰€ä»¥ä¸€æ—¦å†™å¤±è´¥ï¼Œè¿™äº›<code>freelist</code>ä¿¡æ¯å°±å›é€€ï¼Œå¹¶ä¸å½±å“å…¶ä»–çš„æ“ä½œã€‚</p>

<h2 id="è°ƒæ•´freelisté¡µé¢ä¿¡æ¯">è°ƒæ•´freelisté¡µé¢ä¿¡æ¯</h2>

<p>åˆ°äº†è¿™ä¸€æ­¥ï¼Œå‰é¢çš„ä¸¤ä¸ªè°ƒæ•´ï¼šé‡å¹³è¡¡å’Œåˆ†è£‚é¡µé¢æ“ä½œå·²ç»å®Œæˆï¼Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿäº†æ–°çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯<code>freelist</code>ä¿¡æ¯ä¼šæœ‰æ”¹å˜ï¼Œå› æ­¤è¦ç›¸åº”çš„è°ƒæ•´<code>freelist</code>é¡µé¢ä¿¡æ¯ã€‚</p>

<p>åœ¨è¿™é‡Œé¦–å…ˆæ¥çœ‹çœ‹<code>freelist</code>ä¸­å¦‚ä½•ç»´æŠ¤é¡µé¢çš„åˆ†é…ä¿¡æ¯ï¼Œ<code>freelist</code>ä¸­åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæˆå‘˜ï¼š</p>

<ul>
<li>idsï¼šä¿å­˜å½“å‰å¯ç”¨çš„é¡µé¢IDæ•°ç»„ã€‚</li>
<li>pendingï¼špendingæ˜¯ä¸€ä¸ªmapï¼Œé”®æ˜¯äº‹åŠ¡idï¼Œå€¼ä¸ºé¡µé¢IDæ•°ç»„ï¼Œå­˜å‚¨çš„æ˜¯æ¯ä¸ªäº‹åŠ¡æ“ä½œæ—¶å€™æ¶‰åŠåˆ°çš„é¡µé¢IDã€‚</li>
<li>cacheï¼šcacheæ˜¯ä¸€ä¸ªmapï¼Œé”®ä¸ºé¡µé¢IDï¼Œå€¼ä¸ºå¸ƒå°”å€¼ï¼Œå¯ä»¥ä»è¿™é‡Œå¿«é€ŸæŸ¥çœ‹ä¸€ä¸ªé¡µé¢å½“å‰æ˜¯å¦ç©ºé—²ã€‚</li>
</ul>

<p>ä»¥ä¸Šä¸‰ä¸ªæˆå‘˜ä¸­ï¼Œ<code>cache</code>æ˜¯æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾é¡µé¢ç©ºé—²æƒ…å†µçš„æ•°æ®ï¼Œå¯ä»¥ç†è§£ä¸ºå¯ç”¨é¡µé¢çš„ç´¢å¼•ï¼›<code>ids</code>æ˜¯å­˜å‚¨å¯ç”¨é¡µé¢IDçš„æ•°ç»„ï¼Œæ¯æ¬¡åˆ†é…ä¸€ä¸ªé¡µé¢å‡ºå»å°±è¦å¯¹åº”çš„ä¿®æ”¹è¿™ä¸ªæ•°ç»„ï¼›æœ€åï¼Œ<code>pending</code>å°±æ˜¯å­˜å‚¨ä¸€ä¸ªäº‹åŠ¡æ“ä½œè¿‡ç¨‹ä¸­é—´çš„æ•°æ®ã€‚</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200725-boltdb-3/freelist.png" alt="freelist" title="freelist" />
</center></p>

<p>åœ¨ä¸Šå›¾ä¸­ï¼Œ<code>freelist</code>é¡µé¢åœ¨ç£ç›˜ä¸­å­˜å‚¨çš„å½“å‰é¡µé¢<code>id</code>çš„åˆ†é…æ•°ç»„ï¼Œæ¯ä¸€æ¬¡åˆå§‹åŒ–æ—¶å°†å¯ç”¨é¡µé¢IDè¯»å…¥<code>ids</code>æ•°ç»„ä¹‹åï¼Œéƒ½ä¼šå†è°ƒç”¨<code>freelist.reindex</code>å‡½æ•°æ¥é‡å»ºç´¢å¼•æ•°æ®ï¼š</p>

<pre><code class="language-Go">func (f *freelist) reindex() {
	f.cache = make(map[pgid]bool)
	for _, id := range f.ids {
		f.cache[id] = true
	}
	for _, pendingIDs := range f.pending {
		for _, pendingID := range pendingIDs {
			f.cache[pendingID] = true
		}
	}
}
</code></pre>

<p>å¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œå®é™…ä¸Šæ˜¯å°†<code>pending</code>ä¸­çš„é¡µé¢è¿”è¿˜å›å»ï¼Œé‡æ–°å˜æˆç©ºé—²é¡µé¢ï¼š</p>

<pre><code class="language-Go">// rollback removes the pages from a given pending tx.
func (f *freelist) rollback(txid txid) {
	// Remove page ids from cache.
	// å›æ»šå°±æ˜¯æŠŠæ‰€æœ‰å¾…é‡Šæ”¾çš„idåˆ é™¤ï¼Œè¡¨ç¤ºä¸é‡Šæ”¾äº†
	for _, id := range f.pending[txid] {
		delete(f.cache, id)
	}

	// Remove pages from pending list.
	// ç„¶ååˆ é™¤è¿™ä¸ªäº‹åŠ¡çš„pendingæ•°ç»„
	delete(f.pending, txid)
}
</code></pre>

<p>æœ‰äº†å¯¹<code>freelist</code>ç›¸å…³çš„äº†è§£ï¼Œå›åˆ°äº‹åŠ¡æäº¤æ“ä½œä¿®æ”¹<code>freelist</code>éƒ¨åˆ†ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">func (tx *Tx) Commit() error {
  // ...
  // é‡Šæ”¾freelist
	tx.db.freelist.free(tx.meta.txid, tx.db.page(tx.meta.freelist))
	// åˆ†é…ä¸€ä¸ªfreelist
	p, err := tx.allocate((tx.db.freelist.size() / tx.db.pageSize) + 1)
	if err != nil {
		tx.rollback()
		return err
	}
	if err := tx.db.freelist.write(p); err != nil {
		tx.rollback()
		return err
  }
  // ...
}  
</code></pre>

<p>åœ¨è¿™é‡Œï¼š</p>

<ul>
<li>é¦–å…ˆæ ¹æ®äº‹åŠ¡IDå°†åŸæœ‰å­˜å‚¨<code>freelist</code>é¡µé¢ä¿¡æ¯çš„é¡µé¢é‡Šæ”¾æ‰ã€‚</li>
<li>åˆ†é…å­˜å‚¨è¿™ä¸€æ¬¡å†™äº‹åŠ¡çš„é¡µé¢ä¿¡æ¯é¡µé¢ã€‚</li>
<li>å†™å…¥è¿™ä¸€æ¬¡çš„é¡µé¢ä¿¡æ¯ã€‚</li>
</ul>

<h2 id="å°†metaä¿¡æ¯å†™å›ç£ç›˜">å°†metaä¿¡æ¯å†™å›ç£ç›˜</h2>

<p>æœ€åï¼Œåœ¨æ›´æ–°å®Œæ¯•æ–°çš„<code>freelist</code>é¡µé¢ä¿¡æ¯ä¹‹åï¼Œå°±å¯ä»¥æŠŠæœ¬æ¬¡æ“ä½œä¹‹åçš„<code>meta</code>å…ƒä¿¡æ¯ä¹Ÿå†™å›ç£ç›˜äº†ã€‚</p>

<pre><code class="language-Go">// writeMeta writes the meta to the disk.
// æ›´æ–°metaæ•°æ®åˆ°ç£ç›˜
func (tx *Tx) writeMeta() error {
	// Create a temporary buffer for the meta page.
	// åˆ†é…ç¼“å†²åŒºï¼Œå¤§å°ä¸ºä¸€ä¸ªé¡µé¢
	buf := make([]byte, tx.db.pageSize)
	// è½¬æ¢æˆpageç»“æ„ä½“
	p := tx.db.pageInBuffer(buf, 0)
	// å°†äº‹åŠ¡çš„metaæ•°æ®å†™å…¥pageä¸­
	tx.meta.write(p)

	// Write the meta page to file.
	// ç¼“å†²çš„æ•°æ®å†™å…¥æ–‡ä»¶
	if _, err := tx.db.ops.writeAt(buf, int64(p.id)*int64(tx.db.pageSize)); err != nil {
		return err
	}
	if !tx.db.NoSync || IgnoreNoSync {
		if err := fdatasync(tx.db); err != nil {
			return err
		}
	}

	// Update statistics.
	tx.stats.Write++

	return nil
}
</code></pre>

<h1 id="æ€»ç»“">æ€»ç»“</h1>

<p>æ€»ç»“ä¸‹æ¥ï¼Œboltdbçš„å†™äº‹åŠ¡æ“ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹ï¼š</p>

<ul>
<li>ä½¿ç”¨å½“å‰dbæ•°æ®æ¥åˆå§‹åŒ–äº‹åŠ¡ï¼šå¤åˆ¶ä¸€ä»½å½“å‰çš„metaå…ƒä¿¡æ¯ã€åˆå§‹åŒ–æ ¹Bucketä¿¡æ¯ã€è‡ªå¢äº‹åŠ¡IDã€‚</li>
<li>å¯¹B+æ ‘è¿›è¡Œå†™æ“ä½œï¼Œè¿™éƒ¨åˆ†åœ¨æœªæäº¤ä¹‹å‰éƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ•°æ®ã€‚</li>
<li>å†™æ“ä½œå®Œæˆä¹‹åï¼Œæäº¤å†™äº‹åŠ¡ï¼š

<ul>
<li>å¹³è¡¡B+æ ‘ã€å¯¹è¶…è¿‡é˜ˆå€¼çš„èŠ‚ç‚¹è¿›è¡Œåˆ†è£‚æ“ä½œã€‚åˆ†è£‚è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°é¡µé¢å°†ä»<code>freelist</code>ä¸­åˆ†é…å‡ºæ¥ã€‚</li>
<li>ç»™<code>freelist</code>åˆ†é…æ–°çš„é¡µé¢ã€‚</li>
<li>åˆ°äº†è¿™é‡Œï¼Œå°†B+æ ‘å’Œ<code>freelist</code>æ•°æ®å†™å…¥æ–‡ä»¶ã€‚</li>
<li>æ›´æ–°metaå…ƒä¿¡æ¯å†™å…¥æ–‡ä»¶ã€‚</li>
</ul></li>
</ul>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20200711-boltdb-2/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20200726-boltdb-4/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
