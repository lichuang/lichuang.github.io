<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="boltdb 1.3.0å®ç°åˆ†æ">




<meta name="keywords" content=" boltdb  å­˜å‚¨å¼•æ“ ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸€ï¼‰" />
<meta name="twitter:description" content="æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB&#43;æ ‘ç»“" />


<link rel="canonical" href="https://www.codedump.info/post/20200625-boltdb-1/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸€ï¼‰ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸€ï¼‰</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8'>#å­˜å‚¨</a>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E'>#å­˜å‚¨å¼•æ“</a>
        
      </div>
      
      <div class="content">
        

<blockquote>
<p>æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ä½“ã€‚å…³äºetcdã€raftåè®®ä»¥åŠB+æ ‘ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p>

<ul>
<li><a href="https://www.codedump.info/post/20180921-raft/">Raftç®—æ³•åŸç†</a></li>
<li><a href="https://www.codedump.info/post/20180922-etcd-raft/">etcd Raftåº“è§£æ</a></li>
<li><a href="https://www.codedump.info/post/20181125-etcd-server/">Etcdå­˜å‚¨çš„å®ç°</a></li>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>

<p>æœ¬æ–‡çš„å†™ä½œï¼Œä¸»è¦å‚è€ƒäº†<a href="https://www.jianshu.com/p/b86a69892990">ã€ŠåŒºå—çš„æŒä¹…åŒ–ä¹‹BoltDBã€‹ç³»åˆ—æ–‡ç« </a>ä»¥åŠ<a href="https://youjiali1995.github.io/storage/boltdb">boltdb æºç åˆ†æ</a></p>
</blockquote>

<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>boltdbæ˜¯etcdé¡¹ç›®ä½¿ç”¨çš„kvå­˜å‚¨å¼•æ“ï¼Œä»£ç é‡ä¸å¤§ï¼Œä¸ç®—æµ‹è¯•ç”¨ä¾‹çš„è¯ä»…æœ‰å‡ åƒè¡Œä»£ç é‡ï¼Œæ˜¯å…¥é—¨å­˜å‚¨å¼•æ“ä¸é”™çš„å‚è€ƒé¡¹ç›®ã€‚</p>

<p>boltdbä¸­ä¸mysqlè¿™ç±»çš„å…³ç³»æ•°æ®åº“ç›¸å¯¹åº”çš„æ¦‚å¿µåˆ—ä¸¾å¦‚ä¸‹ï¼š</p>

<table>
<thead>
<tr>
<th>boltdb</th>
<th>mysql</th>
</tr>
</thead>

<tbody>
<tr>
<td>db</td>
<td>database</td>
</tr>

<tr>
<td>bucket</td>
<td>table</td>
</tr>
</tbody>
</table>

<p>å³ï¼šåœ¨boltdbä¸­ï¼Œdbä»£è¡¨ä¸€ä¸ªæ•°æ®åº“ï¼Œå¯¹åº”ä¸€ä¸ªdbæ–‡ä»¶ï¼›è€Œä¸€ä¸ªæ•°æ®åº“ä¸­å¯èƒ½æœ‰å¤šä¸ªè¡¨ï¼Œå¯¹åº”çš„æ¦‚å¿µå°±æ˜¯boltdbä¸­çš„bucketã€‚</p>

<p>å¦å¤–ï¼Œå¯¹B+æ ‘æœ‰äº†è§£çš„éƒ½çŸ¥é“ï¼ŒB+æ ‘ä¸­ä¸ºäº†å‡å°‘ç£ç›˜è¯»å†™æ¬¡æ•°ï¼Œæ¯æ¬¡è¯»å†™éƒ½æ˜¯ä»¥é¡µä¸ºå•ä½çš„ï¼Œå¯¹åº”åˆ°boltdbä¸­ç”¨<code>page</code>æ•°æ®ç»“æ„è¡¨ç¤ºï¼Œ<code>page</code>åªæ˜¯æè¿°ç£ç›˜ä¸Šä¸€ä¸ªé¡µé¢çš„æ•°æ®ç»“æ„ï¼Œå½“ä¸€ä¸ªé¡µé¢è¯»å–åˆ°å†…å­˜ä¸­æ—¶ï¼Œå°±ä½¿ç”¨<code>node</code>ç»“æ„ä½“æ¥æè¿°ã€‚å¦å¤–ï¼Œæ—¢ç„¶è½åœ°åˆ°ç£ç›˜çš„å•ä½æ˜¯é¡µï¼Œå°±éœ€è¦æœ‰æ•°æ®ç»“æ„æ¥ç®¡ç†é¡µé¢çš„åˆ†é…ï¼Œè¿™éƒ¨åˆ†ä½¿ç”¨<code>freelist</code>è¿™ä¸ªæ•°æ®ç»“æ„æ¥ç®¡ç†ã€‚</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/page-struct.png" alt="page-struct" title="page-struct" />
</center></p>

<p>ä»¥ä¸‹ï¼Œé¦–å…ˆå±•å¼€å¯¹é¡µé¢ç›¸å…³æ ¸å¿ƒæ•°æ®ç»“æ„çš„åˆ†æã€‚</p>

<h1 id="æ•°æ®åº“æ–‡ä»¶çš„ç£ç›˜å¸ƒå±€å’Œé¡µé¢">æ•°æ®åº“æ–‡ä»¶çš„ç£ç›˜å¸ƒå±€å’Œé¡µé¢</h1>

<p>å‰é¢æåˆ°è¿‡ï¼Œboltdbä¸­ä»¥é¡µé¢ä¸ºå•ä½æ¥è¿›è¡Œç£ç›˜çš„è¯»å†™æ“ä½œï¼Œä¸€ä¸ªé¡µé¢çš„å¤§å°ä¸€èˆ¬è€Œè¨€ä¸æ“ä½œç³»ç»Ÿçš„é¡µé¢ä¸€è‡´ï¼Œå³4Kå¤§å°ã€‚åœ¨boltdbä¸­ï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹çš„é¡µé¢ï¼š</p>

<ul>
<li>å­˜å‚¨metaå…ƒæ•°æ®çš„é¡µé¢ã€‚</li>
<li>å­˜å‚¨freelistï¼Œå³ç®¡ç†é¡µé¢æ•°æ®çš„é¡µé¢ã€‚</li>
<li>Branché¡µé¢ï¼Œå­˜å‚¨B+æ ‘ç´¢å¼•èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨èŠ‚ç‚¹çš„é¡µé¢ã€‚</li>
<li>Leafé¡µé¢ï¼Œå­˜å‚¨B+æ ‘æ•°æ®èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¶å­èŠ‚ç‚¹çš„é¡µé¢ã€‚</li>
</ul>

<p>boltdbä»£ç ä¸­å®šä¹‰é¡µé¢ç±»å‹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">const (
	branchPageFlag   = 0x01
	leafPageFlag     = 0x02
	metaPageFlag     = 0x04
	freelistPageFlag = 0x10
)
</code></pre>

<p>è¿™å››ç§é¡µé¢ï¼Œåœ¨boltdbçš„æ•°æ®åº“æ–‡ä»¶çš„å¸ƒå±€å¤§ä½“å¦‚ä¸‹ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/boltdb-layout.png" alt="boltdb-layout" title="boltdb-layout" />
</center></p>

<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼š</p>

<ul>
<li>æœ€å¼€å§‹çš„ä¸¤ä¸ªé¡µé¢æ˜¯ä¸¤ä¸ªmetaé¡µé¢ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªï¼Œåé¢å†å±•å¼€è®¨è®ºã€‚</li>
<li>ç´§è·Ÿç€çš„ä¸€ä¸ªé¡µé¢æ˜¯freelisté¡µé¢ã€‚</li>
<li>ä»ä¸Šé¢å¯çŸ¥ï¼Œæ•°æ®åº“æ–‡ä»¶ä¸­æœ€å¼€å§‹çš„ä¸‰ä¸ªé¡µé¢å­˜çš„éƒ½æ˜¯ç®¡ç†ä¿¡æ¯ï¼Œæ­¤åæ•°æ®æ•°æ®å‹çš„branchä»¥åŠleafé¡µé¢äº†ã€‚</li>
</ul>

<p>æ¥ä¸‹æ¥å°±è¿™å‡ ç§é¡µé¢å…·ä½“çš„ç»“æ„å±•å¼€è¯´æ˜ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰è¿˜æ˜¯é¦–å…ˆæ¥çœ‹çœ‹<code>page</code>ç»“æ„ä½“ï¼Œå®ƒç”¨äºè¡¨ç¤ºä¸€ä¸ªç£ç›˜é¡µé¢çš„æ•°æ®ç»“æ„ã€‚</p>

<h2 id="pageç»“æ„ä½“">pageç»“æ„ä½“</h2>

<p><code>page</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">type pgid uint64

type page struct {
    id       pgid
    flags    uint16
    count    uint16
    overflow uint32
    ptr      uintptr
}
</code></pre>

<p>å…¶ä¸­ï¼š</p>

<ul>
<li>idï¼šé¡µé¢IDã€‚</li>
<li>flagsï¼šæ ‡å¿—ä½ï¼Œä¸åŒç±»å‹çš„é¡µé¢ç”¨ä¸åŒçš„æ ‡å¿—ä½æ¥åŒºåˆ†ã€‚åˆ†ä¸ºï¼šmetaPageFlagã€freelistPageFlagã€branchPageFlagã€leafPageFlagã€‚</li>
<li>countï¼šé¡µé¢ä¸­å­˜å‚¨çš„æ•°æ®æ•°é‡ï¼Œä»…åœ¨é¡µé¢ç±»å‹æ˜¯branchä»¥åŠleafçš„æ—¶å€™èµ·ä½œç”¨ã€‚</li>
<li>overflowï¼šå½“å‰é¡µé¢å¦‚æœè¿˜ä¸å¤Ÿå­˜æ”¾æ•°æ®ï¼Œå°±ä¼šæœ‰åç»­é¡µé¢ï¼Œè¿™ä¸ªå­—æ®µè¡¨ç¤ºåç»­é¡µé¢çš„æ•°é‡ã€‚</li>
<li>ptrï¼šæŒ‡å‘é¡µè¡¨å¤´æ•°æ®ç»“å°¾ï¼Œä¹Ÿå°±æ˜¯é¡µé¢æ•°æ®çš„èµ·å§‹ä½ç½®ã€‚ä¸€ä¸ªé¡µé¢çš„é¡µè¡¨å¤´ç”±å‰é¢çš„idã€flagsã€countå’Œoverflowå­—æ®µæ„æˆï¼Œè€Œptrå¹¶ä¸æ˜¯é¡µè¡¨å¤´çš„ä¸€éƒ¨åˆ†ã€‚</li>
</ul>

<p>æ ¹æ®ä»¥ä¸Šçš„åˆ†æï¼Œä¸€ä¸ªé¡µé¢çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/page-layout.png" alt="page-layout" title="page-layout" />
</center></p>

<p>æœ‰äº†å¯¹é¡µé¢çš„åˆæ­¥è®¤è¯†ï¼Œæ¥ç€ä¸‹æ¥çœ‹å…·ä½“çš„å‡ ç§ä¸åŒç±»å‹é¡µé¢çš„æ ¼å¼ã€‚</p>

<h2 id="metaé¡µé¢">metaé¡µé¢</h2>

<p>metaé¡µé¢ç”¨äºå­˜å‚¨è¡¨ç¤ºæ•´ä¸ªæ•°æ®åº“ä¿¡æ¯çš„å…ƒæ•°æ®ï¼Œå…¶æ ¼å¼å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">type meta struct {
    magic    uint32
    version  uint32
    pageSize uint32
    flags    uint32
    root     bucket
    freelist pgid
    pgid     pgid
    txid     txid
    checksum uint64
}
</code></pre>

<p>å…¶ä¸­ï¼š</p>

<ul>
<li>magicï¼šboltdbçš„magic numberï¼Œå€¼ä¸ºâ€œ0xED0CDAEDâ€ã€‚</li>
<li>versionï¼šboltdbçš„ç‰ˆæœ¬å·ï¼Œå½“å‰ä¸º2ã€‚</li>
<li>pageSizeï¼šboltdbæ–‡ä»¶çš„é¡µé¢å¤§å°ã€‚</li>
<li>flagsï¼šä¿ç•™å­—æ®µï¼Œæš‚æ—¶æœªä½¿ç”¨ã€‚</li>
<li>rootï¼šä¿å­˜boltdbçš„æ ¹bucketçš„ä¿¡æ¯ï¼Œåç»­ä»‹ç»bucketæ—¶è¯¦ç»†å±•å¼€ã€‚</li>
<li>freelistï¼šä¿å­˜freelisté¡µé¢çš„é¡µé¢IDã€‚</li>
<li>pgidï¼šä¿å­˜å½“å‰æ€»çš„é¡µé¢æ•°é‡ï¼Œå³æœ€å¤§é¡µé¢å·åŠ ä¸€ã€‚</li>
<li>txidï¼šä¸Šä¸€æ¬¡å†™æ•°æ®åº“çš„äº‹åŠ¡IDï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰boltdbçš„ä¿®æ”¹ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å†™æ•°æ®åº“æ—¶åŠ 1ï¼Œåªè¯»æ—¶ä¸æ”¹å˜ã€‚</li>
<li>checksumï¼šæ ¡éªŒç ï¼Œç”¨äºæ ¡éªŒå…ƒæ•°æ®é¡µé¢æ˜¯å¦å‡ºé”™çš„ã€‚</li>
</ul>

<p>ä»ä¸Šé¢å¯¹<code>page</code>ç»“æ„ä½“çš„åˆ†æï¼ŒptræŒ‡å‘å…·ä½“çš„é¡µé¢æ•°æ®å†…å®¹ï¼Œæ®æ­¤ï¼Œä»<code>page</code>ç»“æ„ä½“ä¸­è¿”å›<code>meta</code>æŒ‡é’ˆçš„å‡½æ•°å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">func (p *page) meta() *meta {
    return (*meta)(unsafe.Pointer(&amp;p.ptr))
}
</code></pre>

<p>å³ï¼šå°†<code>page</code>çš„ptræŒ‡é’ˆè½¬æ¢ä¸º<code>meta</code>ç±»å‹è¿”å›ã€‚</p>

<p>å› æ­¤ï¼Œä¸€ä¸ª<code>meta</code>é¡µé¢çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/meta-page-layout.png" alt="meta-page-layout" title="meta-page-layout" />
</center></p>

<h2 id="freelisté¡µé¢">freelisté¡µé¢</h2>

<p>æ¥ä¸‹æ¥çœ‹freelisté¡µé¢çš„æ„æˆã€‚ç”±äºboltdbç£ç›˜åˆ†é…çš„å•ä½æ˜¯é¡µé¢ï¼Œæ‰€ä»¥å½“å‰å“ªäº›é¡µé¢å¯ç”¨ã€å“ªäº›é—²ç½®ï¼Œå°±éœ€è¦ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„æ¥æè¿°ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯å°±ç”±freelisté¡µé¢æ¥ç»´æŠ¤ã€‚å¦‚æœå½“å‰ç£ç›˜é¡µé¢å·²ç»ä¸å¤Ÿåˆ†é…äº†ï¼Œboltdbå°±éœ€è¦æ‰©å¤§ç£ç›˜æ–‡ä»¶çš„å¤§å°ï¼Œåˆ›å»ºå‡ºæ›´å¤šå¯ç”¨çš„é—²ç½®é¡µé¢ä¾›åˆ†é…ã€‚</p>

<p>æ¥çœ‹freelistçš„æ•°æ®ç»“æ„å®šä¹‰ï¼š</p>

<pre><code class="language-Go">type freelist struct {
	ids     []pgid          // all free and available free page ids.
	pending map[txid][]pgid // mapping of soon-to-be free page ids by tx.
	cache   map[pgid]bool   // fast lookup of all free and pending page ids.
}
</code></pre>

<p>å…¶ä¸­ï¼š</p>

<ul>
<li>idsï¼šä¿å­˜å½“å‰é—²ç½®é¡µé¢idçš„æ•°ç»„ã€‚</li>
<li>pendingï¼šä¿å­˜äº‹åŠ¡æ“ä½œå¯¹åº”çš„é¡µé¢IDï¼Œé”®ä¸ºäº‹åŠ¡IDï¼Œå€¼ä¸ºé¡µé¢IDæ•°ç»„ã€‚è¿™éƒ¨åˆ†çš„é¡µé¢IDï¼Œåœ¨äº‹åŠ¡æ“ä½œå®Œæˆä¹‹åå³è¢«é‡Šæ”¾ã€‚</li>
<li>cacheï¼šæ ‡è®°ä¸€ä¸ªé¡µé¢IDå¯ç”¨ï¼Œå³è¿™ä¸ªæˆå‘˜ä¸­çš„æ‰€æœ‰é”®éƒ½æ˜¯é¡µé¢IDï¼Œè€Œè¿™äº›é¡µé¢IDå½“å‰éƒ½æ˜¯é—²ç½®å¯åˆ†é…ä½¿ç”¨çš„ã€‚</li>
</ul>

<p>åœ¨è¿™ä¸‰ä¸ªæˆå‘˜ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æˆå‘˜éƒ½æ˜¯éœ€è¦ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„æ•°æ®ï¼Œå®é™…ä¸Šè¯»å†™freelisté¡µé¢æ—¶æ˜¯è¿™æ ·æ“ä½œçš„ï¼š</p>

<ul>
<li>è¯»é¡µé¢å†…å®¹åˆ°å†…å­˜ï¼šå¯¹åº”æ“ä½œåœ¨<code>freelist.read</code>ä¸­ï¼Œé¡µé¢æ•°æ®éƒ¨åˆ†ä¿å­˜çš„æ˜¯å½“å‰é—²ç½®é¡µé¢IDæ•°ç»„ï¼Œå°†å…¶è¯»å…¥<code>ids</code>æˆå‘˜ä¸­ã€‚</li>
<li>å†™é¡µé¢å†…å®¹åˆ°ç£ç›˜ï¼šå¯¹åº”æ“ä½œåœ¨<code>freelist.write</code>ä¸­ï¼Œè¯»å–<code>ids</code>æ•°ç»„å’Œ<code>pending</code>ä¸­çš„é¡µé¢idï¼Œæ‹¼æ¥ã€æ’åºä¹‹ååœ¨ä¸€èµ·å†™å…¥ç£ç›˜ã€‚</li>
</ul>

<p>å³ï¼šfreelisté¡µé¢çš„æ•°æ®éƒ¨åˆ†ï¼Œä»…å­˜å‚¨çš„æ˜¯å¯ç”¨çš„é¡µé¢IDæ•°ç»„ã€‚è¿™ä¸€éƒ¨åˆ†åœ¨è¯»å–åˆ°å†…å­˜æ—¶ï¼Œå†™å…¥<code>ids</code>æˆå‘˜ä¸­ï¼Œè€Œ<code>pending</code>å’Œ<code>cache</code>ï¼Œéƒ½æ˜¯boltdbåˆ†é…é¡µé¢æµç¨‹ä¸­çš„ä¸­é—´äº§ç‰©ã€‚</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/freelist-page-layout.png" alt="freelist-page-layout" title="freelist-page-layout" />
</center></p>

<p><code>freelist</code>ä¸­çš„ä¸€äº›æ“ä½œä¸äº‹åŠ¡æœ‰å…³ï¼Œè¿™é‡Œæš‚æ—¶ä¸å±•å¼€è¿™éƒ¨åˆ†çš„è®¨è®ºï¼Œå…ˆæ¥çœ‹çœ‹åŸºæœ¬çš„é¡µé¢åˆ†é…æ˜¯æ€ä¹ˆå®Œæˆçš„ã€‚</p>

<p><code>freelist</code>å¯¹å¤–æä¾›<code>allocate</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•´æ•°nï¼Œè¡¨ç¤ºå¸Œæœ›èƒ½åˆ†é…è¿ç»­çš„nä¸ªé¡µé¢ï¼Œè¿”å›è¿™äº›é¡µé¢ä¸­ç¬¬ä¸€ä¸ªé¡µé¢çš„é¡µé¢IDã€‚å®é™…æƒ…å†µè‚¯å®šä¸æ˜¯æ¯æ¬¡è¿™æ ·åˆ†é…å°±èƒ½æˆåŠŸçš„ï¼Œåœ¨ä¸æˆåŠŸçš„æ—¶å€™ï¼Œboltdbå°±åªèƒ½å†è¿›è¡Œ<code>mmap</code>æ“ä½œï¼Œæ‰©å¤§æ•°æ®åº“ç£ç›˜æ–‡ä»¶çš„å¤§å°äº†ï¼š</p>

<pre><code class="language-Go">// allocate returns a contiguous block of memory starting at a given page.
func (db *DB) allocate(count int) (*page, error) {
  // ...
	// Use pages from the freelist if they are available.
	// åˆ†é…é¡µé¢idï¼Œä¼ å…¥çš„countè¡¨ç¤ºéœ€è¦å¤šå°‘ä¸ªè¿ç»­çš„id
	if p.id = db.freelist.allocate(count); p.id != 0 {
		return p, nil
	}

	// å‰é¢åˆ†é…é¡µé¢idå¤±è´¥ï¼Œè¯´æ˜å½“å‰å·²ç»ä¸å¤Ÿç”¨äº†ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°mmapåˆ†é…æ›´å¤§çš„ç©ºé—´å‡ºæ¥

	// Resize mmap() if we're at the end.
	p.id = db.rwtx.meta.pgid
	// è®¡ç®—éœ€è¦çš„æœ€å°æ–‡ä»¶å¤§å°
	var minsz = int((p.id+pgid(count))+1) * db.pageSize
	// å¦‚æœå¤§äºå½“å‰æ–‡ä»¶å¤§å°ï¼Œéœ€è¦é‡æ–°åˆ†é…
	if minsz &gt;= db.datasz {
		if err := db.mmap(minsz); err != nil {
			return nil, fmt.Errorf(&quot;mmap allocate error: %s&quot;, err)
		}
	}

	// Move the page id high water mark.
	// ä¿å­˜ç›®å‰æœ€é«˜çš„é¡µé¢id
	db.rwtx.meta.pgid += pgid(count)

	return p, nil  
}
</code></pre>

<p>ä»ä»¥ä¸Šä»£ç å¯ä»¥çœ‹åˆ°ï¼š</p>

<ul>
<li>é¦–å…ˆè°ƒç”¨<code>freelist.allocate</code>åˆ†é…countä¸ªè¿ç»­é¡µé¢ï¼Œè¿”å›èµ·å§‹é¡µé¢IDã€‚</li>
<li>è¿™ä¸ªè¿‡ç¨‹ä¸€æ—¦å¤±è´¥ï¼Œæ„å‘³ç€å½“å‰ç³»ç»Ÿä¸­å·²ç»æ²¡æœ‰äº†countä¸ªè¿ç»­é¡µé¢ï¼Œæ­¤æ—¶è®¡ç®—æ»¡è¶³æ¡ä»¶éœ€è¦çš„æœ€å°æ–‡ä»¶å¤§å°ï¼Œå¦‚æœè¶…è¿‡äº†å½“å‰æ•°æ®åº“æ–‡ä»¶å¤§å°ï¼Œå°±è°ƒç”¨<code>db.mmap</code>å‡½æ•°å¯¹ç£ç›˜æ–‡ä»¶æ‰©å®¹ã€‚</li>
</ul>

<p>ç»§ç»­çœ‹<code>db.mmap</code>å‡½æ•°çš„å®ç°ï¼Œè¿™é‡Œä»…ä»…åˆ—ä¸¾å‡ºæ ¸å¿ƒçš„ä»£ç ï¼š</p>

<pre><code>// mmap opens the underlying memory-mapped file and initializes the meta references.
// minsz is the minimum size that the new mmap can be.
func (db *DB) mmap(minsz int) error {
	// Unmap existing data before continuing.
	if err := db.munmap(); err != nil {
		return err
	}

	// Memory-map the data file as a byte slice.
	if err := mmap(db, size); err != nil {
		return err
	}

	// Save references to the meta pages.
	// å‰ä¸¤é¡µæ˜¯ä¸¤ä¸ªmetaæ•°æ®
	db.meta0 = db.page(0).meta()
	db.meta1 = db.page(1).meta()
}
</code></pre>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼š</p>

<ul>
<li>mmapæ“ä½œä¹‹å‰é¦–å…ˆè°ƒç”¨<code>munmap</code>å‡½æ•°å–æ¶ˆå†…å­˜æ˜ å°„ï¼Œå†é‡æ–°è°ƒç”¨ä¸€æ¬¡<code>mmap</code>å‡½æ•°æ‰©å¤§æ–‡ä»¶å¤§å°ä¹‹åæ˜ å°„è¿›å…¥å†…å­˜ã€‚</li>
<li>ç”±äºä»¥ä¸Šçš„æ“ä½œï¼Œç£ç›˜å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆè‚¯å®šå°±éœ€è¦æ›´æ–°<code>meta</code>é¡µé¢ä¿¡æ¯ã€‚</li>
</ul>

<h2 id="branché¡µé¢">branché¡µé¢</h2>

<p>branché¡µé¢å°±æ˜¯ç”¨äºå­˜å‚¨B+æ ‘ä¸­çš„å†…éƒ¨èŠ‚ç‚¹çš„é¡µé¢ï¼Œå³è¿™é‡Œçš„æ•°æ®åªæœ‰ç´¢å¼•æ•°æ®ï¼Œç”±äºåªæœ‰ç´¢å¼•æ•°æ®ï¼Œæ‰€ä»¥branchä¸­å¹¶ä¸ä¼šå­˜å‚¨å€¼ã€‚</p>

<p>branché¡µé¢çš„æ•°æ®éƒ¨åˆ†åˆ’åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>

<ul>
<li>branchPageElementæ•°ç»„ï¼Œå³å­˜å‚¨æ¯ä¸ªbranchå…ƒç´ çš„å…ƒä¿¡æ¯ã€‚</li>
<li>çœŸå®çš„æ•°æ®éƒ¨åˆ†ã€‚</li>
</ul>

<p>æ¥çœ‹çœ‹<code>branchPageElement</code>ç»“æ„ä½“çš„å®šä¹‰ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰æ¯ä¸ªbranchä¸­çš„å…ƒç´ çš„ä¿¡æ¯ï¼š</p>

<pre><code class="language-Go">// branchPageElement represents a node on a branch page.
type branchPageElement struct {
	pos   uint32
	ksize uint32
	pgid  pgid
}
</code></pre>

<p>å…¶ä¸­ï¼š</p>

<ul>
<li>posï¼šå­˜å‚¨é”®ç›¸å¯¹äºå½“å‰é¡µé¢æ•°æ®éƒ¨åˆ†çš„åç§»é‡ã€‚</li>
<li>ksizeï¼šé”®çš„å¤§å°ã€‚</li>
<li>pgidï¼šå­èŠ‚ç‚¹çš„é¡µé¢IDã€‚</li>
</ul>

<p>branché¡µé¢çš„æ ¼å¼å¸ƒå±€ä¹Ÿå¯ä»¥ä»<code>page</code>åºåˆ—åŒ–åˆ°å†…å­˜ä¸­çš„<code>node</code>ç»“æ„ä½“çš„ä»£ç ä¸­çœ‹å‡ºï¼Œä»¥ä¸‹åˆ—å‡ºæ ¸å¿ƒçš„å‡ ä¸ªå‡½æ•°ï¼š</p>

<pre><code class="language-Go">// branchPageElement retrieves the branch node by index
func (p *page) branchPageElement(index uint16) *branchPageElement {
	return &amp;((*[0x7FFFFFF]branchPageElement)(unsafe.Pointer(&amp;p.ptr)))[index]
}

func (n *branchPageElement) key() []byte {
	buf := (*[maxAllocSize]byte)(unsafe.Pointer(n))
	return (*[maxAllocSize]byte)(unsafe.Pointer(&amp;buf[n.pos]))[:n.ksize]
}

func (n *node) read(p *page) {
	for i := 0; i &lt; int(p.count); i++ {
		inode := &amp;n.inodes[i]
		if n.isLeaf {
		} else {
			elem := p.branchPageElement(uint16(i))
			inode.pgid = elem.pgid
			inode.key = elem.key()
		}
	}
}
</code></pre>

<p>ä»¥ä¸Šä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>

<ul>
<li>æ ¹æ®<code>page.branchPageElement</code>å‡½æ•°çš„å®ç°ï¼Œåœ¨branchç±»å‹çš„é¡µé¢ä¸­ï¼Œ<code>page.ptr</code>å®é™…ä¸ŠæŒ‡å‘çš„æ˜¯ä¸€ä¸ª<code>branchPageElement</code>ç±»å‹çš„æ•°ç»„ï¼Œäºæ˜¯å°†<code>ptr</code>æŒ‡é’ˆè½¬æ¢æˆ<code>branchPageElement</code>æ•°ç»„ç±»å‹ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ç´¢å¼•å€¼å–åˆ°å¯¹åº”ä½ç½®çš„<code>branchPageElement</code>ã€‚</li>
<li>è€Œæ ¹æ®<code>branchPageElement.key</code>å‡½æ•°çš„å®ç°ï¼Œä¸€ä¸ª<code>branchPageElement</code>çš„<code>key</code>ï¼Œä½ç½®åœ¨è¿™ä¸ªå…ƒç´ çš„<code>pos</code>ä½ç½®å¼€å§‹ï¼Œé•¿åº¦ä¸º<code>key</code>ã€‚</li>
</ul>

<p>å› æ­¤ï¼Œbranché¡µé¢çš„æ ¼å¼å¦‚ä¸‹å›¾ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/branch-page-layout.png" alt="branch-page-layout" title="branch-page-layout" />
</center></p>

<h2 id="leafé¡µé¢">leafé¡µé¢</h2>

<p>leafé¡µé¢å°±æ˜¯B+æ ‘ä¸­å­˜å‚¨æ•°æ®çš„å¶å­èŠ‚ç‚¹ï¼Œå…¶é¡µé¢å…ƒç´ å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">// leafPageElement represents a node on a leaf page.
type leafPageElement struct {
	flags uint32
	pos   uint32
	ksize uint32
	vsize uint32
}
</code></pre>

<p>ä¸branchä¸åŒçš„æ˜¯ï¼Œleafé¡µé¢å…ƒç´ æœ‰ä»¥ä¸‹æˆå‘˜ï¼š</p>

<ul>
<li>flagsï¼šæ ‡å¿—ä½ï¼Œä¸º0çš„æ—¶å€™è¡¨ç¤ºå°±æ˜¯æ™®é€šçš„å¶å­èŠ‚ç‚¹ï¼Œè€Œä¸º1çš„æ—¶å€™è¡¨ç¤ºæ˜¯å­bucketï¼Œå­bucketåé¢å†å±•å¼€è¯´æ˜ã€‚</li>
<li>vsizeï¼šå­˜å‚¨æ•°æ®çš„å¤§å°ã€‚</li>
</ul>

<p>ä¸branché¡µé¢ç±»ä¼¼ï¼Œleafé¡µé¢ä¹Ÿåˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š</p>

<ul>
<li>å­˜å‚¨<code>leafPageElement</code>ç±»å‹æ•°æ®çš„æ•°ç»„ã€‚</li>
<li>å­˜å‚¨keyã€valueæ•°æ®çš„æ•°ç»„ã€‚</li>
</ul>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒleafèŠ‚ç‚¹å…ƒç´ ä¸branchèŠ‚ç‚¹å…ƒç´ ç±»ä¼¼ï¼Œåœ¨è¿™é‡Œå°±ä¸å†åŠ ä»¥è¯´æ˜ï¼Œä»…æŠŠæ ¼å¼ç¤ºæ„å›¾åˆ—åœ¨ä¸‹é¢ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å‚è€ƒä»£ç é˜…è¯»ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200625-boltdb-1/leaf-page-layout.png" alt="leaf-page-layout" title="leaf-page-layout" />
</center></p>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20200620-sgfap-loadavg/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20200711-boltdb-2/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
