<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="Nginxæºç é˜…è¯»ç¬”è®°-Master Wokerè¿›ç¨‹æ¨¡å‹">




<meta name="keywords" content=" Nginx  è¿›ç¨‹æ¨¡å‹ ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Nginxæºç é˜…è¯»ç¬”è®°-Master Wokerè¿›ç¨‹æ¨¡å‹" />
<meta name="twitter:description" content="masterè¿›ç¨‹ Nginxé‡‡ç”¨çš„æ¨¡å‹æ˜¯master-workeræ¨¡å‹ï¼Œå³ï¼š ç”±masterè¿›ç¨‹è´Ÿè´£åˆ›å»ºworkerè¿›ç¨‹ï¼Œä»¥åŠç›‘æ§workerè¿›" />


<link rel="canonical" href="https://www.codedump.info/post/20190131-nginx-master-worker/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>Nginxæºç é˜…è¯»ç¬”è®°-Master Wokerè¿›ç¨‹æ¨¡å‹ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>Nginxæºç é˜…è¯»ç¬”è®°-Master Wokerè¿›ç¨‹æ¨¡å‹</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/nginx'>#nginx</a>
        
      </div>
      
      <div class="content">
        

<h1 id="masterè¿›ç¨‹">masterè¿›ç¨‹</h1>

<p>Nginxé‡‡ç”¨çš„æ¨¡å‹æ˜¯master-workeræ¨¡å‹ï¼Œå³ï¼š</p>

<ul>
<li>ç”±masterè¿›ç¨‹è´Ÿè´£åˆ›å»ºworkerè¿›ç¨‹ï¼Œä»¥åŠç›‘æ§workerè¿›ç¨‹çš„æƒ…å†µï¼Œå¦‚éœ€è¦æ›´æ–°é…ç½®çš„æƒ…å†µä¸‹å‘æ¶ˆæ¯ç»™workerè¿›ç¨‹é‡æ–°åŠ è½½é…ç½®ç­‰ã€‚</li>
<li>masterè¿›ç¨‹è´Ÿè´£å…·ä½“ç½‘ç»œäº‹ä»¶ã€‚</li>
</ul>

<p>å°†é‡Œé¢æ ¸å¿ƒçš„æµç¨‹å’Œå‡½æ•°æŠ½å–å‡ºæ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190131-nginx-master-worker/master-worker.png" alt="master-worker" title="master-worker" /></p>

<ul>
<li>masterè¿›ç¨‹çš„ä¸»å¾ªç¯åœ¨å‡½æ•°ngx_master_process_cycleä¸­ï¼Œä¸»è¦è´Ÿè´£ï¼š

<ul>
<li>è°ƒç”¨ngx_start_worker_processeså‡½æ•°åˆ›å»ºworkerå­è¿›ç¨‹ã€‚</li>
<li>ç›‘æ§å„ç§ä¿¡å·é‡çš„å˜åŒ–åšå¤„ç†ï¼Œæ¯”å¦‚éœ€è¦åœæ­¢è¿›ç¨‹ã€é‡æ–°åŠ è½½é…ç½®ç­‰ã€‚</li>
</ul></li>
<li>masterè¿›ç¨‹æœ€ç»ˆä¼šè°ƒç”¨å‡½æ•°ngx_spawn_processå‡½æ•°æ¥åˆ›å»ºå‡ºworkerå­è¿›ç¨‹ï¼š

<ul>
<li>ä½¿ç”¨å…±äº«å†…å­˜åˆ›å»ºå‡ºç”¨äºmaster-workerè¿›ç¨‹ä¹‹é—´é€šä¿¡çš„channelã€‚</li>
<li>forkå‡ºå­è¿›ç¨‹ä¹‹åï¼Œè¿›å…¥workerè¿›ç¨‹çš„ä¸»å‡½æ•°ngx_worker_process_cycleã€‚</li>
</ul></li>
</ul>

<p>ä»¥ä¸‹åˆ—ä¸¾å‡ºå‡ ä¸ªç›¸å…³çš„ä¿¡å·é‡ï¼š</p>

<table>
<thead>
<tr>
<th>ä¿¡å·</th>
<th>å¯¹åº”å…¨å±€å˜é‡</th>
<th>å¤„ç†</th>
</tr>
</thead>

<tbody>
<tr>
<td>QUIT</td>
<td>ngx_quit</td>
<td>ä¼˜é›…å…³é—­æ•´ä¸ªNginxæœåŠ¡</td>
</tr>

<tr>
<td>TERMæˆ–è€…INT</td>
<td>ngx_terminate</td>
<td>å¼ºåˆ¶å…³é—­NginxæœåŠ¡</td>
</tr>

<tr>
<td>USR1</td>
<td>ngx_reopen</td>
<td>é‡æ–°æ‰“å¼€æ–‡ä»¶</td>
</tr>

<tr>
<td>WINCH</td>
<td>ngx_noaccept</td>
<td>æ‰€æœ‰workerè¿›ç¨‹ä¸å†æ¥å—æ–°çš„è¿æ¥ï¼Œç›¸å½“äºç»™å­è¿›ç¨‹å‘é€QUITä¿¡å·</td>
</tr>

<tr>
<td>USR2</td>
<td>ngx_change_binary</td>
<td>å¹³æ»‘å‡çº§åˆ°æ–°çš„NginxäºŒè¿›åˆ¶æ–‡ä»¶</td>
</tr>

<tr>
<td>HUP</td>
<td>ng_reconfigure</td>
<td>é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</td>
</tr>

<tr>
<td>CHLD</td>
<td>ngx_reap</td>
<td>éœ€è¦ç›‘æ§æ‰€æœ‰å­è¿›ç¨‹</td>
</tr>
</tbody>
</table>

<h1 id="workerè¿›ç¨‹">workerè¿›ç¨‹</h1>

<p>workerè¿›ç¨‹çš„å‡½æ•°å…¥å£åœ¨ngx_worker_process_cycleä¸­ï¼Œå…¶ä¸»è¦åšçš„å·¥ä½œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>

<ul>
<li>è°ƒç”¨ngx_process_events_and_timerså¤„ç†IOäº‹ä»¶ä»¥åŠå®šæ—¶å™¨äº‹ä»¶ã€‚</li>
<li>åˆ¤æ–­ngx_terminateã€ngx_quitã€ngx_reopenè¿™å‡ ä¸ªå˜é‡æ˜¯å¦è¢«ç½®ä½æ¥åšç›¸åº”çš„å¤„ç†ã€‚</li>
</ul>

<p>ä¸‹é¢ä¸»è¦è°ˆç½‘ç»œIOäº‹ä»¶çš„å¤„ç†ï¼Œå³ngx_process_events_and_timerså‡½æ•°ã€‚</p>

<p>å…ˆæ¥ä»‹ç»å‡ ä¸ªä¸æ¥æ”¶è¿æ¥ç›¸å…³çš„å…¨å±€å˜é‡ï¼š</p>

<ul>
<li>ngx_use_accept_mutexï¼šç”±é…ç½®é¡¹accept_mutexé…ç½®ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦ä½¿ç”¨accepté”ï¼Œåªæœ‰æŠ¢åˆ°è¯¥é”çš„workeræ‰å…è®¸æ¥æ”¶æ–°çš„è¿æ¥ã€‚</li>
<li>ngx_accept_mutex_delayï¼šç”±é…ç½®é¡¹accept_mutex_delayé…ç½®ï¼Œåœ¨å¼€å¯accept_mutexçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªworkerè¿›ç¨‹åœ¨æŠ¢ä¸åˆ°accepté”çš„æƒ…å†µä¸‹ï¼Œæœ€é•¿å¤šå°‘æ—¶é—´æ‰é‡æ–°æ¥æ”¶æ–°çš„è¿æ¥ã€‚</li>
<li>ngx_accept_disabledï¼šå€¼ä¸ºngx_cycle-&gt;connection_n / 8 - ngx_cycle-&gt;free_connection_nï¼Œå¯ä»¥çœ‹åˆ°å½“é“¾æ¥æ•°é‡åˆ°nginx.confä¸­é…ç½®çš„worker_connectionsçš„7/8ä»¥ä¸Šæ—¶ï¼Œè¿™ä¸ªå˜é‡ngx_accept_disabledä¸ºæ­£æ•°ï¼Œæ­¤æ—¶ä¸ä¼šæ¥æ”¶æ–°çš„è¿æ¥ï¼Œç›´åˆ°è¯¥å€¼å°äºç­‰äº0ä¸ºæ­¢ã€‚</li>
<li>ngx_accept_mutex_heldï¼šè¡¨ç¤ºæ˜¯å¦æŠ¢åˆ°äº†accepté”ï¼Œåªæœ‰æŠ¢åˆ°çš„æ‰èƒ½æ¥æ”¶æ–°è¿æ¥ã€‚</li>
</ul>

<p>å…·ä½“æ¥çœ‹çœ‹ngx_process_events_and_timerså‡½æ•°ä¸­ä¸æ¥æ”¶è¿æ¥ç›¸å…³çš„é€»è¾‘ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">å¦‚æœå¼€å¯äº†accept_mutexé…ç½®ï¼š
  å¦‚æœå½“å‰ngx_accept_disabledå¤§äº0ï¼Œè¡¨ç¤ºä¸èƒ½æ¥æ”¶æ–°çš„è¿æ¥ï¼Œç›´æ¥è¿”å›ã€‚
  å¦åˆ™å°è¯•è·å–accept mutexã€‚
  å¦‚æœè·å–accept mutexé”æˆåŠŸï¼š
    å°†è°ƒç”¨äº‹ä»¶è½®è¯¢å‡½æ•°çš„æ ‡å¿—ä½åŠ ä¸ŠNGX_POST_EVENTSæ ‡å¿—
  å¦‚æœè·å–å¤±è´¥ï¼š
    è°ƒç”¨äº‹ä»¶è½®è¯¢å‡½æ•°çš„äº‹ä»¶å‚æ•°ä¸å¾—è¶…è¿‡ngx_accept_mutex_delayå€¼ã€‚

  è°ƒç”¨ngx_process_eventså‡½æ•°å¤„ç†è½®è¯¢äº‹ä»¶

  è°ƒç”¨ngx_event_process_posted(cycle, &amp;ngx_posted_accept_events)å‡½æ•°å¤„ç†acceptäº‹ä»¶

  å¦‚æœå‰é¢æ‹¿åˆ°äº†accept mutexé”ï¼Œåˆ™é‡Šæ”¾è¿™ä¸ªé”ï¼Œå¥½è®©å…¶ä»–workerä¹Ÿæœ‰æœºä¼šæ¥æ”¶æ–°çš„è¿æ¥

  è°ƒç”¨ngx_event_expire_timerså¤„ç†å®šæ—¶å™¨äº‹ä»¶

  è°ƒç”¨ngx_event_process_posted(cycle, &amp;ngx_posted_events);å‡½æ•°å¤„ç†é™¤äº†acceptäº‹ä»¶ä»¥å¤–çš„å…¶ä»–postäº‹ä»¶
</code></pre>

<p>åœ¨ngx_process_eventså¤„ç†å‡½æ•°ä¸­ï¼Œå½“ä¼ å…¥çš„flagsæœ‰NGX_POST_EVENTSæ ‡å¿—æ—¶ï¼Œæ„å‘³ç€å¹¶ä¸é©¬ä¸Šåœ¨è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨äº‹ä»¶çš„å›è°ƒå‡½æ•°è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå›å¤´åœ¨åé¢çš„ngx_event_process_postedå‡½æ•°ä¸­å†è¿›è¡Œå¤„ç†ã€‚</p>

<p>è€Œè¿™é‡Œçš„é˜Ÿåˆ—åˆ†ä¸ºä¸¤ç±»ï¼š</p>

<ul>
<li>ngx_posted_accept_eventsç”¨äºå­˜æ”¾æ¥æ”¶æ–°è¿æ¥äº‹ä»¶ã€‚</li>
<li>ngx_posted_eventsç”¨äºå­˜æ”¾é™¤äº†acceptä¹‹å¤–çš„å…¶ä»–äº‹ä»¶ã€‚</li>
</ul>

<p>è¿™æ ·çš„åšæ³•ï¼Œæ˜¯ä¸ºäº†å°†æ¥æ”¶æ–°è¿æ¥çš„äº‹ä»¶ä¼˜å…ˆçº§æ”¾åœ¨å…¶ä»–IOäº‹ä»¶ä»¥åŠå®šæ—¶å™¨äº‹ä»¶ä¹‹å‰ã€‚</p>

<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œå†è¯¦ç»†å±•å¼€äº‹ä»¶æ¨¡å—çš„åˆ†æã€‚</p>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20190123-libuv/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20190131-nginx-event/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
