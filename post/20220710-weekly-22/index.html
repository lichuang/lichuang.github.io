<!DOCTYPE html>
<html
  lang="zh"
  dir="ltr"
  
><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>周刊（第22期）：图解一致性模型 - codedump的网络日志</title>

<meta name="generator" content="Hugo Eureka 0.9.1" />
<link rel="stylesheet" href="https://www.codedump.info/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css">
<script defer src="https://www.codedump.info/js/eureka.min.a3e627c430c1281e6e0f18283a36c9cd4ddd90b993c45656c2290b897d81d6b0753b8fd02dc595974e0b8afcb4e8e1ea.js"></script>













<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&amp;family=Noto&#43;Serif&#43;SC:wght@400;600;700&amp;display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"
   crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js"
     crossorigin></script>
<link rel="stylesheet" href="https://www.codedump.info/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css" media="print" onload="this.media='all';this.onload=null">


<script defer type="text/javascript" src="https://www.codedump.info/js/fontawesome.min.30595d8a9ed7468eba3aa95ad3a1030aec262644fb8e8c8a2ac064630c5a2b4aebf09c5105e5497b5e596c982d93cf45.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"
   integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ"  media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" 
  integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY"  crossorigin></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
   integrity="sha384-&#43;XBljXPPiv&#43;OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
    });
  });
</script>


<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js" 
  integrity="sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0"  crossorigin></script>
<link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-126255685-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'UA-126255685-1');
</script>


<link rel="icon" type="image/png" href="/images/c.png" sizes="64x64">

<meta name="description"
  content="周刊（第22期）：图解一致性模型">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"Posts",
      "item":"https://www.codedump.info/post/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"周刊（第22期）：图解一致性模型",
      "item":"https://www.codedump.info/post/20220710-weekly-22/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.codedump.info/post/20220710-weekly-22/"
    },
    "headline": "周刊（第22期）：图解一致性模型 - codedump的网络日志","datePublished": "2022-07-10T14:41:24+08:00",
    "dateModified": "2022-07-10T14:41:24+08:00",
    "wordCount":  6166 ,
    "publisher": {
        "@type": "Person",
        "name": "lichuang",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.codedump.info/images/c.png"
        }
        },
    "description": "周刊（第22期）：图解一致性模型"
}
</script><meta property="og:title" content="周刊（第22期）：图解一致性模型 - codedump的网络日志" />
<meta property="og:type" content="article" />


<meta property="og:image" content="https://www.codedump.info/images/c.png">


<meta property="og:url" content="https://www.codedump.info/post/20220710-weekly-22/" />



<meta property="og:description" content="周刊（第22期）：图解一致性模型" />



<meta property="og:locale" content="zh" />




<meta property="og:site_name" content="codedump的网络日志" />






<meta property="article:published_time" content="2022-07-10T14:41:24&#43;08:00" />


<meta property="article:modified_time" content="2022-07-10T14:41:24&#43;08:00" />



<meta property="article:section" content="post" />


<meta property="article:tag" content="周刊" />

<meta property="article:tag" content="分布式" />









<meta property="og:see_also" content="https://www.codedump.info/post/20220904-weekly-24/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220807-weekly-23/" />





<meta property="og:see_also" content="https://www.codedump.info/post/20220703-weekly-21/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220625-weekly-20/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220619-weekly-19/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220612-weekly-18/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220528-weekly-17/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220521-weekly-16/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220514-weekly-15/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220507-weekly-14/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220417-weekly-13/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220410-weekly-12/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220327-weekly-11/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220319-weekly-10/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220313-weekly-9/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220304-weekly-8/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220227-weekly-7/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220220-weekly-6/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220211-weekly-5/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220204-weekly-4/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220129-weekly-3/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220123-weekly-2/" />



<meta property="og:see_also" content="https://www.codedump.info/post/20220116-weekly-1/" />






  <body class="flex min-h-screen flex-col">
    <header
      class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"
    >
      <div class="mx-auto w-full max-w-screen-xl"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="me-6 text-primary-text text-xl font-bold">codedump的网络日志</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/#about" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">关于</a>
            <a href="/post/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  me-4">文章</a>
            <a href="/categories/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">分类</a>
            <a href="/tags/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">标签</a>
            <a href="/series/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">系列</a>
            <a href="/index.xml" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">RSS</a>
            <a href="https://www.getrevue.co/profile/lichuang" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">邮件订阅</a>
        </div>

        <div class="flex">
            <div class="relative pt-4 md:pt-0">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">浅色</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">深色</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">自动</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
    </header>
    <main class="grow pt-16">
        <div class="pl-scrollbar">
          <div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8">
  
  
  <div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12">
    <div
      class=" bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"
    >
      <article class="prose">
  <h1 class="mb-4">周刊（第22期）：图解一致性模型</h1>

  <div
  class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"
>
  <div class="me-6 my-2">
    <i class="fas fa-calendar me-1"></i>
    <span
      >2022-07-10</span
    >
  </div>
  <div class="me-6 my-2">
    <i class="fas fa-clock me-1"></i>
    <span>13分钟阅读时长</span>
  </div>

  
    <div class="me-6 my-2">
      <i class="fas fa-folder me-1"></i>
      
        <a href="https://www.codedump.info/categories/%E5%91%A8%E5%88%8A/" class="hover:text-eureka"
          >周刊</a
        >
      
        
          <span>, </span>
        <a href="https://www.codedump.info/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" class="hover:text-eureka"
          >分布式</a
        >
      
    </div>
  

  
    <div class="me-6 my-2">
      <i class="fas fa-th-list me-1"></i>
      
        <a href="https://www.codedump.info/series/2022%E5%91%A8%E5%88%8A/" class="hover:text-eureka"
          >2022周刊</a
        >
      
    </div>
  
</div>


  
  

  <hr>
<p>引言：本文使用大量的图例，同时没有难懂的公式，意图解释清楚一致性模型要解决什么问题，以及三种一致性模型：顺序一致性、线性一致性、因果一致性。</p>
<hr>
<h1 id="图解一致性模型">图解一致性模型</h1>
<h2 id="概述">概述</h2>
<h3 id="解决什么问题">解决什么问题？</h3>
<p>分布式系统要保证系统的可用性，就需要对数据提供一定的冗余度：一份数据，要存储在多个服务器上，才能认为保存成功，至于这里要保存的冗余数，有<code>Majority</code>和<code>Quorum</code>之说，可以参考之前的文章：<a href="https://www.codedump.info/post/20220528-weekly-17/">周刊（第17期）：Read-Write Quorum System及在Raft中的实践</a>。</p>
<p>同一份数据保存在多个机器上提供冗余度，也被称为<code>副本(replica)策略</code>，这个做法带来下面的好处：</p>
<ul>
<li>容错性：即便分布式系统中几台机器不能工作，系统还能照常对外提供服务。</li>
<li>提升吞吐量：既然同一份数据存储在多个机器上，对该数据的请求（至少是读请求）能够分担到多个副本上，这样整个系统可以线性扩容增加更多的机器以应付请求量的增加。</li>
</ul>
<p>同时，副本策略也有自己需要解决的问题，其中最重要的问题就是一致性问题：在系统中的一个机器写入的数据，是否在系统中其他机器看来也是一样的？</p>
<p>很显然，即便在一切都正常工作的条件下，在系统中的一个机器成功写入了数据，因为广播这个修改到系统中的其他机器还需要时间，那么系统的其他机器看到这个修改的结果也还是需要时间的。换言之，中间的这个<code>时间差</code>可能出现短暂的数据不一致的情况。</p>
<p>可以看到，由于这个<code>时间差</code>的客观存在，并不存在一个<code>绝对</code>意义上的数据一致性。换言之，<code>数据一致性</code>有其实现的严格范围，越严格的数据一致，要付出的成本、代价就越大。</p>
<p>为了解决一致性问题，需要首先定义一致性模型，在维基的页面上，<code>一致性模型（Consistency model）</code>的定义如下：</p>
<blockquote>
<p>In computer science, a consistency model specifies a contract between the programmer and a system, wherein the system guarantees that if the programmer follows the rules for operations on memory, memory will be consistent and the results of reading, writing, or updating memory will be predictable.</p>
</blockquote>
<p>我们举一个日常生活中常见的问题来解释<code>一致性模型</code>：</p>
<p><img src="/media/imgs/20220710-weekly-22/wechat.png" alt="wechat" title="wechat"></p>
<p>在上图中：</p>
<ul>
<li>不妨把<code>朋友圈</code>当成一个大型的<code>分布式系统</code>：
<ul>
<li>这个分布式系统，对外提供了写入（发朋友圈）和读取（ 读朋友圈）的功能。</li>
<li>存储这些朋友圈数据的，肯定不止一台机器，因此这些机器在一起构成了这个大型的分布式系统。</li>
<li>不同的用户，发朋友圈的时候，也不一定都写入相同的一台机器。反之也是，在读朋友圈时也不一定会到同一台机器上读取数据。</li>
</ul>
</li>
<li><code>朋友圈</code>这个分布式系统，有两种客户端：<code>发朋友圈</code>的客户端负责写入数据，<code>读朋友圈</code>的客户端负责读取数据，当然很多时候同一个客户端既能读也能写。</li>
</ul>
<p>接下来的问题是：</p>
<ul>
<li>这些看朋友圈的人，是否能看到全局一致的数据？即所有人看到的朋友圈都是同一个顺序排列的？</li>
</ul>
<p>显然，有很多时候，即便是在看同一个朋友圈下的评论回复，不同的人看到也不尽然都是同一个顺序的，所以以上的答案是否定的。那么就引入了下一个问题：</p>
<ul>
<li>如果不同的人看到的朋友圈（包括评论）顺序各有不同，这些顺序又该遵守怎样的规则才是合理的？</li>
</ul>
<p>回答怎样的<code>顺序规则</code>才是合理的，这就是<code>一致性模型</code>要解答的问题。</p>
<h3 id="一致性模型图例">一致性模型图例</h3>
<p>本文意在使用各种图例来解释一致性模型，所以在继续往下讲解之前，有必要首先交待一下图例中的各种元素，以下图为例：</p>
<p><img src="/media/imgs/20220710-weekly-22/sample.png" alt="sample" title="sample"></p>
<p>在上图中，有以下几个元素：</p>
<ul>
<li>最左边是分布式系统中的进程编号${\displaystyle P_1}$、${\displaystyle P_2}$。</li>
<li>横轴是时间轴，从左往右时间递增，但是这里并没有严格的时间刻度。</li>
<li>进程中发生的事件，事件的命名规则为<code>进程编号_进程中的事件编号</code>，比如${\displaystyle P_11}$，除此以外：
<ul>
<li>事件有其开始、结束时间，使用一个矩形来表示一个事件的执行，这样矩形的宽度可以认为在时间轴上的宽度，即事件的执行时长。</li>
<li>事件与事件之间，在执行时间上可能发生重叠，如图中的${\displaystyle P_11}$和${\displaystyle P_21}$，这种有重叠的事件，被称为并发事件（concurrent event），在顺序上，并发事件之间可以认为谁先谁后都可以，后面会专门聊这部分。</li>
<li>使用不同的颜色来区分不同进程上发生的事件。</li>
<li>每个事件关联一个操作，为了简化问题目前只有读和写操作：
<ul>
<li>w(x) = A：向变量x写入A。</li>
<li>r(x) = A：从变量x读出A。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="单进程下的事件排列">单进程下的事件排列</h3>
<p>我们继续回到<code>朋友圈</code>的话题上来，一条朋友圈下面有多个人发表评论，可以认为这是一个<code>二维</code>的数据：</p>
<ul>
<li>进程（也就是发表评论的人）是一个维度。</li>
<li>时间又是另一个维度，即这些评论出现的先后顺序。</li>
</ul>
<p>但是在阅读这些评论的读者看来，需要将这一份<code>二维</code>的数据，去除掉不同进程这个维度，<code>压平</code>到只有本进程时间线这一个单一维度上面来，以上面图例来说就是这样的：</p>
<p><img src="/media/imgs/20220710-weekly-22/wechat-2.png" alt="wechat-2" title="wechat-2"></p>
<p>在上图中，在读进程${\displaystyle P_3}$的视角看来，两个写进程的事件，需要<code>压平</code>到本进程的时间线上进行排列，可以看到这些事件在<code>压平</code>之后有多种排列的可能性。</p>
<p>将多个写进程的事件进行排列，放到单进程的时间线上，这是一个排列组合问题，如果所有的写进程事件加起来一共有<code>n</code>个，那么这些事件的所有排列组合就是$n!$。比如事件<code>a</code>、<code>b</code>、<code>c</code>，不同的排列一共有这些：</p>
<pre tabindex="0"><code>{(a,b,c),(a,c,b),(b,a,c),(b,c,a),(c,a,b),(c,b,a)}
</code></pre><p><code>一致性模型</code>就是要回答：<code>在所有的这些可能存在的事件排列组合中，按照要求的一致性严格程度，哪些是可以接受的，哪些不可能出现？</code></p>
<p>后面的讲述将看到：越是宽松的一致性模型，能容纳的事件排列可能性就越多；反之越严格则越少。</p>
<h2 id="一致性模型">一致性模型</h2>
<p>本文中将讨论以下三种一致性模型：线性一致性、顺序一致性、因果一致性，上面是按照严格顺序排行的，也就是说线性一致性最严格、因果一致性则最弱。需要说明的是，还存在其它一致性模型，但是不在本文的讨论范围内。</p>
<h3 id="顺序一致性">顺序一致性</h3>
<p>顺序一致性的定义最初出现在论文《How to Make a Multiprocessor Computer That Correctly Executes Multiprocess Progranm》中，原文中要求顺序一致性模型满足两个要求：</p>
<blockquote>
<p>the result of any execution is the same as if the operations of all the processors were executed in some sequential order, and the operations of each individual processor appear in this sequence in the order specified by its program.</p>
<p>（任何执行的结果都与所有处理器的操作按某种顺序执行的情况相同，每个单独的处理器的操作按其程序指定的顺序出现在这个序列中。）</p>
</blockquote>
<p>它有两个条件：</p>
<blockquote>
<p>Requirement Rl: Each processor issues memory requests in the order specified by its program.</p>
<p>Requirement R2: Memory requests from all processors issued to an individual memory module are serviced from a single FIFO queue. Issuing a memory request consists of entering the request on this queue.</p>
</blockquote>
<p>先来看条件1：</p>
<ul>
<li>条件1：每个进程的执行顺序要和该进程的程序执行顺序保持一致。</li>
</ul>
<p>前面提到过，当读进程读到多进程的多个事件时，相当于把这些不同时间、进程维度的事件“压平”到本进程的同一个时间维度里，条件1要求这样被<code>压平</code>之后的顺序，<code>每个进程发出的事件的执行顺序，和程序顺序（program order）保持一致。</code></p>
<p>举一个违反这个条件的反例，如下图所示：</p>
<p><img src="/media/imgs/20220710-weekly-22/program-order.png" alt="program-order" title="program-order"></p>
<p>上图中：</p>
<ul>
<li>进程${P_1}$视角下：程序的执行顺序是先执行 ${P_11}$，再执行 ${P_12}$。</li>
<li>但是到了P3视角下重排事件之后，${P_12}$出现在了事件${P_11}$前面，这是不允许出现的，因为违反了原进程${P1}$的程序顺序了。</li>
</ul>
<p>但是，仅靠条件1还不足以满足顺序一致性，于是还有条件2：</p>
<ul>
<li>条件2：对变量的读写要表现得像FIFO一样先入先出，即<code>每次读到的都是最近写入的数据</code>。</li>
</ul>
<p><img src="/media/imgs/20220710-weekly-22/FIFO.png" alt="FIFO" title="FIFO"></p>
<p>我们来举一个例子来完整说明顺序一致性：</p>
<p><img src="/media/imgs/20220710-weekly-22/seq-model.png" alt="seq-model" title="seq-model"></p>
<p>上图中，有三个进程对变量x进行读写操作：</p>
<ul>
<li>
<p>进程${P_1}$：事件${P_11}$修改x为A，事件${P_12}$修改x为B。</p>
</li>
<li>
<p>进程${P_2}$：事件${P_21}$修改x为C。</p>
</li>
<li>
<p>进程${P_3}$：事件${P_31}$读出x为A，事件${P_32}$读出x为C，事件${P_31}$读出x为B。</p>
</li>
</ul>
<p>注意：在上图中，事件${P_12}$和${P_21}$有重叠，意味着这两个事件是“并发事件”，即哪个事件先发生、完成都是可以接受的。</p>
<p>图中下半部分给出了三种可能的事件排列：</p>
<ul>
<li>第一种排列：
<ul>
<li>将事件对应的操作解读出来，那么执行顺序为：{w(x)=A,r(x)=A,w(x)=B,r(x)=B,w(x)=C,r(x)=C}。</li>
<li>可以看到，上面这个顺序，既没有违反条件1（因为同进程的程序顺序没有被打乱），也没有违反条件2（读出的都是开始写入的数据）。</li>
</ul>
</li>
<li>第二种排列：
<ul>
<li>将事件对应的操作解读出来，那么执行顺序为：{w(x)=A,r(x)=A,w(x)=B,r(x)=C,w(x)=C,r(x)=B}。</li>
<li>由于${P_12}$和${P_21}$是并发事件，可以任意排列两者的顺序，这里选择先执行${P_12}$，可以看到：
<ul>
<li><code>w(x)=B,r(x)=C</code>，这违反了条件2。</li>
</ul>
</li>
</ul>
</li>
<li>第三种排列：
<ul>
<li>将事件对应的操作解读出来，那么执行顺序为：{w(x)=A,r(x)=A,w(x)=C,r(x)=B,w(x)=B,r(x)=C}。</li>
<li>这一次选择了先执行${P_21}$，可以看到：
<ul>
<li><code>w(x)=C,r(x)=B</code>以及<code>w(x)=B,r(x)=C</code>：违反了条件2。</li>
<li>${P_33}$先于${P_32}$执行，违反了条件1。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>以上就是顺序一致性的解释，它要求两个条件：</p>
<ul>
<li>不能打乱单进程的程序顺序，同一个进程里的事件先后顺序要得到保留。</li>
<li>每次读出来的都是最新的值，而且一旦形成了一个排列，要求系统中所有进程都是同样的一个排列。</li>
</ul>
<p>这里需要特别说明的是，只要满足这两个条件，并没有对<code>不同进程的事件</code>先后顺序其他硬性的规定，所以即便是某些事件在排列之后看起来违反了事件发生的先后顺序也是可以的。其实这在上图中已经有体现了：</p>
<ul>
<li>事件${P_31}$明明比事件${P_12}$和${P_21}$发生得更晚，但是只要在重排之后它是紧跟着${P_11}$的第一个读事件，就没有违反顺序一致性。在这个大前提下，事件${P_31}$甚至能出现在${P_12}$和${P_21}$之前，这看起来就很<code>违反直觉</code>了。</li>
</ul>
<p>再比如下图：</p>
<p><img src="/media/imgs/20220710-weekly-22/seq-model-2.png" alt="seq-model-2" title="seq-model-2"></p>
<p>在上图中，故意将三个事件画的分开一些，意味着三个事件并不重叠，即有明确的先后顺序，但是在顺序一致性模型看来：</p>
<ul>
<li>{${P_11}$,${P_21}$,${P_31}$}和{${P_11}$,${P_31}$,${P_21}$}都是对的，因为这两者都没有违反条件1和2。</li>
<li>只有最下面的{${P_31}$,${P_21}$,${P_11}$}才是错的，因为违反了条件2。</li>
</ul>
<p>可以看到，顺序一致性在满足了条件1、2之后，对<code>不同进程的事件</code>之间的顺序没有硬性的要求，即便在感官直觉上某事件应该发生得更早，但是只要没有违反这两个条件就可以认为是满足顺序一致性模型的。</p>
<p>于是就出现了更严格的线性一致性，它基于顺序一致性的条件，对事件的先后顺序做了更严格的要求。</p>
<h3 id="线性一致性">线性一致性</h3>
<p>线性一致性要求首先满足顺序一致性的条件，同时还多了一个条件，不妨称之为条件3：</p>
<ul>
<li>条件3：不同进程的事件，如果在时间上不重叠，即不是并发事件，那么要求这个先后顺序在重排之后保持一致。</li>
</ul>
<p>如果加上这个更强的条件，上面的图中，就只有{${P_11}$,${P_21}$,${P_31}$}是满足线性一致性的排列了。</p>
<p>再举一个例子来说明线性一致性：</p>
<p><img src="/media/imgs/20220710-weekly-22/lin-model.png" alt="lin-model" title="lin-model"></p>
<p>这还是最开始解释顺序一致性模型的图，但是在线性一致性的条件下，找不到能够满足条件的排列了。</p>
<p>这是因为：</p>
<ul>
<li>事件${P_21}$和${P_12}$都在事件${P_11}$之后，这个顺序需要得到保持。</li>
<li>而事件${P_31}$在事件${P_21}$和${P_12}$之后，这个顺序也需要得到保持。</li>
<li>如果保持了前面两个顺序，那么${P_31}$执行的时候，必然读不出来A，而应该是B或者C（即${P_21}$或者${P_12}$的执行结果）。</li>
</ul>
<h3 id="顺序一致性和线性一致性总结">顺序一致性和线性一致性总结</h3>
<p>可以看到，如果满足线性一致性，就一定满足顺序一致性，因为后者的条件是前者的真子集。</p>
<p>除了满足这些条件以外，这两个一致性还有一个要求：系统中所有进程的顺序是一致的，即如果系统中的进程A按照要求使用了某一种排序，即便有其他排序的可能性存在，系统中的其他进程也必须使用这种排序，系统中只能用一种满足要求的排序。</p>
<p>这个要求，使得满足顺序和线性一致性的系统，对外看起来“表现得像只有一个副本”一样。</p>
<p>但因果一致性则与此不同：只要满足因果一致性的条件，即便不同进程的事件排列不一致也没有关系。</p>
<h3 id="因果一致性">因果一致性</h3>
<p>相较于顺序和线性一致性，因果一致性就简单一些，其实就只要满足在Lamport时钟中提到的<a href="https://www.codedump.info/post/20220703-weekly-21/#happen-before%E5%85%B3%E7%B3%BB">happen-before</a>关系即可：</p>
<blockquote>
<ul>
<li>引入符号$→ $做为表示事件之间<code>happen-before</code>的记号。</li>
</ul>
<ul>
<li>在同一个进程中，如果事件${\displaystyle a}$在事件${\displaystyle b}$之前发生，那么${\displaystyle a → b}$。（这是因为根据规则1，进程每次发出事件之后都会将本地的lamport时钟加一，于是可以在同一个进程内定义事件的先后顺序了）</li>
<li>在不同的进程中，如果事件${\displaystyle a}$表示一个进程发出一个事件，事件${\displaystyle b}$表示接收进程收到这个事件，那么也必然满足${\displaystyle a → b}$。（这是因为根据规则2，接收进程在收到事件之后会取本地时钟和事件时钟的最大值并且+1，于是发出事件和接收事件尽管在不同的进程，但是也可以比较其lamport时钟知道其先后顺序了）</li>
<li>最后，<code>happend-before</code>关系是满足传递性的，即：如果${\displaystyle a → b}$且${\displaystyle b → c}$，那么也一定有${\displaystyle a → c}$。</li>
</ul>
</blockquote>
<p>以<code>评论朋友圈</code>这个行为来解释因果一致性再合适不过：</p>
<ul>
<li>评论另一个用户的评论：相当于进程给另一个进程发消息，肯定要求满足<code>happen-before</code>关系，即先有了评论，才能针对这个评论发表评论。</li>
<li>同一个用户的评论：相当于同一个进程的事件，也是必须满足<code>happen-before</code>关系才行。</li>
</ul>
<p>以下图为例：</p>
<p><img src="/media/imgs/20220710-weekly-22/casual-model.png" alt="casual-model" title="casual-model"></p>
<p>一共有4个朋友圈的读者，它们看到的评论顺序都各不一样：</p>
<ul>
<li>最上面的两个读者，读到的顺序都满足因果一致性，因此即便是不一样的顺序也是正确的。</li>
<li>最下面的两个读者，顺序都不满足因果一致性：
<ul>
<li>A回复B这个事件出现在了B回复A之前，不符合多进程之间的<code>happen-before</code>关系。</li>
<li>A回复C这个事件在进程A中应该在A回复B之前，不符合同一进程的事件之间的先后顺序。</li>
</ul>
</li>
</ul>
<h2 id="总结">总结</h2>
<ul>
<li>
<p>在分布式系统中，多个进程组合在一起协调工作，产生多个事件，事件之间可以有多种排列的可能性。</p>
</li>
<li>
<p>一致性模型本质上要回答这个问题：按照该一致性模型定义，怎样的事件排列才符合要求？</p>
</li>
<li>
<p>顺序一致性和线性一致性都意图让系统中所有进程<code>看起来</code>有统一的全局事件顺序，但是两者的要求不同，顺序一致性：</p>
<ul>
<li>条件1：每个进程的执行顺序要和该进程的程序执行顺序保持一致。</li>
<li>条件2：对变量的读写要表现得像FIFO一样先入先出，即每次读到的都是最近写入的数据。</li>
</ul>
<p>只要满足这两个条件，顺序一致性对事件之间的先后顺序并没有硬性要求，而线性一致性在此基础上多了条件3：</p>
<ul>
<li>条件3：不同进程的事件，如果在时间上不重叠，即不是并发事件，那么要求这个先后顺序在重排之后保持一致。</li>
</ul>
</li>
<li>
<p>因果一致性是更弱的一致性，只要满足<code>happen-before</code>关系即可。由于<code>happen-before</code>关系实际上是由Lamport时钟定义的，这是一种逻辑时钟，所以不同的读者看到的先后顺序可能会有点<code>反直觉</code>，但是只要满足<code>happen-before</code>关系就是正确的。</p>
</li>
</ul>
<h2 id="参考资料">参考资料</h2>
<ul>
<li>顺序一致性论文：<a href="https://www.microsoft.com/en-us/research/uploads/prod/2016/12/How-to-Make-a-Multiprocessor-Computer-That-Correctly-Executes-Multiprocess-Programs.pdf">How to Make a Multiprocessor Computer That Correctly Executes Multiprocess Progranm</a></li>
<li>线性一致性论文：<a href="https://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf">Linearizability: A Correctness Condition for Concurrent Objects</a></li>
<li><a href="https://danielw.cn/history-of-distributed-systems-1">分布式系统一致性的发展历史 (一)</a></li>
<li><a href="http://zhangtielei.com/posts/blog-distributed-strong-weak-consistency.html">条分缕析分布式：浅析强弱一致性 - 铁蕾的个人博客</a></li>
</ul>

</article>


      
        <div class="my-4">
    
    <a href="https://www.codedump.info/tags/%E5%91%A8%E5%88%8A/" class="inline-block text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#周刊</a>
    
    <a href="https://www.codedump.info/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" class="inline-block text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#分布式</a>
    
</div>
      



      



      

      
  <div
    class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"
  >
    <div>
      
        <span class="text-primary-text block font-bold"
          >上一页</span
        >
        <a href="https://www.codedump.info/post/20220807-weekly-23/" class="block">周刊（第23期）：图解Blink-Tree：B&#43;Tree的一种并发优化结构和算法</a>
      
    </div>
    <div class="mt-4 md:mt-0 md:text-right">
      
        <span class="text-primary-text block font-bold">下一页</span>
        <a href="https://www.codedump.info/post/20220703-weekly-21/" class="block">周刊（第21期）：Lamport时钟介绍</a>
      
    </div>
  </div>


    </div>
    
      <div class="col-span-2">

        
          <div
  class="
    bg-primary-bg
   prose sticky top-16 z-10 hidden px-6 py-4 lg:block"
>
  <h3>本页目录</h3>
</div>
<div
  class="sticky-toc  hidden px-6 pb-6 lg:block"
>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#图解一致性模型">图解一致性模型</a>
      <ul>
        <li><a href="#概述">概述</a>
          <ul>
            <li><a href="#解决什么问题">解决什么问题？</a></li>
            <li><a href="#一致性模型图例">一致性模型图例</a></li>
            <li><a href="#单进程下的事件排列">单进程下的事件排列</a></li>
          </ul>
        </li>
        <li><a href="#一致性模型">一致性模型</a>
          <ul>
            <li><a href="#顺序一致性">顺序一致性</a></li>
            <li><a href="#线性一致性">线性一致性</a></li>
            <li><a href="#顺序一致性和线性一致性总结">顺序一致性和线性一致性总结</a></li>
            <li><a href="#因果一致性">因果一致性</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#参考资料">参考资料</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    enableStickyToc();
  });
</script>

        
      </div>
    

    
    
      <div
        class=" bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"
      >
        <h3>相关</h3>
        
          <a href="https://www.codedump.info/post/20220220-weekly-6/" class="no-underline">周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇</a>
          <br />
        
          <a href="https://www.codedump.info/post/20220211-weekly-5/" class="no-underline">周刊（第5期）：从存储模型聊一聊时序数据库的应用场景</a>
          <br />
        
          <a href="https://www.codedump.info/post/20220204-weekly-4/" class="no-underline">周刊（第4期）：为什么我还在看中国足球</a>
          <br />
        
          <a href="https://www.codedump.info/post/20220101-etcd3.5-joint-consensus/" class="no-underline">etcd 3.5版本的joint consensus实现解析</a>
          <br />
        
          <a href="https://www.codedump.info/post/20211011-raft-propose-prev-term/" class="no-underline">为什么Raft协议不能提交之前任期的日志？</a>
          <br />
        
          <a href="https://www.codedump.info/post/20210628-etcd-wal/" class="no-underline">Etcd Raft库的日志存储</a>
          <br />
        
      </div>
    

    <div
    class=" bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"
  >      
      



  <script src="https://utteranc.es/client.js"
  repo="lichuang/lichuang.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>

<script>
    if (storageColorScheme == "Light") {
      document.getElementById('utterances').setAttribute('theme', 'github-light')
    } else if (storageColorScheme == "Dark") {
      document.getElementById('utterances').setAttribute('theme', 'github-dark')
    }
</script>

    </div>
  </div>


  
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
      });
    </script>

          </div>
        </div>
      
    </main>
    <footer class="pl-scrollbar">
      <div class="mx-auto w-full max-w-screen-xl"><div class="text-center">
      <div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="邮件订阅本站更新" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="点击订阅" name="member[subscribe]">
  </form>
</div>
      <a href="https://github.com/lichuang" class="me-2" target="_blank" title="github">
        <i class="fab fa-github"></i>
      </a>
      <a href="https://www.zhihu.com/people/codedump" class="me-2" target="_blank" title="zhihu">
        <i class="fab fa-zhihu"></i>
      </a>
      <a href="https://weibo.com/lichuang" class="me-2" target="_blank" title="weibo">
        <i class="fab fa-weibo"></i>
      </a>
      <a href="https://twitter.com/lichuang" class="me-2" target="_blank" title="twitter">
        <i class="fab fa-twitter"></i>
      </a>


  <a href="https://www.codedump.info/index.xml" type="application/rss+xml" class="me-2" target="_blank" title="rss">
      <i class="fas fa-rss"></i> 
    </a>
</div>


<div class="text-center">
    <p class="text-sm text-tertiary-text">&copy; 2018 <a href="https://www.codedump.info/">codedump</a>   
  <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>
</span>
 &middot; 
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/wangchucheng/hugo-eureka" rel="noopener" target="_blank">Eureka</a>
</div>

</div>
    </footer>
  </body>
</html>
