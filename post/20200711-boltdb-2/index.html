<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="boltdb 1.3.0å®ç°åˆ†æ">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" boltdb  å­˜å‚¨å¼•æ“ ">
  

  
  

  
  <meta property="og:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰" />
<meta property="og:description" content="boltdb 1.3.0å®ç°åˆ†æ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20200711-boltdb-2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-07-11T09:33:06+08:00" />
<meta property="article:modified_time" content="2020-07-11T09:33:06+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20200711-boltdb-2/">

  
  
  <meta itemprop="name" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰">
<meta itemprop="description" content="boltdb 1.3.0å®ç°åˆ†æ"><meta itemprop="datePublished" content="2020-07-11T09:33:06+08:00" />
<meta itemprop="dateModified" content="2020-07-11T09:33:06+08:00" />
<meta itemprop="wordCount" content="4014">
<meta itemprop="keywords" content="å­˜å‚¨,å­˜å‚¨å¼•æ“," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰"/>
<meta name="twitter:description" content="boltdb 1.3.0å®ç°åˆ†æ"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">å‘¨åˆŠ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8'>#å­˜å‚¨</a>
    
    <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E'>#å­˜å‚¨å¼•æ“</a>
    
  </div>
  
  
  <article class="content">
    
    <blockquote>
<p>æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ä½“ã€‚å…³äºetcdã€raftåè®®ä»¥åŠB+æ ‘ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p>
</blockquote>
<blockquote>
<ul>
<li><a href="https://www.codedump.info/post/20180921-raft/">Raftç®—æ³•åŸç†</a></li>
<li><a href="https://www.codedump.info/post/20180922-etcd-raft/">etcd Raftåº“è§£æ</a></li>
<li><a href="https://www.codedump.info/post/20181125-etcd-server/">Etcdå­˜å‚¨çš„å®ç°</a></li>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>
</blockquote>
<blockquote>
<p>æœ¬æ–‡çš„å†™ä½œï¼Œä¸»è¦å‚è€ƒäº†<a href="https://www.jianshu.com/p/b86a69892990">ã€ŠåŒºå—çš„æŒä¹…åŒ–ä¹‹BoltDBã€‹ç³»åˆ—æ–‡ç« </a>ä»¥åŠ<a href="https://youjiali1995.github.io/storage/boltdb">boltdb æºç åˆ†æ</a></p>
</blockquote>
<p>åœ¨<a href="https://www.codedump.info/post/20200625-boltdb-1/">ä¸Šä¸€èŠ‚</a>é‡Œé¢ï¼Œç³»ç»Ÿçš„ä»‹ç»äº†Boltdbä¸­å‡ ç§ç±»å‹é¡µé¢çš„æ ¼å¼ï¼Œæœ‰äº†è¿™äº›åŸºç¡€ï¼Œæœ¬èŠ‚å¼€å§‹ä»‹ç»boltdbä¸­çš„Bucketç»“æ„ã€‚</p>
<h1 id="bucket">Bucket</h1>
<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼ŒBucketç±»æ¯”äºmysqlä¸­çš„tableï¼Œåœ¨boltdbä¸­ï¼Œ<code>meta</code>é¡µé¢ä¸­æœ‰ä¸€ä¸ªæˆå‘˜<code>bucket</code>ï¼Œå…¶å­˜å‚¨äº†æ•´ä¸ªæ•°æ®åº“æ ¹bucketçš„ä¿¡æ¯ï¼Œè€Œä¸€ä¸ªæ•°æ®åº“ä¸­å­˜å‚¨çš„å…¶ä»–tableçš„ä¿¡æ¯ï¼Œåˆ™ä½œä¸ºå­bucketå­˜å‚¨åˆ°Bucketä¸­ã€‚è¿™å‡ ä¸ªæ•°æ®ç»“æ„çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> DB <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	meta0    <span style="color:#666">*</span>meta
</span></span><span style="display:flex;"><span>	meta1    <span style="color:#666">*</span>meta  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> meta <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	root     bucket	<span style="color:#080;font-style:italic">// æ ¹bucketçš„ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> Bucket <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#666">*</span>bucket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  buckets  <span style="color:#a2f;font-weight:bold">map</span>[<span style="color:#0b0;font-weight:bold">string</span>]<span style="color:#666">*</span>Bucket <span style="color:#080;font-style:italic">// å­˜å‚¨å­bucketçš„å¯¹åº”å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> bucket <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// æ ¹èŠ‚ç‚¹çš„page id
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	root pgid <span style="color:#080;font-style:italic">// page id of the bucket&#39;s root-level page
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å•è°ƒé€’å¢çš„åºåˆ—å·
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	sequence <span style="color:#0b0;font-weight:bold">uint64</span> <span style="color:#080;font-style:italic">// monotonically incrementing, used by NextSequence()
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>åœ¨<code>bucket</code>æ•°æ®ç»“æ„ä¸­ï¼Œä¸¤ä¸ªæˆå‘˜çš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>rootï¼šè¯¥bucketçš„æ ¹èŠ‚ç‚¹çš„page idã€‚</li>
<li>sequenceï¼šè¯¥bucketå½“å‰çš„åºåˆ—å·ï¼Œå•è°ƒé€’å¢ï¼Œåœ¨å‡½æ•°<code>NextSequence</code>ä¸­ä½¿ç”¨ã€‚</li>
</ul>
<p>æ¯ä¸ª<code>Bucket</code>æ•°æ®ç»“æ„ï¼Œéƒ½ç»§æ‰¿è‡ª<code>bucket</code>ï¼ŒåŒæ—¶å…¶ä¸­çš„<code>buckets</code>å­˜å‚¨äº†è¯¥<code>Bucket</code>ä¸­å­Bucketåå­—çš„å¯¹åº”å…³ç³»ã€‚</p>
<p>æœ€åï¼Œ<code>meta</code>é¡µé¢çš„<code>root</code>æˆå‘˜ï¼Œå­˜å‚¨çš„å°±æ˜¯è¿™ä¸ªdbçš„æ ¹<code>bucket</code>é¡µé¢ä¿¡æ¯ã€‚è¿™å‡ ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/media/imgs/20200711-boltdb-2/buckets.png" alt="buckets" title="buckets"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼š</p>
<ul>
<li><code>DB</code>ç»“æ„ä½“æ˜¯è¡¨ç¤ºæ•´ä¸€ä¸ªboltdbæ•°æ®åº“çš„ç»“æ„ä½“ï¼Œå…¶ä¸­æœ‰<code>meta0</code>å’Œ<code>meta1</code>ä¸¤ä¸ª<code>meta</code>ç±»å‹çš„æˆå‘˜ï¼Œç”¨äºä¿å­˜<code>meta</code>é¡µé¢ä¿¡æ¯ã€‚</li>
<li><code>meta</code>é¡µé¢ä¸­ï¼Œå…¶ä¸­çš„<code>root</code>æ˜¯ä¸€ä¸ª<code>bucket</code>ç±»å‹æˆå‘˜ï¼Œä¿å­˜äº†æ ¹bucketçš„é¡µé¢ä¿¡æ¯ã€‚</li>
<li>æ ¹æ®<code>bucket</code>ä¸­çš„é¡µé¢ä¿¡æ¯ï¼Œå°±èƒ½æ‰¾åˆ°DBçš„æ ¹<code>Bucket</code>ä¿¡æ¯ï¼Œå…¶ä¸­çš„<code>buckets</code>æˆå‘˜ä¿å­˜äº†è¯¥æ•°æ®åº“ä¸­æ‰€æœ‰å­<code>bucket</code>åå­—ä¸å®ä½“ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</li>
</ul>
<h2 id="bucketç»“æ„ä½“å®šä¹‰">Bucketç»“æ„ä½“å®šä¹‰</h2>
<p>æ¥ä¸‹æ¥ä»‹ç»<code>Bucket</code>ç»“æ„ä½“æˆå‘˜ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> Bucket <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#666">*</span>bucket
</span></span><span style="display:flex;"><span>	tx       <span style="color:#666">*</span>Tx                <span style="color:#080;font-style:italic">// the associated transaction
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	buckets  <span style="color:#a2f;font-weight:bold">map</span>[<span style="color:#0b0;font-weight:bold">string</span>]<span style="color:#666">*</span>Bucket <span style="color:#080;font-style:italic">// subbucket cache
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	page     <span style="color:#666">*</span>page              <span style="color:#080;font-style:italic">// inline page reference
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	rootNode <span style="color:#666">*</span>node              <span style="color:#080;font-style:italic">// materialized node for the root page.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	nodes    <span style="color:#a2f;font-weight:bold">map</span>[pgid]<span style="color:#666">*</span>node     <span style="color:#080;font-style:italic">// node cache
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Sets the threshold for filling nodes when they split. By default,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// the bucket will fill to 50% but it can be useful to increase this
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// amount if you know that your write workloads are mostly append-only.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// This is non-persisted across transactions so it must be set in every Tx.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	FillPercent <span style="color:#0b0;font-weight:bold">float64</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶ä¸­ï¼š</p>
<ul>
<li>bucketï¼šå­˜å‚¨è¯¥<code>Bucket</code>æ‰€åœ¨é¡µé¢IDï¼Œä»¥åŠå½“å‰åºåˆ—å·ã€‚</li>
<li>txï¼šå½“å‰Bucketå…³è”çš„äº‹åŠ¡ã€‚</li>
<li>bucketsï¼šå‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œç»´æŠ¤å­<code>bucket</code>çš„æ˜ å°„å…³ç³»ã€‚</li>
<li>pageï¼šå­˜å‚¨inlineé¡µé¢ä¿¡æ¯ã€‚</li>
<li>rootNodeï¼šè¯¥Bucketçš„B+æ ‘æ ¹èŠ‚ç‚¹æŒ‡é’ˆã€‚</li>
<li>nodesï¼šç¼“å­˜å·²ç»è¯»å…¥å†…å­˜çš„<code>page</code>å¯¹åº”çš„<code>node</code>ä¿¡æ¯ã€‚</li>
<li>FillPercentï¼šè¿™æ˜¯ä¸€ä¸ªé˜ˆå€¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®é‡è¶…è¿‡è¯¥é˜ˆå€¼æ—¶è¿›è¡Œåˆ†è£‚æ“ä½œï¼Œé»˜è®¤å€¼ä¸ºDefaultFillPercent=0.5ã€‚è‡³äºB+æ ‘åˆ†è£‚æ“ä½œçš„æµç¨‹ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æœ€å¼€å§‹çš„B+æ ‘åŸç†é“¾æ¥ã€‚</li>
</ul>
<h2 id="å­bucket">å­Bucket</h2>
<p>æŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œä¸€ä¸ªboltçš„DBå­˜åœ¨ä¸€ä¸ªå”¯ä¸€çš„æ ¹Bucketï¼Œè€ŒDBä¸­ä¸åŒçš„tableå°±æ˜¯è¯¥æ ¹Bucketçš„å­Bucketï¼Œå…¶å¯¹åº”å…³ç³»å­˜å‚¨åœ¨<code>Bucket.buckets</code>æˆå‘˜ä¸­ã€‚é‚£ä¹ˆï¼Œå­Bucketä¿¡æ¯ä¿å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ä¿å­˜åœ¨å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<code>leafPageElement</code>ä¸­ï¼Œå›é¡¾ä¸€ä¸‹è¿™ä¸ªæ•°æ®ç»“æ„çš„å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// leafPageElement represents a node on a leaf page.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">type</span> leafPageElement <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	flags <span style="color:#0b0;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>	pos   <span style="color:#0b0;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>	ksize <span style="color:#0b0;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>	vsize <span style="color:#0b0;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶ä¸­çš„<code>flags</code>æˆå‘˜ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>0ï¼šè¡¨ç¤ºå°±æ˜¯æ™®é€šçš„å¶å­èŠ‚ç‚¹ã€‚</li>
<li>1ï¼šè¡¨ç¤ºæ˜¯å­bucketã€‚</li>
</ul>
<p>å³åœ¨boltdbä¸­ï¼Œå­Bucketçš„ä¿¡æ¯ï¼Œæ˜¯åšä¸ºä¸€ç§ç‰¹æ®Šçš„å¶å­èŠ‚ç‚¹ä¿¡æ¯å­˜å‚¨ä¸‹æ¥çš„ã€‚boltdbä½¿ç”¨äº†å¸¸é‡æ¥è¡¨ç¤ºè¿™ç§ç±»å‹çš„å¶å­èŠ‚ç‚¹æ ‡å¿—ä½ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">const</span> (
</span></span><span style="display:flex;"><span>	bucketLeafFlag = <span style="color:#666">0x01</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>å³ï¼š</p>
<ul>
<li>å¯¹äºä¸€ä¸ªæ ‡å¿—ä½ä¸º0çš„å¶å­é¡µé¢ï¼šå…¶å†…å®¹å°±æ˜¯B+æ ‘å¶å­é¡µé¢çš„å†…å®¹ï¼Œå­˜å‚¨çš„æ˜¯æ•°æ®çš„é”®å€¼ï¼Œboltdbä¸­å¶å­é¡µé¢çš„æ ¼å¼ç¤ºæ„å›¾åœ¨<a href="https://www.codedump.info/post/20200625-boltdb-1/#leaf%E9%A1%B5%E9%9D%A2">ä¸Šä¸€èŠ‚ä¸­</a>å·²ç»ç»™å‡ºã€‚</li>
<li>å¯¹äºä¸€ä¸ªæ ‡å¿—ä½ä¸º1çš„å¶å­é¡µé¢ï¼šå…¶å†…å­˜å­˜å‚¨çš„æ˜¯Bucketç»“æ„ä½“çš„ä¿¡æ¯ã€‚</li>
</ul>
<p>æœ‰äº†ä»¥ä¸Šçš„ä»‹ç»ï¼Œç†è§£èµ·æ¥è¿”å›ä¸€ä¸ªå­Bucketçš„ç›¸å…³ä»£ç å°±ä¸éš¾äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (b <span style="color:#666">*</span>Bucket) <span style="color:#00a000">Bucket</span>(name []<span style="color:#0b0;font-weight:bold">byte</span>) <span style="color:#666">*</span>Bucket {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Move cursor to key.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å¦åˆ™åˆ›å»ºä¸€ä¸ªCursoræŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	c <span style="color:#666">:=</span> b.<span style="color:#00a000">Cursor</span>()
</span></span><span style="display:flex;"><span>	k, v, flags <span style="color:#666">:=</span> c.<span style="color:#00a000">seek</span>(name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Return nil if the key doesn&#39;t exist or it is not a bucket.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// æŸ¥è¯¢ä¸åˆ°ï¼Œæˆ–è€…ä¸æ˜¯å­bucketèŠ‚ç‚¹ï¼Œéƒ½è¿”å›nil
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> !bytes.<span style="color:#00a000">Equal</span>(name, k) <span style="color:#666">||</span> (flags<span style="color:#666">&amp;</span>bucketLeafFlag) <span style="color:#666">==</span> <span style="color:#666">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Otherwise create a bucket and cache it.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// æ‰“å¼€è¿™ä¸ªbucketå¹¶ä¸”cacheåˆ°buckets mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">var</span> child = b.<span style="color:#00a000">openBucket</span>(v)
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">if</span> b.buckets <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		b.buckets[<span style="color:#a2f">string</span>(name)] = child
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> child
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">func</span> (b <span style="color:#666">*</span>Bucket) <span style="color:#00a000">openBucket</span>(value []<span style="color:#0b0;font-weight:bold">byte</span>) <span style="color:#666">*</span>Bucket {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// åˆ›å»ºä¸€ä¸ªbucket
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">var</span> child = <span style="color:#00a000">newBucket</span>(b.tx)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// If this is a writable transaction then we need to copy the bucket entry.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// Read-only transactions can point directly at the mmap entry.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> b.tx.writable {
</span></span><span style="display:flex;"><span>		child.bucket = <span style="color:#666">&amp;</span>bucket{}
</span></span><span style="display:flex;"><span>		<span style="color:#666">*</span>child.bucket = <span style="color:#666">*</span>(<span style="color:#666">*</span>bucket)(unsafe.<span style="color:#00a000">Pointer</span>(<span style="color:#666">&amp;</span>value[<span style="color:#666">0</span>]))
</span></span><span style="display:flex;"><span>	} <span style="color:#a2f;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		child.bucket = (<span style="color:#666">*</span>bucket)(unsafe.<span style="color:#00a000">Pointer</span>(<span style="color:#666">&amp;</span>value[<span style="color:#666">0</span>]))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Save a reference to the inline page if the bucket is inline.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// inline bucket
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> child.root <span style="color:#666">==</span> <span style="color:#666">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// bucketçš„page
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		child.page = (<span style="color:#666">*</span>page)(unsafe.<span style="color:#00a000">Pointer</span>(<span style="color:#666">&amp;</span>value[bucketHeaderSize]))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">&amp;</span>child
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>Bucket.Bucket</code>ç”¨äºæ ¹æ®åå­—è¿”å›ä¸€ä¸ªå­Bucketçš„æŒ‡é’ˆï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆæ ¹æ®å­Bucketåå­—æŸ¥æ‰¾åˆ°å¶å­é¡µé¢çš„æ•°æ®ã€æ ‡å¿—ä½ï¼Œå¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥å­Bucketï¼›æˆ–è€…å…¶æ ‡å¿—ä½ä¸æ˜¯<code>bucketLeafFlag</code>ï¼Œè¯´æ˜è¿™ä¸ªåå­—å·²ç»è¢«æ™®é€šæ•°æ®å ç”¨ï¼Œå³ï¼šboltdbä¸­ä¸å…è®¸å­Bucketä¸å…¶çˆ¶Bucketä¸­å†™å…¥çš„é”®åŒåã€‚</li>
<li>ä»¥ä¸ŠæŸ¥æ‰¾æˆåŠŸï¼Œå°±ä»¥è¯¥å¶å­é¡µé¢çš„æ•°æ®ä¸ºå‚æ•°ï¼Œè°ƒç”¨<code>Bucket.openBucket</code>å‡½æ•°ï¼Œæ ¹æ®<code>Bucket</code>ç»“æ„ä½“æ ¼å¼ï¼Œååºåˆ—åŒ–å‡ºæ¥<code>Bucket</code>ç»“æ„ä½“ä¿¡æ¯è¿”å›ã€‚</li>
</ul>
<h2 id="inline-page">inline page</h2>
<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå­Bucketçš„ä¿¡æ¯æ˜¯ç‹¬å ä¸€ä¸ªå¶å­é¡µé¢æ¥å­˜å‚¨çš„ï¼Œè¯¥é¡µé¢å¤§éƒ¨åˆ†çš„å†…å®¹éƒ½æ˜¯å†—ä½™çš„ã€‚å¦‚æœå­Bucketä¸­çš„æ•°æ®é‡å¾ˆå°‘ï¼Œå°±ä¼šé€ æˆç£ç›˜ç©ºé—´çš„æµªè´¹ã€‚ä¸ºäº†é’ˆå¯¹è¿™ç±»å‹Bucketè¿›è¡Œä¼˜åŒ–ï¼Œboltdbæä¾›äº†<code>inline page</code>è¿™ä¸ªç‰¹æ®Šçš„é¡µé¢ï¼Œå°†å°çš„å­Bucketæ•°æ®å­˜æ”¾åœ¨è¿™é‡Œã€‚</p>
<p>è¿™ç±»å‹çš„å­Bucketéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>è¯¥å­Bucketå†æ²¡æœ‰åµŒå¥—çš„å­Bucketäº†ã€‚</li>
<li>æ•´ä¸ªå­Bucketçš„å¤§å°ä¸èƒ½è¶…è¿‡page size/4ã€‚</li>
</ul>
<p><code>Bucket.inlineable</code>å‡½æ•°å°±æ˜¯ç”¨æ¥åš<code>inline</code>æ“ä½œçš„åˆ¤æ–­çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// inlineable returns true if a bucket is small enough to be written inline
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// and if it contains no subbuckets. Otherwise returns false.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// è¿”å›è¿™ä¸ªbucketæ˜¯å¦èƒ½å¤Ÿinlineæ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">func</span> (b <span style="color:#666">*</span>Bucket) <span style="color:#00a000">inlineable</span>() <span style="color:#0b0;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">var</span> n = b.rootNode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Bucket must only contain a single leaf node.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å¦‚æœæ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œæˆ–è€…æ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹çš„ä¸èƒ½è¿›è¡Œinlineæ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> n <span style="color:#666">==</span> <span style="color:#a2f;font-weight:bold">nil</span> <span style="color:#666">||</span> !n.isLeaf {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// Bucket is not inlineable if it contains subbuckets or if it goes beyond
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// our threshold for inline bucket size.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// æœ‰å­bucketï¼Œæˆ–è€…å¤§å°è¶…è¿‡maxInlineBucketSizeé˜ˆå€¼çš„ï¼Œéƒ½ä¸èƒ½è¿›è¡Œinlineæ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">var</span> size = pageHeaderSize
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">for</span> _, inode <span style="color:#666">:=</span> <span style="color:#a2f;font-weight:bold">range</span> n.inodes {
</span></span><span style="display:flex;"><span>		size <span style="color:#666">+=</span> leafPageElementSize <span style="color:#666">+</span> <span style="color:#a2f">len</span>(inode.key) <span style="color:#666">+</span> <span style="color:#a2f">len</span>(inode.value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">if</span> inode.flags<span style="color:#666">&amp;</span>bucketLeafFlag <span style="color:#666">!=</span> <span style="color:#666">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#a2f;font-weight:bold">if</span> size &gt; b.<span style="color:#00a000">maxInlineBucketSize</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// Returns the maximum total size of a bucket to make it a candidate for inlining.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">func</span> (b <span style="color:#666">*</span>Bucket) <span style="color:#00a000">maxInlineBucketSize</span>() <span style="color:#0b0;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> b.tx.db.pageSize <span style="color:#666">/</span> <span style="color:#666">4</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="cursor">Cursor</h1>
<p>ä»¥ä¸Šå·²ç»å¤§ä½“äº†è§£<code>Bucket</code>çš„ç»“æ„ï¼Œåœ¨boltdbæŸ¥æ‰¾æ•°æ®æµç¨‹ä¸­ï¼Œè¿˜æ˜¯ä½¿ç”¨äº†<code>Cursor</code>ç»“æ„ä½“æ¥åšä¸ºæ¸¸æ ‡ï¼ˆiteratorï¼‰ï¼Œä¿å­˜æŸ¥æ‰¾æµç¨‹ä¸­çš„ä¸­é—´æ•°æ®ï¼Œä¸‹é¢ä¹Ÿæ¥ç®€å•äº†è§£ä¸€ä¸‹ã€‚</p>
<p><code>Cursor</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">type</span> Cursor <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	bucket <span style="color:#666">*</span>Bucket		<span style="color:#080;font-style:italic">// å¯¹åº”çš„bucket
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	stack  []elemRef	<span style="color:#080;font-style:italic">// å­˜å‚¨é€’å½’éå†æ—¶ä¸­é—´è¿‡ç¨‹çš„æ ˆï¼Œç”±äºæ ˆæ˜¯å…ˆè¿›åå‡ºç»“æ„ï¼Œæ‰€ä»¥éå†çš„è¿‡ç¨‹ä¸­å±‚æ¬¡é«˜çš„åœ¨æ ˆçš„ä½ç«¯ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// å…‰æ ‡ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸­é—´è¿‡ç¨‹çš„ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">type</span> elemRef <span style="color:#a2f;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	page  <span style="color:#666">*</span>page	<span style="color:#080;font-style:italic">// é¡µé¢
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	node  <span style="color:#666">*</span>node	<span style="color:#080;font-style:italic">// å†…å­˜ä¸­çš„é¡µé¢ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	index <span style="color:#0b0;font-weight:bold">int</span>		<span style="color:#080;font-style:italic">// ä¿å­˜åœ¨å½“å‰pageã€nodeéå†åˆ°äº†å“ªä¸ªèŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p><code>Cursor</code>æœ‰ä»¥ä¸‹æˆå‘˜ï¼š</p>
<ul>
<li>bucketï¼šæ¸¸æ ‡æ“ä½œæ‰€å¯¹åº”çš„<code>Bucket</code>æŒ‡é’ˆã€‚</li>
<li>stackï¼šå­˜å‚¨é€’å½’éå†è¿‡ç¨‹ä¸­çš„æ ˆï¼Œç”±äºæ ˆæ˜¯å…ˆè¿›åå‡ºç»“æ„ï¼Œæ‰€ä»¥éå†çš„è¿‡ç¨‹ä¸­å±‚æ¬¡é«˜çš„èŠ‚ç‚¹åœ¨æ ˆçš„ä½ç«¯ã€‚</li>
</ul>
<p>æ¯ä¸ªstackæˆå‘˜ç±»å‹æ˜¯<code>elemRef</code>ï¼Œå…¶æˆå‘˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>pageï¼šé¡µé¢æŒ‡é’ˆã€‚</li>
<li>nodeï¼šå†…å­˜ä¸­çš„é¡µé¢ä¿¡æ¯ã€‚</li>
<li>indexï¼šä¿å­˜éå†åˆ°å½“å‰é¡µé¢çš„ç´¢å¼•ä½ç½®ã€‚</li>
</ul>
<p>ç”±äº<code>node</code>æ˜¯<code>page</code>åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºï¼Œæ‰€ä»¥å®é™…ä¸Šåœ¨<code>elemRef</code>ç»“æ„ä½“ä¸­ï¼Œ<code>page</code>å’Œ<code>node</code>æˆå‘˜åŒæ—¶åªä¼šæœ‰ä¸€ä¸ªæˆå‘˜ä¸ä¸ºNULLã€‚</p>
<p><code>Cursor</code>ç»“æ„ä½“åšä¸ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¯¹å¤–æä¾›çš„å°±æ˜¯å¸¸è§„è¿­ä»£å™¨æ‰€æ”¯æŒçš„æ“ä½œï¼š</p>
<ul>
<li>Firstï¼šè¿”å›å½“å‰Bucketçš„ç¬¬ä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Lastï¼šè¿”å›å½“å‰Bucketçš„æœ€åä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Nextï¼šè¿”å›å½“å‰æ¸¸æ ‡ä½ç½®çš„ä¸‹ä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Prevï¼šè¿”å›å½“å‰æ¸¸æ ‡ä½ç½®çš„ä¸Šä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Seekï¼šæŸ¥æ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹è¿”å›å…¶é”®ã€å€¼ã€‚</li>
<li>keyValueï¼šè¿”å›å½“å‰æ¸¸æ ‡ä½ç½®çš„é”®ã€å€¼ã€æ ‡å¿—ä½ã€‚</li>
<li>Deleteï¼šåˆ é™¤å½“å‰æ¸¸æ ‡ä½ç½®çš„æ•°æ®ã€‚</li>
</ul>
<p>åœ¨è¿™é‡Œï¼Œä¸æ‰“ç®—è®¨è®ºå…¶ä¸­çš„æ‰€æœ‰å®ç°ï¼Œå¦‚æœè¯»è€…å¯¹B+æ ‘çš„å®ç°å¹¶ä¸äº†è§£ï¼Œå¯ä»¥çœ‹æœ€å¼€å§‹ä»‹ç»B+æ ‘åŸç†çš„è¿æ¥ã€‚</p>
<p>è¿™é‡Œä»¥<code>First</code>å‡½æ•°ä¸ºä¾‹ç®€å•çš„è®²è§£å…¶å®ç°ï¼Œç”±äºB+æ ‘æ˜¯ä¸­åºéå†çš„æ ‘ç»“æ„ï¼Œå› æ­¤<code>First</code>å…ƒç´ ä¸€å®šæ˜¯æœ€å·¦è¾¹å¶å­èŠ‚ç‚¹çš„å·¦è¾¹ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¸¦æ³¨é‡Šçš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// ç§»åŠ¨åˆ°bucketçš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸Šï¼Œè¿”å›å…¶key valueæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">func</span> (c <span style="color:#666">*</span>Cursor) <span style="color:#00a000">First</span>() (key []<span style="color:#0b0;font-weight:bold">byte</span>, value []<span style="color:#0b0;font-weight:bold">byte</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#00a000">_assert</span>(c.bucket.tx.db <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span>, <span style="color:#b44">&#34;tx closed&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// ä¿®æ”¹stackåªä¿å­˜ç¬¬ä¸€ä¸ªstackï¼ŒåŠæ ˆåº•éƒ¨
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	c.stack = c.stack[:<span style="color:#666">0</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// è¿”å›rootèŠ‚ç‚¹çš„pageã€node
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	p, n <span style="color:#666">:=</span> c.bucket.<span style="color:#00a000">pageNode</span>(c.bucket.root)
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// å°†rootèŠ‚ç‚¹æ‰€åœ¨çš„pageã€nodeä¿¡æ¯æ”¾åˆ°æ ˆé¡¶ï¼Œindexä¸º0ï¼Œè¡¨ç¤ºä»ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å¼€å§‹éå†
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	c.stack = <span style="color:#a2f">append</span>(c.stack, elemRef{page: p, node: n, index: <span style="color:#666">0</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// ç§»åŠ¨åˆ°å½“å‰çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// firstå‡½æ•°åšçš„äº‹æƒ…ï¼šä»æ ‘é¡¶ç«¯å¼€å§‹ï¼Œä»æœ€å·¦è¾¹ä¸€ç›´å¾€ä¸‹éå†åˆ°å¶å­èŠ‚ç‚¹ä¸ºæ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å› ä¸ºBæ ‘æ˜¯ä¸­åºéå†çš„ï¼Œæ‰€ä»¥æœ€å·¦è¾¹çš„èŠ‚ç‚¹æ•°æ®æœ€å°
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	c.<span style="color:#00a000">first</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// If we land on an empty page then move to the next value.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// https://github.com/boltdb/bolt/issues/450
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#080;font-style:italic">// å¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œå°±ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ 
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> c.stack[<span style="color:#a2f">len</span>(c.stack)<span style="color:#666">-</span><span style="color:#666">1</span>].<span style="color:#00a000">count</span>() <span style="color:#666">==</span> <span style="color:#666">0</span> {
</span></span><span style="display:flex;"><span>		c.<span style="color:#00a000">next</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// æ‹¿åˆ°kã€vã€flags
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	k, v, flags <span style="color:#666">:=</span> c.<span style="color:#00a000">keyValue</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">// å¦‚æœæ˜¯å­bucketï¼Œå°±è¿”å›kä»¥åŠnil
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>	<span style="color:#a2f;font-weight:bold">if</span> (flags <span style="color:#666">&amp;</span> <span style="color:#a2f">uint32</span>(bucketLeafFlag)) <span style="color:#666">!=</span> <span style="color:#666">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">return</span> k, <span style="color:#a2f;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> k, v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// first moves the cursor to the first leaf element under the last page in the stack.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">// æ‰¾åˆ°stackæœ€åä¸€ä¸ªé¡µé¢ä¸­çš„ç¬¬ä¸€ä¸ªå¶å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">func</span> (c <span style="color:#666">*</span>Cursor) <span style="color:#00a000">first</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">for</span> {	<span style="color:#080;font-style:italic">// æ‰¾åˆ°æœ€å·¦è¾¹ç¬¬ä¸€ä¸ªå¶å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// Exit when we hit a leaf page.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// æ¯æ¬¡å¾ªç¯å–å‡ºæœ€åä¸€ä¸ªå…ƒç´ 
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		<span style="color:#a2f;font-weight:bold">var</span> ref = <span style="color:#666">&amp;</span>c.stack[<span style="color:#a2f">len</span>(c.stack)<span style="color:#666">-</span><span style="color:#666">1</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">if</span> ref.<span style="color:#00a000">isLeaf</span>() {	<span style="color:#080;font-style:italic">// å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹å°±é€€å‡ºå¾ªç¯ï¼Œå³è¿™ä¸ªå¾ªç¯ç»ˆæ­¢çš„æ¡ä»¶æ˜¯å‘ä¸‹ä¸€ç›´æ‰¾åˆ°å¶å­èŠ‚ç‚¹ä¸ºæ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>			<span style="color:#a2f;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// Keep adding pages pointing to the first element to the stack.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// æ ¹æ®ref.indexæ‹¿åˆ°pgid
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		<span style="color:#a2f;font-weight:bold">var</span> pgid pgid
</span></span><span style="display:flex;"><span>		<span style="color:#a2f;font-weight:bold">if</span> ref.node <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			pgid = ref.node.inodes[ref.index].pgid
</span></span><span style="display:flex;"><span>		} <span style="color:#a2f;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			pgid = ref.page.<span style="color:#00a000">branchPageElement</span>(<span style="color:#a2f">uint16</span>(ref.index)).pgid
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// æ‹¿åˆ°å¯¹åº”çš„pageã€node
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		p, n <span style="color:#666">:=</span> c.bucket.<span style="color:#00a000">pageNode</span>(pgid)
</span></span><span style="display:flex;"><span>		<span style="color:#080;font-style:italic">// æ”¾åˆ°æ ˆé¡¶ï¼Œæ³¨æ„è¿™é‡Œçš„indexæ˜¯0
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// å³å‘ä¸‹æŸ¥æ‰¾çš„æ—¶å€™å–çš„éƒ½æ˜¯æœ€å·¦è¾¹çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		c.stack = <span style="color:#a2f">append</span>(c.stack, elemRef{page: p, node: n, index: <span style="color:#666">0</span>})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20200625-boltdb-1/">â† prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20200725-boltdb-3/">next â†’</a>
    
  </div>

    
<h1>ç›¸å…³æ–‡ç« </h1><li><strong> 1029-02-01: </strong> <a href="https://www.codedump.info/post/20220201-sqlite-btree-5-btree/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆäº”ï¼‰- Btreeçš„å®ç°</a>  </li><li><strong> 6019-01-06: </strong> <a href="https://www.codedump.info/post/20220106-sqlite-btree-4-wal/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆå››ï¼‰- WALçš„å®ç°</a>  </li><li><strong> 22129-12-22: </strong> <a href="https://www.codedump.info/post/20211222-sqlite-btree-3-journal/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆä¸‰ï¼‰- journalæ–‡ä»¶å¤‡ä»½æœºåˆ¶</a>  </li><li><strong> 18129-12-18: </strong> <a href="https://www.codedump.info/post/20211218-sqlite-btree-2-concurrency-control/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆäºŒï¼‰- å¹¶å‘æ§åˆ¶æ¡†æ¶</a>  </li><li><strong> 17129-12-17: </strong> <a href="https://www.codedump.info/post/20211217-sqlite-btree-1-pagecache/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆä¸€ï¼‰- ç®¡ç†é¡µé¢ç¼“å­˜</a>  </li><li><strong> 17129-12-17: </strong> <a href="https://www.codedump.info/post/20211217-sqlite-btree-0/">sqlite3.36ç‰ˆæœ¬ btreeå®ç°ï¼ˆé›¶ï¼‰- èµ·æ­¥åŠæ¦‚è¿°</a>  </li><li><strong> 26079-07-26: </strong> <a href="https://www.codedump.info/post/20200726-boltdb-4/">boltdb 1.3.0å®ç°åˆ†æï¼ˆå››ï¼‰</a>  </li><li><strong> 25079-07-25: </strong> <a href="https://www.codedump.info/post/20200725-boltdb-3/">boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸‰ï¼‰</a>  </li><li><strong> 25069-06-25: </strong> <a href="https://www.codedump.info/post/20200625-boltdb-1/">boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸€ï¼‰</a>  </li><li><strong> 15069-06-15: </strong> <a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B&#43;æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a>  </li><li><strong> 9069-06-09: </strong> <a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B&#43;æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a>  </li><li><strong> 15029-02-15: </strong> <a href="https://www.codedump.info/post/20190215-leveldb/">Leveldbä»£ç é˜…è¯»ç¬”è®°</a>  </li>

<h1>é‚®ä»¶è®¢é˜…</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="é‚®ä»¶è®¢é˜…æœ¬ç«™æ›´æ–°" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="ç‚¹å‡»è®¢é˜…" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revueâ€™s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://www.codedump.info/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%AD%98%E5%82%A8/">å­˜å‚¨</a>
          <a href="/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">å­˜å‚¨å¼•æ“</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    

        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  

  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
