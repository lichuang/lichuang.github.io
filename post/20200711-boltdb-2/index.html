<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="boltdb 1.3.0å®ç°åˆ†æ">




<meta name="keywords" content=" boltdb  å­˜å‚¨å¼•æ“ ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰" />
<meta name="twitter:description" content="æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB&#43;æ ‘ç»“" />


<link rel="canonical" href="https://www.codedump.info/post/20200711-boltdb-2/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>boltdb 1.3.0å®ç°åˆ†æï¼ˆäºŒï¼‰</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8'>#å­˜å‚¨</a>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E'>#å­˜å‚¨å¼•æ“</a>
        
      </div>
      
      <div class="content">
        

<blockquote>
<p>æœ¬æ–‡åŸºäºboltdb 1.3.0å¯¹å…¶å®ç°è¿›è¡Œåˆ†æã€‚boltdbæ˜¯etcdç³»ç»Ÿå­˜å‚¨æ•°æ®ä½¿ç”¨çš„KVåµŒå…¥å¼DBï¼Œä½¿ç”¨Goç¼–ç å®ç°ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ªB+æ ‘ç»“æ„ä½“ã€‚å…³äºetcdã€raftåè®®ä»¥åŠB+æ ‘ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p>

<ul>
<li><a href="https://www.codedump.info/post/20180921-raft/">Raftç®—æ³•åŸç†</a></li>
<li><a href="https://www.codedump.info/post/20180922-etcd-raft/">etcd Raftåº“è§£æ</a></li>
<li><a href="https://www.codedump.info/post/20181125-etcd-server/">Etcdå­˜å‚¨çš„å®ç°</a></li>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">Bæ ‘ã€B+æ ‘ç´¢å¼•ç®—æ³•åŸç†ï¼ˆä¸‹ï¼‰</a></li>
</ul>

<p>æœ¬æ–‡çš„å†™ä½œï¼Œä¸»è¦å‚è€ƒäº†<a href="https://www.jianshu.com/p/b86a69892990">ã€ŠåŒºå—çš„æŒä¹…åŒ–ä¹‹BoltDBã€‹ç³»åˆ—æ–‡ç« </a>ä»¥åŠ<a href="https://youjiali1995.github.io/storage/boltdb">boltdb æºç åˆ†æ</a></p>
</blockquote>

<p>åœ¨<a href="https://www.codedump.info/post/20200625-boltdb-1/">ä¸Šä¸€èŠ‚</a>é‡Œé¢ï¼Œç³»ç»Ÿçš„ä»‹ç»äº†Boltdbä¸­å‡ ç§ç±»å‹é¡µé¢çš„æ ¼å¼ï¼Œæœ‰äº†è¿™äº›åŸºç¡€ï¼Œæœ¬èŠ‚å¼€å§‹ä»‹ç»boltdbä¸­çš„Bucketç»“æ„ã€‚</p>

<h1 id="bucket">Bucket</h1>

<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>

<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼ŒBucketç±»æ¯”äºmysqlä¸­çš„tableï¼Œåœ¨boltdbä¸­ï¼Œ<code>meta</code>é¡µé¢ä¸­æœ‰ä¸€ä¸ªæˆå‘˜<code>bucket</code>ï¼Œå…¶å­˜å‚¨äº†æ•´ä¸ªæ•°æ®åº“æ ¹bucketçš„ä¿¡æ¯ï¼Œè€Œä¸€ä¸ªæ•°æ®åº“ä¸­å­˜å‚¨çš„å…¶ä»–tableçš„ä¿¡æ¯ï¼Œåˆ™ä½œä¸ºå­bucketå­˜å‚¨åˆ°Bucketä¸­ã€‚è¿™å‡ ä¸ªæ•°æ®ç»“æ„çš„å…³ç³»å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">type DB struct {
  // ...
	meta0    *meta
	meta1    *meta  
}

type meta struct {
  // ...
	root     bucket	// æ ¹bucketçš„ä¿¡æ¯
}

type Bucket struct {
	*bucket

  // ...
  buckets  map[string]*Bucket // å­˜å‚¨å­bucketçš„å¯¹åº”å…³ç³»
}

type bucket struct {
	// æ ¹èŠ‚ç‚¹çš„page id
	root pgid // page id of the bucket's root-level page
	// å•è°ƒé€’å¢çš„åºåˆ—å·
	sequence uint64 // monotonically incrementing, used by NextSequence()
}
</code></pre>

<p>åœ¨<code>bucket</code>æ•°æ®ç»“æ„ä¸­ï¼Œä¸¤ä¸ªæˆå‘˜çš„ä½œç”¨æ˜¯ï¼š</p>

<ul>
<li>rootï¼šè¯¥bucketçš„æ ¹èŠ‚ç‚¹çš„page idã€‚</li>
<li>sequenceï¼šè¯¥bucketå½“å‰çš„åºåˆ—å·ï¼Œå•è°ƒé€’å¢ï¼Œåœ¨å‡½æ•°<code>NextSequence</code>ä¸­ä½¿ç”¨ã€‚</li>
</ul>

<p>æ¯ä¸ª<code>Bucket</code>æ•°æ®ç»“æ„ï¼Œéƒ½ç»§æ‰¿è‡ª<code>bucket</code>ï¼ŒåŒæ—¶å…¶ä¸­çš„<code>buckets</code>å­˜å‚¨äº†è¯¥<code>Bucket</code>ä¸­å­Bucketåå­—çš„å¯¹åº”å…³ç³»ã€‚</p>

<p>æœ€åï¼Œ<code>meta</code>é¡µé¢çš„<code>root</code>æˆå‘˜ï¼Œå­˜å‚¨çš„å°±æ˜¯è¿™ä¸ªdbçš„æ ¹<code>bucket</code>é¡µé¢ä¿¡æ¯ã€‚è¿™å‡ ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200711-boltdb-2/buckets.png" alt="buckets" title="buckets" />
</center></p>

<p>åœ¨ä¸Šå›¾ä¸­ï¼š</p>

<ul>
<li><code>DB</code>ç»“æ„ä½“æ˜¯è¡¨ç¤ºæ•´ä¸€ä¸ªboltdbæ•°æ®åº“çš„ç»“æ„ä½“ï¼Œå…¶ä¸­æœ‰<code>meta0</code>å’Œ<code>meta1</code>ä¸¤ä¸ª<code>meta</code>ç±»å‹çš„æˆå‘˜ï¼Œç”¨äºä¿å­˜<code>meta</code>é¡µé¢ä¿¡æ¯ã€‚</li>
<li><code>meta</code>é¡µé¢ä¸­ï¼Œå…¶ä¸­çš„<code>root</code>æ˜¯ä¸€ä¸ª<code>bucket</code>ç±»å‹æˆå‘˜ï¼Œä¿å­˜äº†æ ¹bucketçš„é¡µé¢ä¿¡æ¯ã€‚</li>
<li>æ ¹æ®<code>bucket</code>ä¸­çš„é¡µé¢ä¿¡æ¯ï¼Œå°±èƒ½æ‰¾åˆ°DBçš„æ ¹<code>Bucket</code>ä¿¡æ¯ï¼Œå…¶ä¸­çš„<code>buckets</code>æˆå‘˜ä¿å­˜äº†è¯¥æ•°æ®åº“ä¸­æ‰€æœ‰å­<code>bucket</code>åå­—ä¸å®ä½“ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</li>
</ul>

<h2 id="bucketç»“æ„ä½“å®šä¹‰">Bucketç»“æ„ä½“å®šä¹‰</h2>

<p>æ¥ä¸‹æ¥ä»‹ç»<code>Bucket</code>ç»“æ„ä½“æˆå‘˜ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">type Bucket struct {
	*bucket
	tx       *Tx                // the associated transaction
	buckets  map[string]*Bucket // subbucket cache
	page     *page              // inline page reference
	rootNode *node              // materialized node for the root page.
	nodes    map[pgid]*node     // node cache

	// Sets the threshold for filling nodes when they split. By default,
	// the bucket will fill to 50% but it can be useful to increase this
	// amount if you know that your write workloads are mostly append-only.
	//
	// This is non-persisted across transactions so it must be set in every Tx.
	FillPercent float64
}
</code></pre>

<p>å…¶ä¸­ï¼š</p>

<ul>
<li>bucketï¼šå­˜å‚¨è¯¥<code>Bucket</code>æ‰€åœ¨é¡µé¢IDï¼Œä»¥åŠå½“å‰åºåˆ—å·ã€‚</li>
<li>txï¼šå½“å‰Bucketå…³è”çš„äº‹åŠ¡ã€‚</li>
<li>bucketsï¼šå‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œç»´æŠ¤å­<code>bucket</code>çš„æ˜ å°„å…³ç³»ã€‚</li>
<li>pageï¼šå­˜å‚¨inlineé¡µé¢ä¿¡æ¯ã€‚</li>
<li>rootNodeï¼šè¯¥Bucketçš„B+æ ‘æ ¹èŠ‚ç‚¹æŒ‡é’ˆã€‚</li>
<li>nodesï¼šç¼“å­˜å·²ç»è¯»å…¥å†…å­˜çš„<code>page</code>å¯¹åº”çš„<code>node</code>ä¿¡æ¯ã€‚</li>
<li>FillPercentï¼šè¿™æ˜¯ä¸€ä¸ªé˜ˆå€¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®é‡è¶…è¿‡è¯¥é˜ˆå€¼æ—¶è¿›è¡Œåˆ†è£‚æ“ä½œï¼Œé»˜è®¤å€¼ä¸ºDefaultFillPercent=0.5ã€‚è‡³äºB+æ ‘åˆ†è£‚æ“ä½œçš„æµç¨‹ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æœ€å¼€å§‹çš„B+æ ‘åŸç†é“¾æ¥ã€‚</li>
</ul>

<h2 id="å­bucket">å­Bucket</h2>

<p>æŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œä¸€ä¸ªboltçš„DBå­˜åœ¨ä¸€ä¸ªå”¯ä¸€çš„æ ¹Bucketï¼Œè€ŒDBä¸­ä¸åŒçš„tableå°±æ˜¯è¯¥æ ¹Bucketçš„å­Bucketï¼Œå…¶å¯¹åº”å…³ç³»å­˜å‚¨åœ¨<code>Bucket.buckets</code>æˆå‘˜ä¸­ã€‚é‚£ä¹ˆï¼Œå­Bucketä¿¡æ¯ä¿å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>

<p>ç­”æ¡ˆæ˜¯ä¿å­˜åœ¨å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<code>leafPageElement</code>ä¸­ï¼Œå›é¡¾ä¸€ä¸‹è¿™ä¸ªæ•°æ®ç»“æ„çš„å®šä¹‰ï¼š</p>

<pre><code class="language-Go">// leafPageElement represents a node on a leaf page.
type leafPageElement struct {
	flags uint32
	pos   uint32
	ksize uint32
	vsize uint32
}
</code></pre>

<p>å…¶ä¸­çš„<code>flags</code>æˆå‘˜ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</p>

<ul>
<li>0ï¼šè¡¨ç¤ºå°±æ˜¯æ™®é€šçš„å¶å­èŠ‚ç‚¹ã€‚</li>
<li>1ï¼šè¡¨ç¤ºæ˜¯å­bucketã€‚</li>
</ul>

<p>å³åœ¨boltdbä¸­ï¼Œå­Bucketçš„ä¿¡æ¯ï¼Œæ˜¯åšä¸ºä¸€ç§ç‰¹æ®Šçš„å¶å­èŠ‚ç‚¹ä¿¡æ¯å­˜å‚¨ä¸‹æ¥çš„ã€‚boltdbä½¿ç”¨äº†å¸¸é‡æ¥è¡¨ç¤ºè¿™ç§ç±»å‹çš„å¶å­èŠ‚ç‚¹æ ‡å¿—ä½ï¼š</p>

<pre><code class="language-Go">const (
	bucketLeafFlag = 0x01
)
</code></pre>

<p>å³ï¼š</p>

<ul>
<li>å¯¹äºä¸€ä¸ªæ ‡å¿—ä½ä¸º0çš„å¶å­é¡µé¢ï¼šå…¶å†…å®¹å°±æ˜¯B+æ ‘å¶å­é¡µé¢çš„å†…å®¹ï¼Œå­˜å‚¨çš„æ˜¯æ•°æ®çš„é”®å€¼ï¼Œboltdbä¸­å¶å­é¡µé¢çš„æ ¼å¼ç¤ºæ„å›¾åœ¨<a href="https://www.codedump.info/post/20200625-boltdb-1/#leaf%E9%A1%B5%E9%9D%A2">ä¸Šä¸€èŠ‚ä¸­</a>å·²ç»ç»™å‡ºã€‚</li>
<li>å¯¹äºä¸€ä¸ªæ ‡å¿—ä½ä¸º1çš„å¶å­é¡µé¢ï¼šå…¶å†…å­˜å­˜å‚¨çš„æ˜¯Bucketç»“æ„ä½“çš„ä¿¡æ¯ã€‚</li>
</ul>

<p>æœ‰äº†ä»¥ä¸Šçš„ä»‹ç»ï¼Œç†è§£èµ·æ¥è¿”å›ä¸€ä¸ªå­Bucketçš„ç›¸å…³ä»£ç å°±ä¸éš¾äº†ï¼š</p>

<pre><code class="language-Go">func (b *Bucket) Bucket(name []byte) *Bucket {
	// Move cursor to key.
	// å¦åˆ™åˆ›å»ºä¸€ä¸ªCursoræŸ¥è¯¢
	c := b.Cursor()
	k, v, flags := c.seek(name)

	// Return nil if the key doesn't exist or it is not a bucket.
	// æŸ¥è¯¢ä¸åˆ°ï¼Œæˆ–è€…ä¸æ˜¯å­bucketèŠ‚ç‚¹ï¼Œéƒ½è¿”å›nil
	if !bytes.Equal(name, k) || (flags&amp;bucketLeafFlag) == 0 {
		return nil
	}

	// Otherwise create a bucket and cache it.
	// æ‰“å¼€è¿™ä¸ªbucketå¹¶ä¸”cacheåˆ°buckets mapä¸­
	var child = b.openBucket(v)
	if b.buckets != nil {
		b.buckets[string(name)] = child
	}

	return child
}

func (b *Bucket) openBucket(value []byte) *Bucket {
	// åˆ›å»ºä¸€ä¸ªbucket
	var child = newBucket(b.tx)

	// If this is a writable transaction then we need to copy the bucket entry.
	// Read-only transactions can point directly at the mmap entry.
	if b.tx.writable {
		child.bucket = &amp;bucket{}
		*child.bucket = *(*bucket)(unsafe.Pointer(&amp;value[0]))
	} else {
		child.bucket = (*bucket)(unsafe.Pointer(&amp;value[0]))
	}

	// Save a reference to the inline page if the bucket is inline.
	// inline bucket
	if child.root == 0 {
		// bucketçš„page
		child.page = (*page)(unsafe.Pointer(&amp;value[bucketHeaderSize]))
	}

	return &amp;child
}
</code></pre>

<p><code>Bucket.Bucket</code>ç”¨äºæ ¹æ®åå­—è¿”å›ä¸€ä¸ªå­Bucketçš„æŒ‡é’ˆï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
<li>é¦–å…ˆæ ¹æ®å­Bucketåå­—æŸ¥æ‰¾åˆ°å¶å­é¡µé¢çš„æ•°æ®ã€æ ‡å¿—ä½ï¼Œå¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥å­Bucketï¼›æˆ–è€…å…¶æ ‡å¿—ä½ä¸æ˜¯<code>bucketLeafFlag</code>ï¼Œè¯´æ˜è¿™ä¸ªåå­—å·²ç»è¢«æ™®é€šæ•°æ®å ç”¨ï¼Œå³ï¼šboltdbä¸­ä¸å…è®¸å­Bucketä¸å…¶çˆ¶Bucketä¸­å†™å…¥çš„é”®åŒåã€‚</li>
<li>ä»¥ä¸ŠæŸ¥æ‰¾æˆåŠŸï¼Œå°±ä»¥è¯¥å¶å­é¡µé¢çš„æ•°æ®ä¸ºå‚æ•°ï¼Œè°ƒç”¨<code>Bucket.openBucket</code>å‡½æ•°ï¼Œæ ¹æ®<code>Bucket</code>ç»“æ„ä½“æ ¼å¼ï¼Œååºåˆ—åŒ–å‡ºæ¥<code>Bucket</code>ç»“æ„ä½“ä¿¡æ¯è¿”å›ã€‚</li>
</ul>

<h2 id="inline-page">inline page</h2>

<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå­Bucketçš„ä¿¡æ¯æ˜¯ç‹¬å ä¸€ä¸ªå¶å­é¡µé¢æ¥å­˜å‚¨çš„ï¼Œè¯¥é¡µé¢å¤§éƒ¨åˆ†çš„å†…å®¹éƒ½æ˜¯å†—ä½™çš„ã€‚å¦‚æœå­Bucketä¸­çš„æ•°æ®é‡å¾ˆå°‘ï¼Œå°±ä¼šé€ æˆç£ç›˜ç©ºé—´çš„æµªè´¹ã€‚ä¸ºäº†é’ˆå¯¹è¿™ç±»å‹Bucketè¿›è¡Œä¼˜åŒ–ï¼Œboltdbæä¾›äº†<code>inline page</code>è¿™ä¸ªç‰¹æ®Šçš„é¡µé¢ï¼Œå°†å°çš„å­Bucketæ•°æ®å­˜æ”¾åœ¨è¿™é‡Œã€‚</p>

<p>è¿™ç±»å‹çš„å­Bucketéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>

<ul>
<li>è¯¥å­Bucketå†æ²¡æœ‰åµŒå¥—çš„å­Bucketäº†ã€‚</li>
<li>æ•´ä¸ªå­Bucketçš„å¤§å°ä¸èƒ½è¶…è¿‡page size/4ã€‚</li>
</ul>

<p><code>Bucket.inlineable</code>å‡½æ•°å°±æ˜¯ç”¨æ¥åš<code>inline</code>æ“ä½œçš„åˆ¤æ–­çš„ï¼š</p>

<pre><code class="language-Go">// inlineable returns true if a bucket is small enough to be written inline
// and if it contains no subbuckets. Otherwise returns false.
// è¿”å›è¿™ä¸ªbucketæ˜¯å¦èƒ½å¤Ÿinlineæ“ä½œ
func (b *Bucket) inlineable() bool {
	var n = b.rootNode

	// Bucket must only contain a single leaf node.
	// å¦‚æœæ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œæˆ–è€…æ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹çš„ä¸èƒ½è¿›è¡Œinlineæ“ä½œ
	if n == nil || !n.isLeaf {
		return false
	}

	// Bucket is not inlineable if it contains subbuckets or if it goes beyond
	// our threshold for inline bucket size.
	// æœ‰å­bucketï¼Œæˆ–è€…å¤§å°è¶…è¿‡maxInlineBucketSizeé˜ˆå€¼çš„ï¼Œéƒ½ä¸èƒ½è¿›è¡Œinlineæ“ä½œ
	var size = pageHeaderSize
	for _, inode := range n.inodes {
		size += leafPageElementSize + len(inode.key) + len(inode.value)

		if inode.flags&amp;bucketLeafFlag != 0 {
			return false
		} else if size &gt; b.maxInlineBucketSize() {
			return false
		}
	}

	return true
}

// Returns the maximum total size of a bucket to make it a candidate for inlining.
func (b *Bucket) maxInlineBucketSize() int {
	return b.tx.db.pageSize / 4
}
</code></pre>

<h1 id="cursor">Cursor</h1>

<p>ä»¥ä¸Šå·²ç»å¤§ä½“äº†è§£<code>Bucket</code>çš„ç»“æ„ï¼Œåœ¨boltdbæŸ¥æ‰¾æ•°æ®æµç¨‹ä¸­ï¼Œè¿˜æ˜¯ä½¿ç”¨äº†<code>Cursor</code>ç»“æ„ä½“æ¥åšä¸ºæ¸¸æ ‡ï¼ˆiteratorï¼‰ï¼Œä¿å­˜æŸ¥æ‰¾æµç¨‹ä¸­çš„ä¸­é—´æ•°æ®ï¼Œä¸‹é¢ä¹Ÿæ¥ç®€å•äº†è§£ä¸€ä¸‹ã€‚</p>

<p><code>Cursor</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">type Cursor struct {
	bucket *Bucket		// å¯¹åº”çš„bucket
	stack  []elemRef	// å­˜å‚¨é€’å½’éå†æ—¶ä¸­é—´è¿‡ç¨‹çš„æ ˆï¼Œç”±äºæ ˆæ˜¯å…ˆè¿›åå‡ºç»“æ„ï¼Œæ‰€ä»¥éå†çš„è¿‡ç¨‹ä¸­å±‚æ¬¡é«˜çš„åœ¨æ ˆçš„ä½ç«¯ã€‚
}

// å…‰æ ‡ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸­é—´è¿‡ç¨‹çš„ä¿¡æ¯
type elemRef struct {
	page  *page	// é¡µé¢
	node  *node	// å†…å­˜ä¸­çš„é¡µé¢ä¿¡æ¯
	index int		// ä¿å­˜åœ¨å½“å‰pageã€nodeéå†åˆ°äº†å“ªä¸ªèŠ‚ç‚¹
}
</code></pre>

<p><code>Cursor</code>æœ‰ä»¥ä¸‹æˆå‘˜ï¼š</p>

<ul>
<li>bucketï¼šæ¸¸æ ‡æ“ä½œæ‰€å¯¹åº”çš„<code>Bucket</code>æŒ‡é’ˆã€‚</li>
<li>stackï¼šå­˜å‚¨é€’å½’éå†è¿‡ç¨‹ä¸­çš„æ ˆï¼Œç”±äºæ ˆæ˜¯å…ˆè¿›åå‡ºç»“æ„ï¼Œæ‰€ä»¥éå†çš„è¿‡ç¨‹ä¸­å±‚æ¬¡é«˜çš„èŠ‚ç‚¹åœ¨æ ˆçš„ä½ç«¯ã€‚</li>
</ul>

<p>æ¯ä¸ªstackæˆå‘˜ç±»å‹æ˜¯<code>elemRef</code>ï¼Œå…¶æˆå‘˜å¦‚ä¸‹ï¼š</p>

<ul>
<li>pageï¼šé¡µé¢æŒ‡é’ˆã€‚</li>
<li>nodeï¼šå†…å­˜ä¸­çš„é¡µé¢ä¿¡æ¯ã€‚</li>
<li>indexï¼šä¿å­˜éå†åˆ°å½“å‰é¡µé¢çš„ç´¢å¼•ä½ç½®ã€‚</li>
</ul>

<p>ç”±äº<code>node</code>æ˜¯<code>page</code>åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºï¼Œæ‰€ä»¥å®é™…ä¸Šåœ¨<code>elemRef</code>ç»“æ„ä½“ä¸­ï¼Œ<code>page</code>å’Œ<code>node</code>æˆå‘˜åŒæ—¶åªä¼šæœ‰ä¸€ä¸ªæˆå‘˜ä¸ä¸ºNULLã€‚</p>

<p><code>Cursor</code>ç»“æ„ä½“åšä¸ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¯¹å¤–æä¾›çš„å°±æ˜¯å¸¸è§„è¿­ä»£å™¨æ‰€æ”¯æŒçš„æ“ä½œï¼š</p>

<ul>
<li>Firstï¼šè¿”å›å½“å‰Bucketçš„ç¬¬ä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Lastï¼šè¿”å›å½“å‰Bucketçš„æœ€åä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Nextï¼šè¿”å›å½“å‰æ¸¸æ ‡ä½ç½®çš„ä¸‹ä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Prevï¼šè¿”å›å½“å‰æ¸¸æ ‡ä½ç½®çš„ä¸Šä¸€ä¸ªæ•°æ®ã€‚</li>
<li>Seekï¼šæŸ¥æ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹è¿”å›å…¶é”®ã€å€¼ã€‚</li>
<li>keyValueï¼šè¿”å›å½“å‰æ¸¸æ ‡ä½ç½®çš„é”®ã€å€¼ã€æ ‡å¿—ä½ã€‚</li>
<li>Deleteï¼šåˆ é™¤å½“å‰æ¸¸æ ‡ä½ç½®çš„æ•°æ®ã€‚</li>
</ul>

<p>åœ¨è¿™é‡Œï¼Œä¸æ‰“ç®—è®¨è®ºå…¶ä¸­çš„æ‰€æœ‰å®ç°ï¼Œå¦‚æœè¯»è€…å¯¹B+æ ‘çš„å®ç°å¹¶ä¸äº†è§£ï¼Œå¯ä»¥çœ‹æœ€å¼€å§‹ä»‹ç»B+æ ‘åŸç†çš„è¿æ¥ã€‚</p>

<p>è¿™é‡Œä»¥<code>First</code>å‡½æ•°ä¸ºä¾‹ç®€å•çš„è®²è§£å…¶å®ç°ï¼Œç”±äºB+æ ‘æ˜¯ä¸­åºéå†çš„æ ‘ç»“æ„ï¼Œå› æ­¤<code>First</code>å…ƒç´ ä¸€å®šæ˜¯æœ€å·¦è¾¹å¶å­èŠ‚ç‚¹çš„å·¦è¾¹ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¸¦æ³¨é‡Šçš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>

<pre><code class="language-Go">// ç§»åŠ¨åˆ°bucketçš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸Šï¼Œè¿”å›å…¶key valueæ•°æ®
func (c *Cursor) First() (key []byte, value []byte) {
	_assert(c.bucket.tx.db != nil, &quot;tx closed&quot;)
	// ä¿®æ”¹stackåªä¿å­˜ç¬¬ä¸€ä¸ªstackï¼ŒåŠæ ˆåº•éƒ¨
	c.stack = c.stack[:0]
	// è¿”å›rootèŠ‚ç‚¹çš„pageã€node
	p, n := c.bucket.pageNode(c.bucket.root)
	// å°†rootèŠ‚ç‚¹æ‰€åœ¨çš„pageã€nodeä¿¡æ¯æ”¾åˆ°æ ˆé¡¶ï¼Œindexä¸º0ï¼Œè¡¨ç¤ºä»ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å¼€å§‹éå†
	c.stack = append(c.stack, elemRef{page: p, node: n, index: 0})
	// ç§»åŠ¨åˆ°å½“å‰çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
	// firstå‡½æ•°åšçš„äº‹æƒ…ï¼šä»æ ‘é¡¶ç«¯å¼€å§‹ï¼Œä»æœ€å·¦è¾¹ä¸€ç›´å¾€ä¸‹éå†åˆ°å¶å­èŠ‚ç‚¹ä¸ºæ­¢
	// å› ä¸ºBæ ‘æ˜¯ä¸­åºéå†çš„ï¼Œæ‰€ä»¥æœ€å·¦è¾¹çš„èŠ‚ç‚¹æ•°æ®æœ€å°
	c.first()

	// If we land on an empty page then move to the next value.
	// https://github.com/boltdb/bolt/issues/450
	// å¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œå°±ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ 
	if c.stack[len(c.stack)-1].count() == 0 {
		c.next()
	}

	// æ‹¿åˆ°kã€vã€flags
	k, v, flags := c.keyValue()
	// å¦‚æœæ˜¯å­bucketï¼Œå°±è¿”å›kä»¥åŠnil
	if (flags &amp; uint32(bucketLeafFlag)) != 0 {
		return k, nil
	}
	return k, v

}

// first moves the cursor to the first leaf element under the last page in the stack.
// æ‰¾åˆ°stackæœ€åä¸€ä¸ªé¡µé¢ä¸­çš„ç¬¬ä¸€ä¸ªå¶å­èŠ‚ç‚¹
func (c *Cursor) first() {
	for {	// æ‰¾åˆ°æœ€å·¦è¾¹ç¬¬ä¸€ä¸ªå¶å­èŠ‚ç‚¹
		// Exit when we hit a leaf page.
		// æ¯æ¬¡å¾ªç¯å–å‡ºæœ€åä¸€ä¸ªå…ƒç´ 
		var ref = &amp;c.stack[len(c.stack)-1]
		if ref.isLeaf() {	// å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹å°±é€€å‡ºå¾ªç¯ï¼Œå³è¿™ä¸ªå¾ªç¯ç»ˆæ­¢çš„æ¡ä»¶æ˜¯å‘ä¸‹ä¸€ç›´æ‰¾åˆ°å¶å­èŠ‚ç‚¹ä¸ºæ­¢
			break
		}

		// Keep adding pages pointing to the first element to the stack.
		// æ ¹æ®ref.indexæ‹¿åˆ°pgid
		var pgid pgid
		if ref.node != nil {
			pgid = ref.node.inodes[ref.index].pgid
		} else {
			pgid = ref.page.branchPageElement(uint16(ref.index)).pgid
		}
		// æ‹¿åˆ°å¯¹åº”çš„pageã€node
		p, n := c.bucket.pageNode(pgid)
		// æ”¾åˆ°æ ˆé¡¶ï¼Œæ³¨æ„è¿™é‡Œçš„indexæ˜¯0
		// å³å‘ä¸‹æŸ¥æ‰¾çš„æ—¶å€™å–çš„éƒ½æ˜¯æœ€å·¦è¾¹çš„èŠ‚ç‚¹
		c.stack = append(c.stack, elemRef{page: p, node: n, index: 0})
	}
}
</code></pre>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20200625-boltdb-1/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20200725-boltdb-3/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
