<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" C&#43;&#43;  å†…å­˜æ¨¡å‹ ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹" />
<meta property="og:description" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20191214-cxx11-memory-model-2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-12-14T22:41:22+08:00" />
<meta property="article:modified_time" content="2019-12-14T22:41:22+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20191214-cxx11-memory-model-2/">

  
  
  <meta itemprop="name" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹">
<meta itemprop="description" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹"><meta itemprop="datePublished" content="2019-12-14T22:41:22+08:00" />
<meta itemprop="dateModified" content="2019-12-14T22:41:22+08:00" />
<meta itemprop="wordCount" content="3298">
<meta itemprop="keywords" content="å¤šæ ¸,ç³»ç»Ÿç¼–ç¨‹,ç³»ç»Ÿè®¾è®¡," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹"/>
<meta name="twitter:description" content="C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å‘è¡¨</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">å‘¨åˆŠ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸‹ç¯‡ - C&#43;&#43;11æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/%E5%A4%9A%E6%A0%B8'>#å¤šæ ¸</a>
    
    <a class="link" href='https://www.codedump.info/tags/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B'>#ç³»ç»Ÿç¼–ç¨‹</a>
    
    <a class="link" href='https://www.codedump.info/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1'>#ç³»ç»Ÿè®¾è®¡</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#sequenced-before">sequenced-before</a></li>
    <li><a href="#happens-before">happens-before</a></li>
    <li><a href="#synchronizes-with">synchronizes-with</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <p>åœ¨æœ¬ç³»åˆ—çš„ä¸Šç¯‡ï¼Œä»‹ç»äº†å†…å­˜æ¨¡å‹çš„åŸºæœ¬æ¦‚å¿µï¼Œæ¥ä¸‹æ¥çœ‹C++11ä¸­æ”¯æŒçš„å‡ ç§å†…å­˜æ¨¡å‹ã€‚</p>
<h1 id="å‡ ç§å…³ç³»æœ¯è¯­">å‡ ç§å…³ç³»æœ¯è¯­</h1>
<p>åœ¨æ¥ç€ç»§ç»­è§£é‡Šä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹å‡ ç§å…³ç³»æœ¯è¯­ã€‚</p>
<h2 id="sequenced-before">sequenced-before</h2>
<p>sequenced-beforeç”¨äºè¡¨ç¤º<strong class=chinese>å•çº¿ç¨‹</strong>ä¹‹é—´ï¼Œä¸¤ä¸ªæ“ä½œä¸Šçš„å…ˆåé¡ºåºï¼Œè¿™ä¸ªé¡ºåºæ˜¯éå¯¹ç§°ã€å¯ä»¥è¿›è¡Œä¼ é€’çš„å…³ç³»ã€‚</p>
<p>å®ƒä¸ä»…ä»…è¡¨ç¤ºä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å…ˆåé¡ºåºï¼Œè¿˜è¡¨ç¤ºäº†æ“ä½œç»“æœä¹‹é—´çš„å¯è§æ€§å…³ç³»ã€‚ä¸¤ä¸ªæ“ä½œAå’Œæ“ä½œBï¼Œå¦‚æœæœ‰A sequenced-before Bï¼Œé™¤äº†è¡¨ç¤ºæ“ä½œAçš„é¡ºåºåœ¨Bä¹‹å‰ï¼Œè¿˜è¡¨ç¤ºäº†æ“ä½œAçš„ç»“æœæ“ä½œBå¯è§ã€‚</p>
<h2 id="happens-before">happens-before</h2>
<p>ä¸sequenced-beforeä¸åŒçš„æ˜¯ï¼Œhappens-beforeå…³ç³»è¡¨ç¤ºçš„<strong class=chinese>ä¸åŒçº¿ç¨‹</strong>ä¹‹é—´çš„æ“ä½œå…ˆåé¡ºåºï¼ŒåŒæ ·çš„ä¹Ÿæ˜¯éå¯¹ç§°ã€å¯ä¼ é€’çš„å…³ç³»ã€‚</p>
<p>å¦‚æœA happens-before Bï¼Œåˆ™Açš„å†…å­˜çŠ¶æ€å°†åœ¨Bæ“ä½œæ‰§è¡Œä¹‹å‰å°±å¯è§ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼ŒæŸäº›æƒ…å†µä¸‹ä¸€ä¸ªå†™æ“ä½œåªæ˜¯ç®€å•çš„å†™å…¥å†…å­˜å°±è¿”å›äº†ï¼Œå…¶ä»–æ ¸å¿ƒä¸Šçš„æ“ä½œä¸ä¸€å®šèƒ½é©¬ä¸Šè§åˆ°æ“ä½œçš„ç»“æœï¼Œè¿™æ ·çš„å…³ç³»æ˜¯ä¸æ»¡è¶³happens-beforeçš„ã€‚</p>
<h2 id="synchronizes-with">synchronizes-with</h2>
<p>synchronizes-withå…³ç³»å¼ºè°ƒçš„æ˜¯å˜é‡è¢«ä¿®æ”¹ä¹‹åçš„ä¼ æ’­å…³ç³»ï¼ˆpropagateï¼‰ï¼Œå³å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æŸå˜é‡çš„ä¹‹åçš„ç»“æœèƒ½è¢«å…¶å®ƒçº¿ç¨‹å¯è§ï¼Œé‚£ä¹ˆå°±æ˜¯æ»¡è¶³synchronizes-withå…³ç³»çš„ã€‚</p>
<p>æ˜¾ç„¶ï¼Œæ»¡è¶³synchronizes-withå…³ç³»çš„æ“ä½œä¸€å®šæ»¡è¶³happens-beforeå…³ç³»äº†ã€‚</p>
<h1 id="c11ä¸­æ”¯æŒçš„å†…å­˜æ¨¡å‹">C++11ä¸­æ”¯æŒçš„å†…å­˜æ¨¡å‹</h1>
<p>ä»C++11å¼€å§‹ï¼Œå°±æ”¯æŒä»¥ä¸‹å‡ ç§å†…å­˜æ¨¡å‹ï¼š</p>
<pre tabindex="0"><code>enum memory_order {
    memory_order_relaxed,
    memory_order_consume,
    memory_order_acquire,
    memory_order_release,
    memory_order_acq_rel,
    memory_order_seq_cst
};
</code></pre><p>ä¸å†…å­˜æ¨¡å‹ç›¸å…³çš„æšä¸¾ç±»å‹æœ‰ä»¥ä¸Šå…­ç§ï¼Œä½†æ˜¯å…¶å®åˆ†ä¸ºå››ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­å¯¹ä¸€è‡´æ€§çš„è¦æ±‚é€æ¸å‡å¼±ï¼Œä»¥ä¸‹æ¥åˆ†åˆ«è®²è§£ã€‚</p>
<p><img src="/media/imgs/20191214-cxx11-memory-model-2/c++model.png" alt="c++model" title="c++model"></p>
<h1 id="memory_order_seq_cst">memory_order_seq_cst</h1>
<p>è¿™æ˜¯é»˜è®¤çš„å†…å­˜æ¨¡å‹ï¼Œå³ä¸Šç¯‡æ–‡ç« ä¸­åˆ†æè¿‡çš„é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ï¼Œç”±äºåœ¨ä¸Šç¯‡ä¸­çš„ç›¸å…³æ¦‚å¿µå·²ç»åšè¿‡è¯¦ç»†çš„ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†é˜è¿°äº†ã€‚ä»…åˆ—å‡ºå¼•ç”¨è‡ªã€ŠC++  Concurrency In Actionã€‹çš„ç¤ºä¾‹ä»£ç ã€‚</p>
<pre tabindex="0"><code>#include &lt;atomic&gt;
#include &lt;thread&gt;
#include &lt;assert.h&gt;

std::atomic&lt;bool&gt; x,y;
std::atomic&lt;int&gt; z;

void write_x()
{
    x.store(true,std::memory_order_seq_cst);
}

void write_y()
{
    y.store(true,std::memory_order_seq_cst);
}

void read_x_then_y()
{
    while(!x.load(std::memory_order_seq_cst));
    if(y.load(std::memory_order_seq_cst))
        ++z;
}

void read_y_then_x()
{
    while(!y.load(std::memory_order_seq_cst));
    if(x.load(std::memory_order_seq_cst))
        ++z;
}

int main()
{
    x=false;
    y=false;
    z=0;
    std::thread a(write_x);
    std::thread b(write_y);
    std::thread c(read_x_then_y);
    std::thread d(read_y_then_x);
    a.join();
    b.join();
    c.join();
    d.join();
    assert(z.load()!=0);
}
</code></pre><p>ç”±äºé‡‡ç”¨äº†é¡ºåºä¸€è‡´æ€§æ¨¡å‹ï¼Œå› æ­¤æœ€åçš„æ–­è¨€ä¸å¯èƒ½å‘ç”Ÿï¼Œå³åœ¨ç¨‹åºç»“æŸæ—¶ä¸å¯èƒ½å‡ºç°zä¸º0çš„æƒ…å†µã€‚</p>
<h1 id="memory_order_relaxed">memory_order_relaxed</h1>
<p>è¿™ç§ç±»å‹å¯¹åº”çš„æ¾æ•£å†…å­˜æ¨¡å‹ï¼Œè¿™ç§å†…å­˜æ¨¡å‹çš„ç‰¹ç‚¹æ˜¯ï¼š</p>
<ul>
<li>é’ˆå¯¹ä¸€ä¸ªå˜é‡çš„è¯»å†™æ“ä½œæ˜¯åŸå­æ“ä½œï¼›</li>
<li>ä¸åŒçº¿ç¨‹ä¹‹é—´é’ˆå¯¹è¯¥å˜é‡çš„è®¿é—®æ“ä½œå…ˆåé¡ºåºä¸èƒ½å¾—åˆ°ä¿è¯ï¼Œå³æœ‰å¯èƒ½ä¹±åºã€‚</li>
</ul>
<p>æ¥çœ‹ç¤ºä¾‹ä»£ç ï¼š</p>
<pre tabindex="0"><code>#include &lt;atomic&gt;
#include &lt;thread&gt;
#include &lt;assert.h&gt;

std::atomic&lt;bool&gt; x,y;
std::atomic&lt;int&gt; z;

void write_x_then_y()
{
    x.store(true,std::memory_order_relaxed);
    y.store(true,std::memory_order_relaxed);
}

void read_y_then_x()
{
    while(!y.load(std::memory_order_relaxed));
    if(x.load(std::memory_order_relaxed))
        ++z;
}

int main()
{
    x=false;
    y=false;
    z=0;
    std::thread a(write_x_then_y);
    std::thread b(read_y_then_x);
    a.join();
    b.join();
    assert(z.load()!=0);
}
</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¯¹åŸå­å˜é‡çš„è®¿é—®éƒ½ä½¿ç”¨memory_order_relaxedæ¨¡å‹ï¼Œå¯¼è‡´äº†æœ€åçš„æ–­è¨€å¯èƒ½å¤±è´¥ï¼Œå³åœ¨ç¨‹åºç»“æŸæ—¶zå¯èƒ½ä¸º0ã€‚</p>
<h1 id="acquire-release">Acquire-Release</h1>
<ul>
<li>memory_order_acquireï¼šç”¨æ¥ä¿®é¥°ä¸€ä¸ªè¯»æ“ä½œï¼Œè¡¨ç¤ºåœ¨æœ¬çº¿ç¨‹ä¸­ï¼Œæ‰€æœ‰åç»­çš„å…³äºæ­¤å˜é‡çš„å†…å­˜æ“ä½œéƒ½å¿…é¡»åœ¨æœ¬æ¡åŸå­æ“ä½œå®Œæˆåæ‰§è¡Œã€‚</li>
</ul>
<p><img src="/media/imgs/20191214-cxx11-memory-model-2/read-acquire.png" alt="read-acquire" title="read-acquire"></p>
<ul>
<li>memory_order_releaseï¼šç”¨æ¥ä¿®é¥°ä¸€ä¸ªå†™æ“ä½œï¼Œè¡¨ç¤ºåœ¨æœ¬çº¿ç¨‹ä¸­ï¼Œæ‰€æœ‰ä¹‹å‰çš„é’ˆå¯¹è¯¥å˜é‡çš„å†…å­˜æ“ä½œå®Œæˆåæ‰èƒ½æ‰§è¡Œæœ¬æ¡åŸå­æ“ä½œã€‚</li>
</ul>
<p><img src="/media/imgs/20191214-cxx11-memory-model-2/write-release.png" alt="write-release" title="write-release"></p>
<ul>
<li>memory_order_acq_relï¼šåŒæ—¶åŒ…å«memory_order_acquireå’Œmemory_order_releaseæ ‡å¿—ã€‚</li>
</ul>
<p>æ¥çœ‹ç¤ºä¾‹ä»£ç ï¼š</p>
<pre tabindex="0"><code>// 5.7.cpp
#include &lt;atomic&gt;
#include &lt;thread&gt;
#include &lt;assert.h&gt;

std::atomic&lt;bool&gt; x,y;
std::atomic&lt;int&gt; z;

void write_x()
{
    x.store(true,std::memory_order_release);
}

void write_y()
{
    y.store(true,std::memory_order_release);
}

void read_x_then_y()
{
    while(!x.load(std::memory_order_acquire));
    if(y.load(std::memory_order_acquire))
        ++z;
}

void read_y_then_x()
{
    while(!y.load(std::memory_order_acquire));
    if(x.load(std::memory_order_acquire))
        ++z;
}

int main()
{
    x=false;
    y=false;
    z=0;
    std::thread a(write_x);
    std::thread b(write_y);
    std::thread c(read_x_then_y);
    std::thread d(read_y_then_x);
    a.join();
    b.join();
    c.join();
    d.join();
    assert(z.load()!=0);
}
</code></pre><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¹¶ä¸èƒ½ä¿è¯ç¨‹åºæœ€åçš„æ–­è¨€å³z!=0ä¸ºçœŸï¼Œå…¶åŸå› åœ¨äºï¼šåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­åˆ†åˆ«é’ˆå¯¹xã€yä¸¤ä¸ªå˜é‡è¿›è¡Œäº†åŒæ­¥æ“ä½œå¹¶ä¸èƒ½ä¿è¯xã€yå˜é‡çš„è¯»å–æ“ä½œã€‚</p>
<p>çº¿ç¨‹write_xé’ˆå¯¹å˜é‡xä½¿ç”¨äº†write-releaseæ¨¡å‹ï¼Œè¿™æ ·ä¿è¯äº†read_x_then_yå‡½æ•°ä¸­ï¼Œåœ¨loadå˜é‡yä¹‹å‰xä¸ºtrueï¼›åŒç†çº¿ç¨‹write_yé’ˆå¯¹å˜é‡yä½¿ç”¨äº†write-releaseæ¨¡å‹ï¼Œè¿™æ ·ä¿è¯äº†read_y_then_xå‡½æ•°ä¸­ï¼Œåœ¨loadå˜é‡xä¹‹å‰yä¸ºtrueã€‚</p>
<p>ç„¶è€Œå³ä¾¿æ˜¯è¿™æ ·ï¼Œä»ç„¶å¯èƒ½å‡ºç°ä»¥ä¸‹ç±»ä¼¼çš„æƒ…å†µï¼š</p>
<p><img src="/media/imgs/20191214-cxx11-memory-model-2/5.7.png" alt="5.7" title="5.7"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p>
<ul>
<li>åˆå§‹æ¡ä»¶ä¸ºx = y = falseã€‚</li>
<li>ç”±äºåœ¨read_x_and_yçº¿ç¨‹ä¸­ï¼Œå¯¹xçš„loadæ“ä½œä½¿ç”¨äº†acquireæ¨¡å‹ï¼Œå› æ­¤ä¿è¯äº†æ˜¯å…ˆæ‰§è¡Œwrite_xå‡½æ•°æ‰åˆ°è¿™ä¸€æ­¥çš„ï¼›åŒç†å…ˆæ‰§è¡Œwrite_yæ‰åˆ°read_y_and_xä¸­é’ˆå¯¹yçš„loadæ“ä½œã€‚</li>
<li>ç„¶è€Œå³ä¾¿å¦‚æ­¤ï¼Œä¹Ÿå¯èƒ½å‡ºç°åœ¨read_x_then_yä¸­é’ˆå¯¹yçš„loadæ“ä½œåœ¨yçš„storeæ“ä½œä¹‹å‰å®Œæˆï¼Œå› ä¸ºy.storeæ“ä½œä¸æ­¤ä¹‹é—´æ²¡æœ‰å…ˆåé¡ºåºå…³ç³»ï¼›åŒç†ä¹Ÿä¸èƒ½ä¿è¯xä¸€å®šè¯»åˆ°trueå€¼ï¼Œå› æ­¤åˆ°ç¨‹åºç»“æŸæ˜¯å°±å‡ºç°äº†z = 0çš„æƒ…å†µã€‚</li>
</ul>
<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå³ä¾¿åœ¨è¿™é‡Œä½¿ç”¨äº†release-acquireæ¨¡å‹ï¼Œä»ç„¶æ²¡æœ‰ä¿è¯z=0ï¼Œå…¶åŸå› åœ¨äºï¼šæœ€å¼€å§‹é’ˆå¯¹xã€yä¸¤ä¸ªå˜é‡çš„å†™æ“ä½œæ˜¯åˆ†åˆ«åœ¨write_xå’Œwrite_yçº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œä¸èƒ½ä¿è¯ä¸¤è€…æ‰§è¡Œçš„é¡ºåºå¯¼è‡´ã€‚å› æ­¤ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// 5.8.cpp
#include &lt;atomic&gt;
#include &lt;thread&gt;
#include &lt;assert.h&gt;

std::atomic&lt;bool&gt; x,y;
std::atomic&lt;int&gt; z;

void write_x_then_y()
{
    x.store(true,std::memory_order_relaxed);
    y.store(true,std::memory_order_release);
}

void read_y_then_x()
{
    while(!y.load(std::memory_order_acquire));
    if(x.load(std::memory_order_relaxed))
        ++z;
}

int main()
{
    x=false;
    y=false;
    z=0;
    std::thread a(write_x_then_y);
    std::thread b(read_y_then_x);
    a.join();
    b.join();
    assert(z.load()!=0);
}
</code></pre><p><img src="/media/imgs/20191214-cxx11-memory-model-2/5.8.png" alt="5.8" title="5.8"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p>
<ul>
<li>åˆå§‹æ¡ä»¶ä¸ºx = y = falseã€‚</li>
<li>åœ¨write_x_then_yçº¿ç¨‹ä¸­ï¼Œå…ˆæ‰§è¡Œå¯¹xçš„å†™æ“ä½œï¼Œå†æ‰§è¡Œå¯¹yçš„å†™æ“ä½œï¼Œç”±äºä¸¤è€…åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥å³ä¾¿é’ˆå¯¹xçš„ä¿®æ”¹æ“ä½œä½¿ç”¨relaxedæ¨¡å‹ï¼Œä¿®æ”¹xä¹Ÿä¸€å®šåœ¨ä¿®æ”¹yä¹‹å‰æ‰§è¡Œã€‚</li>
<li>åœ¨write_x_then_yçº¿ç¨‹ä¸­ï¼Œå¯¹yçš„loadæ“ä½œä½¿ç”¨äº†acquireæ¨¡å‹ï¼Œè€Œåœ¨çº¿ç¨‹write_x_then_yä¸­é’ˆå¯¹å˜é‡yçš„è¯»æ“ä½œä½¿ç”¨releaseæ¨¡å‹ï¼Œå› æ­¤ä¿è¯äº†æ˜¯å…ˆæ‰§è¡Œwrite_x_then_yå‡½æ•°æ‰åˆ°read_y_then_xçš„é’ˆå¯¹å˜é‡yçš„loadæ“ä½œã€‚</li>
<li>å› æ­¤æœ€ç»ˆçš„æ‰§è¡Œé¡ºåºå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ­¤æ—¶ä¸å¯èƒ½å‡ºç°z=0çš„æƒ…å†µã€‚</li>
</ul>
<p>ä»ä»¥ä¸Šçš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œé’ˆå¯¹åŒä¸€ä¸ªå˜é‡çš„release-acquireæ“ä½œï¼Œæ›´å¤šæ—¶å€™æ‰®æ¼”äº†ä¸€ç§â€œçº¿ç¨‹é—´ä½¿ç”¨æŸä¸€å˜é‡çš„åŒæ­¥â€ä½œç”¨ï¼Œç”±äºæœ‰äº†è¿™ä¸ªè¯­ä¹‰çš„ä¿è¯ï¼Œåšåˆ°äº†çº¿ç¨‹é—´æ“ä½œçš„å…ˆåé¡ºåºä¿è¯ï¼ˆinter-thread happens-beforeï¼‰ã€‚</p>
<h1 id="release-consume">Release-Consume</h1>
<p>ä»ä¸Šé¢å¯¹Acquire-Releaseæ¨¡å‹çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡å‹åšåˆ°ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´æŸäº›æ“ä½œçš„synchronizes-withå…³ç³»ï¼Œç„¶åè¿™ä¸ªç²’åº¦æœ‰äº›è¿‡äºå¤§äº†ã€‚</p>
<p>åœ¨å¾ˆå¤šæ—¶å€™ï¼Œçº¿ç¨‹é—´åªæƒ³é’ˆå¯¹æœ‰ä¾èµ–å…³ç³»çš„æ“ä½œè¿›è¡ŒåŒæ­¥ï¼Œé™¤æ­¤ä¹‹å¤–çº¿ç¨‹ä¸­çš„å…¶ä»–æ“ä½œé¡ºåºå¦‚ä½•æ— æ‰€è°“ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼š</p>
<pre tabindex="0"><code>b = *a;
c = *b;
</code></pre><p>å…¶ä¸­ç¬¬äºŒè¡Œä»£ç çš„æ‰§è¡Œç»“æœä¾èµ–äºç¬¬ä¸€è¡Œä»£ç çš„æ‰§è¡Œç»“æœï¼Œæ­¤æ—¶ç§°è¿™ä¸¤è¡Œä»£ç ä¹‹é—´çš„å…³ç³»ä¸ºâ€œcarry-a-dependency â€ã€‚C++ä¸­å¼•å…¥çš„memory_order_consumeå†…å­˜æ¨¡å‹å°±é’ˆå¯¹è¿™ç±»ä»£ç é—´æœ‰æ˜ç¡®çš„ä¾èµ–å…³ç³»çš„è¯­å¥é™åˆ¶å…¶å…ˆåé¡ºåºã€‚</p>
<p>æ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre tabindex="0"><code>// 5.10
#include &lt;string&gt;
#include &lt;thread&gt;
#include &lt;atomic&gt;
#include &lt;assert.h&gt;
struct X
{
    int i;
    std::string s;
};

std::atomic&lt;X*&gt; p;
std::atomic&lt;int&gt; a;

void create_x()
{
    X* x=new X;
    x-&gt;i=42;
    x-&gt;s=&#34;hello&#34;;
    a.store(99,std::memory_order_relaxed);
    p.store(x,std::memory_order_release);
}

void use_x()
{
    X* x;
    while(!(x=p.load(std::memory_order_consume)))
        std::this_thread::sleep_for(std::chrono::microseconds(1));
    assert(x-&gt;i==42);
    assert(x-&gt;s==&#34;hello&#34;);
    assert(a.load(std::memory_order_relaxed)==99);
}
int main()
{
    std::thread t1(create_x);
    std::thread t2(use_x);
    t1.join();
    t2.join();
}
</code></pre><p>ä»¥ä¸Šçš„ä»£ç ä¸­ï¼š</p>
<ul>
<li>create_xçº¿ç¨‹ä¸­çš„store(x)æ“ä½œä½¿ç”¨memory_order_releaseï¼Œè€Œåœ¨use_xçº¿ç¨‹ä¸­ï¼Œæœ‰é’ˆå¯¹xçš„ä½¿ç”¨memory_order_consumeå†…å­˜æ¨¡å‹çš„loadæ“ä½œï¼Œä¸¤è€…ä¹‹é—´ç”±äºæœ‰carry-a-dependencyå…³ç³»ï¼Œå› æ­¤èƒ½ä¿è¯ä¸¤è€…çš„å…ˆåæ‰§è¡Œé¡ºåºã€‚æ‰€ä»¥ï¼Œx-&gt;i == 42ä»¥åŠx-&gt;s==&ldquo;hello&quot;è¿™ä¸¤ä¸ªæ–­è¨€éƒ½ä¸ä¼šå¤±è´¥ã€‚</li>
<li>ç„¶è€Œï¼Œcreate_xä¸­é’ˆå¯¹å˜é‡açš„ä½¿ç”¨relaxå†…å­˜æ¨¡å‹çš„storeæ“ä½œï¼Œuse_xçº¿ç¨‹ä¸­ä¹Ÿæœ‰é’ˆå¯¹å˜é‡açš„ä½¿ç”¨relaxå†…å­˜æ¨¡å‹çš„loadæ“ä½œã€‚è¿™ä¸¤è€…çš„å…ˆåæ‰§è¡Œé¡ºåºï¼Œå¹¶ä¸å—å‰é¢çš„memory_order_consumeå†…å­˜æ¨¡å‹å½±å“ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ä¿è¯å‰åé¡ºåºï¼Œå› æ­¤æ–­è¨€a.load(std::memory_order_relaxed)==99çœŸå‡éƒ½æœ‰å¯èƒ½ã€‚</li>
</ul>
<p>ä»¥ä¸Šå¯ä»¥å¯¹æ¯”Acquire-Releaseä»¥åŠRelease-Consumeä¸¤ä¸ªå†…å­˜æ¨¡å‹ï¼Œå¯ä»¥çŸ¥é“ï¼š</p>
<ul>
<li>Acquire-Releaseèƒ½ä¿è¯ä¸åŒçº¿ç¨‹ä¹‹é—´çš„Synchronizes-Withå…³ç³»ï¼Œè¿™åŒæ—¶ä¹Ÿçº¦æŸåˆ°åŒä¸€ä¸ªçº¿ç¨‹ä¸­å‰åè¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li>è€ŒRelease-Consumeåªçº¦æŸæœ‰æ˜ç¡®çš„carry-a-dependencyå…³ç³»çš„è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼ŒåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„å…¶ä»–è¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºå¹¶ä¸å—è¿™ä¸ªå†…å­˜æ¨¡å‹çš„å½±å“ã€‚</li>
</ul>
<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ul>
<li>ã€ŠC++  Concurrency In Actionã€‹</li>
<li><a href="https://preshing.com/20140709/the-purpose-of-memory_order_consume-in-cpp11/">ã€ŠThe Purpose of memory_order_consume in C++11ã€‹</a></li>
<li><a href="https://preshing.com/20130823/the-synchronizes-with-relation/">ã€ŠThe Synchronizes-With Relationã€‹</a></li>
</ul>
<h1 id="ä¿®æ”¹å†å²">ä¿®æ”¹å†å²</h1>
<ul>
<li>2019-12-14ï¼šåˆç¨¿ã€‚</li>
<li>2020-04-11ï¼šä¿®æ”¹ä»£ç æ˜¾ç¤ºã€‚</li>
</ul>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20191214-cxx11-memory-model-1/">â† prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20200128-systemtap-by-example/">next â†’</a>
    
  </div>

    
<h1>ç›¸å…³æ–‡ç« </h1><li><strong> 14129-12-14: </strong> <a href="https://www.codedump.info/post/20191214-cxx11-memory-model-1/">C&#43;&#43;11ä¸­çš„å†…å­˜æ¨¡å‹ä¸Šç¯‡ - å†…å­˜æ¨¡å‹åŸºç¡€</a>  </li>

<h1>é‚®ä»¶è®¢é˜…</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="é‚®ä»¶è®¢é˜…æœ¬ç«™æ›´æ–°" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="ç‚¹å‡»è®¢é˜…" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revueâ€™s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://www.codedump.info/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%A4%9A%E6%A0%B8/">å¤šæ ¸</a>
          <a href="/tags/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/">ç³»ç»Ÿç¼–ç¨‹</a>
          <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">ç³»ç»Ÿè®¾è®¡</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    
    
        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  
    
  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
