<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" 周刊  数据库  sqlite  操作系统  分布式  Linux  数据库 ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇" />
<meta property="og:description" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20220220-weekly-6/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-20T10:53:41+08:00" />
<meta property="article:modified_time" content="2022-02-20T10:53:41+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20220220-weekly-6/">

  
  
  <meta itemprop="name" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇">
<meta itemprop="description" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇"><meta itemprop="datePublished" content="2022-02-20T10:53:41+08:00" />
<meta itemprop="dateModified" content="2022-02-20T10:53:41+08:00" />
<meta itemprop="wordCount" content="2908">
<meta itemprop="keywords" content="周刊," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇 - codedump的网络日志</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇"/>
<meta name="twitter:description" content="周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedump的网络日志</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">主页</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">发表</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">系列文章索引</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">周刊</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">订阅</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">关于</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>周刊（第6期）：《sqlite 3.36 btree实现解析》番外篇</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/%E5%91%A8%E5%88%8A'>#周刊</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#sqlite的注释">sqlite的注释</a></li>
    <li><a href="#sqlite几个相关的链接">sqlite几个相关的链接</a></li>
    <li><a href="#sqlite的箴言">sqlite的箴言</a></li>
    <li><a href="#破解神秘感的项目">破解神秘感的项目</a>
      <ul>
        <li><a href="#操作系统">操作系统</a></li>
        <li><a href="#数据库">数据库</a></li>
        <li><a href="#分布式系统">分布式系统</a></li>
        <li><a href="#linux早期内核实现解析">Linux早期内核实现解析</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <hr>
<p>引言：从2021年9月份开始要探索生产级btree存储引擎的实现，到2022年2月整理完毕发布《sqlite 3.36 btree实现解析》的系列文章，我花费了小半年的时间，本期会聊聊整个过程下来我的一些想法。</p>
<hr>
<h1 id="sqlite-336-btree实现解析番外篇">《sqlite 3.36 btree实现解析》番外篇</h1>
<p>时间回到2021年9月份。彼时，因为工作的关系，要研究一下生产级btree存储引擎的实现，在此之前我大体对btree、b+tree的数据结构和算法有个了解，见：</p>
<ul>
<li><a href="https://www.codedump.info/post/20200609-btree-1/">B树、B+树索引算法原理（上） - codedump的网络日志</a></li>
<li><a href="https://www.codedump.info/post/20200615-btree-2/">B树、B+树索引算法原理（下） - codedump的网络日志</a></li>
</ul>
<p>但是，一个生产级的产品，对比教科书的示范型代码，还是有很大的区别的，具体来说，我当时不明白以下这些生产级存储引擎的问题如何解决：</p>
<ul>
<li>如何存储变长的数据？</li>
<li>如何存储数据大小超过一个物理页面的数据？</li>
<li>如何利用被回收的空间？</li>
<li>如何处理崩溃恢复？</li>
<li>读写并发如何处理？</li>
<li>&hellip;</li>
</ul>
<p>为了解答这些疑问，先后去翻阅InnodDB、WiredTiger、sqlite的文档，但是这些项目代码量都太大了，以我当时的程度，无法马上找到很具体的解答。</p>
<p>事情的突破在从网上查找文章时看到的这一篇文章：<a href="https://dzone.com/articles/database-btree-indexing-in-sqlite">How Database B-Tree Indexing Works - DZone Database</a>，这是一篇解释btree工作原理的文章，这篇文章同时还列出了一个项目：<a href="https://github.com/madushadhanushka/simple-sqlite">madushadhanushka/simple-sqlite: Code reading for sqlite backend</a>，这个项目的作者，将sqlite2.5版本中btree的实现，单独抽取出来形成了一个独立的KV库，可以编译通过使用。</p>
<p>看到这个项目的时候，我的感觉就是如获至宝，因为虽然只有几千行的代码量，但是解答了很多上面提到的疑问，“麻雀虽小五脏俱全”，我花了几天的时间整体阅读了解了原理，这个项目给我打开了研究生产级btree存储引擎的突破口。</p>
<p>在这以后，考虑到2.5版本的sqlite已经是2002年的作品，距离现在时间太久了，还想接着了解后面做了那些改进，又接着阅读了3.6.10版本的实现，找这个版本的原因，是因为这是sqlite官方在github上同步的第一个版本，那时候仍然步子不敢迈得太大。</p>
<p>又花了一个多月把这个版本的btree实现了解以后，我了解到在这之后的版本里，sqlite做了另一个重大的更新：在页面管理部分引入了WAL机制，加上前面两个版本阅读下来累积的信心，就接着找当时还是最新的3.36版本的实现来阅读，这又花了一个多月的时间。</p>
<p>这以后，就是逐步将整理的笔记写成文档了，后续的事情不表，都在这几篇文档里。</p>
<p>回头看这整个流程，我自己的感受是：</p>
<ul>
<li>“问题驱动”可能是效率更高的学习方式，带着问题出发、找到自己疑问的答案，能更快的学习某个知识。</li>
<li>生产级的实现和教科书的区别很大，后者更多的是讲解原理，而生产级实现考虑更多的是各种实际生产中的边际情况。如果只了解原理，而不去具体做实现，对事情的理解最后只能浮于表面。</li>
<li>找到那个精简实现是这个过程里的“突破口”，原因在于：如果一上来看的很成熟的版本，而且你在这个领域积累的不深，那么很可能会导致丢失了很多“上下文（context）”情景，给阅读、理解带来很大困难。下次再遇到类似的问题，我会按照这次的经验，先尝试回退到之前的更简单的版本，看看在那里能不能跟上作者的思路，攻克简单的实现之后，再尝试最新的版本。</li>
<li>除了数据库领域以外，有一些别的领域，在教学的时候会让学生参与实现一个简单的项目。这类型的项目虽然简单，但是五脏俱全，能够让学生了解这个领域的概貌，我把这种流程称为“破解神秘感”。如我最开始提到的那些疑问，如果在这之前做过数据库相关的作业，应该会有个大体的想法。</li>
</ul>
<h1 id="这篇番外篇的番外篇">这篇番外篇的番外篇</h1>
<h2 id="sqlite的注释">sqlite的注释</h2>
<p>除了这些以外，sqlite的代码风格也很好，尤其是注释写的非常详尽。</p>
<p>有一种说法，“好的代码都是自解释的，无需多做注释”。我对这句话有一些不太一样的看法，因为即便再好的代码，如果只看代码的话，对整个的架构、结构很难了解。这一点sqlite就做的很好，在代码中会写上类似文档一样的注释来解释结构，比如有这么一段解释btree内部结构的注释文档：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#666">/</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> This file implements an external (disk<span style="color:#666">-</span>based) database using BTrees.
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> For a detailed discussion of BTrees, refer to
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>     Donald E. Knuth, THE ART OF COMPUTER PROGRAMMING, Volume <span style="color:#666">3</span><span style="color:#666">:</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>     <span style="color:#b44">&#34;Sorting And Searching&#34;</span>, pages <span style="color:#666">473</span><span style="color:#666">-</span><span style="color:#666">480.</span> Addison<span style="color:#666">-</span>Wesley
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>     Publishing Company, Reading, Massachusetts.
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> The basic idea is that each page of the file contains N database
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> entries and N<span style="color:#666">+</span><span style="color:#666">1</span> pointers to subpages.
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>   <span style="color:#666">----------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>   <span style="color:#666">|</span>  Ptr(<span style="color:#666">0</span>) <span style="color:#666">|</span> Key(<span style="color:#666">0</span>) <span style="color:#666">|</span> Ptr(<span style="color:#666">1</span>) <span style="color:#666">|</span> Key(<span style="color:#666">1</span>) <span style="color:#666">|</span> ... <span style="color:#666">|</span> Key(N<span style="color:#666">-</span><span style="color:#666">1</span>) <span style="color:#666">|</span> Ptr(N) <span style="color:#666">|</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>   <span style="color:#666">----------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span>
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> All of the keys on the page that Ptr(<span style="color:#666">0</span>) points to have values less
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> than Key(<span style="color:#666">0</span>).  All of the keys on page Ptr(<span style="color:#666">1</span>) and its subpages have
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> values greater than Key(<span style="color:#666">0</span>) and less than Key(<span style="color:#666">1</span>).  All of the keys
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> on Ptr(N) and its subpages have values greater than Key(N<span style="color:#666">-</span><span style="color:#666">1</span>).  And
</span></span><span style="display:flex;"><span><span style="color:#666">**</span> so forth.
</span></span><span style="display:flex;"><span><span style="">*/</span>
</span></span></code></pre></div><p>如果不写这些注释，读者想要理解作者的思路的话，仅凭代码是很困难的。</p>
<p>这里只是抽取了sqlite代码注释中的一小部分，我读代码下来的感觉，sqlite的注释可以说是“保姆级别”的。“写代码是表达自己，读代码是去理解别人”（见<a href="https://www.zhihu.com/question/21820752/answer/19427754">为什么说读代码比写代码难？ - 知乎</a>），可以说sqlite的作者为了让别人更好的理解自己，尽力了。</p>
<p>对应的，我也看过那种几乎没有注释、变量函数名都是缩写的代码，这样的代码作者，可能就不是很像让别人读懂ta。</p>
<h2 id="sqlite几个相关的链接">sqlite几个相关的链接</h2>
<p>可以在这里（<a href="https://sqlite.org/chronology.html">History Of SQLite Releases</a>）找到sqlite的release历史，进而下载到对应版本的代码。以2.5版本为例，发布于<a href="https://www.sqlite.org/src/timeline?c=9baef3e240&amp;y=ci">2002-06-17</a>这一天，我用代码统计工具统计了一下，代码量仅有31188行（包括注释）：</p>
<p><img src="/media/imgs/20220220-weekly-6/2.5.png" alt="sqlite2.5的代码统计" title="sqlite2.5的代码统计"></p>
<p>BTW：不知道sqlite 2.5版本，对比一些数据库实验课程的大作业，复杂度如何，感觉以早期sqlite代码来入门数据库学习也是足够的，前提是有足够的耐心和时间。</p>
<p>而3.36版本发布于<a href="https://www.sqlite.org/src/timeline?c=5c9a6c0687&amp;y=ci">2021-06-18</a>这一天，代码量已经到了21W行，前后相隔19年：</p>
<p><img src="/media/imgs/20220220-weekly-6/3.36.png" alt="sqlite3.36的代码统计" title="sqlite3.36的代码统计"></p>
<p>还可以在<a href="https://www.sqlite.org/changes.html">Release History Of SQLite</a>看到不同版本新增的特性、bug fix等，比如可以看到WAL是在3.7.0版本引入的特性：</p>
<blockquote>
<p>2010-07-21 (3.7.0)</p>
<ol>
<li>Added support for write-ahead logging.</li>
</ol>
</blockquote>
<h2 id="sqlite的箴言">sqlite的箴言</h2>
<p>在每个sqlite代码文件中，开头都有这么一段注释：</p>
<blockquote>
<p>**    May you do good and not evil.
**    May you find forgiveness for yourself and forgive others.
**    May you share freely, never taking more than you give.</p>
</blockquote>
<h2 id="破解神秘感的项目">破解神秘感的项目</h2>
<p>前面提到过要破解神秘感，列举几个计算机相关课程的实验大作业或项目。</p>
<h3 id="操作系统">操作系统</h3>
<ul>
<li>哈佛大学的Xv6：<a href="https://pdos.csail.mit.edu/6.828/2012/xv6.html">Xv6, a simple Unix-like teaching operating system</a>， 对应的课程：<a href="https://pdos.csail.mit.edu/6.828/2021/">6.S081 / Fall 2021</a>。</li>
<li>清华的uCore：<a href="https://github.com/kiukotsu/ucore">kiukotsu/ucore: 清华大学操作系统课程实验 (OS Kernel Labs)</a>，实验指导书：<a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/">Introduction · ucore_os_docs</a></li>
</ul>
<h3 id="数据库">数据库</h3>
<ul>
<li>CMU的15445：<a href="https://15445.courses.cs.cmu.edu/fall2021/">CMU 15-445/645 :: Intro to Database Systems (Fall 2021)</a>，随课程要完成一个大作业项目，之前没有做过，否则应该不至于不了解生产级实现的原理。</li>
</ul>
<h3 id="分布式系统">分布式系统</h3>
<ul>
<li>MIT的6.824：<a href="https://pdos.csail.mit.edu/6.824/schedule.html">6.824 Schedule: Spring 2022</a>，也是有随课程要完成的大作业，以前使用C++实现Paxos，后面改成了Go实现Raft。</li>
</ul>
<h3 id="linux早期内核实现解析">Linux早期内核实现解析</h3>
<p>许多年以前，赵炯博士在网上公开过一份文档，基本上<strong class=chinese>逐行</strong>讲解了Linux0.11版本内核的实现，那时候的官网oldlinux.org 现在好像已经不能访问，在官网的页面<a href="http://www.oldlinux.org/book.html">Early Linux Kernel Analisys and Comments</a>也提供了这份文档电子版的下载链接：http://www.oldlinux.org/download/clk011c-1.9.5.pdf，也有对应的公开发行物：<a href="https://book.douban.com/subject/3229243/">Linux内核完全剖析 (豆瓣)</a>。</p>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20220211-weekly-5/">← prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20220227-weekly-7/">next →</a>
    
  </div>

    
<h1>相关文章</h1>
<li><strong> 14059-05-14: </strong> <a href="https://www.codedump.info/post/20220514-weekly-15/">周刊（第15期）：图解ARIES论文（上）</a>  </li><li><strong> 7059-05-07: </strong> <a href="https://www.codedump.info/post/20220507-weekly-14/">周刊（第14期）：重读Raft论文中的集群成员变更算法（二）：实践篇</a>  </li><li><strong> 17049-04-17: </strong> <a href="https://www.codedump.info/post/20220417-weekly-13/">周刊（第13期）：重读Raft论文中的集群成员变更算法（一）：理论篇</a>  </li><li><strong> 10049-04-10: </strong> <a href="https://www.codedump.info/post/20220410-weekly-12/">周刊（第12期）：Page oriented类存储引擎里可能同时存在多种结构</a>  </li><li><strong> 27039-03-27: </strong> <a href="https://www.codedump.info/post/20220327-weekly-11/">周刊（第11期）：mmap适用于存储引擎吗？</a>  </li>
<h1>邮件订阅</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="邮件订阅本站更新" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="点击订阅" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revue’s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://www.codedump.info/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%91%A8%E5%88%8A/">周刊</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    
    
        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  
    
  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> 🍦 Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
