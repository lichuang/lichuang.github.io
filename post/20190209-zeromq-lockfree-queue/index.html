<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" ZeroMQ  æ— é”é˜Ÿåˆ— ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€" />
<meta property="og:description" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20190209-zeromq-lockfree-queue/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-02-09T20:10:13+08:00" />
<meta property="article:modified_time" content="2019-02-09T20:10:13+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20190209-zeromq-lockfree-queue/">

  
  
  <meta itemprop="name" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€">
<meta itemprop="description" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€"><meta itemprop="datePublished" content="2019-02-09T20:10:13+08:00" />
<meta itemprop="dateModified" content="2019-02-09T20:10:13+08:00" />
<meta itemprop="wordCount" content="5379">
<meta itemprop="keywords" content="ç½‘ç»œç¼–ç¨‹,zeromq," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€"/>
<meta name="twitter:description" content="zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">å‘¨åˆŠ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>zeromqæ‰€è°“çš„â€œæ— é”æ¶ˆæ¯é˜Ÿåˆ—â€</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B'>#ç½‘ç»œç¼–ç¨‹</a>
    
    <a class="link" href='https://www.codedump.info/tags/zeromq'>#zeromq</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#yqueue_t">yqueue_t</a></li>
    <li><a href="#ypipe_t">ypipe_t</a>
      <ul>
        <li><a href="#1åˆå§‹åŒ–">1ã€åˆå§‹åŒ–</a></li>
        <li><a href="#2writea-true">2ã€write(&lsquo;a&rsquo;, true)</a></li>
        <li><a href="#3writeb-false">3ã€write(&lsquo;b&rsquo;, false)</a></li>
        <li><a href="#4flush">4ã€flush()</a></li>
        <li><a href="#5readret">5ã€read(&amp;ret)</a></li>
        <li><a href="#6readret">6ã€read(&amp;ret)</a></li>
        <li><a href="#7readret">7ã€read(&amp;ret)</a></li>
      </ul>
    </li>
    <li><a href="#mailbox_t">mailbox_t</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <p>æœ¬æ–‡åŸºäºzeromq 4.3.0ç‰ˆæœ¬ï¼Œåˆ†æå…¶æ— é”æ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°ã€‚</p>
<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>
<p>zeromqè¿™ä¸ªç½‘ç»œåº“ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªäº®ç‚¹ï¼š</p>
<ul>
<li>ä»ä»¥å¾€çš„é¢å‘TCPæµçš„ç½‘ç»œå¼€å‘ï¼Œå˜æˆäº†é¢å‘æ¶ˆæ¯çš„å¼€å‘ã€‚åº”ç”¨å±‚å…³æ³¨çš„æ˜¯ä»€ä¹ˆç±»å‹çš„æ¶ˆæ¯ï¼Œåº“æœ¬èº«è§£å†³ç½‘ç»œæ”¶å‘ã€æ–­çº¿é‡è¿ç­‰é—®é¢˜ã€‚</li>
<li>å°†è¿™äº›æ¶ˆæ¯çš„ä¼ è¾“æ¨¡å¼å°è£…æˆå‡ ä¸ªæ¨¡å¼ï¼Œåº”ç”¨å¼€å‘è€…åªéœ€è¦å…³æ³¨è‡ªå·±çš„ä¸šåŠ¡ç¬¦åˆä»€ä¹ˆæ¨¡å¼ï¼Œé‡‡ç”¨æ­ç§¯æœ¨çš„æ–¹å¼å°±èƒ½æ„å»ºèµ·åº”ç”¨æœåŠ¡ã€‚</li>
<li>å†…éƒ¨å®ç°æ— é”æ¶ˆæ¯é˜Ÿåˆ—ç”¨äºå¯¹è±¡é—´é€šä¿¡ï¼Œç±»ä¼¼actoræ¨¡å¼ã€‚</li>
</ul>
<h1 id="åŸºæœ¬æ¶æ„">åŸºæœ¬æ¶æ„</h1>
<p>zeromqå†…éƒ¨è¿è¡Œç€å¤šä¸ªioçº¿ç¨‹ï¼Œæ¯ä¸ªioçº¿ç¨‹å†…éƒ¨æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<ul>
<li>pollerï¼šå³é’ˆå¯¹epollã€selectç­‰äº‹ä»¶è½®è¯¢å™¨çš„å°è£…ã€‚</li>
<li>mailboxï¼šè´Ÿè´£æ¥æ”¶æ¶ˆæ¯çš„æ¶ˆæ¯é‚®ç®±ã€‚</li>
</ul>
<p>å¯ä»¥ç®€å•ç†è§£IOçº¿ç¨‹åšçš„äº‹æƒ…æ˜¯ï¼šå†…éƒ¨é€šè¿‡ä¸€ä¸ªpollerï¼Œç›‘å¬ç€å„ç§äº‹ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬é’ˆå¯¹IOçº¿ç¨‹çš„mailboxçš„æ¶ˆæ¯ï¼Œä»¥åŠç»‘å®šåœ¨è¯¥IOçº¿ç¨‹ä¸Šçš„IOå¯¹è±¡çš„æ¶ˆæ¯ã€‚</p>
<p>å³è¿™æ˜¯ä¸€ä¸ªper-thread-per-loopçš„çº¿ç¨‹è®¾è®¡ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡é€šè¿‡æ¶ˆæ¯é‚®ç®±æ¥è¿›è¡Œã€‚</p>
<p>é™¤äº†ioçº¿ç¨‹ä¹‹å¤–ï¼Œioå¯¹è±¡ä¹Ÿæœ‰mailboxï¼Œå³å¦‚æœæƒ³ä¸æŸä¸ªIOå¯¹è±¡é€šä¿¡ä¹Ÿæ˜¯é€šè¿‡è¯¥mailboxè¿›è¡Œã€‚ç”±äºæ¶ˆæ¯é‚®ç®±æ˜¯zeromqä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸‹é¢å°†ä¸“é—¨åˆ†æzeromqæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p>æ‰€æœ‰éœ€è¦æ”¶å‘æ¶ˆæ¯çš„å¯¹è±¡éƒ½ç»§æ‰¿è‡ªobject_tï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>class object_t
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a0a000">public</span>:
</span></span><span style="display:flex;"><span>  object_t (zmq<span style="color:#666">::</span>ctx_t <span style="color:#666">*</span>ctx_, <span style="color:#0b0;font-weight:bold">uint32_t</span> tid_);
</span></span><span style="display:flex;"><span>  <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">process_command</span> (zmq<span style="color:#666">::</span>command_t <span style="color:#666">&amp;</span>cmd_);
</span></span><span style="display:flex;"><span><span style="color:#a0a000">private</span>:
</span></span><span style="display:flex;"><span>  zmq<span style="color:#666">::</span>ctx_t <span style="color:#666">*</span>ctx;<span style="color:#080;font-style:italic">//  Context provides access to the global state.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">uint32_t</span> tid;<span style="color:#080;font-style:italic">//  Thread ID of the thread the object belongs to.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">send_command</span> (command_t <span style="color:#666">&amp;</span>cmd_);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è€ŒIOå¯¹è±¡ä¹‹é—´çš„å‘½ä»¤é€šè¿‡command_tç»“æ„ä½“æ¥å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">struct</span> command_t
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Object to process the command.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  zmq<span style="color:#666">::</span>object_t <span style="color:#666">*</span>destination;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">enum</span> type_t
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>  } type;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">union</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>  } args;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œzeromqå®ç°å¯¹è±¡é—´ç›¸äº’é€šä¿¡ä¾èµ–äºmailboxï¼Œæœ¬æ–‡é‡ç‚¹åœ¨åˆ†æå…¶æ— é”é˜Ÿåˆ—çš„å®ç°ä¸Šã€‚</p>
<h1 id="ä½¿ç”¨æ— é”é˜Ÿåˆ—å®ç°çš„æ¶ˆæ¯é‚®ç®±">ä½¿ç”¨æ— é”é˜Ÿåˆ—å®ç°çš„æ¶ˆæ¯é‚®ç®±</h1>
<p>zeromqå†…éƒ¨ç±»ä¼¼actoræ¨¡å‹ï¼Œæ¯ä¸ªactorå†…éƒ¨æœ‰ä¸€ä¸ªmailboxï¼Œè´Ÿè´£æ”¶å‘æ¶ˆæ¯ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£å°±æ˜¯æ”¶å‘ç›¸å…³çš„sendã€recvæ¥å£ã€‚</p>
<p>è´Ÿè´£æ”¶å‘æ¶ˆæ¯çš„ç±»æ˜¯mailbox_tï¼Œå†…éƒ¨å®ç°ä½¿ç”¨äº†ypipe_tæ¥å®ç°æ— é”æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œypipe_tå†…éƒ¨åˆä½¿ç”¨äº†yqueue_tæ¥å®ç°é˜Ÿåˆ—ï¼Œè¿™ä¸ªå®ç°çš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…éƒ¨çš„åˆ†é…ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190209-zeromq-lockfree-queue/mailbox_t.png" alt="mailbox_t" title="mailbox_t"></p>
<p>ä¸‹é¢æ ¹æ®ä¸Šé¢è¿™ä¸ªå›¾ï¼Œè‡ªä¸Šè€Œä¸‹åˆ†æé‚®ç®±çš„å®ç°ã€‚</p>
<h2 id="yqueue_t">yqueue_t</h2>
<p>yqueue_tçš„å®ç°ï¼Œæ¯æ¬¡èƒ½æ‰¹é‡åˆ†é…ä¸€æ‰¹å…ƒç´ ï¼Œå‡å°‘å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚</p>
<p>yqueue_tå†…éƒ¨ç”±ä¸€ä¸ªä¸€ä¸ªchunkç»„æˆï¼Œæ¯ä¸ªchunkä¿å­˜Nä¸ªå…ƒç´ ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190209-zeromq-lockfree-queue/yqueue_t.png" alt="yqueue_t" title="yqueue_t"></p>
<p>æœ‰äº†chunk_tæ¥ç®¡ç†æ•°æ®ï¼Œè¿™æ ·æ¯æ¬¡éœ€è¦æ–°åˆ†é…å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰å·²ç»æ²¡æœ‰å¯ç”¨å…ƒç´ ï¼Œå¯ä»¥ä¸€æ¬¡æ€§åˆ†é…ä¸€ä¸ªchunk_tï¼Œè¿™é‡Œé¢æœ‰Nä¸ªå…ƒç´ ï¼›å¦å¤–åœ¨å›æ”¶çš„æ—¶å€™ï¼Œä¹Ÿä¸æ˜¯é©¬ä¸Šè¢«é‡Šæ”¾ï¼Œæ ¹æ®å±€éƒ¨æ€§åŸç†å¯ä»¥å…ˆå›æ”¶åˆ°spare_chunké‡Œé¢ï¼Œå½“å†æ¬¡éœ€è¦åˆ†é…chunk_tçš„æ—¶å€™ä»spare_chunkä¸­è·å–ã€‚</p>
<p>yqueue_tå†…éƒ¨æœ‰ä¸‰ä¸ªchunk_tç±»å‹æŒ‡é’ˆä»¥åŠå¯¹åº”çš„ç´¢å¼•ä½ç½®ï¼š</p>
<ul>
<li>begin_chunk/begin_posï¼šbegin_chunkç”¨äºæŒ‡å‘é˜Ÿåˆ—å¤´çš„chunkï¼Œbegin_posç”¨äºæŒ‡å‘é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ åœ¨å½“å‰chunkä¸­çš„ä½ç½®ã€‚</li>
<li>back_chunk/back_posï¼šback_chunkç”¨äºæŒ‡å‘é˜Ÿåˆ—å°¾çš„chunkï¼Œback_chunkç”¨äºæŒ‡å‘é˜Ÿåˆ—æœ€åä¸€ä¸ªå…ƒç´ åœ¨å½“å‰chunkçš„ä½ç½®ã€‚</li>
<li>end_chunk/end_posï¼šç”±äºchunkæ˜¯æ‰¹é‡åˆ†é…çš„ï¼Œæ‰€ä»¥end_chunkç”¨äºæŒ‡å‘åˆ†é…çš„æœ€åä¸€ä¸ªchunkä½ç½®ã€‚</li>
</ul>
<p>æ³¨æ„ä¸è¦æ··æ·†äº†backå’Œendçš„ä½œç”¨ï¼Œ<strong>back_chunk/back_posè´Ÿè´£çš„æ˜¯å…ƒç´ çš„å­˜å‚¨ï¼Œè€Œend_chunk/end_posè´Ÿè´£çš„æ˜¯chunkçš„åˆ†é…</strong>ï¼Œyqueue_tçš„backå‡½æ•°è¿”å›çš„æ˜¯back_posï¼Œè€Œå¯¹å¤–éƒ¨è€Œè¨€ï¼Œendç›¸å…³çš„æ•°æ®ä¸å¯è§ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190209-zeromq-lockfree-queue/chunk.png" alt="chunk" title="chunk"></p>
<p>å¦‚ä¸Šå›¾ä¸­ï¼š</p>
<ul>
<li>æœ‰ä¸‰å—chunkï¼Œåˆ†åˆ«ç”±begin_chunkã€back_chunkã€end_chunkç»„æˆã€‚</li>
<li>begin_posæŒ‡å‘begin_chunkä¸­çš„ç¬¬nä¸ªå…ƒç´ ã€‚</li>
<li>back_posæŒ‡å‘back_chunkçš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</li>
<li>ç”±äºback_poså·²ç»æŒ‡å‘äº†back_chunkçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥end_poså°±æŒ‡å‘äº†end_chunkçš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li>
</ul>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªspare_chunkæŒ‡é’ˆï¼Œç”¨äºä¿å­˜é‡Šæ”¾çš„chunkæŒ‡é’ˆï¼Œå½“éœ€è¦å†æ¬¡åˆ†é…chunkçš„æ—¶å€™ï¼Œä¼šé¦–å…ˆæŸ¥çœ‹è¿™é‡Œï¼Œä»è¿™é‡Œåˆ†é…chunkã€‚è¿™é‡Œä½¿ç”¨äº†åŸå­çš„casæ“ä½œæ¥å®Œæˆï¼Œåˆ©ç”¨äº†æ“ä½œç³»ç»Ÿçš„å±€éƒ¨æ€§åŸç†ã€‚</p>
<h2 id="ypipe_t">ypipe_t</h2>
<p>ypipe_tåœ¨yqueue_tä¹‹ä¸Šï¼Œæ„å»ºäº†ä¸€ä¸ª<strong class=chinese>å•å†™å•è¯»çš„æ— é”é˜Ÿåˆ—</strong>ã€‚</p>
<p>å†…éƒ¨çš„å…ƒç´ æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<ul>
<li>yqueue_t&lt;T, N&gt; _queueï¼šç”±yqueue_tå®ç°çš„é˜Ÿåˆ—ã€‚</li>
<li>T *_wï¼šæŒ‡å‘ç¬¬ä¸€ä¸ªæ²¡æœ‰è¢«flushçš„å…ƒç´ ï¼Œåªèƒ½è¢«å†™çº¿ç¨‹ä½¿ç”¨ã€‚</li>
<li>T *_rï¼šæŒ‡å‘ç¬¬ä¸€ä¸ªæœªè¯»çš„å…ƒç´ ï¼Œåªèƒ½è¢«è¯»çº¿ç¨‹ä½¿ç”¨ã€‚</li>
<li>T *_fï¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå†™å…¥ä½†æ˜¯è¿˜æ²¡æœ‰è¢«åˆ·æ–°çš„å…ƒç´ ã€‚</li>
<li>atomic_ptr_t<T> _cï¼šè¯»å†™çº¿ç¨‹éƒ½èƒ½ä½¿ç”¨çš„æŒ‡é’ˆï¼ŒæŒ‡å‘æœ€åä¸€ä¸ªè¢«åˆ·æ–°çš„å…ƒç´ ã€‚å¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆè¯»çº¿ç¨‹å°†ä¼‘çœ ã€‚</li>
</ul>
<p>ä¹‹æ‰€ä»¥é™¤äº†å†™æŒ‡é’ˆ_wä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ª_fçš„åˆ·æ–°æŒ‡é’ˆï¼ŒåŸå› åœ¨äºï¼šå¯èƒ½ä¼šåˆ†æ‰¹æ¬¡å†™å…¥ä¸€å †æ•°æ®ï¼Œä½†æ˜¯åœ¨æ²¡æœ‰å†™å®Œæ¯•ä¹‹å‰ï¼Œä¸å¸Œæœ›è¢«è¯»çº¿ç¨‹çœ‹åˆ°ï¼Œæ‰€ä»¥å†™å…¥æ•°æ®çš„æ—¶å€™ç”±_wæŒ‡é’ˆæ§åˆ¶ï¼Œè€Œ_fæŒ‡é’ˆæ§åˆ¶è¯»çº¿ç¨‹å¯ä»¥çœ‹åˆ°å“ªäº›æ•°æ®ã€‚</p>
<p>æ¥çœ‹ç›¸å…³çš„å‡ ä¸ªå¯¹å¤–APIï¼š</p>
<ul>
<li>void write (const T &amp;value_, bool incomplete_)ï¼šå†™å…¥æ•°æ®ï¼Œincompleteå‚æ•°è¡¨ç¤ºå†™å…¥æ˜¯å¦è¿˜æ²¡å®Œæˆï¼Œåœ¨æ²¡å®Œæˆçš„æ—¶å€™ä¸ä¼šä¿®æ”¹flushæŒ‡é’ˆï¼Œå³è¿™éƒ¨åˆ†æ•°æ®ä¸ä¼šè®©è¯»çº¿ç¨‹çœ‹åˆ°ã€‚</li>
<li>bool flush ()ï¼šåˆ·æ–°æ‰€æœ‰å·²ç»å®Œæˆçš„æ•°æ®åˆ°ç®¡é“ï¼Œè¿”å›falseæ„å‘³ç€è¯»çº¿ç¨‹åœ¨ä¼‘çœ ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è°ƒç”¨è€…éœ€è¦å”¤é†’è¯»çº¿ç¨‹ã€‚</li>
<li>bool read (T *value_):è¯»æ•°æ®ï¼Œå°†è¯»å‡ºçš„æ•°æ®å†™å…¥valueæŒ‡é’ˆä¸­ï¼Œè¿”å›falseæ„å‘³ç€æ²¡æœ‰æ•°æ®å¯è¯»ã€‚</li>
</ul>
<p>ä»¥ä¸‹é¢çš„åœºæ™¯æ¥è§£é‡Šè¿™ä¸ªæ— é”é˜Ÿåˆ—ç›¸å…³çš„æµç¨‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20190209-zeromq-lockfree-queue/ypipe_t.png" alt="ypipe_t" title="ypipe_t"></p>
<p>è¯´æ˜ï¼šä»¥ä¸‹åœºæ™¯å¿½ç•¥beginã€backã€endåœ¨ä¸åŒchunkçš„æƒ…å†µï¼Œå‡è®¾éƒ½åœ¨ä¸€ä¸ªchunkå®Œæˆçš„æ“ä½œã€‚</p>
<h3 id="1åˆå§‹åŒ–">1ã€åˆå§‹åŒ–</h3>
<p>ypipe_tæ„é€ å‡½æ•°åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°†pushè¿›å»ä¸€ä¸ªå“‘å…ƒç´ åœ¨é˜Ÿåˆ—å°¾éƒ¨ï¼Œç„¶å_rã€_wã€_cã€_fæŒ‡é’ˆéƒ½åŒæ—¶æŒ‡å‘é˜Ÿåˆ—å¤´ã€‚
è€Œç»è¿‡è¿™ä¸ªæ“ä½œä¹‹åï¼Œbegin_poså’Œback_poséƒ½ä¸º0ï¼Œend_posä¸º1ï¼ˆå› ä¸ºpushäº†ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">inline</span> <span style="color:#00a000">ypipe_t</span> ()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Insert terminator element into the queue.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  å…ˆæ”¾å…¥ä¸€ä¸ªç©ºå…ƒç´ 
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  _queue.push ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Let all the pointers to point to the terminator.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  (unless pipe is dead, in which case c is set to NULL).
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  _r <span style="color:#666">=</span> _w <span style="color:#666">=</span> _f <span style="color:#666">=</span> <span style="color:#666">&amp;</span>_queue.back ();
</span></span><span style="display:flex;"><span>  _c.set (<span style="color:#666">&amp;</span>_queue.back ());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2writea-true">2ã€write(&lsquo;a&rsquo;, true)</h3>
<p>ç”±äºè¿›è¡Œäº†pushæ“ä½œï¼Œå› æ­¤back_posæ›´æ–°ä¸º1ï¼Œè€Œend_posæ›´æ–°ä¸º2ã€‚</p>
<p>å†™å…¥ä¸€ä¸ªå…ƒç´ aï¼ŒåŒæ—¶incompleteä¸ºtrueï¼Œæ„å‘³ç€å†™å…¥è¿˜æœªå®Œæˆï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ›´æ–°flushæŒ‡é’ˆï¼Œ_wæŒ‡é’ˆä¹Ÿæ²¡æœ‰åœ¨è¿™ä¸ªå‡½æ•°ä¸­è¢«æ›´æ–°ï¼Œå› æ­¤å½“incompleteä¸ºtrueæ—¶ä¸ä¼šæ›´æ–°ä¸Šé¢çš„å››ä¸ªæŒ‡é’ˆã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">//  incomplete_ä¸ºtrueæ„å‘³ç€è¿™åªæ˜¯å†™å…¥æ•°æ®çš„ä¸€éƒ¨åˆ†ï¼Œæ­¤æ—¶ä¸éœ€è¦ä¿®æ”¹flushçš„æŒ‡é’ˆæŒ‡å‘
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">inline</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">write</span> (<span style="color:#a2f;font-weight:bold">const</span> T <span style="color:#666">&amp;</span>value_, <span style="color:#0b0;font-weight:bold">bool</span> incomplete_)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">// æ³¨æ„åœ¨è¿™é‡Œå†™å…¥æ•°æ®çš„æ—¶å€™ä¿®æ”¹çš„æ˜¯_fæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  Place the value to the queue, add new terminator element.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  _queue.back () <span style="color:#666">=</span> value_;
</span></span><span style="display:flex;"><span>  _queue.push ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Move the &#34;flush up to here&#34; poiter.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span>incomplete_)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">// incomplete_ä¸ºfalseè¡¨ç¤ºå†™å®Œæ¯•æ•°æ®äº†ï¼Œå¯ä»¥ä¿®æ”¹flushæŒ‡é’ˆæŒ‡å‘
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    _f <span style="color:#666">=</span> <span style="color:#666">&amp;</span>_queue.back ();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3writeb-false">3ã€write(&lsquo;b&rsquo;, false)</h3>
<p>ç”±äºè¿›è¡Œäº†pushæ“ä½œï¼Œå› æ­¤back_posæ›´æ–°ä¸º1ï¼Œè€Œend_posæ›´æ–°ä¸º2ã€‚</p>
<p>å†™å…¥ä¸€ä¸ªå…ƒç´ bï¼ŒåŒæ—¶incompleteä¸ºfalseï¼Œæ„å‘³ç€å†™å…¥å®Œæˆï¼Œæ­¤æ—¶éœ€è¦ä¿®æ”¹flushæŒ‡é’ˆæŒ‡å‘é˜Ÿåˆ—å°¾ï¼Œå³æ–°çš„back_posä½ç½®2ã€‚</p>
<h3 id="4flush">4ã€flush()</h3>
<p>åˆ·æ–°æ•°æ®æ“ä½œï¼Œè¯¥æ“ä½œä¸­å°†æ›´æ–°_wä»¥åŠ_cæŒ‡é’ˆã€‚</p>
<p>æ›´æ–°_wæŒ‡é’ˆçš„æ“ä½œï¼Œç”±äºåªæœ‰å†™çº¿ç¨‹æ¥å®Œæˆï¼Œå› æ­¤ä¸éœ€è¦åŠ é”ï¼Œ_wæŒ‡é’ˆç”¨äºä¸_fæŒ‡é’ˆè¿›è¡Œå¯¹æ¯”ï¼Œå¿«é€ŸçŸ¥é“æ˜¯å¦æœ‰æ•°æ®éœ€è¦åˆ·æ–°ï¼Œä»¥å”¤é†’è¯»çº¿ç¨‹æ¥ç»§ç»­è¯»æ•°æ®ã€‚</p>
<p>è€Œ_cæŒ‡é’ˆï¼Œåˆ™æ˜¯è¯»å†™çº¿ç¨‹éƒ½å¯ä»¥æ“ä½œï¼Œå› æ­¤éœ€è¦ä½¿ç”¨åŸå­çš„CASæ“ä½œæ¥ä¿®æ”¹ï¼Œå®ƒçš„å¯èƒ½å€¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>NULLï¼šè¯»çº¿ç¨‹è®¾ç½®ï¼Œæ­¤æ—¶æ„å‘³ç€å·²ç»æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œè¯»çº¿ç¨‹åœ¨ä¼‘çœ ã€‚</li>
<li>éé›¶ï¼šå†™çº¿ç¨‹è®¾ç½®ï¼Œè¿™é‡ŒåˆåŒºåˆ†ä¸¤ç§æƒ…å†µï¼š
<ul>
<li>æ—§å€¼ä¸º_wçš„æƒ…å†µä¸‹ï¼Œcas(_w,_f)æ“ä½œä¿®æ”¹ä¸º_fï¼Œæ„å‘³ç€å¦‚æœåŸå…ˆçš„å€¼ä¸º_wï¼Œåˆ™åŸå­æ€§çš„ä¿®æ”¹ä¸º_fï¼Œè¡¨ç¤ºæœ‰æ›´å¤šå·²è¢«åˆ·æ–°çš„æ•°æ®å¯è¯»ã€‚</li>
<li>åœ¨æ—§å€¼ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶è¯»çº¿ç¨‹ä¼‘çœ ï¼Œå› æ­¤å¯ä»¥å®‰å…¨çš„è®¾ç½®ä¸ºå½“å‰_fæŒ‡é’ˆçš„ä½ç½®ã€‚</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">inline</span> <span style="color:#0b0;font-weight:bold">bool</span> <span style="color:#00a000">flush</span> ()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  If there are no un-flushed items, do nothing.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  _wç­‰äº_fï¼Œæ„å‘³ç€æ²¡æœ‰éœ€è¦åˆ·æ–°çš„å…ƒç´ äº†ï¼Œç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">if</span> (_w <span style="color:#666">==</span> _f)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Try to set &#39;c&#39; to &#39;f&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  å¦‚æœcåŸæ¥æ˜¯_wï¼Œåˆ‡æ¢ä¸º_fï¼ŒåŒæ—¶è¿”å›æ—§çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  å¦‚æœè¿”å›å€¼ä¸æ˜¯_wï¼Œæ„å‘³ç€æ—§çš„å€¼ä¸æ˜¯_w
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">if</span> (_c.cas (_w, _f) <span style="color:#666">!=</span> _w) {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//  Compare-and-swap was unseccessful because &#39;c&#39; is NULL.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#080;font-style:italic">//  This means that the reader is asleep. Therefore we don&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#080;font-style:italic">//  care about thread-safeness and update c in non-atomic
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#080;font-style:italic">//  manner. We&#39;ll return false to let the caller know
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#080;font-style:italic">//  that reader is sleeping.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#080;font-style:italic">//  casæ“ä½œè¿”å›ä¸æ˜¯_wï¼Œæ„å‘³ç€_cæŒ‡é’ˆä¸ºNULL
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#080;font-style:italic">//  è¿™ç§æƒ…å†µä¸‹è¯»çº¿ç¨‹åœ¨ä¼‘çœ ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹_wæŒ‡é’ˆä¸º_få¹¶ä¸”è¿”å›falseå”¤é†’è¯»çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    _c.set (_f);
</span></span><span style="display:flex;"><span>    _w <span style="color:#666">=</span> _f;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Reader is alive. Nothing special to do now. Just move
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  the &#39;first un-flushed item&#39; pointer to &#39;f&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  åˆ°äº†è¿™é‡Œæ„å‘³ç€è¯»çº¿ç¨‹æ²¡æœ‰åœ¨ä¼‘çœ ï¼Œç›´æ¥ä¿®æ”¹_wæŒ‡é’ˆä¸º_f
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  _w <span style="color:#666">=</span> _f;
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="5readret">5ã€read(&amp;ret)</h3>
<p>ç¬¬ä¸€æ¬¡è¯»æ“ä½œï¼Œreadå‡½æ•°è¿”å›trueè¡¨ç¤ºè¯»åˆ°äº†æ•°æ®ï¼Œretä¸­ä¿å­˜çš„æ˜¯&rsquo;a&rsquo;è¿”å›ã€‚</p>
<p>è¯»æ“ä½œé¦–å…ˆè¿›å…¥check_readå‡½æ•°ä¸­æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯»ï¼Œåšä»¥ä¸‹çš„åˆ¤æ–­ï¼š</p>
<ul>
<li>&amp;_queue.front () != _r &amp;&amp; _rï¼šå¦‚æœé˜Ÿåˆ—å¤´ä¸ç­‰äº_rï¼Œè€Œä¸”_rä¸ä¸ºNULLï¼Œæ„å‘³ç€æœ‰é¢„è¯»çš„æ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸‹ç›´æ¥è¿”å›ã€‚</li>
<li>å¦‚æœä¸Šé¢çš„æ¡ä»¶ä¸æ»¡è¶³ï¼Œæ„å‘³ç€æ²¡æœ‰é¢„è¯»çš„æ•°æ®ã€‚æ­¤æ—¶æ ¹æ®_cæŒ‡é’ˆæ¥åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®å¯è¯»ã€‚ä½¿ç”¨åŸå­çš„CASæ“ä½œï¼Œåœ¨_cä¸ºé˜Ÿåˆ—å¤´çš„æƒ…å†µä¸‹é‡ç½®ä¸ºNULLï¼ŒåŒæ—¶å°†_cçš„æ—§å€¼è¿”å›åˆ°_ræŒ‡é’ˆä¸­ï¼Œå¦‚æœ_rä¸ºé˜Ÿåˆ—å¤´æˆ–è€…ä¸ºNULLï¼Œåˆ™è¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¯è¯»ã€‚</li>
<li>å¦åˆ™ï¼Œè¿”å›trueæ„å‘³ç€æœ‰æ•°æ®å¯è¯»ã€‚</li>
</ul>
<p>è€Œåœ¨check_readå‡½æ•°è¿”å›trueè¡¨ç¤ºæœ‰æ•°æ®å¯è¯»çš„æƒ…å†µä¸‹ï¼Œreadå‡½æ•°å°†popå‡ºé˜Ÿåˆ—çš„å¤´éƒ¨æ•°æ®ï¼Œè¿™ä¸ªæ“ä½œå°†begin_posé€’å¢ä¸€ä½ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">//  è¿”å›æ˜¯å¦æœ‰æ•°æ®å¯ä»¥è¯»
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">inline</span> <span style="color:#0b0;font-weight:bold">bool</span> <span style="color:#00a000">check_read</span> ()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Was the value prefetched already? If so, return.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  é˜Ÿåˆ—é¦–å…ƒç´ ä½ç½®ä¸ç­‰äº_rå¹¶ä¸”_rä¸ä¸ºNULLï¼Œè¯´æ˜æœ‰å…ƒç´ å¯è¯»
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">&amp;</span>_queue.front () <span style="color:#666">!=</span> _r <span style="color:#666">&amp;&amp;</span> _r)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  There&#39;s no prefetched value, so let us prefetch more values.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  Prefetching is to simply retrieve the
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  pointer from c in atomic fashion. If there are no
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  items to prefetch, set c to NULL (using compare-and-swap).
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  è¿”å›_cçš„æ—§å€¼åˆ°_rä¸­ï¼ŒåŒæ—¶å¦‚æœ_cä¸ºé˜Ÿåˆ—å¤´ï¼Œåˆ™è®¾ç½®ä¸ºNULL
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  _r <span style="color:#666">=</span> _c.cas (<span style="color:#666">&amp;</span>_queue.front (), <span style="color:#a2f">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  If there are no elements prefetched, exit.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  During pipe&#39;s lifetime r should never be NULL, however,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  it can happen during pipe shutdown when items
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  are being deallocated.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  å¦‚æœ_cçš„æ—§å€¼ä¸ºé˜Ÿåˆ—å¤´ï¼Œæˆ–è€…_cçš„æ—§å€¼ä¸ºNULLï¼Œåˆ™æ²¡æœ‰æ•°æ®å¯è¯»
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">&amp;</span>_queue.front () <span style="color:#666">==</span> _r <span style="color:#666">||</span> <span style="color:#666">!</span>_r)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  There was at least one value prefetched.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//  Reads an item from the pipe. Returns false if there is no value.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//  available.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">inline</span> <span style="color:#0b0;font-weight:bold">bool</span> <span style="color:#00a000">read</span> (T <span style="color:#666">*</span>value_)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  Try to prefetch a value.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span>check_read ())
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-style:italic">//  There was at least one value prefetched.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">//  Return it to the caller.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#666">*</span>value_ <span style="color:#666">=</span> _queue.front ();
</span></span><span style="display:flex;"><span>  _queue.pop ();
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ˜ç™½äº†ä»¥ä¸Šçš„æµç¨‹ï¼Œå…·ä½“è§£é‡Šç¬¬ä¸€æ¬¡è°ƒç”¨read(&amp;ret)æ“ä½œï¼š</p>
<ul>
<li>åœ¨è°ƒç”¨ä¹‹å‰ï¼Œ_ræŒ‡å‘é˜Ÿåˆ—å¤´ï¼Œç”±äº_cä¸æ˜¯æŒ‡å‘é˜Ÿåˆ—å¤´ï¼Œæ‰€ä»¥_r = _c.cas (&amp;_queue.front (), NULL)çš„æ“ä½œå¹¶æ²¡æœ‰ä¿®æ”¹_cçš„å€¼ï¼Œåªæ˜¯å°†_rç½®ä¸º_cï¼Œç„¶åcheck_readå‡½æ•°è¿”å›trueè¡¨ç¤ºæœ‰æ•°æ®å¯è¯»ã€‚</li>
<li>ç”±äºcheck_readå‡½æ•°è¿”å›trueè¡¨ç¤ºæœ‰æ•°æ®å¯è¯»ï¼Œå› æ­¤readå‡½æ•°ä¸­è°ƒç”¨popå‡½æ•°è¯»å‡ºé˜Ÿåˆ—å¤´æ•°æ®ï¼ŒåŒæ—¶å°†begin_posé€’å¢ä¸º1ã€‚</li>
</ul>
<h3 id="6readret">6ã€read(&amp;ret)</h3>
<p>ç¬¬äºŒæ¬¡è¯»æ“ä½œï¼Œreadå‡½æ•°è¿”å›trueè¡¨ç¤ºè¯»åˆ°äº†æ•°æ®ï¼Œretä¸­ä¿å­˜çš„æ˜¯&rsquo;b&rsquo;è¿”å›ã€‚</p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ­¤æ—¶_rå’Œ_cä¸ºback_poså³ç´¢å¼•ä½ç½®2ï¼Œè€Œé˜Ÿåˆ—å¤´ä¸ºbegin_posç´¢å¼•ä½ç½®1ï¼Œå› æ­¤æœ‰æ•°æ®å¯è¯»check_readè¿”å›trueã€‚</li>
<li>ç”±äºcheck_readå‡½æ•°è¿”å›trueè¡¨ç¤ºæœ‰æ•°æ®å¯è¯»ï¼Œå› æ­¤readå‡½æ•°ä¸­è°ƒç”¨popå‡½æ•°è¯»å‡ºé˜Ÿåˆ—å¤´æ•°æ®ï¼ŒåŒæ—¶å°†begin_posé€’å¢ä¸º2ã€‚</li>
</ul>
<h3 id="7readret">7ã€read(&amp;ret)</h3>
<p>ç¬¬ä¸‰æ¬¡è¯»æ“ä½œï¼ˆä¸Šå›¾ä¸­æ²¡æœ‰ç»™å‡ºï¼‰ï¼Œreadå‡½æ•°è¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¯è¯»ã€‚</p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ­¤æ—¶_rä¸ºback_poså³ç´¢å¼•ä½ç½®2ï¼Œè€Œé˜Ÿåˆ—å¤´begin_posä¹Ÿæ˜¯2ï¼Œå› æ­¤check_readè¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¯è¯»ã€‚</li>
</ul>
<p>æ€»ç»“ypipe_tçš„æ•´ä½“è®¾è®¡ï¼š</p>
<ul>
<li>åŒºåˆ†äº†å‡ ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æœ‰ä»¥ä¸‹ä¸åŒçš„åŠŸèƒ½ï¼š
<ul>
<li>_fï¼šç”¨äºå­˜æ”¾åˆ·æ–°æ•°æ®çš„ä½ç½®ã€‚åªæœ‰å†™çº¿ç¨‹å¯ä»¥æ›´æ–°ï¼Œåœ¨å†™å…¥çš„æ•°æ®æœªå®Œæˆçš„æƒ…å†µä¸‹ä¸ä¼šæ›´æ–°è¯¥æŒ‡é’ˆã€‚</li>
<li>_wï¼šç”¨äºå­˜æ”¾å†™å…¥æ•°æ®çš„ä½ç½®ã€‚åªæœ‰å†™çº¿ç¨‹å¯ä»¥æ›´æ–°ï¼Œåªæœ‰åœ¨å†™å…¥å®Œæˆä¹‹åè°ƒç”¨flushå‡½æ•°æ‰ä¼šå°†è¯¥æŒ‡é’ˆæ›´æ–°åˆ°_fã€‚</li>
<li>_rï¼šç”¨äºå­˜æ”¾è¯»å–æ•°æ®çš„ä½ç½®ã€‚åªæœ‰è¯»çº¿ç¨‹å¯ä»¥æ›´æ–°ï¼Œå¦‚æœ_rä¸æ˜¯é˜Ÿåˆ—å¤´ï¼Œåˆ™è¡¨ç¤ºä¸€ç›´æœ‰æ•°æ®å¯è¯»ï¼›å¦åˆ™éœ€è¦æ ¹æ®_cçš„å€¼åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®å¯è¯»ã€‚</li>
<li>_cï¼šæŒ‡å‘æœ€åä¸€ä¸ªè¢«åˆ·æ–°æ•°æ®çš„ä½ç½®ï¼Œè¯»å†™çº¿ç¨‹éƒ½å¯ä»¥ä¿®æ”¹ï¼Œå¦‚æœä¸ºNULLè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¯è¯»ã€‚</li>
</ul>
</li>
</ul>
<h2 id="mailbox_t">mailbox_t</h2>
<p>æœ‰äº†ä»¥ä¸Šçš„ä»‹ç»ï¼Œå®é™…ç†è§£èµ·æ¥mailbox_tçš„å®ç°å°±æ¯”è¾ƒç®€å•äº†ã€‚ä½†æ˜¯å‰é¢åˆ†æypipe_tçš„æ—¶å€™æåˆ°è¿‡ï¼Œè¿™ä¸ªæ— é”é˜Ÿåˆ—çš„å®ç°æ˜¯å•å†™å•è¯»çš„ï¼Œè€Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šæœ‰å¤šä¸ªä¸åŒçš„çº¿ç¨‹åŒæ—¶å¾€ä¸€ä¸ªactorå‘æ¶ˆæ¯ï¼Œå³éœ€è¦çš„æ˜¯å¤šå†™å¤šè¯»çš„æ¨¡å¼ï¼Œæ¥çœ‹mailbox_tä¸­sendå‡½æ•°çš„å®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#0b0;font-weight:bold">void</span> zmq<span style="color:#666">::</span>mailbox_t<span style="color:#666">::</span>send (<span style="color:#a2f;font-weight:bold">const</span> command_t <span style="color:#666">&amp;</span>cmd_)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">// è¿™é‡Œéœ€è¦åŠ é”ï¼Œå› ä¸ºæ˜¯å¤šå†™ä¸€è¯»çš„é‚®ç®±
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    _sync.lock ();
</span></span><span style="display:flex;"><span>    _cpipe.write (cmd_, <span style="color:#a2f">false</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">const</span> <span style="color:#0b0;font-weight:bold">bool</span> ok <span style="color:#666">=</span> _cpipe.flush ();
</span></span><span style="display:flex;"><span>    _sync.unlock ();
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span>ok)  <span style="color:#080;font-style:italic">// flushæ“ä½œè¿”å›falseæ„å‘³ç€è¯»çº¿ç¨‹åœ¨ä¼‘çœ ï¼Œsignalå‘é€ä¿¡å·å”¤é†’è¯»çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>        _signaler.send ();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥ä»ä»£ç ä¸­çœ‹åˆ°ï¼Œè™½ç„¶ypipe_tçš„å®ç°äº†ä¸€ä¸ªå•å†™å•è¯»çš„æ— é”é˜Ÿåˆ—ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰è§£å†³å¤šå†™å¤šè¯»é—®é¢˜ï¼Œè¿˜æ˜¯éœ€è¦åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™åŠ é”ã€‚
å› æ­¤ï¼Œ<strong>zeromqå·ç§°çš„æ— é”æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡ï¼Œå…¶å®å‡†ç¡®çš„è¯´åªæ˜¯é’ˆå¯¹è¯»å†™çº¿ç¨‹æ— é”ï¼Œå¯¹äºå¤šä¸ªå†™çº¿ç¨‹è€Œè¨€è¿˜æ˜¯æœ‰é”çš„</strong>ã€‚</p>
<p>å¦å¤–ï¼Œç”±äºåœ¨æ²¡æœ‰å…ƒç´ å¯è¯»çš„æƒ…å†µä¸‹ï¼Œè¯»çº¿ç¨‹ä¼šä¼‘çœ ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªå”¤é†’è¯»çº¿ç¨‹çš„æœºåˆ¶ï¼Œè¿™é‡Œé‡‡ç”¨äº†signaler_tç±»å‹çš„æˆå‘˜å˜é‡_signalerï¼Œå†…éƒ¨å®ç°å®é™…ä¸Šä¸€ä¸ªpipeï¼Œå‘è¿™ä¸ªpipeå†™å…¥ä¸€ä¸ªå­—ç¬¦ç”¨äºå”¤é†’è¯»çº¿ç¨‹ã€‚</p>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20190131-nginx-read-http-request/">â† prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20190212-nginx-http-config/">next â†’</a>
    
  </div>

    
<h1>ç›¸å…³æ–‡ç« </h1>
<li><strong> 5119-11-05: </strong> <a href="https://www.codedump.info/post/20201105-kcp/">KCP 1.4æºç åˆ†æ</a>  </li><li><strong> 29079-07-29: </strong> <a href="https://www.codedump.info/post/20190729-glog/">glog C&#43;&#43;ç‰ˆæœ¬ä»£ç åˆ†æ</a>  </li><li><strong> 13049-04-13: </strong> <a href="https://www.codedump.info/post/20190413-problem-fix/">çº¿ä¸Šå­˜å‚¨æœåŠ¡å´©æºƒé—®é¢˜åˆ†æè®°å½•</a>  </li><li><strong> 27029-02-27: </strong> <a href="https://www.codedump.info/post/20190227-tcp/">TCPåè®®ç¬”è®°</a>  </li><li><strong> 23019-01-23: </strong> <a href="https://www.codedump.info/post/20190123-libuv/">Libuvä»£ç ç®€å•åˆ†æ</a>  </li>
<h1>é‚®ä»¶è®¢é˜…</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="é‚®ä»¶è®¢é˜…æœ¬ç«™æ›´æ–°" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="ç‚¹å‡»è®¢é˜…" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revueâ€™s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">ç½‘ç»œç¼–ç¨‹</a>
          <a href="/tags/zeromq/">zeromq</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    
    
        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  
    
  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
