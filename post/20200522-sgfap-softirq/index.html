<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° ä¸­æ–­ï¼ˆinterruptï¼‰é€šå¸¸è¢«å®šä¹‰ä¸ºä¸€">




<meta name="keywords" content=" linux  systemtap ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è½¯ä¸­æ–­" />
<meta name="twitter:description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° ä¸­æ–­ï¼ˆinterruptï¼‰é€šå¸¸è¢«å®šä¹‰ä¸ºä¸€" />


<link rel="canonical" href="https://www.codedump.info/post/20200522-sgfap-softirq/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è½¯ä¸­æ–­ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è½¯ä¸­æ–­</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/linux%E7%B3%BB%E7%BB%9F'>#Linuxç³»ç»Ÿ</a>
        
      </div>
      
      <div class="content">
        

<blockquote>
<p>æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§<a href="https://www.codedump.info/post/20200501-system-guide-for-application-programmer/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®º</a>ã€‚</p>
</blockquote>

<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>ä¸­æ–­ï¼ˆinterruptï¼‰é€šå¸¸è¢«å®šä¹‰ä¸ºä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶æ”¹å˜å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºã€‚ä¸­æ–­åˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§ï¼š</p>

<ul>
<li>åŒæ­¥ä¸­æ–­åœ¨æŒ‡ä»¤æ‰§è¡Œæ—¶ç”±CPUæ§åˆ¶å•å…ƒäº§ç”Ÿï¼Œä¹‹æ‰€ä»¥ç§°ä¸ºåŒæ­¥ï¼Œæ˜¯å› ä¸ºåªæœ‰åœ¨ä¸€æ¡æŒ‡ä»¤ç»ˆæ­¢æ‰§è¡ŒåCPUæ‰å‘ç”Ÿä¸­æ–­ã€‚</li>
<li>å¼‚æ­¥ä¸­æ–­æ˜¯ç”±å…¶ä»–ç¡¬ä»¶è®¾å¤‡ä¾ç…§CPUæ—¶é’Ÿä¿¡å·éšæœºäº§ç”Ÿçš„ã€‚</li>
</ul>

<p>åœ¨Intelçš„å¤„ç†å™¨æ‰‹å†Œä¸­ï¼Œå°†åŒæ­¥ä¸­æ–­ç§°ä¸ºâ€œå¼‚å¸¸ï¼ˆexceptionï¼‰â€ï¼Œå¼‚æ­¥ä¸­æ–­ç§°ä¸ºâ€œä¸­æ–­â€ã€‚</p>

<p>å¼‚å¸¸é€šå¸¸ç”±ç¨‹åºçš„é”™è¯¯äº§ç”Ÿï¼Œæˆ–è€…æ˜¯ç”±å†…æ ¸å¿…é¡»å¤„ç†çš„å¼‚å¸¸æ¡ä»¶äº§ç”Ÿçš„ã€‚æ¯”å¦‚ç¨‹åºä¸­æœ‰é™¤é›¶å¼‚å¸¸ï¼Œæ¯”å¦‚è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„â€œç¼ºé¡µå¼‚å¸¸ï¼ˆpagefaultï¼‰â€ç­‰ï¼Œéƒ½å±äºå¼‚å¸¸ã€‚</p>

<p>è€Œä¸­æ–­æ˜¯ç”±å®šæ—¶å™¨å’ŒI/Oè®¾å¤‡äº§ç”Ÿçš„ï¼Œæ¯”å¦‚ç”¨æˆ·çš„ä¸€æ¬¡æŒ‰é”®ã€ç½‘å¡æ”¶åˆ°æ•°æ®ï¼Œéƒ½ä¼šäº§ç”Ÿä¸­æ–­ã€‚</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200522-sgfap-softirq/interrupt-type.png" alt="interrupt-type" title="interrupt-type" />
</center></p>

<p>å¤„ç†å™¨ä¸€æ—¦æ”¶åˆ°ä¸­æ–­ï¼Œå°±å¿…é¡»æ‰“æ–­å½“å‰çš„æ‰§è¡Œï¼Œè½¬è€Œå»æ‰§è¡Œä¸­æ–­å¤„ç†å‡½æ•°ã€‚ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œæœ¬èº«æœ‰ä¸€äº›ç¼ºé™·ï¼š</p>

<ul>
<li>ä¸èƒ½åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå› æ­¤ä¸èƒ½é˜»å¡ã€‚</li>
<li>ä¸­æ–­å¤„ç†ç¨‹åºä¼šæ‰“æ–­ç¨‹åºæ‰§è¡Œï¼Œä¸ºäº†é¿å…è¿™ä¸ªæ‰“æ–­çš„æµç¨‹åœæ­¢æ—¶é—´è¿‡é•¿ï¼Œæ‰€ä»¥åº”è¯¥æ‰§è¡Œçš„è¶ŠçŸ­è¶Šå¥½ã€‚</li>
</ul>

<p>å› ä¸ºä»¥ä¸Šçš„åŸå› ï¼ŒLinuxå†…æ ¸å°†ä¸­æ–­çš„å¤„ç†åˆ†ä¸ºäº†ä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸ŠåŠéƒ¨å°±æ˜¯å‰é¢æåˆ°çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œè¿™éƒ¨åˆ†èƒ½å¤Ÿæœ€å¿«çš„å“åº”ä¸­æ–­ï¼Œå¹¶ä¸”åšä¸€äº›ä¸­æ–­åå¿…é¡»è¦åšçš„äº‹æƒ…ï¼Œè€Œä¸€äº›å¯ä»¥åœ¨ä¸­æ–­å¤„ç†å‡½æ•°åç»§ç»­æ‰§è¡Œçš„æ“ä½œï¼Œåˆ™å¯ä»¥æ”¾åœ¨ä¸‹åŠéƒ¨ä¸­ã€‚</p>

<p>ä»¥ç½‘å¡æ¥æ”¶åˆ°æ•°æ®æ¥ä¸¾ä¾‹ï¼Œç½‘å¡é€šè¿‡ä¸­æ–­å‘Šè¯‰å†…æ ¸æœ‰æ•°æ®å¯ä»¥æ¥æ”¶ï¼Œæ­¤æ—¶å†…æ ¸å°±ä¼šåˆ°ç½‘å¡çš„ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œä¸€äº›ç½‘å¡ç¡¬ä»¶çš„å¿…è¦è®¾ç½®ï¼Œè€Œå¯¹åº”çš„ä¸‹åŠéƒ¨å°±æ˜¯å¤„ç†ç½‘å¡æ”¶åˆ°çš„æ•°æ®ï¼Œå› ä¸ºå¤„ç†ç½‘å¡æ•°æ®æ²¡æœ‰å¿…è¦åœ¨ä¸­æ–­å¤„ç†å‡½æ•°é‡Œé¢é©¬ä¸Šæ‰§è¡Œã€‚</p>

<p>ä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼šä¸­æ–­ä¸èƒ½è¢«ç›¸åŒç±»å‹çš„ä¸­æ–­æ‰“æ–­ï¼Œè€Œä¸‹åŠéƒ¨ä¾ç„¶å¯ä»¥è¢«ä¸­æ–­æ‰“æ–­ï¼›ä¸­æ–­å¯¹äºæ—¶é—´éå¸¸æ•æ„Ÿï¼Œè€Œä¸‹åŠéƒ¨åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€äº›å¯ä»¥å»¶è¿Ÿçš„å·¥ä½œã€‚ç”±äºäºŒè€…çš„è¿™ç§åŒºåˆ«ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªå·¥ä½œæ˜¯æ”¾åœ¨ä¸ŠåŠéƒ¨è¿˜æ˜¯æ”¾åœ¨ä¸‹åŠéƒ¨å»æ‰§è¡Œï¼Œå¯ä»¥å‚è€ƒä¸‹é¢4æ¡ï¼š</p>

<ul>
<li>å¦‚æœä¸€ä¸ªä»»åŠ¡å¯¹æ—¶é—´éå¸¸æ•æ„Ÿï¼Œå°†å…¶æ”¾åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œã€‚</li>
<li>å¦‚æœä¸€ä¸ªä»»åŠ¡å’Œç¡¬ä»¶ç›¸å…³ï¼Œå°†å…¶æ”¾åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œã€‚</li>
<li>å¦‚æœä¸€ä¸ªä»»åŠ¡è¦ä¿è¯ä¸è¢«å…¶ä»–ä¸­æ–­ï¼ˆç‰¹åˆ«æ˜¯ç›¸åŒçš„ä¸­æ–­ï¼‰æ‰“æ–­ï¼Œå°†å…¶æ”¾åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œã€‚</li>
<li>å…¶ä»–æ‰€æœ‰ä»»åŠ¡ï¼Œè€ƒè™‘æ”¾åœ¨ä¸‹åŠéƒ¨å»æ‰§è¡Œã€‚</li>
</ul>

<p>æœ‰å†™å†…æ ¸ä»»åŠ¡éœ€è¦å»¶åæ‰§è¡Œï¼Œå› æ­¤æ‰æœ‰çš„ä¸‹åŠéƒ¨ï¼Œè¿›è€Œå®ç°äº†ä¸‰ç§å®ç°ä¸‹åŠéƒ¨çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯æœ¬æ–‡è¦è®¨è®ºçš„è½¯ä¸­æ–­ã€taskletå’Œå·¥ä½œé˜Ÿåˆ—ã€‚</p>

<h1 id="è½¯ä¸­æ–­">è½¯ä¸­æ–­</h1>

<p>è½¯ä¸­æ–­ä½œä¸ºä¸‹åŠéƒ¨æœºåˆ¶çš„ä»£è¡¨ï¼Œæ˜¯éšç€SMPï¼ˆshare memory processorï¼‰çš„å‡ºç°åº”è¿è€Œç”Ÿçš„ï¼Œå®ƒä¹Ÿæ˜¯taskletå®ç°çš„åŸºç¡€ï¼ˆtaskletå®é™…ä¸Šåªæ˜¯åœ¨è½¯ä¸­æ–­çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€å®šçš„æœºåˆ¶ï¼‰ã€‚è½¯ä¸­æ–­ä¸€èˆ¬æ˜¯â€œå¯å»¶è¿Ÿå‡½æ•°â€çš„æ€»ç§°ï¼Œæœ‰æ—¶å€™ä¹ŸåŒ…æ‹¬äº†taskletï¼ˆè¯·è¯»è€…åœ¨é‡åˆ°çš„æ—¶å€™æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­æ˜¯å¦åŒ…å«taskletï¼‰ã€‚å®ƒçš„å‡ºç°å°±æ˜¯å› ä¸ºè¦æ»¡è¶³ä¸Šé¢æ‰€æå‡ºçš„ä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨çš„åŒºåˆ«ï¼Œä½¿å¾—å¯¹æ—¶é—´ä¸æ•æ„Ÿçš„ä»»åŠ¡å»¶åæ‰§è¡Œï¼Œè€Œä¸”å¯ä»¥åœ¨å¤šä¸ªCPUä¸Šå¹¶è¡Œæ‰§è¡Œï¼Œä½¿å¾—æ€»çš„ç³»ç»Ÿæ•ˆç‡å¯ä»¥æ›´é«˜ã€‚å®ƒçš„ç‰¹æ€§åŒ…æ‹¬ï¼š</p>

<p>äº§ç”Ÿåå¹¶ä¸æ˜¯é©¬ä¸Šå¯ä»¥æ‰§è¡Œï¼Œå¿…é¡»è¦ç­‰å¾…å†…æ ¸çš„è°ƒåº¦æ‰èƒ½æ‰§è¡Œã€‚è½¯ä¸­æ–­ä¸èƒ½è¢«è‡ªå·±æ‰“æ–­(å³å•ä¸ªcpuä¸Šè½¯ä¸­æ–­ä¸èƒ½åµŒå¥—æ‰§è¡Œ)ï¼Œåªèƒ½è¢«ç¡¬ä»¶ä¸­æ–­æ‰“æ–­ï¼ˆä¸ŠåŠéƒ¨ï¼‰ã€‚
å¯ä»¥å¹¶å‘è¿è¡Œåœ¨å¤šä¸ªCPUä¸Šï¼ˆå³ä½¿åŒä¸€ç±»å‹çš„ä¹Ÿå¯ä»¥ï¼‰ã€‚æ‰€ä»¥è½¯ä¸­æ–­å¿…é¡»è®¾è®¡ä¸ºå¯é‡å…¥çš„å‡½æ•°ï¼ˆå…è®¸å¤šä¸ªCPUåŒæ—¶æ“ä½œï¼‰ï¼Œå› æ­¤ä¹Ÿéœ€è¦ä½¿ç”¨è‡ªæ—‹é”æ¥ä¿å…¶æ•°æ®ç»“æ„ã€‚</p>

<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>

<p>è½¯ä¸­æ–­ç”±ç³»ç»Ÿåœ¨å¯åŠ¨çš„æ—¶å€™æ³¨å†Œåˆ°å†…æ ¸ä¸­ï¼Œç”±ä¸€ä¸ªå…¨å±€æ•°ç»„æ¥ç»´æŠ¤è½¯ä¸­æ–­ï¼š</p>

<pre><code class="language-C">struct softirq_action
{
	void	(*action)(struct softirq_action *);
};

static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬è´¨ä¸Šç»“æ„ä½“softirq_actionå­˜å‚¨çš„æ˜¯å‡½æ•°æŒ‡é’ˆè€Œå·²ï¼Œè½¯ä¸­æ–­æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p>

<pre><code class="language-C">enum
{
	HI_SOFTIRQ=0,     // å¤„ç†é«˜ä¼˜å…ˆçº§çš„tasklet
	TIMER_SOFTIRQ,    // å®šæ—¶å™¨çš„ä¸‹åŠéƒ¨
	NET_TX_SOFTIRQ,   // ç½‘å¡å‘é€æ•°æ®åŒ…
	NET_RX_SOFTIRQ,   // ç½‘å¡æ¥æ”¶æ•°æ®åŒ…
	BLOCK_SOFTIRQ,    // BLOCKè£…ç½®     
	IRQ_POLL_SOFTIRQ, 
	TASKLET_SOFTIRQ,  // å¤„ç†å¸¸è§„çš„tasklet
	SCHED_SOFTIRQ,
	HRTIMER_SOFTIRQ, 
	RCU_SOFTIRQ,
	NR_SOFTIRQS
};
</code></pre>

<p>ç³»ç»Ÿæä¾›äº†open_softirqå‡½æ•°ç”¨äºå„ä¸ªéœ€è¦ä½¿ç”¨åˆ°è½¯ä¸­æ–­çš„ç³»ç»Ÿæ³¨å†Œå¯¹åº”çš„è½¯ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p>

<pre><code class="language-C">void open_softirq(int nr, void (*action)(struct softirq_action *))
{
	softirq_vec[nr].action = action;
}
</code></pre>

<p>åŒæ—¶ï¼Œè¿˜æä¾›äº†softirq_to_nameæ•°ç»„ï¼Œç”¨äºæŠŠè½¯ä¸­æ–­çš„ç´¢å¼•æ˜ å°„åˆ°å¯¹åº”çš„è½¯ä¸­æ–­åç§°ï¼š</p>

<pre><code class="language-C">const char * const softirq_to_name[NR_SOFTIRQS] = {
	&quot;HI&quot;, &quot;TIMER&quot;, &quot;NET_TX&quot;, &quot;NET_RX&quot;, &quot;BLOCK&quot;, &quot;IRQ_POLL&quot;,
	&quot;TASKLET&quot;, &quot;SCHED&quot;, &quot;HRTIMER&quot;, &quot;RCU&quot;
};
</code></pre>

<p>åœ¨Linuxä¸‹é¢ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹<code>/proc/softirqs</code>æ–‡ä»¶çŸ¥é“å½“å‰ç³»ç»Ÿè½¯ä¸­æ–­çš„æƒ…å†µï¼š</p>

<pre><code>$ cat /proc/softirqs
                    CPU0       CPU1       CPU2       CPU3
          HI:     276180     286764    2509097     254357
       TIMER:    1550133    1285854    1440533    1812909
      NET_TX:     102895         16         15         57
      NET_RX:        155        178        115    1619192
       BLOCK:       1713      15048     251826       1082
    IRQ_POLL:          0          0          0          0
     TASKLET:          9         63          6       2830
       SCHED:    1484942    1207449    1310735    1724911
     HRTIMER:          0          0          0          0
         RCU:     690954     685825     787447     878963
</code></pre>

<h2 id="è§¦å‘è½¯ä¸­æ–­">è§¦å‘è½¯ä¸­æ–­</h2>

<p>è§¦å‘è½¯ä¸­æ–­çš„å…¥å£å‡½æ•°æ˜¯raise_softirqï¼š</p>

<pre><code class="language-C">void raise_softirq(unsigned int nr)
{
	unsigned long flags;

	local_irq_save(flags);
	raise_softirq_irqoff(nr);
	local_irq_restore(flags);
}
</code></pre>

<p>é¦–å…ˆï¼Œç”±äºè°ƒç”¨è½¯ä¸­æ–­å¤„ç†å‡½æ•°å¿…é¡»ç¦ç”¨ä¸­æ–­ï¼Œæ‰€ä»¥local_irq_saveå®å°†ä¿å­˜åœ¨eflagså¯„å­˜å™¨ä¸­çš„IFæ ‡å¿—ï¼ŒåŒæ—¶ç¦ç”¨æœ¬åœ°å¤„ç†å™¨çš„ä¸­æ–­ã€‚å¯¹åº”çš„ï¼Œlocal_irq_restoreå®å°†ä¿å­˜ä¸‹æ¥çš„flagsæ ‡å¿—ä½æ¢å¤å›å»ï¼ŒåŒæ—¶æ‰“å¼€æœ¬åœ°å¤„ç†å™¨çš„ä¸­æ–­ã€‚</p>

<p>æ¥ç€çœ‹raise_softirq_irqoffå‡½æ•°ï¼š</p>

<pre><code class="language-C">inline void raise_softirq_irqoff(unsigned int nr)
{
	__raise_softirq_irqoff(nr);

	if (!in_interrupt())
		wakeup_softirqd();
}
</code></pre>

<ul>
<li><p>é¦–å…ˆï¼Œè°ƒç”¨<code>__raise_softirq_irqoff</code>å°†æœ¬åœ°å¤„ç†å™¨çš„ä¸­<code>__softirq_pending</code>å˜é‡å¯¹åº”nrè¿™ä¸ªè½¯ä¸­æ–­çš„ä½ç½®ä¸º1ï¼Œè¡¨ç¤ºè¯¥ç±»å‹çš„è½¯ä¸­æ–­è¢«è§¦å‘äº†ã€‚</p></li>

<li><p>ç„¶åï¼Œé€šè¿‡<code>in_interrupt</code>å‡½æ•°æ¥åˆ¤æ–­å¤„ç†å™¨å½“å‰æ˜¯å¦åœ¨å¤„ç†ä¸­æ–­çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨<code>wakeup_softirqd</code>å‡½æ•°å”¤é†’æœ¬å¤„ç†å™¨çš„<code>ksoftirqd</code>å†…æ ¸è¿›ç¨‹ï¼š</p>

<pre><code class="language-C">static void wakeup_softirqd(void)
{
	struct task_struct *tsk = __this_cpu_read(ksoftirqd);

	if (tsk &amp;&amp; tsk-&gt;state != TASK_RUNNING)
		wake_up_process(tsk);
}
</code></pre></li>
</ul>

<p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªCPUéƒ½ä¼šè¿è¡Œä¸€ä¸ª<code>ksoftirqd</code>å†…æ ¸è¿›ç¨‹ï¼Œä¸“é—¨ç”±è¿™ä¸ªè¿›ç¨‹æ¥å¤„ç†æœ¬CPUçš„è½¯ä¸­æ–­ã€‚<code>ksoftirqd</code>å†…æ ¸è¿›ç¨‹çš„ä¸»è¦æµç¨‹åœ¨å‡½æ•°<code>__do_softirq</code>ä¸­å®Œæˆï¼Œå…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œç”¨æ¥æ£€æµ‹å½“å‰æœ‰å“ªäº›æœªå¤„ç†çš„è½¯ä¸­æ–­ï¼Œè°ƒç”¨å…¶æ³¨å†Œçš„å¤„ç†å‡½æ•°æ¥å¤„ç†è½¯ä¸­æ–­ï¼š</p>

<pre><code class="language-C">asmlinkage __visible void __softirq_entry __do_softirq(void)
{
	// ...
	while ((softirq_bit = ffs(pending))) {
		trace_softirq_entry(vec_nr);	// è®°å½•å¼€å§‹å¤„ç†è½¯ä¸­æ–­çš„trace event
		h-&gt;action(h);									// è°ƒç”¨æ³¨å†Œçš„è½¯ä¸­æ–­å¤„ç†å‡½æ•°
		trace_softirq_exit(vec_nr);		// è®°å½•ç»“æŸå¤„ç†è½¯ä¸­æ–­çš„trace event
	}
}
</code></pre>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200522-sgfap-softirq/softirq.png" alt="softirq" title="softirq" />
</center></p>

<p>æ€»ç»“æ¥è¯´ï¼Œè¦è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­åªéœ€è¦ä»¥ä¸‹å‡ æ­¥ï¼š</p>

<ol>
<li>ä¿å­˜IFæ ‡å¿—ï¼Œç¦ç”¨ä¸­æ–­ã€‚</li>
<li>å°†è¿™ä¸ªè½¯ä¸­æ–­å¯¹åº”çš„ä½ç½®ä¸º1ã€‚</li>
<li>é€šçŸ¥æœ¬CPUçš„ksoftirqdå†…æ ¸è¿›ç¨‹ï¼Œæœ‰è½¯ä¸­æ–­éœ€è¦å¤„ç†ã€‚</li>
<li>æ¢å¤IFæ ‡å¿—ï¼Œå¼€å¯ä¸­æ–­ã€‚</li>
</ol>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº†è½¯ä¸­æ–­æœºåˆ¶ï¼Œå†…æ ¸åœ¨ç¦ç”¨ä¸­æ–­çš„çŠ¶æ€ä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰è€—è´¹å¤ªå¤šæ—¶é—´ï¼Œä»…ä»…ä¿®æ”¹äº†ä¸€ä¸ªæ ‡è®°ç„¶åå”¤é†’<code>ksoftirqd</code>å†…æ ¸è¿›ç¨‹å°±å¯ä»¥è¿”å›äº†ã€‚</p>

<h1 id="tasklet">tasklet</h1>

<p>è½¯ä¸­æ–­æœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p>

<ul>
<li>åªèƒ½åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ³¨å†Œï¼Œå¦å¤–æ•°é‡å’Œç±»å‹ä¸èƒ½åŠ¨æ€å˜æ›´ã€‚</li>
<li>å› ä¸ºæ¯ä¸ªå¤„ç†å™¨ä¸Šéƒ½æœ‰ä¸€ä¸ª<code>ksoftirqd</code>å†…æ ¸è¿›ç¨‹ï¼Œå¯èƒ½åŒæ—¶åœ¨å¤„ç†åŒä¸€ç§ç±»å‹çš„è½¯ä¸­æ–­ï¼Œè½¯ä¸­æ–­å¿…é¡»å®ç°ä¸ºå¯é‡å…¥å‡½æ•°ï¼Œå¯¼è‡´å¼€å‘ä¸Šçš„å¤æ‚åº¦æé«˜ã€‚å¦‚æœæŸç§åº”ç”¨å¹¶ä¸éœ€è¦åœ¨å¤šä¸ªCPUä¸Šå¹¶è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆè½¯ä¸­æ–­æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚</li>
</ul>

<p>å› æ­¤åŸºäºè½¯ä¸­æ–­ä¹‹ä¸Šåˆå®ç°taskletï¼Œè¿™æ˜¯æœ€å¸¸è§çš„å®ç°å»¶è¿Ÿä¸­æ–­å¤„ç†çš„æœºåˆ¶ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>

<ul>
<li>ä¸€ç§ç±»å‹çš„taskletåªèƒ½è¿è¡Œåœ¨ä¸€ä¸ªCPUä¸Šï¼Œä¸èƒ½å¹¶è¡Œè€Œåªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚</li>
<li>å¤šä¸ªä¸åŒç±»å‹çš„taskletå¯ä»¥å¹¶è¡Œåœ¨å¤šä¸ªCPUä¸Šã€‚</li>
<li>è½¯ä¸­æ–­æ˜¯é™æ€ï¼Œåªèƒ½æ”¯æŒæœ‰é™çš„å‡ ç§è½¯ä¸­æ–­ç±»å‹ï¼Œä¸€æ—¦å†…æ ¸ç¼–è¯‘å¥½ä¹‹åå°±ä¸èƒ½æ”¹å˜ï¼›è€Œtaskletçµæ´»å¾ˆå¤šï¼Œå¯ä»¥é€šè¿‡æ·»åŠ å†…æ ¸æ¨¡å—çš„æ–¹å¼åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€‚</li>
</ul>

<p>taskletæ˜¯åœ¨ä¸¤ç§è½¯ä¸­æ–­ç±»å‹çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œå› æ­¤å¦‚æœä¸éœ€è¦è½¯ä¸­æ–­çš„å¹¶è¡Œç‰¹æ€§ï¼Œtaskletå°±æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´taskletæ˜¯è½¯ä¸­æ–­çš„ä¸€ç§ç‰¹æ®Šç”¨æ³•ï¼Œå³å»¶è¿Ÿæƒ…å†µä¸‹çš„ä¸²è¡Œæ‰§è¡Œã€‚</p>

<p>é¦–å…ˆæ¥çœ‹åˆå§‹åŒ–ï¼Œå¯¹åº”çš„æ˜¯softirq_initå‡½æ•°ï¼š</p>

<pre><code class="language-C">void __init softirq_init(void)
{
	int cpu;

	for_each_possible_cpu(cpu) {
		per_cpu(tasklet_vec, cpu).tail =
			&amp;per_cpu(tasklet_vec, cpu).head;
		per_cpu(tasklet_hi_vec, cpu).tail =
			&amp;per_cpu(tasklet_hi_vec, cpu).head;
	}

	open_softirq(TASKLET_SOFTIRQ, tasklet_action);
	open_softirq(HI_SOFTIRQ, tasklet_hi_action);
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œtaskletå„æœ‰ä¸€ä¸ªåŸºäºTASKLET_SOFTIRQå’ŒHI_SOFTIRQä¸¤ä¸ªç±»å‹è½¯ä¸­æ–­çš„taskletï¼Œè¿™ä¸¤ä¸ªç±»å‹åˆ†åˆ«å¯¹åº”ä½ä¼˜å…ˆçº§å’Œé«˜ä¼˜å…ˆçº§çš„taskletï¼Œå˜é‡tasklet_vecå’Œtasklet_hi_vecçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">struct tasklet_head {
	struct tasklet_struct *head;
	struct tasklet_struct **tail;
};

static DEFINE_PER_CPU(struct tasklet_head, tasklet_vec);
static DEFINE_PER_CPU(struct tasklet_head, tasklet_hi_vec);
</code></pre>

<p>è¿™ä¸¤ä¸ªå˜é‡åˆ†åˆ«å®šä¹‰äº†ä¸¤ä¸ªå­˜å‚¨tasklet_structç»“æ„ä½“çš„é“¾è¡¨ã€‚ç»“æ„ä½“tasklet_structå®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code>struct tasklet_struct
{
	struct tasklet_struct *next;
	unsigned long state;
	atomic_t count;
	void (*func)(unsigned long);
	unsigned long data;
};
</code></pre>

<p>å…¶ä¸­åŒ…å«äº†äº”ä¸ªæˆå‘˜å˜é‡ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>

<ul>
<li>struct tasklet_struct *nextï¼šé“¾è¡¨ä¸­ä¸‹ä¸€ä¸ªæˆå‘˜çš„æŒ‡é’ˆã€‚</li>
<li>unsigned long stateï¼štaskletçš„çŠ¶æ€ã€‚</li>
<li>atomic_t countï¼šåŸå­å˜é‡ï¼Œè¡¨ç¤ºè¿™ä¸ªtaskletå½“å‰æ˜¯å¦æ´»è·ƒã€‚</li>
<li>void (*func)(unsigned long)ï¼šå¤„ç†è¿™ä¸ªtaskletçš„å›è°ƒå‡½æ•°ã€‚</li>
<li>unsigned long dataï¼šå›è°ƒå‡½æ•°å‚æ•°ã€‚</li>
</ul>

<h2 id="è§¦å‘tasklet">è§¦å‘tasklet</h2>

<p>å†…æ ¸é€šè¿‡å‡½æ•°tasklet_scheduleè§¦å‘ä¸€ä¸ªtaskletè¢«æ‰§è¡Œï¼š</p>

<pre><code class="language-C">static inline void tasklet_schedule(struct tasklet_struct *t)
{
	if (!test_and_set_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state))
		__tasklet_schedule(t);
}
</code></pre>

<p>é¦–å…ˆï¼Œä½¿ç”¨test_and_set_bitå‡½æ•°åˆ¤æ–­t-&gt;stateä¸­çš„TASKLET_STATE_SCHEDæ˜¯å¦è¢«ç½®ä¸º1ï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨å‡½æ•°__tasklet_scheduleè°ƒåº¦taskletæ¥æ‰§è¡Œï¼š</p>

<pre><code class="language-C">// kernel/softirq.c
void __tasklet_schedule(struct tasklet_struct *t)
{
	unsigned long flags;

	local_irq_save(flags);
	t-&gt;next = NULL;
	*__this_cpu_read(tasklet_vec.tail) = t;
	__this_cpu_write(tasklet_vec.tail, &amp;(t-&gt;next));
	raise_softirq_irqoff(TASKLET_SOFTIRQ);
	local_irq_restore(flags);
}
</code></pre>

<p>è¯¥å‡½æ•°é¦–å…ˆå’Œå‰é¢è½¯ä¸­æ–­çš„å¤„ç†ä¸€æ ·ï¼Œä¿å­˜IFæ ‡å¿—ä½åŒæ—¶ç¦ç”¨ä¸­æ–­ï¼Œç„¶åä¿®æ”¹tasklet_vecé“¾è¡¨å°†æ–°å¢çš„taskletæ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œè°ƒç”¨raise_softirq_irqoffè§¦å‘TASKLET_SOFTIRQç±»å‹çš„è½¯ä¸­æ–­æ‰§è¡Œï¼Œæœ€åæ¢å¤IFæ ‡å¿—ä½åŒæ—¶å¯ç”¨ä¸­æ–­ã€‚</p>

<p>åœ¨å‡½æ•°softirq_initä¸­ï¼Œä¸¤ç±»ç”¨äºå¤„ç†taskletçš„å¤„ç†å‡½æ•°åˆ†åˆ«æ˜¯ï¼š</p>

<pre><code>	open_softirq(TASKLET_SOFTIRQ, tasklet_action);
	open_softirq(HI_SOFTIRQ, tasklet_hi_action);
</code></pre>

<p>æ¥ç€çœ‹å‡½æ•°tasklet_actionçš„å®ç°ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ä»å‰é¢çš„é“¾è¡¨ä¸­ä¾æ¬¡å–å‡ºtasklet_structç»“æ„ä½“æ•°æ®è°ƒç”¨å…¶å¤„ç†å‡½æ•°ï¼š</p>

<pre><code class="language-C">// kernel/softirq.c
static __latent_entropy void tasklet_action(struct softirq_action *a)
{
	struct tasklet_struct *list;

	while (list) {
		struct tasklet_struct *t = list;
		t-&gt;func(t-&gt;data);
	}
}
</code></pre>

<p>è¯¥å‡½æ•°çš„å·¥ä½œæµç¨‹æ˜¯ï¼š</p>

<ol>
<li>è°ƒç”¨local_irq_disableç¦ç”¨æœ¬åœ°CPUçš„ä¸­æ–­ã€‚</li>
<li>ä»tasklet_vecé“¾è¡¨å¤´å–å‡ºå¤´å…ƒç´ listã€‚</li>
<li>è°ƒç”¨local_irq_enableå¯ç”¨æœ¬åœ°CPUçš„ä¸­æ–­ã€‚</li>
<li>æ¥ç€ï¼Œå°±æ˜¯éå†æ•´ä¸ªtasklet_vecé“¾è¡¨ï¼Œä¾æ¬¡å¤„ç†è¿™äº›taskletäº†ã€‚æ¯æ¬¡å–å‡ºä¸€ä¸ªtaskletçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯åƒå‰é¢ä¸€æ ·åº”ç”¨æœ¬åœ°CPUçš„ä¸­æ–­ï¼Œå–å‡ºä¹‹åå†å¼€å¯ä¸­æ–­ã€‚</li>
</ol>

<h1 id="workqueue">workqueue</h1>

<p>workqueueæ˜¯å¦å¤–ä¸€ç§å»¶è¿Ÿå¤„ç†ä¸­æ–­çš„æœºåˆ¶ã€‚ä¸taskletç›¸æ¯”ï¼Œä¸¤è€…æœ‰ä»¥ä¸‹çš„åŒºåˆ«ï¼š</p>

<ul>
<li>workqueueå‡½æ•°è¿è¡Œåœ¨å†…æ ¸è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼ˆcontext of kernel processï¼‰ï¼Œè€Œtaskletè¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ã€‚</li>
<li>taskletéƒ½åœ¨å®ƒæœ€åˆè¢«è§¦å‘çš„CPUä¸­æ‰§è¡Œï¼Œè€Œworkqueueåˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚</li>
<li>å¦‚æœå¤„ç†å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦ç¡çœ å’Œé˜»å¡ï¼Œé‚£å°±å¿…é¡»ä½¿ç”¨å·¥ä½œé˜Ÿåˆ—äº†ã€‚è½¯ä¸­æ–­è¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤ä¸èƒ½é˜»å¡å’Œç¡çœ ï¼Œè€Œtaskletä½¿ç”¨è½¯ä¸­æ–­å®ç°ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½é˜»å¡å’Œç¡çœ ã€‚</li>
</ul>

<h2 id="æ•°æ®ç»“æ„-1">æ•°æ®ç»“æ„</h2>

<p>å†…æ ¸ä½¿ç”¨ç»“æ„ä½“worker_poolæ¥ç®¡ç†æ‰€æœ‰CPUä¸Šé¢çš„workerï¼Œåœ¨è¿™é‡Œä»…åˆ—ä¸¾å…¶ä¸­çš„ä¸€éƒ¨åˆ†æˆå‘˜ï¼š</p>

<pre><code class="language-C">// kernel/workqueue.c
struct worker_pool {
	spinlock_t		lock;		/* the pool lock */
	int			cpu;		/* I: the associated cpu */
	int			node;		/* I: the associated node ID */
	int			id;		/* I: pool ID */
	unsigned int		flags;		/* X: flags */

	unsigned long		watchdog_ts;	/* L: watchdog timestamp */

	struct list_head	worklist;	/* L: list of pending works */
	int			nr_workers;	/* L: total number of workers */

	....
}
</code></pre>

<p>worker_poolä¸­ç®¡ç†çš„æ¯ä¸ªworkerå¦‚ä¸‹å®šä¹‰ï¼š</p>

<pre><code class="language-C">// kernel/workqueue_internal.h
struct worker {
	/* on idle list while idle, on busy hash table while busy */
	union {
		struct list_head	entry;	/* L: while idle */
		struct hlist_node	hentry;	/* L: while busy */
	};

	struct work_struct	*current_work;	/* L: work being processed */
	work_func_t		current_func;	/* L: current_work's fn */
	struct pool_workqueue	*current_pwq; /* L: current_work's pwq */
	bool			desc_valid;	/* -&gt;desc is valid */
	struct list_head	scheduled;	/* L: scheduled works */

	....
}
</code></pre>

<p>æ¯ä¸ªCPUä¸Šè¿è¡Œçš„kworkerè¿›ç¨‹ï¼š</p>

<pre><code>$ ps aux | grep kworker
root         4  0.0  0.0      0     0 ?        I&lt;   1æœˆ30   0:00 [kworker/0:0H]
root        18  0.0  0.0      0     0 ?        I&lt;   1æœˆ30   0:00 [kworker/1:0H]
root        24  0.0  0.0      0     0 ?        I&lt;   1æœˆ30   0:00 [kworker/2:0H]
</code></pre>

<h2 id="æ·»åŠ ä»»åŠ¡åˆ°workqueue">æ·»åŠ ä»»åŠ¡åˆ°workqueue</h2>

<p>å†…æ ¸æä¾›å‡½æ•°queue_workå°†ä»»åŠ¡æ”¾å…¥workqueueä¸­ï¼š</p>

<pre><code>// include/linux/workqueue.h
static inline bool queue_work(struct workqueue_struct *wq,
			      struct work_struct *work)
{
	return queue_work_on(WORK_CPU_UNBOUND, wq, work);
}
</code></pre>

<p>æ¥ç€çœ‹å‡½æ•°queue_work_onï¼š</p>

<pre><code class="language-C">// kernel/workqueue.c
bool queue_work_on(int cpu, struct workqueue_struct *wq,
		   struct work_struct *work)
{
	bool ret = false;
	unsigned long flags;

	local_irq_save(flags);

	if (!test_and_set_bit(WORK_STRUCT_PENDING_BIT, work_data_bits(work))) {
		__queue_work(cpu, wq, work);
		ret = true;
	}

	local_irq_restore(flags);
	return ret;
}
</code></pre>

<p>å®ƒåšçš„äº‹æƒ…å¾ˆç®€å•ï¼ŒåŒæ ·ä¹Ÿæ˜¯å‰åç¦ç”¨ã€å¯ç”¨ä¸­æ–­ï¼Œåœ¨åˆ¤æ–­WORK_STRUCT_PENDING_BITè¢«ç½®ä¸º1å¤±è´¥ä¹‹åï¼Œè°ƒç”¨__queue_workå°†ä»»åŠ¡æ”¾å…¥workqueueï¼š</p>

<pre><code class="language-C">static void __queue_work(int cpu, struct workqueue_struct *wq,
			 struct work_struct *work)
{
	// ....

	if (req_cpu == WORK_CPU_UNBOUND)
		cpu = wq_select_unbound_cpu(raw_smp_processor_id());

	if (!(wq-&gt;flags &amp; WQ_UNBOUND))
		pwq = per_cpu_ptr(wq-&gt;cpu_pwqs, cpu);
	else
		pwq = unbound_pwq_by_node(wq, cpu_to_node(cpu));

	// ...

	insert_work(pwq, work, worklist, work_flags);

	// ...
}
</code></pre>

<p>è¿™é‡Œè£å‰ªæ‰æ— å…³çš„ä»£ç ï¼Œæ¥çœ‹æ ¸å¿ƒçš„éƒ¨åˆ†ï¼š</p>

<ul>
<li>é¦–å…ˆï¼Œå¦‚æœworkåŠ å…¥æ—¶æœªæŒ‡å®šè¦è¿è¡Œçš„CPUï¼Œé€šè¿‡wq_select_unbound_cpuè¿›è¡Œé€‰æ‹©ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰CPUã€‚å¦‚æœè¯¥CPUä¸åœ¨wq_unbound_cpumask (å…¨å±€ cpumask)å†…ï¼Œåˆ™ä»wq_unbound_cpumaskä¸­é€šè¿‡round robinæ–¹å¼é€‰æ‹©ã€‚</li>
<li>å¯¹äº bound workqueue ï¼Œå–å‡ºå½“å‰ per CPUå˜é‡ä¸­çš„pool_workqueue ã€‚å¯¹äºunbound workqueueï¼Œå–å‡ºå½“å‰CPU æ‰€åœ¨nodeå¯¹åº”çš„pool_workqueueã€‚</li>
</ul>

<p>åœ¨kworkå†…æ ¸è¿›ç¨‹å†…éƒ¨ï¼Œæœ€ç»ˆä¼šåœ¨å‡½æ•°<code>process_one_work</code>ä¸­å¤„ç†workï¼š</p>

<pre><code class="language-C">// kernel/workqueue.c
static void process_one_work(struct worker *worker, struct work_struct *work)
{
	// ...
	trace_workqueue_execute_start(work);	// è®°å½•å¼€å§‹å¤„ç†workçš„trace event
	worker-&gt;current_func(work);						// è°ƒç”¨workçš„å¤„ç†å‡½æ•°
	trace_workqueue_execute_end(work);		// è®°å½•ç»“æŸå¤„ç†workçš„trace event
}
</code></pre>

<h1 id="ä½¿ç”¨systemtapè¿½è¸ªè½¯ä¸­æ–­">ä½¿ç”¨systemtapè¿½è¸ªè½¯ä¸­æ–­</h1>

<p><code>systemtap</code>ä¸Šæä¾›äº†å¯ä»¥è·Ÿè¸ªè½¯ä¸­æ–­ä»¥åŠå·¥ä½œé˜Ÿåˆ—çš„<code>probe</code>äº‹ä»¶ï¼Œå¯ä»¥åœ¨<code>systemtap</code>çš„<code>tapset\linux\irq.stp</code>ä¸­çœ‹åˆ°ç›¸å…³çš„å®šä¹‰ï¼Œæ¯”è¾ƒç®€å•è¿™é‡Œå°±ä¸åšè§£é‡Šï¼Œè¿™é‡Œä»…åˆ—ä¸¾ç½‘ä¸Šçœ‹åˆ°çš„ä¸€ä¸ªä½¿ç”¨è¿™äº›tapsetæ¥è¿½è¸ªè½¯ä¸­æ–­äº‹ä»¶çš„ä¾‹å­ï¼š</p>

<pre><code>global hard, soft, wq
 
// è®°å½•ç¡¬ä¸­æ–­
probe irq_handler.entry {
  hard[irq, dev_name]++;
}
 
// æ¯éš”ä¸€ç§’æ‰“å°ä¸­æ–­ã€è½¯ä¸­æ–­ã€å·¥ä½œé˜Ÿåˆ—çš„ç»Ÿè®¡ä¿¡æ¯
probe timer.s(1) {
  println(&quot;==irq number:dev_name&quot;)
  foreach( [irq, dev_name] in hard- limit 5) {
    printf(&quot;%d,%s-&gt;%d\n&quot;, irq, kernel_string(dev_name), hard[irq, dev_name]);       
  }
 
  println(&quot;==softirq cpu:h:vec:action&quot;)
  foreach(  in soft- limit 5) {
    printf(&quot;%d:%x:%x:%s-&gt;%d\n&quot;, c, h, vec, symdata(action), soft);       
  }
 
  println(&quot;==workqueue wq_thread:work_func&quot;)
  foreach( [wq_thread,work_func] in wq- limit 5) {
    printf(&quot;%x:%x-&gt;%d\n&quot;, wq_thread, work_func, wq[wq_thread, work_func]);  
  }
 
  println(&quot;\n&quot;)
  delete hard
  delete soft
  delete wq
}
 
// ç»Ÿè®¡è½¯ä¸­æ–­
probe softirq.entry {
  soft[cpu(), h,vec,action]++;
}
 
// ç»Ÿè®¡å·¥ä½œé˜Ÿåˆ—æ‰§è¡Œä¿¡æ¯
probe workqueue.execute {
  wq[wq_thread, work_func]++
}
 
 
probe begin {
  println(&quot;~&quot;)
}

</code></pre>

<h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1>

<ul>
<li><a href="https://tech.meituan.com/2018/03/16/redis-high-concurrency-optimization.html">Redis é«˜è´Ÿè½½ä¸‹çš„ä¸­æ–­ä¼˜åŒ–</a></li>
<li><a href="http://blog.yufeng.info/archives/2037">MYSQLæ•°æ®åº“ç½‘å¡è½¯ä¸­æ–­ä¸å¹³è¡¡é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="https://www.cnblogs.com/alantu2018/p/8527205.html">Linuxå†…æ ¸ä¸­çš„è½¯ä¸­æ–­ã€taskletå’Œå·¥ä½œé˜Ÿåˆ—è¯¦è§£</a></li>
</ul>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20200516-sgfap-syscall/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20200605-how-to-read-code-v2020/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
