<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="codedump">

  
  
  <meta name="description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨å†…æ ¸æä¾›å‡ºæ¥çš„ä¸€äº›åŠŸèƒ½ï¼Œ">
  

  
  <link rel="icon" href="https://www.codedump.info/favicon.ico">

  
  
  <meta name="keywords" content=" linux  systemtap ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ç³»ç»Ÿè°ƒç”¨" />
<meta property="og:description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨å†…æ ¸æä¾›å‡ºæ¥çš„ä¸€äº›åŠŸèƒ½ï¼Œ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.codedump.info/post/20200516-sgfap-syscall/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-16T16:31:03+08:00" />
<meta property="article:modified_time" content="2020-05-16T16:31:03+08:00" />



  
  <link rel="canonical" href="https://www.codedump.info/post/20200516-sgfap-syscall/">

  
  
  <meta itemprop="name" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ç³»ç»Ÿè°ƒç”¨">
<meta itemprop="description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨å†…æ ¸æä¾›å‡ºæ¥çš„ä¸€äº›åŠŸèƒ½ï¼Œ"><meta itemprop="datePublished" content="2020-05-16T16:31:03+08:00" />
<meta itemprop="dateModified" content="2020-05-16T16:31:03+08:00" />
<meta itemprop="wordCount" content="4037">
<meta itemprop="keywords" content="Linuxç³»ç»Ÿ," />

  
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>

  
  
  <title>ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ç³»ç»Ÿè°ƒç”¨ - codedumpçš„ç½‘ç»œæ—¥å¿—</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ç³»ç»Ÿè°ƒç”¨"/>
<meta name="twitter:description" content="æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®ºã€‚ æ¦‚è¿° åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨å†…æ ¸æä¾›å‡ºæ¥çš„ä¸€äº›åŠŸèƒ½ï¼Œ"/>


  
<link rel="stylesheet" href='https://www.codedump.info/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/weekly">å‘¨åˆŠ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ç³»ç»Ÿè°ƒç”¨</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://www.codedump.info/tags/linux%E7%B3%BB%E7%BB%9F'>#Linuxç³»ç»Ÿ</a>
    
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#ä¼ ç»Ÿç³»ç»Ÿè°ƒç”¨legacy-system-calls">ä¼ ç»Ÿç³»ç»Ÿè°ƒç”¨ï¼ˆLegacy system callsï¼‰</a></li>
    <li><a href="#å¿«é€Ÿç³»ç»Ÿè°ƒç”¨">å¿«é€Ÿç³»ç»Ÿè°ƒç”¨</a></li>
    <li><a href="#ç°å®ä¸­çš„ç³»ç»Ÿè°ƒç”¨">ç°å®ä¸­çš„ç³»ç»Ÿè°ƒç”¨</a></li>
  </ul>

  <ul>
    <li><a href="#æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨">æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨</a></li>
    <li><a href="#æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿">æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿</a></li>
    <li><a href="#æŸ¥è¯¢å ç”¨æ—¶é—´æœ€é•¿çš„ç³»ç»Ÿè°ƒç”¨">æŸ¥è¯¢å ç”¨æ—¶é—´æœ€é•¿çš„ç³»ç»Ÿè°ƒç”¨</a></li>
    <li><a href="#æ‰“å°ç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·è°ƒç”¨æ ˆ">æ‰“å°ç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·è°ƒç”¨æ ˆ</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content">
    
    <blockquote>
<p>æœ¬æ–‡æ˜¯ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹æ–‡æ¡£å…¶ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç›®å½•è§<a href="https://www.codedump.info/post/20200501-system-guide-for-application-programmer/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹å¯¼è®º</a>ã€‚</p>
</blockquote>
<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>
<p>åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨å†…æ ¸æä¾›å‡ºæ¥çš„ä¸€äº›åŠŸèƒ½ï¼Œæ‰èƒ½å®Œæˆç›¸åº”çš„æ“ä½œï¼Œè¿™ä¸ªç”±å†…æ ¸æä¾›å‡ºæ¥ç»™ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨çš„æ¥å£ï¼Œå°±æ˜¯â€œç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰â€ã€‚æ¯”å¦‚æ‰“å¼€æ–‡ä»¶æ—¶éœ€è¦è°ƒç”¨<code>open</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå†™æ–‡ä»¶æ—¶éœ€è¦è°ƒç”¨<code>write</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç­‰ç­‰ã€‚</p>
<p>æœ¬èŠ‚å°†ç®€å•æè¿°Linuxåœ¨X86ä¸‹ç³»ç»Ÿè°ƒç”¨çš„å·¥ä½œåŸç†ï¼Œæ¥ç€æè¿°å¦‚ä½•è¿½è¸ªç”¨æˆ·å±‚è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h1 id="ç³»ç»Ÿè°ƒç”¨åŸç†">ç³»ç»Ÿè°ƒç”¨åŸç†</h1>
<h2 id="ä¼ ç»Ÿç³»ç»Ÿè°ƒç”¨legacy-system-calls">ä¼ ç»Ÿç³»ç»Ÿè°ƒç”¨ï¼ˆLegacy system callsï¼‰</h2>
<p>åœ¨è¿™é‡Œå…ˆè®¨è®ºç³»ç»Ÿè°ƒç”¨çš„ä¼ ç»Ÿå®ç°æ–¹å¼ï¼Œåœ¨è¿™é‡Œéœ€è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ç”¨æˆ·æ€æ€ä¹ˆè§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</li>
<li>ç”¨æˆ·æ€æ€ä¹ˆä¼ é€’å‚æ•°ç»™ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</li>
</ul>
<p>å†…æ ¸é¢„ç•™äº†ä¸€ä¸ªç‰¹æ®Šçš„è½¯ä¸­æ–­å· 128 (0x80)ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºä½¿ç”¨å®ƒå¯ä»¥è¿›å…¥å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨å†…æ ¸ä¸­å®šä¹‰äº†å®<code>IA32_SYSCALL_VECTOR</code>ä¸ä¹‹å¯¹åº”ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// arch/x86/include/asm/irq_vectors.h
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#080">#define IA32_SYSCALL_VECTOR		0x80
</span></span></span></code></pre></div><p>è§¦å‘ç»™è½¯ä¸­æ–­æ—¶ä¼šè°ƒç”¨åˆ°æ±‡ç¼–ç¼–å†™çš„å‡½æ•°<code>	entry_INT80_32</code>ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// arch/x86/kernel/idt.h
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>SYSG(IA32_SYSCALL_VECTOR,	entry_INT80_32),
</span></span></code></pre></div><p><code>entry_INT80_32</code>å‡½æ•°åœ¨<code>arch/x86/entry/entry_32.S</code>ä¸­å®ç°ï¼Œå…¶æœ€ç»ˆä¼šèµ°åˆ°<code>do_int80_syscall_32</code>å‡½æ•°ä¸­è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä»¥ä¸Šè§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå³ç”¨æˆ·æ€é€šè¿‡è§¦å‘è½¯ä¸­æ–­<code>int 0x80</code>æ¥è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„ï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œå†…æ ¸å¦‚ä½•çŸ¥é“è°ƒç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä»¥åŠæ€ä¹ˆè§£å†³ç»™ç³»ç»Ÿè°ƒç”¨ä¼ é€’å‚æ•°çš„é—®é¢˜ã€‚</p>
<p>åœ¨å‡½æ•°<code>entry_INT80_32</code>çš„æ³¨é‡Šä¸­ï¼Œçœ‹åˆ°æœ‰å¦‚ä¸‹çš„æè¿°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// arch/x86/entry/entry_32.S
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#080;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * Arguments:
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * eax  system call number
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * ebx  arg1
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * ecx  arg2
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * edx  arg3
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * esi  arg4
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * edi  arg5
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * ebp  arg6
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> */</span>
</span></span></code></pre></div><p>å¯è§ï¼Œå¯„å­˜å™¨<code>eax</code>ä¸­å­˜æ”¾çš„æ˜¯ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼Œæ¥ä¸‹æ¥çš„å‡ ä¸ªå¯„å­˜å™¨åˆ†åˆ«å­˜æ”¾ä¼ é€’è¿›æ¥çš„å‚æ•°ã€‚</p>
<p>äºæ˜¯ä¸Šé¢çš„ä¸¤ä¸ªç–‘é—®ä¹Ÿè§£å†³äº†ã€‚</p>
<p>å†…æ ¸ä¸­ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ï¼Œæ¥å…·ä½“ä¿å­˜å…·ä½“ç³»ç»Ÿè°ƒç”¨ç¼–å·ä¸å…¶å®ç°å‡½æ•°çš„å¯¹åº”å…³ç³»ï¼Œè¯¥æ•°ç»„åç§°ä¸º<code>ia32_sys_call_table</code>ï¼Œå› æ­¤åœ¨æœ€åä¸€æ­¥è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä»£ç æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// arch/x86/entry/common.c
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">static</span> __always_inline <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">do_syscall_32_irqs_on</span>(<span style="color:#a2f;font-weight:bold">struct</span> pt_regs <span style="color:#666">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>		regs<span style="color:#666">-&gt;</span>ax <span style="color:#666">=</span> ia32_sys_call_table[nr](
</span></span><span style="display:flex;"><span>			(<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span>)regs<span style="color:#666">-&gt;</span>bx, (<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span>)regs<span style="color:#666">-&gt;</span>cx,
</span></span><span style="display:flex;"><span>			(<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span>)regs<span style="color:#666">-&gt;</span>dx, (<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span>)regs<span style="color:#666">-&gt;</span>si,
</span></span><span style="display:flex;"><span>			(<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span>)regs<span style="color:#666">-&gt;</span>di, (<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span>)regs<span style="color:#666">-&gt;</span>bp);
</span></span><span style="display:flex;"><span>	}  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è€Œæ•°ç»„<code>ia32_sys_call_table</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// arch/x86/syscall_32.c
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>__visible <span style="color:#a2f;font-weight:bold">const</span> sys_call_ptr_t ia32_sys_call_table[__NR_syscall_compat_max<span style="color:#666">+</span><span style="color:#666">1</span>] <span style="color:#666">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">	 * Smells like a compiler bug -- it doesn&#39;t work
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">	 * when the &amp; below is removed.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	[<span style="color:#666">0</span> ... __NR_syscall_compat_max] <span style="color:#666">=</span> <span style="color:#666">&amp;</span>sys_ni_syscall,
</span></span><span style="display:flex;"><span><span style="color:#080">#include</span> <span style="color:#080">&lt;asm/syscalls_32.h&gt;</span><span style="color:#080">
</span></span></span><span style="display:flex;"><span><span style="color:#080"></span>};
</span></span></code></pre></div><p>å¯è§ï¼Œä¼šä»¥<code>sys_ni_syscall</code>çš„å€¼æ¥åˆå§‹åŒ–æ•°ç»„<code>ia32_sys_call_table</code>ï¼Œ<code>sys_ni_syscall</code>æ˜¯ç”±æ±‡ç¼–å®šä¹‰çš„ä¸€ä¸ªå¤§æ•°ç»„ï¼Œå†…éƒ¨å°±æ˜¯å„ç§ç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œåœ¨æ­¤ä¸å†åˆ—å‡ºã€‚</p>
<p>æŠŠä»¥ä¸Šæµç¨‹å¤§ä½“æ€»ç»“å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-syscall/legacy-syscalls.png" alt="legacy-syscalls" title="legacy-syscalls"></p>
<p>å³ï¼š</p>
<ul>
<li>é€šè¿‡0x80ï¼ˆ128ï¼‰å·è½¯ä¸­æ–­è§¦å‘ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li>è§¦å‘ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œ<code>eax</code>å¯„å­˜å™¨å­˜å‚¨äº†ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼Œè€Œå…¶ä½™çš„å‡ ä¸ªå¯„å­˜å™¨å­˜å‚¨äº†ä¼ å…¥ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ã€‚</li>
<li>å†…æ ¸ä½¿ç”¨ä¸€ä¸ªå¤§çš„ç³»ç»Ÿè°ƒç”¨æ•°ç»„æ¥å­˜å‚¨ç³»ç»Ÿè°ƒç”¨ç¼–å·ä¸å…¶å¤„ç†å‡½æ•°çš„å¯¹åº”å…³ç³»ã€‚</li>
</ul>
<p>å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥æ¼”ç¤ºä¸€ä¸‹ä¸Šé¢è¿™ä¸ªè°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#0b0;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#00a000">main</span>(<span style="color:#0b0;font-weight:bold">int</span> argc, <span style="color:#0b0;font-weight:bold">char</span> <span style="color:#666">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">int</span> syscall_nr <span style="color:#666">=</span> <span style="color:#666">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#0b0;font-weight:bold">int</span> exit_status <span style="color:#666">=</span> <span style="color:#666">42</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">asm</span> (<span style="color:#b44">&#34;movl %0, %%eax</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>           <span style="color:#080;font-style:italic">// ç¼–å·ä¸º0çš„ç³»ç»Ÿè°ƒç”¨æ˜¯exit
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>             <span style="color:#b44">&#34;movl %1, %%ebx</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>     <span style="color:#080;font-style:italic">// ä¼ å…¥ebxå¯„å­˜å™¨çš„å‚æ•°è¾“å…¥çš„å‚æ•°1
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>       <span style="color:#b44">&#34;int $0x80&#34;</span>                  <span style="color:#080;font-style:italic">// è§¦å‘è½¯ä¸­æ–­0x80
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>      <span style="color:#b44">&#34;m&#34;</span> (syscall_nr), <span style="color:#b44">&#34;m&#34;</span> (exit_status) <span style="color:#080;font-style:italic">// è¾“å‡ºå‚æ•°ï¼Œå…¶ä¸­$0å³syscall_nrè¡¨ç¤ºè¾“å…¥å‚æ•°çš„æ•°é‡ï¼Œ$1è¡¨ç¤ºä¼ å…¥ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#666">:</span> <span style="color:#080;font-style:italic">/* registers that we are &#34;clobbering&#34;, unneeded since we are calling exit */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;eax&#34;</span>, <span style="color:#b44">&#34;ebx&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼Œç¼–å·ä¸º0çš„ç³»ç»Ÿè°ƒç”¨æ˜¯<code>exit</code>ï¼Œä¼ å…¥ç»™å®ƒçš„å‚æ•°æ˜¯<code>42</code>ï¼Œå› æ­¤æ‰§è¡Œä¹‹åçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>$ gcc -o test test.c
$ ./test
$ echo $?
42
</code></pre><h2 id="å¿«é€Ÿç³»ç»Ÿè°ƒç”¨">å¿«é€Ÿç³»ç»Ÿè°ƒç”¨</h2>
<p>ä»¥ä¸Šæ˜¯ä¼ ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨å®ç°ï¼Œç”±äºæºå¤´ä½¿ç”¨çš„æ˜¯è½¯ä¸­æ–­ï¼Œæ‰€ä»¥å…¶æ•ˆç‡å¹¶ä¸é«˜ã€‚ä¸ºäº†åŠ é€Ÿç³»ç»Ÿè°ƒç”¨çš„é€Ÿåº¦ï¼ŒIntel CPUåˆæä¾›äº†ä¸“é—¨ç»™ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œç§°ä¸ºâ€œå¿«é€Ÿç³»ç»Ÿè°ƒç”¨ï¼ˆFast System Callï¼‰æŒ‡ä»¤â€ï¼Œåˆ†åˆ«éƒ½åŒ…å«äº†è¿›å…¥å†…æ ¸å’Œç¦»å¼€å†…æ ¸çš„æŒ‡ä»¤ï¼š</p>
<ul>
<li>åœ¨ 32bit ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨ sysenter å’Œ sysexit</li>
<li>åœ¨ 64bit ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨ syscall å’Œ sysret</li>
</ul>
<p>åœ¨è¿™é‡Œï¼Œå¹¶ä¸æ‰“ç®—è®¨è®ºè¿™äº›æŒ‡ä»¤çš„åŸç†ï¼Œå”¯ä¸€éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå‰é¢é€šè¿‡è½¯ä¸­æ–­è§¦å‘ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä½¿ç”¨çš„å¯„å­˜å™¨åœ¨è¿™ç§æƒ…å†µå¹¶ä¸é€‚ç”¨ï¼Œä»¥64ä½ç³»ç»Ÿæ¥è¯´ï¼Œå…¶åˆ†åˆ«ä½¿ç”¨ä»¥ä¸‹å¯„å­˜å™¨ï¼š</p>
<ul>
<li>%raxï¼šå­˜å‚¨ç³»ç»Ÿè°ƒç”¨ç¼–å·ã€‚</li>
<li>%rdiã€%rsiã€%rdxã€%r10ã€%r8ã€%r9ï¼šä¾æ¬¡å­˜å‚¨ä¼ å…¥ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œå‰é¢çš„æ¼”ç¤ºä»£ç å¦‚æœæ¢ç”¨äº†å¿«é€Ÿç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤å¯ä»¥ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#0b0;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#00a000">main</span>(<span style="color:#0b0;font-weight:bold">int</span> argc, <span style="color:#0b0;font-weight:bold">char</span> <span style="color:#666">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">long</span> syscall_nr <span style="color:#666">=</span> <span style="color:#666">60</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#0b0;font-weight:bold">long</span> exit_status <span style="color:#666">=</span> <span style="color:#666">42</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a2f;font-weight:bold">asm</span> (<span style="color:#b44">&#34;movq %0, %%rax</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#b44">&#34;movq %1, %%rdi</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#b44">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">:</span> <span style="color:#080;font-style:italic">/* output parameters, we aren&#39;t outputting anything, no none */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-style:italic">/* (none) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">:</span> <span style="color:#080;font-style:italic">/* input parameters mapped to %0 and %1, repsectively */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;m&#34;</span> (syscall_nr), <span style="color:#b44">&#34;m&#34;</span> (exit_status)
</span></span><span style="display:flex;"><span>    <span style="color:#666">:</span> <span style="color:#080;font-style:italic">/* registers that we are &#34;clobbering&#34;, unneeded since we are calling exit */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;rax&#34;</span>, <span style="color:#b44">&#34;rdi&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¾“å‡ºç»“æœåŒä¸Šé¢ä¸€æ ·ã€‚</p>
<h2 id="ç°å®ä¸­çš„ç³»ç»Ÿè°ƒç”¨">ç°å®ä¸­çš„ç³»ç»Ÿè°ƒç”¨</h2>
<p>ä»¥ä¸Šç®€è¿°äº†ç³»ç»Ÿè°ƒç”¨çš„å®ç°åŸç†ï¼Œç„¶åç°å®ä»£ç ä¸­ï¼Œç»å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæ˜¯é€šè¿‡<code>glibc</code>è¿™æ ·çš„Cåº“æ¥å°è£…ç³»ç»Ÿè°ƒç”¨çš„ã€‚</p>
<p>Cè¯­è¨€æ ‡å‡†ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—æ ‡å‡†å‡½æ•°ï¼Œåªè¦æ”¯æŒCè¯­è¨€æ ‡å‡†çš„ç¼–è¯‘å™¨éƒ½åº”è¯¥å®ç°è¿™äº›å‡½æ•°ï¼Œè€Œ<code>glibc</code>è¿™æ ·çš„åº“è´Ÿè´£å°è£…Cæ ‡å‡†åº“å‡½æ•°ï¼Œè½¬æ¢ä¸ºå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä»¥Cåº“ä¸­çš„æ ‡å‡†å‡½æ•°<code>fwrite</code>ä¸ºä¾‹æ¥è¯´æ˜ï¼Œå…¶æµç¨‹å›¾å¤§ä½“å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200503-sgfap-syscall/glibc-syscall.png" alt="glibc-syscall" title="glibc-syscall"></p>
<p>å¼•å…¥<code>glibc</code>è¿™æ ·çš„ä¸­é—´å±‚æœ‰ä»¥ä¸‹å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>Cæ ‡å‡†åº“æ˜¯ä¸€å¥—ç‹¬ç«‹äºå…·ä½“å¹³å°çš„æ ‡å‡†ï¼Œä¸åŒçš„ç³»ç»Ÿè™½ç„¶å†…éƒ¨å®ç°ä¸åŒï¼Œä½†æ˜¯åªè¦å£°ç§°æ˜¯æ”¯æŒCæ ‡å‡†çš„ç¼–è¯‘å™¨å…¶éƒ½åº”è¯¥å®ç°è¿™äº›æ ‡å‡†çš„åº“å‡½æ•°ï¼Œ<code>glibc</code>çš„å­˜åœ¨å±è”½äº†å„ä¸ªå¹³å°å…·ä½“å†…éƒ¨çš„å®ç°ï¼Œä½¿ç”¨è€…åªéœ€è¦è°ƒç”¨è¿™äº›æ ‡å‡†Cå‡½æ•°å³å¯ï¼Œä¸éœ€è¦å…³å¿ƒå„ä¸ªç³»ç»Ÿçš„å®ç°ã€‚</li>
<li><code>glibc</code>èƒ½å¤Ÿä¼˜åŒ–ç”¨æˆ·è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å’Œé¢‘ç‡ï¼Œä»¥ä¸Šé¢çš„<code>fwrite</code>æ¥è¯´ï¼Œå¹¶ä¸æ˜¯æ¯ä¸€æ¬¡<code>fwrite</code>éƒ½é©¬ä¸Šä¼šè½¬æ¢æˆä¸€æ¬¡<code>write</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>glibc</code>åº“ä¼šå°†è¿™äº›å†™æ“ä½œè¿›è¡Œç¼“å­˜å†ä¸€æ¬¡æ€§è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å†™å…¥ä»¥è¾¾åˆ°å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„ç›®çš„ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œä»¥ä¸Šçš„ä¸¤ä¸ªæ¼”ç¤ºç¨‹åºä¸­ï¼Œéƒ½æ˜¯ä½¿ç”¨çš„åœ¨Cä»£ç ä¸­åµŒå…¥æ±‡ç¼–çš„æ–¹å¼æ¥è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œå®é™…ä¸ŠLinuxå·²ç»æä¾›äº†è°ƒç”¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œå¯ä»¥<code>man 2 syscall</code>çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ï¼Œè¿™é‡Œä¸å†é˜è¿°ã€‚</p>
<h1 id="è¿½è¸ªç³»ç»Ÿè°ƒç”¨">è¿½è¸ªç³»ç»Ÿè°ƒç”¨</h1>
<p>ç”±äºç³»ç»Ÿè°ƒç”¨ä¼šè¿›å…¥å†…æ ¸æ€ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°ç”¨æˆ·æ€æ•°æ®å‚æ•°çš„ä¼ å…¥ã€ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ç­‰æ“ä½œï¼Œæ‰€ä»¥ç³»ç»Ÿè°ƒç”¨æ˜¯å¸¸è§çš„ç³»ç»Ÿæ€æ‰‹ä¹‹ä¸€ã€‚å¸¸è§çš„è·Ÿè¸ªä¸€ä¸ªè¿›ç¨‹éƒ½è°ƒç”¨äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨<code>strace</code>å‘½ä»¤æ¥å®Œæˆï¼Œæ¯”å¦‚ï¼š</p>
<pre tabindex="0"><code>$ strace cat /dev/null
execve(&#34;/bin/cat&#34;, [&#34;cat&#34;, &#34;/dev/null&#34;], [/* 37 vars */]) = 0
brk(NULL)                               = 0x1c55000
access(&#34;/etc/ld.so.nohwcap&#34;, F_OK)      = -1 ENOENT (No such file or directory)
access(&#34;/etc/ld.so.preload&#34;, R_OK)      = -1 ENOENT (No such file or directory)
</code></pre><p>ç„¶è€Œï¼Œ<code>strace</code>åªæœ‰ç³»ç»Ÿè°ƒç”¨çš„åç§°ï¼Œæ²¡æœ‰è€—æ—¶ã€ç»Ÿè®¡ç­‰åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œæ¥ä¸‹æ¥ä¼šæ¼”ç¤ºä¸€äº›ä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„<code>systemtap</code>è„šæœ¬çš„ä½¿ç”¨ã€‚</p>
<h2 id="æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨">æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨</h2>
<p>ç³»ç»Ÿè°ƒç”¨éƒ½ä»¥<code>syscall</code>ä¸ºå‰ç¼€ï¼Œå› æ­¤å¯ä»¥è¿™æ ·æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦è¿‡æ»¤åˆ™æ­é…<code>grep</code>å‘½ä»¤å³å¯ï¼Œæ¯”å¦‚æƒ³æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨<code>open</code>ï¼š</p>
<pre tabindex="0"><code>$ sudo stap -L &#39;syscall.*&#39; | grep open
syscall.mq_open name:string name_uaddr:long filename:string u_attr_uaddr:long oflag:long oflag_str:string mode:long argstr:string $u_name:long int $oflag:long int $mode:long int $u_attr:long int
syscall.open filename:string mode:long __nr:long name:string flags:long flags_str:string argstr:string $filename:long int $flags:long int $mode:long int
syscall.open_by_handle_at name:string mount_dfd:long mount_dfd_str:string handle_uaddr:long flags:long flags_str:string argstr:string $mountdirfd:long int $handle:long int $flags:long int
syscall.openat name:string dfd:long dfd_str:string filename:string flags:long flags_str:string mode:long argstr:string $dfd:long int $filename:long int $flags:long int $mode:long int
syscall.perf_event_open name:string attr_uaddr:long pid:long cpu:long group_fd:long flags:long flags_str:string argstr:string $attr_uptr:long int $pid:long int $cpu:long int $group_fd:long int $flags:long int $ret:long int
</code></pre><p>å½“ç„¶ï¼Œå¦‚æœåªæ˜¯æŸ¥è¯¢ç³»ç»Ÿä¸Šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®é™…ä¸Šå¹¶ä¸éœ€è¦ç¥­å‡º<code>systemtap</code>è¿™æŠŠç‰›åˆ€ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„æ¼”ç¤ºã€‚</p>
<h2 id="æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿">æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿</h2>
<p><code>Systemtap</code>è„šæœ¬ä¸­ï¼Œåœ¨<code>.return</code>åç¼€é‡Œï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨<code>@entry</code>æ“ä½œç¬¦ï¼Œåœ¨å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™å­˜å‚¨ä¸€ä¸ªå€¼ï¼Œæ¯”å¦‚å­˜å‚¨è¿›å…¥è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶çš„æ—¶é—´ï¼Œç„¶ååœ¨è¿™é‡Œå†è¿›è¡Œè®¡ç®—ã€‚å› æ­¤å¯ä»¥è¿™æ ·æ‰“å°å‡ºè¿›ç¨‹è°ƒç”¨äº†æŸä¸ªç³»ç»Ÿè°ƒç”¨çš„è€—æ—¶ï¼š</p>
<pre tabindex="0"><code>// syscall-time.stp
probe syscall.$1.return {
  if (target() != 0 &amp;&amp; target() != pid()) next

  time = gettimeofday_us()-@entry(gettimeofday_us())
  printf(&#34;[%s:%d] syscall.%s time: %d\n&#34;, execname(), pid(), @1, time)
}
</code></pre><p>ä½¿ç”¨ï¼š</p>
<pre tabindex="0"><code>sudo stap syscall-time.stp open -x 15055

[top:15055] syscall.open time: 3
[top:15055] syscall.open time: 2
[top:15055] syscall.open time: 2
[top:15055] syscall.open time: 2
[top:15055] syscall.open time: 3
[top:15055] syscall.open time: 3
</code></pre><p>è¯¥è„šæœ¬ä¸­ï¼Œä¼ å…¥è¦è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨åç§°ï¼ˆæœ¬ä¾‹ä¸­æ˜¯<code>open</code>ï¼‰ï¼Œä»¥åŠè¦ç›‘æ§çš„è¿›ç¨‹pidï¼Œè¾“å‡ºè¯¥è¿›ç¨‹ä¸­æ¯æ¬¡è°ƒç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨è€—è´¹çš„æ—¶é—´ã€‚</p>
<p>å¦å¤–ï¼Œå…¶å®<code>systemtap</code>çš„<code>tapset</code>ä¸­å·²ç»å°è£…äº†å¯¹ä»»ä½•ç³»ç»Ÿè°ƒç”¨çš„<code>probe</code>äº‹ä»¶ï¼š</p>
<pre tabindex="0"><code>// tapset/linux/syscall_any.stp
probe syscall_any = kernel.trace(&#34;sys_enter&#34;)
{
	__set_syscall_pt_regs($regs)
	syscall_nr = $id
	name = syscall_name($id)
}
</code></pre><p>åœ¨è¿™é‡Œï¼Œ<code>syscall_any</code>åœ¨å†…æ ¸çš„traceäº‹ä»¶<code>sys_enter</code>ä¸­è¢«è§¦å‘ï¼Œå˜é‡<code>syscall_nr</code>å­˜å‚¨äº†ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼Œè€Œ<code>name</code>å­˜å‚¨äº†ç³»ç»Ÿè°ƒç”¨åç§°ã€‚å› æ­¤å¦‚æœè¦è·Ÿè¿›ä»»ä½•çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç±»ä¼¼ä¸‹é¢çš„è„šæœ¬è¿™ä¹ˆæ¥ï¼š</p>
<pre tabindex="0"><code>probe syscall_any {
    entry_time[tid()] = gettimeofday_ns();
    sys[tid()] = syscall_nr
}
probe syscall_any.return {
    et = entry_time[tid()]
    id = sys[tid()]
    delete entry_time[tid()]
    delete sys[tid()]
    if (et)
       arr[pid(), id] += (gettimeofday_ns() - et)
}
</code></pre><h2 id="æŸ¥è¯¢å ç”¨æ—¶é—´æœ€é•¿çš„ç³»ç»Ÿè°ƒç”¨">æŸ¥è¯¢å ç”¨æ—¶é—´æœ€é•¿çš„ç³»ç»Ÿè°ƒç”¨</h2>
<p>æ—¢ç„¶å¯ä»¥æ‹¿åˆ°æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>systemtap</code>ä¸­çš„ç»Ÿè®¡å‡½æ•°å¯¹è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨è¿›è¡Œç»Ÿè®¡ï¼Œå®šæ—¶è¾“å‡ºç»Ÿè®¡ç»“æœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code># syscall-count.stp
global follow_fork = 0
global thread_time
global time_count

global syscalls_nonreturn[2]
probe begin
{
	/* list those syscalls that never .return */
	syscalls_nonreturn[&#34;exit&#34;]=1
	syscalls_nonreturn[&#34;exit_group&#34;]=1
}

function filter_p()
{
	if (target() == 0) return 0; /* system-wide */
	if (!follow_fork &amp;&amp; pid() != target()) return 1; /* single-process */
	if (follow_fork &amp;&amp; !target_set_pid(pid())) return 1; /* multi-process */
	return 0;
}

# ä»»ä½•ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨
probe nd_syscall.*
{
	if (filter_p()) next;

	thread_time[execname(),pid(),name]=gettimeofday_us()
}

# ä»»ä½•ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨è¿”å›
probe nd_syscall.*.return
{
	if (filter_p()) next;
	if (name in syscalls_nonreturn) next

	s = thread_time[execname(),pid(),name]
	if (s!=0) {
		time_count[execname(),pid(),name] &lt;&lt;&lt; gettimeofday_us() - s
		delete thread_time[execname(),pid(),name]
	}
}

probe timer.s(1) {
  printf(&#34;[exe:pid]syscall time:count\n\n&#34;)
  foreach ([exe,pid,name] in time_count- limit 10)
    printf(&#34;[%s:%d]%s %d:%d\n&#34;, exe,pid,name, @sum(time_count[exe, pid,name]), @count(time_count[exe, pid,name]))
  delete time_count
}
</code></pre><p>è¾“å‡ºä¸¾ä¾‹ï¼š</p>
<pre tabindex="0"><code>$ sudo stap syscall-count.stp -x 2449 -T 2 -w
[exe:pid]syscall time:count

[dockerd:2449]futex 504414:18
[dockerd:2449]pselect6 640:10
[dockerd:2449]epoll_wait 500719:6
[dockerd:2449]read 55:4
[dockerd:2449]write 54:2
</code></pre><p>è¿™ä¸ªè„šæœ¬æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>å› ä¸ºè¦è¿½è¸ªæ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®é™…è€—æ—¶æ˜¯å¾ˆé•¿çš„ï¼Œæ‰€ä»¥åœ¨æŸ¥è¯¢å®Œæ¯•æœ‰å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†å…·ä½“çœ‹ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li>æœ‰ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸ä¼šè¿”å›çš„ï¼Œå…¶ä½œç”¨å°±æ˜¯é€€å‡ºè¿›ç¨‹ï¼Œæ¯”å¦‚exitå’Œexit_groupï¼Œåœ¨beginçš„æ—¶å€™æŠŠè¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨è®°å½•ä¸‹æ¥ï¼Œä¸é’ˆå¯¹å®ƒä»¬æ‰“å°æ—¶é—´äº†ã€‚</li>
<li>å¯ä»¥æ ¹æ®å…¨å±€å˜é‡follow_forkæ¥æ§åˆ¶æ˜¯å¦è·Ÿè¸ªå­è¿›ç¨‹ã€‚</li>
<li>åœ¨è¿™é‡Œæ²¡æœ‰åŠæ³•ä½¿ç”¨å‰é¢ä¾‹å­ä¸­çš„@entryæ“ä½œç¬¦ï¼Œå› ä¸ºå®ƒä¸èƒ½ç”¨åœ¨é€šé…ç¬¦çš„æ¢é’ˆå‡½æ•°ã€‚</li>
</ul>
<h2 id="æ‰“å°ç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·è°ƒç”¨æ ˆ">æ‰“å°ç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·è°ƒç”¨æ ˆ</h2>
<p>å¦‚æœå·²ç»çŸ¥é“æ˜¯å“ªä¸ªç³»ç»Ÿå‡½æ•°çš„è€—æ—¶æœ€å¤šï¼Œæ­¤æ—¶å°±å¯ä»¥å…·ä½“æ‰“å°åˆ°åº•æ˜¯å“ªäº›è¿›ç¨‹è°ƒç”¨æ ˆè°ƒç”¨äº†è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p>
<pre tabindex="0"><code># syscall-backtrace.stp
global backtrace

probe syscall.$1.call {
  if (target() != 0 &amp;&amp; target() != pid()) next

  backtrace[execname(), pid(), ubacktrace()] &lt;&lt;&lt; 1
}

probe timer.s(1) {
  foreach ([exe,pid,ubt] in backtrace- limit 10) {
    printf(&#34;[%s:%d]%s %d\n&#34;, exe,pid,name, @count(backtrace[exe, pid,ubt]))
    print_usyms(ubt);
  }
  delete backtrace
}
</code></pre><p>è¿™ä¸ªè„šæœ¬å½“æ¯æ¬¡è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè®°å½•å…¶ç”¨æˆ·è°ƒç”¨æ ˆï¼Œç„¶ååœ¨å®šæ—¶å™¨ä¸­æ‰“å°å‡ºæ¥ã€‚</p>
<p>ç›´æ¥æ‰“å°ç”¨æˆ·è°ƒç”¨æ ˆå¯èƒ½åªèƒ½å¾—åˆ°ä¸€ä¸²åå…­è¿›åˆ¶çš„åœ°å€ï¼Œæ­¤æ—¶æœ€å¥½ä½¿ç”¨<code>print_usyms</code>è¿™ä¸ªtapsetå‡½æ•°ï¼Œå¯¹åº”çš„å†…æ ¸è°ƒç”¨æ ˆå°±ä½¿ç”¨<code>print_syms</code>ï¼Œå½“ç„¶å³ä¾¿æ˜¯è¿™æ ·ï¼Œåœ¨æ²¡æœ‰è°ƒè¯•ç¬¦å·ä¿¡æ¯çš„æƒ…å†µä¸‹ä¹Ÿåªèƒ½è¾“å‡ºåå…­è¿›åˆ¶åœ°å€ã€‚</p>
<p>è¾“å‡ºç¤ºä¾‹ï¼š</p>
<pre tabindex="0"><code>$ sudo stap syscall-backtrace.stp futex -x 2449 -T 2 -w --all-modules
[dockerd:2449] 30
</code></pre><h1 id="å°ç»“">å°ç»“</h1>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œç®€å•æè¿°äº†ç³»ç»Ÿè°ƒç”¨çš„å®ç°åŸç†ï¼Œå…¶ä¼ ç»Ÿæ–¹å¼é‡‡ç”¨è½¯ä¸­æ–­å®ç°ï¼Œè¿™ç§æ–¹å¼çš„æ•ˆç‡è¾ƒä½ï¼Œæ›´æ–°çš„åŠæ³•ä½¿ç”¨äº†CPUæä¾›çš„ä¸“é—¨é’ˆå¯¹ç³»ç»Ÿè°ƒç”¨çš„æŒ‡ä»¤æ¥å®ç°ã€‚ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç”¨æˆ·è¿›ç¨‹å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥è®¿é—®å†…æ ¸çš„èµ„æºï¼Œè€Œæ˜¯é€šè¿‡<code>glibc</code>å°è£…å¥½çš„Cè¯­è¨€æ ‡å‡†åº“æ¥å®Œæˆå·¥ä½œã€‚</p>
<p><code>strace</code>å‘½ä»¤å¯ä»¥æ‰“å°ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶è€Œè¿™äº›ä¿¡æ¯å¯¹äºè·Ÿè¸ªè¿›ç¨‹å’Œç³»ç»Ÿçš„è¡Œä¸ºè¿˜ä¸å¤Ÿï¼Œå› ä¸ºæ²¡æœ‰ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç»Ÿè®¡ã€è€—æ—¶ç­‰ä¿¡æ¯ï¼Œè¿™æ—¶å€™<code>systemtap</code>åˆå‘æŒ¥äº†ä½œç”¨ï¼Œæœ¬èŠ‚çš„æœ€åä»‹ç»äº†<code>systemtap</code>å¦‚ä½•è¿½è¸ªç³»ç»ŸåŠè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨è¡Œä¸ºçš„ä¸€äº›è„šæœ¬ç¤ºä¾‹ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ul>
<li><a href="http://arthurchiao.art/blog/system-call-definitive-guide-zh/">[è¯‘] Linux ç³»ç»Ÿè°ƒç”¨æƒå¨æŒ‡å—ï¼ˆ2016ï¼‰</a></li>
<li><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">LINUX SYSTEM CALL TABLE FOR X86 64</a></li>
</ul>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://www.codedump.info/post/20200503-sgfap-process-systemtap/">â† prev</a>
    
    
    <a class="link" href="https://www.codedump.info/post/20200522-sgfap-softirq/">next â†’</a>
    
  </div>

    
<h1>ç›¸å…³æ–‡ç« </h1>
<li><strong> 20069-06-20: </strong> <a href="https://www.codedump.info/post/20200620-sgfap-loadavg/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹Linuxç³»ç»Ÿå¹³å‡è´Ÿè½½</a>  </li><li><strong> 22059-05-22: </strong> <a href="https://www.codedump.info/post/20200522-sgfap-softirq/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è½¯ä¸­æ–­</a>  </li><li><strong> 3059-05-03: </strong> <a href="https://www.codedump.info/post/20200503-sgfap-process-systemtap/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹ä½¿ç”¨systemtapåˆ†æè¿›ç¨‹çš„è¡Œä¸º</a>  </li><li><strong> 3059-05-03: </strong> <a href="https://www.codedump.info/post/20200503-sgfap-process-schedule/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è¿›ç¨‹è°ƒåº¦</a>  </li><li><strong> 2059-05-02: </strong> <a href="https://www.codedump.info/post/20200502-sgfap-process/">ã€Šé¢å‘åº”ç”¨å¼€å‘è€…çš„ç³»ç»ŸæŒ‡å—ã€‹CPUç¯‡ä¹‹è¿›ç¨‹</a>  </li>
<h1>é‚®ä»¶è®¢é˜…</h1>

<div class="custom-footer">
  <form action="https://www.getrevue.co/profile/lichuang/add_subscriber" method="post" id="revue-form" name="revue-form"  target="_blank" align="center">
    <input class="newsletter-email-field" placeholder="é‚®ä»¶è®¢é˜…æœ¬ç«™æ›´æ–°" type="email" name="member[email]" size="26">
    <input class="newsletter-submit-button" type="submit" value="ç‚¹å‡»è®¢é˜…" name="member[subscribe]">
    <div class="revue-form-footer">By subscribing, you agree with Revueâ€™s <a target="_blank" href="https://www.getrevue.co/terms">Terms of Service</a> and <a target="_blank" href="https://www.getrevue.co/privacy">Privacy Policy</a>.</div>
  </form>
</div>

<img align="center" src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/reward/qrcode.png" alt="wechat-account-qrcode">
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux%E7%B3%BB%E7%BB%9F/">Linuxç³»ç»Ÿ</a>
          </div><div class="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
    
    
        <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.utterances.owner }}/{{ .Site.Params.utterances.repo }}"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  
    
  </div>

  <main id="main" class="main">
    <div class="content-wrapper">
      <div id="content" class="content">
        
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'lichuang-codedump';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  
    <script src="https://utteranc.es/client.js"
            repo="lichuang/lichuang.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
  </main>


  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/lichuang>GitHub</a>,
<a class=link href=https://twitter.com/lichuang>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  



  
  

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>
