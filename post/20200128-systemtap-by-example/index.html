<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">


<meta name="author" content="codedump">



<meta name="description" content="é€šè¿‡å®ä¾‹å¿«é€Ÿå…¥é—¨Systemtap">




<meta name="keywords" content=" linux  systemtap ">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="é€šè¿‡å®ä¾‹å¿«é€Ÿå…¥é—¨Systemtap" />
<meta name="twitter:description" content="æˆ‘è¿™æ®µæ—¶é—´å¥½å¥½å­¦ä¹ äº†ä¸€ä¸‹Systemtapç›¸å…³çš„ä½¿ç”¨ï¼Œè¿™ç¯‡æ–‡ç« ç®—æ˜¯å­¦ä¹ è¿‡ç¨‹ä¸­æ€»ç»“çš„ä¸€äº›ç¬”è®°ï¼Œæˆ‘å¦å¤–åœ¨githubä¸Šåˆ›å»ºäº†ä¸€ä¸ªawesome-" />


<link rel="canonical" href="https://www.codedump.info/post/20200128-systemtap-by-example/">


<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/common.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/content.css'>
<link media="screen" rel="stylesheet" href='https://www.codedump.info/css/highlight.css'>



<title>é€šè¿‡å®ä¾‹å¿«é€Ÿå…¥é—¨Systemtap - codedumpçš„ç½‘ç»œæ—¥å¿—</title>





  <link rel="stylesheet" href='https://www.codedump.info/css/single.css'>
</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://www.codedump.info">codedumpçš„ç½‘ç»œæ—¥å¿—</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">ä¸»é¡µ</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/">å½’æ¡£</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/tags/">æ ‡ç­¾</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/categories/">åˆ†ç±»</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/post/20200122-series-pages/">ç³»åˆ—æ–‡ç« ç´¢å¼•</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/page/about">å…³äº</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://www.codedump.info/index.xml">è®¢é˜…</a>
    </span>
    
  </nav>
</header>

    <main id="main" class="post">
      
      
      
      <h1>é€šè¿‡å®ä¾‹å¿«é€Ÿå…¥é—¨Systemtap</h1>
      
      <div>
        <b>Keywords: </b>
        
        <a class="link" href='https://www.codedump.info/tags/linux%E7%B3%BB%E7%BB%9F'>#Linuxç³»ç»Ÿ</a>
        
        <a class="link" href='https://www.codedump.info/tags/%E5%8A%A8%E6%80%81%E8%B7%9F%E8%B8%AA'>#åŠ¨æ€è·Ÿè¸ª</a>
        
        <a class="link" href='https://www.codedump.info/tags/systemtap'>#systemtap</a>
        
      </div>
      
      <div class="content">
        

<p>æˆ‘è¿™æ®µæ—¶é—´å¥½å¥½å­¦ä¹ äº†ä¸€ä¸‹Systemtapç›¸å…³çš„ä½¿ç”¨ï¼Œè¿™ç¯‡æ–‡ç« ç®—æ˜¯å­¦ä¹ è¿‡ç¨‹ä¸­æ€»ç»“çš„ä¸€äº›ç¬”è®°ï¼Œæˆ‘å¦å¤–åœ¨githubä¸Šåˆ›å»ºäº†ä¸€ä¸ª<a href="https://github.com/lichuang/awesome-systemtap-cn">awesome-systemtap-cn</a>é¡¹ç›®ï¼Œæ”¶é›†systemtapç›¸å…³çš„ä¼˜ç§€å­¦ä¹ èµ„æºï¼Œæ¬¢è¿æä¾›å…¶ä»–æ›´å¥½çš„å‚è€ƒèµ„æ–™ã€‚</p>

<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>systemtapæ˜¯ä¸€æ¬¾â€œåŠ¨æ€è·Ÿè¸ªï¼ˆdynamic tracingï¼‰â€å·¥å…·ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™ç±»å·¥å…·ï¼Ÿæ‰“ä¸€ä¸ªæ¯”æ–¹ï¼Œè¿™ç±»å·¥å…·å°±å¥½æ¯”åŒ»ç”Ÿçš„å¬è¯Šå™¨ï¼Œç—…äººå°±å¥½æ¯”æ˜¯åœ¨è¿è¡Œçš„ç³»ç»Ÿï¼Œå¾ˆå¤šæ—¶å€™æŸ¥çœ‹ä¸€äº›é—®é¢˜éœ€è¦åœ¨ç³»ç»Ÿåœ¨è¿è¡Œçš„æ—¶å€™æ¥è§‚å¯Ÿï¼Œè¿™æ—¶å€™å°±éœ€è¦è¿™ç±»åŠ¨æ€è·Ÿè¸ªå·¥å…·ã€‚ä¸ä¹‹å¯¹åº”çš„æ˜¯ï¼Œç±»ä¼¼gdbè¿™æ ·çš„è°ƒè¯•å·¥å…·ï¼Œå…¶å·¥ä½œåŸç†æ˜¯è®©è¿›ç¨‹åœ¨æŸäº›æ–­ç‚¹æš‚åœä¸‹æ¥ï¼ŒæŸ¥çœ‹è¿›ç¨‹çš„è¡Œä¸ºï¼Œè¿™ç§æŠ€æœ¯ç§°ä¸ºâ€œé™æ€è°ƒè¯•â€ã€‚</p>

<p>å…³äºåŠ¨æ€è·Ÿè¸ªæŠ€æœ¯ï¼Œæ¨èé˜…è¯»<a href="https://openresty.org/posts/dynamic-tracing/">ã€ŠåŠ¨æ€è¿½è¸ªæŠ€æœ¯æ¼«è°ˆã€‹</a>ã€‚</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200128-systemtap-by-example/Smileytap.svg_.png" alt="Smileytap.svg" title="systemtap" />
</center></p>

<p>æœ¬æ–‡æ—¨åœ¨é€šè¿‡å®ä¾‹ï¼Œå¿«é€Ÿè§£é‡Šsystemtapè„šæœ¬è¯­è¨€çš„æœ€å¸¸è§ç”¨æ³•å’Œè¯­æ³•ã€‚</p>

<h1 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h1>

<p>å¦‚ä¸‹å›¾ï¼Œsystemtapä½¿ç”¨.stpè„šæœ¬è¯­è¨€ï¼Œç”±å‘½ä»¤è¡Œ<code>stap</code>ç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„å†…æ ¸æ¨¡å—ï¼ŒåŠ¨æ€æ”¾å…¥å†…æ ¸ä¸­æ‰§è¡Œï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200128-systemtap-by-example/systemtap.gif" alt="systemtap" title="systemtap" />
</center></p>

<ol>
<li>stap æµç¨‹ä»å°†è„šæœ¬è½¬æ¢æˆè§£ææ ‘å¼€å§‹ (pass 1)ã€‚</li>
<li>ç„¶åä½¿ç”¨ç»†åŒ–ï¼ˆelaborationï¼‰æ­¥éª¤ (pass 2) ä¸­å…³äºå½“å‰è¿è¡Œçš„å†…æ ¸çš„ç¬¦å·ä¿¡æ¯è§£æç¬¦å·ã€‚</li>
<li>æ¥ä¸‹æ¥ï¼Œè½¬æ¢æµç¨‹å°†è§£ææ ‘è½¬æ¢æˆ C æºä»£ç  (pass 3) å¹¶ä½¿ç”¨è§£æåçš„ä¿¡æ¯å’Œ tapset è„šæœ¬ï¼ˆSystemTap å®šä¹‰çš„åº“ï¼ŒåŒ…å«æœ‰ç”¨çš„åŠŸèƒ½ï¼‰ã€‚</li>
<li>stap çš„æœ€åæ­¥éª¤æ˜¯æ„é€ ä½¿ç”¨æœ¬åœ°å†…æ ¸æ¨¡å—æ„å»ºè¿›ç¨‹çš„å†…æ ¸æ¨¡å— (pass 4)ã€‚</li>
<li>æœ‰äº†å¯ç”¨çš„å†…æ ¸æ¨¡å—ä¹‹åï¼Œstap å®Œæˆäº†è‡ªå·±çš„ä»»åŠ¡ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤ç»™å…¶ä»–ä¸¤ä¸ªå®ç”¨ç¨‹åº SystemTapï¼šstaprun å’Œ stapioã€‚è¿™ä¸¤ä¸ªå®ç”¨ç¨‹åºåè°ƒå·¥ä½œï¼Œè´Ÿè´£å°†æ¨¡å—å®‰è£…åˆ°å†…æ ¸ä¸­å¹¶å°†è¾“å‡ºå‘é€åˆ° stdout (pass 5)ã€‚å¦‚æœåœ¨ shell ä¸­æŒ‰ç»„åˆé”® Ctrl-C æˆ–è„šæœ¬é€€å‡ºï¼Œå°†æ‰§è¡Œæ¸…é™¤è¿›ç¨‹ï¼Œè¿™å°†å¯¼è‡´å¸è½½æ¨¡å—å¹¶é€€å‡ºæ‰€æœ‰ç›¸å…³çš„å®ç”¨ç¨‹åºã€‚</li>
</ol>

<h1 id="stapå‘½ä»¤è¡Œå‚æ•°">stapå‘½ä»¤è¡Œå‚æ•°</h1>

<h2 id="x-pid">-x PID</h2>

<p>-xç”¨äºä¼ é€’PIDå‚æ•°ç»™systemtapè„šæœ¬ï¼Œè¿™æ ·åœ¨è„šæœ¬å†…éƒ¨å¯ä»¥é€šè¿‡target()å‡½æ•°æ‹¿åˆ°è¿™ä¸ªä¼ é€’è¿›æ¥çš„å‚æ•°ï¼š</p>

<pre><code>// $ sudo stap x-param.stp -x 10
// è¾“å‡ºï¼špid:10
probe begin
{
  printf(&quot;pid:%d\n&quot;, target())
}
</code></pre>

<h2 id="t-seconds">-T seconds</h2>

<p>-T å‚æ•°åé¢å¯ä»¥å¸¦ä¸Šç§’æ•°ï¼Œè¿™æ ·è„šæœ¬åœ¨è¿™ä¸ªæ—¶é—´ä¹‹åè‡ªåŠ¨é€€å‡ºï¼Œè¿™æ ·å¯ä»¥è®¾ç½®è„šæœ¬æ‰§è¡Œçš„æ—¶é—´ã€‚</p>

<pre><code>// $ sudo stap T-params.stp -T 3
// è¾“å‡ºï¼štime:2
global count

probe timer.s(1) {
  count += 1
}

probe end {
  printf(&quot;time:%d\n&quot;, count)
}
</code></pre>

<h2 id="lå’Œ-l">-Lå’Œ-l</h2>

<p>è¿™ä¸¤ä¸ªå‚æ•°å¤§ä½“ä½œç”¨ä¸€æ ·ï¼Œéƒ½å¯ä»¥åˆ—ä¸¾å‡ºäºŒè¿›åˆ¶æ–‡ä»¶å¯¹åº”çš„å‡½æ•°åœ¨å“ªé‡Œï¼ˆæ‰€åœ¨æ–‡ä»¶å’Œè¡Œæ•°ï¼‰ï¼Œæ‰€ä¸åŒçš„æ˜¯ï¼Œ-Læ¯”-lè¿˜å¤šäº†ä¸€äº›ä¿¡æ¯ï¼šå¯ä»¥æ‰“å°å‡ºå‡½æ•°å±€éƒ¨å˜é‡çš„ä¿¡æ¯ã€‚</p>

<p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªç®€å•çš„Cä»£ç ï¼š</p>

<pre><code class="language-C">#include &lt;stdio.h&gt;

int func1(int a, int b) {
  return a+b;
}

void func() {
  int a,b,c;

  c = func1(a,b);
  printf(&quot;c:%d\n&quot;, c);
}

int main() {
  func();
  return 0;
}
</code></pre>

<p>ä½¿ç”¨ä¸¤ä¸ªå¤§å°å†™ä¸åŒçš„-lå‚æ•°çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<pre><code>$ sudo stap -L 'process(&quot;./a.out&quot;).function(&quot;func&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func@/home/codedump/source/systemtap-examples/src/test.c:7&quot;) $a:int $b:int $c:int

$ sudo stap -l 'process(&quot;./a.out&quot;).function(&quot;func&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func@/home/codedump/source/systemtap-examples/src/test.c:7&quot;)
</code></pre>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦æ¢æµ‹çš„äºŒè¿›åˆ¶æ–‡ä»¶å¿…é¡»æœ‰è°ƒè¯•ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸Šé¢çš„test.cç¼–è¯‘å‡ºæ¥çš„a.outæ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨-gå‚æ•°ç¼–è¯‘è¿™æ ·æ‰èƒ½å¸¦ä¸Šè°ƒè¯•ä¿¡æ¯ï¼Œå¦åˆ™è¾“å‡ºå°±æ˜¯è¿™æ ·çš„ï¼š</p>

<pre><code>$ sudo stap -L 'process(&quot;./a.out&quot;).function(&quot;func&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func&quot;)
</code></pre>

<p>è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰ä¸€äº›ç¼–è¯‘ä¼˜åŒ–çº§åˆ«å¯èƒ½ä¼šæŠŠå±€éƒ¨å˜é‡ä¼˜åŒ–æ‰ï¼Œæ¯”å¦‚ä¸Šé¢çš„æ–‡ä»¶åˆ†åˆ«ä½¿ç”¨O0å’ŒO2ç¼–è¯‘ï¼Œçœ‹åˆ°çš„ç»“æœå°±ä¸ä¸€æ ·äº†ï¼š</p>

<pre><code>$ gcc test.c -g -O0
$ sudo stap -L 'process(&quot;./a.out&quot;).function(&quot;func&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func@/home/codedump/source/systemtap-examples/src/test.c:7&quot;) $a:int $b:int $c:int


$ gcc test.c -g -O2
$ sudo stap -L 'process(&quot;./a.out&quot;).function(&quot;func&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func@/home/codedump/source/systemtap-examples/src/test.c:7&quot;)
</code></pre>

<p>æœ‰äº†è¿™ä¸¤ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œæ­é…<code>grep</code>å‘½ä»¤å¾ˆå®¹æ˜“çš„æŸ¥è¯¢åˆ°ç›¸åº”çš„æ¢é’ˆã€‚</p>

<p>æŸ¥è¯¢åº”ç”¨å±‚ç¨‹åºæ¢é’ˆï¼š</p>

<pre><code>$ sudo stap -L 'process(&quot;./a.out&quot;).function(&quot;*&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;__do_global_dtors_aux&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;__libc_csu_fini&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;__libc_csu_init&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;_fini&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;_init&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;_start&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;deregister_tm_clones&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;frame_dummy&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func1@/home/codedump/source/systemtap-examples/src/test.c:3&quot;) $a:int $b:int
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func@/home/codedump/source/systemtap-examples/src/test.c:7&quot;) $d:int $n:char const* $a:int $b:int $c:int
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;main@/home/codedump/source/systemtap-examples/src/test.c:16&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;register_tm_clones&quot;)
</code></pre>

<p>æŸ¥è¯¢å†…æ ¸ä¸­åŒ…å«<code>tcp_</code>çš„æ¢é’ˆï¼š</p>

<pre><code>$ sudo stap -L 'kernel.function(&quot;*&quot;)' | grep tcp_ | more
kernel.function(&quot;__parse_nl_addr@/build/linux-hwe-dAr4iK/linux-hwe-4.15.0/net/ipv4/tcp_metrics.c:785&quot;) $addr:struct inetpeer_addr* $hash:unsigned int* $optional:int $v4:int $v6:int
kernel.function(&quot;__pskb_trim_head@/build/linux-hwe-dAr4iK/linux-hwe-4.15.0/net/ipv4/tcp_output.c:1398&quot;) $skb:struct sk_buff* $len:int
kernel.function(&quot;__tcp_ack_snd_check@/build/linux-hwe-dAr4iK/linux-hwe-4.15.0/net/ipv4/tcp_input.c:5062&quot;) $sk:struct sock* $ofo_possible:int
kernel.function(&quot;__tcp_add_write_queue_tail@/build/linux-hwe-dAr4iK/linux-hwe-4.15.0/include/net/tcp.h:1647&quot;)
kernel.function(&quot;__tcp_alloc_md5sig_pool@/build/linux-hwe-dAr4iK/linux-hwe-4.15.0/net/ipv4/tcp.c:3371&quot;)
</code></pre>

<h2 id="g-var-val">-G VAR=VAL</h2>

<p>-Gå‘½ä»¤è¡Œå‚æ•°ï¼Œå¯ä»¥è®¾ç½®å…¨å±€å˜é‡VARçš„å€¼ä¸ºVALï¼Œç›¸åº”åœ°å°±å¯ä»¥ä½œä¸ºå¼€å…³æ¥æ§åˆ¶è„šæœ¬çš„è¡Œä¸ºï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>// sudo stap G-params.stp -G flag=1
// flag has set
global flag=0

probe begin {
  if (flag == 0) {
    printf(&quot;flag not set\n&quot;)
  } else {
    printf(&quot;flag has set\n&quot;)
  }
}
</code></pre>

<h1 id="æ¢æµ‹ç‚¹">æ¢æµ‹ç‚¹</h1>

<p>ç”±äºsystemtapç”¨äºåŠ¨æ€è·Ÿè¸ªæ¢æµ‹ï¼Œæ‰€ä»¥é¦–å…ˆçš„ç¬¬ä¸€æ­¥å°±æ˜¯åœ¨è¯­è¨€ä¸­å®šä¹‰æ¢æµ‹ç‚¹ï¼Œåœ¨systemtapä¸­è¢«ç§°ä¸ºâ€œprobeâ€ã€‚å…¶åŸºæœ¬è¯­æ³•æ˜¯ï¼š</p>

<pre><code>probe event { statement }
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œâ€œeventâ€åˆ†ä¸ºä¸¤ç§ï¼š</p>

<ul>
<li>åŒæ­¥äº‹ä»¶ï¼šå‘ç”Ÿåœ¨è¿›ç¨‹æ‰§è¡ŒæŸä¸€æ¡ç¡®å®šçš„å‘½ä»¤æ—¶çš„äº‹ä»¶ã€‚</li>
<li>å¼‚æ­¥äº‹ä»¶ï¼šä¸æ˜¯æ‰§è¡Œåˆ°æŒ‡å®šçš„æŒ‡ä»¤æˆ–ä»£ç ä½ç½®ï¼Œè¿™ä¸€ç±»åŒ…æ‹¬è®¡æ—¶å™¨ï¼Œå®šæ—¶å™¨ç­‰ã€‚</li>
</ul>

<p>ä»¥ä¸‹åˆ†å¼€è§£é‡Šã€‚</p>

<h2 id="åŒæ­¥äº‹ä»¶">åŒæ­¥äº‹ä»¶</h2>

<p>åŒæ­¥äº‹ä»¶æœ‰å¥½å¤šç§ï¼ŒåŒæ­¥äº‹ä»¶çš„æ¢æµ‹ç‚¹åˆåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªç»„æˆéƒ¨åˆ†ï¼š</p>

<ul>
<li>å‰ç¼€éƒ¨åˆ†ï¼Œå®šä¹‰æ‰€åœ¨çš„æ¨¡å—ï¼šå¯ä»¥æ˜¯å†…æ ¸ï¼Œè¿˜å¯ä»¥æ˜¯å†…æ ¸æ¨¡å—ï¼Œè¿˜å¯ä»¥æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œè¿˜å¯ä»¥æ˜¯systemtapåœ¨tapsetä¸­é¢„å®šä¹‰çš„æ¢æµ‹ç‚¹ã€‚</li>
<li>ä¸­é—´éƒ¨åˆ†ï¼Œå®šä¹‰æ‰€åœ¨çš„å‡½æ•°ï¼šå‡½æ•°å¯ä»¥é€šè¿‡å‡½æ•°åæŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ ¹æ®æ–‡ä»¶å:è¡Œå·æŒ‡å®šã€‚</li>
<li>åç¼€éƒ¨åˆ†ï¼Œå®šä¹‰è°ƒç”¨æ—¶æœºï¼šå¯ä»¥åœ¨å‡½æ•°è°ƒç”¨æ—¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥åœ¨å‡½æ•°è¿”å›æ—¶è§¦å‘ã€‚</li>
</ul>

<p>æ ¹æ®ä»¥ä¸Šå‡ ä¸ªåˆ’åˆ†ï¼Œå†æ¥æ‹†è§£â€œæ¢æµ‹ç‚¹â€å°±ç›¸å¯¹å®¹æ˜“äº†ã€‚</p>

<h3 id="æ¨¡å—">æ¨¡å—</h3>

<p>å…¶ä¸­å‡ ç±»çš„è¯­æ³•åˆ†åˆ«æ˜¯ï¼š</p>

<ul>
<li>å†…æ ¸ï¼šè¯­æ³•ä¸ºkernel.function(PATTERN)ï¼Œå³ä»¥â€œkernelâ€å¼€å¤´æ¥æŒ‡å®šçš„å°±æ˜¯å†…æ ¸ä¸­çš„å‡½æ•°ã€‚</li>
<li>å†…æ ¸æ¨¡å—ï¼šè¯­æ³•ä¸ºmodule(MPATTERN).function(PATTERN)ï¼Œå³ä»¥â€œmodule(MPATTERN)â€å¼€å¤´æ¥æŒ‡å®šçš„å°±æ˜¯å†…æ ¸æ¨¡å—ä¸­çš„å‡½æ•°ã€‚</li>
<li>ç”¨æˆ·è¿›ç¨‹ï¼šè¯­æ³•ä¸ºprocess(PROCESSPATH).function(PATTERN)ï¼Œå³ä»¥â€œprocess(PROCESSPATH)â€å¼€å¤´æ¥æŒ‡å®šçš„å°±æ˜¯ç”¨æˆ·è¿›ç¨‹çš„å‡½æ•°ã€‚</li>
<li>å¼‚æ­¥è°ƒç”¨çš„æ¨¡å—ï¼šæ¯”å¦‚beginã€endã€timerç­‰ã€‚</li>
<li>å¦‚æœä¸æ˜¯ä»¥ä¸Šçš„æ ¼å¼ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡å°±æ˜¯systemtapè‡ªå¸¦çš„tapsetä¸­å·²ç»å®šä¹‰çš„æ¢æµ‹ç‚¹ï¼Œå®é™…ä¸Šè¿™äº›è¿˜æ˜¯å°è£…äº†ä»¥ä¸Šå‡ ç§è°ƒç”¨çš„åˆ«åï¼ˆaliasï¼‰æ¢æµ‹ç‚¹ï¼Œåé¢å°†è°ˆåˆ°æ¢æµ‹ç‚¹çš„åˆ«åå®šä¹‰ã€‚tapsetäºsystemtapçš„æ„ä¹‰ï¼Œå°±å¥½æ¯”libcåº“äºCç¨‹åºçš„æ„ä¹‰ã€‚</li>
</ul>

<h3 id="æ‰€åœ¨çš„å‡½æ•°">æ‰€åœ¨çš„å‡½æ•°</h3>

<p>æ‰€åœ¨çš„å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æŒ‡å®šï¼š</p>

<ul>
<li>function(PATTERN)</li>
<li>statement(PATTERN)</li>
</ul>

<p>PATTERNç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>

<ul>
<li>å‡½æ•°åï¼ˆå¿…å¡«ï¼‰ã€‚</li>
<li>@æ–‡ä»¶åï¼šé€‰å¡«ã€‚</li>
<li>å¦‚æœå­˜åœ¨â€œ@æ–‡ä»¶åâ€çš„æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥é€‰å¡«è¡Œå·ã€‚</li>
</ul>

<p>å³PATTERNçš„æ ¼å¼æ˜¯ï¼š</p>

<pre><code>func[@file][:linenumber]
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œå‡½æ•°åè¿™éƒ¨åˆ†å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼ˆwildcardedï¼‰æ¥å®šä¹‰æ–‡ä»¶çš„åå­—ä»¥åŠå‡½æ•°çš„åå­—ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code># æ‰€æœ‰å†…æ ¸ä¸­ä»¥sys_å‰ç¼€å¼€å¤´çš„å‡½æ•°
kernel.function(&quot;sys_*)

# nginxç”¨æˆ·è¿›ç¨‹ä¸­åä¸ºngx_http_process_*çš„å‡½æ•°
process(&quot;/home/admin/nginx/bin/nginx&quot;).function(&quot;ngx_http_process_*&quot;)
</code></pre>

<p>æœ‰æ—¶å€™å¦‚æœä¸ç¡®å®šå‡½æ•°çš„åå­—ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨å‰é¢çš„-Lå’Œ-lå‘½ä»¤æ¥è¾…åŠ©æŸ¥è¯¢ï¼Œæ¯”å¦‚è¿˜æ˜¯ä¸Šé¢test.cçš„ä¾‹å­ï¼š</p>

<pre><code>$ sudo stap -l 'process(&quot;./a.out&quot;).function(&quot;fu*&quot;)'
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func1@/home/codedump/source/systemtap-examples/src/test.c:3&quot;)
process(&quot;/home/codedump/source/systemtap-examples/src/a.out&quot;).function(&quot;func@/home/codedump/source/systemtap-examples/src/test.c:7&quot;)
</code></pre>

<p>ä½¿ç”¨<code>statement</code>å¯ä»¥å¾ˆæ–¹ä¾¿å®šä½åˆ°å…·ä½“çš„æŸä¸€è¡Œä»£ç æ‰§è¡Œå‰åï¼Œå˜é‡çš„å˜åŒ–æƒ…å†µï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªæœ€ç®€å•çš„Cä»£ç ï¼š</p>

<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(int argc, char *argv[])
{
	int a;

	a = 1;
	printf(&quot;a:%d\n&quot;, a);
	a = 2;
	printf(&quot;a:%d\n&quot;, a);
	return 0;
}
</code></pre>

<p>ä½¿ç”¨ä¸‹é¢è¿™ä¸ªsystemtapè„šæœ¬é’ˆå¯¹ä»£ç ä¸­çš„ç¬¬8è¡Œå’Œç¬¬10è¡Œæ‰“å°å½“æ—¶å˜é‡açš„å€¼ï¼š</p>

<pre><code>probe process(&quot;./a.out&quot;).statement(&quot;main@./cc_stap_test.c:8&quot;)
{
    printf(&quot;systemtap probe line 8 a:%d\n&quot;, $a);
}

probe process(&quot;./a.out&quot;).statement(&quot;main@./cc_stap_test.c:10&quot;)
{
    printf(&quot;systemtap probe line 10 a:%d\n&quot;, $a);
}
</code></pre>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<pre><code>$ sudo stap cc_stap_test.stp -c ./a.out
a:1
a:2
systemtap probe line 8 a:1
systemtap probe line 10 a:2
</code></pre>

<h3 id="è°ƒç”¨æ—¶æœº">è°ƒç”¨æ—¶æœº</h3>

<p>æœ‰äº†ä»¥ä¸Šä¸¤ä¸ªè¦ç´ ï¼Œå·²ç»å¯ä»¥åœ¨å…·ä½“çš„å‡½æ•°ã€æ–‡ä»¶è¡Œä¸­å®šä¹‰æ¢æµ‹ç‚¹äº†ï¼Œä½†æ˜¯æœ‰æ—¶å€™é’ˆå¯¹æŸä¸€ä¸ªå…·ä½“å‡½æ•°ï¼Œæƒ³åœ¨ä¸åŒçš„æ—¶æœºå®šä¹‰æ¢æµ‹ç‚¹ï¼Œæ¯”å¦‚å‡½æ•°è¢«è°ƒç”¨å’Œè°ƒç”¨è¿”å›çš„æ—¶å€™ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨åé¢ä»¥åç¼€çš„æ–¹å¼å®šä¹‰å‡ºæ¥ï¼š</p>

<pre><code>probe kernel.function(&quot;*@net/socket.c&quot;).call {
  printf (&quot;%s -&gt; %s\n&quot;, thread_indent(1), probefunc())
}
probe kernel.function(&quot;*@net/socket.c&quot;).return {
  printf (&quot;%s &lt;- %s\n&quot;, thread_indent(-1), probefunc())
}
</code></pre>

<p>æ¯”å¦‚è¿™ä¸¤ä¸ªæ¢æµ‹ç‚¹ï¼Œåˆ†åˆ«åœ¨socket.cä¸­çš„ä»»ä½•å‡½æ•°è¢«è°ƒç”¨ä»¥åŠè¿”å›çš„æ—¶å€™è¢«è°ƒç”¨ã€‚</p>

<h2 id="å¼‚æ­¥äº‹ä»¶">å¼‚æ­¥äº‹ä»¶</h2>

<p>å¸¸è§çš„å¼‚æ­¥äº‹ä»¶æ˜¯beginã€endã€neverã€timersã€‚</p>

<ul>
<li>beginã€endåˆ†åˆ«åœ¨è„šæœ¬å¼€å§‹æ‰§è¡Œä»¥åŠç»“æŸæ‰§è¡Œçš„æ—¶å€™è¢«è°ƒç”¨ã€‚</li>
<li>timersç”¨äºå®šä¹‰å®šæ—¶å™¨æ¢æµ‹ç‚¹ï¼Œå¸¸è§çš„æ ¼å¼timer.s(1)æ¥å®šä¹‰æ¯ç§’è§¦å‘çš„æ¢æµ‹ç‚¹ã€‚</li>
<li>neverå®šä¹‰çš„æ¢æµ‹ç‚¹ä¸ä¼šè¢«è°ƒç”¨åˆ°ï¼Œå¾ˆå¤šæ—¶å€™åŠ è¿™ä¸ªæ¢æµ‹ç‚¹åªæ˜¯ä¸ºäº†æ£€æŸ¥ä¸€äº›è¯­æ³•é”™è¯¯ã€‚</li>
</ul>

<p>è¿™é‡Œç»Ÿä¸€ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š</p>

<pre><code>// sudo stap begin.stp -T 2
// è¾“å‡ºï¼š
// probe begin
// in timer
// probe end

probe begin {
  printf(&quot;probe begin\n&quot;)
}

probe end {
  printf(&quot;probe end\n&quot;)
}

probe timer.s(1) {
  printf(&quot;in timer\n&quot;)
}

probe never {
  printf(&quot;never do this\n&quot;)
}
</code></pre>

<p>ä»¥ä¸‹å›¾ç‰‡ç®€å•æ€»ç»“æ¢é’ˆäº‹ä»¶çš„åˆ’åˆ†ï¼š</p>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200128-systemtap-by-example/probe-event.png" alt="probe-event" title="probe-event" />
</center></p>

<h2 id="æ¢æµ‹ç‚¹åˆ«å-alias">æ¢æµ‹ç‚¹åˆ«åï¼ˆaliasï¼‰</h2>

<p>é™¤äº†ä»¥ä¸Šçš„æ¢æµ‹ç‚¹ä¹‹åï¼Œè¿˜å¯ä»¥é€šè¿‡æ¢æµ‹ç‚¹åˆ«åæŠ€æœ¯å°†å¤šä¸ªæ¢æµ‹ç‚¹çš„å¤„ç†è¡Œä¸ºåˆå¹¶åœ¨ä¸€ä¸ªå¤„ç†å‡½æ•°ä¸­ï¼Œæ¯”å¦‚tapset schedulerä¸­æ˜¯è¿™ä¹ˆå®šä¹‰scheduler.cpu_offè¿™ä¸ªæ¢æµ‹ç‚¹çš„ï¼š</p>

<pre><code>probe scheduler.cpu_off =
	kernel.trace(&quot;sched_switch&quot;) !,
	kernel.function(&quot;context_switch&quot;)
{
    name = &quot;cpu_off&quot;
    task_prev = $prev
    task_next = $next
    idle = __is_idle()
}
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œæ–°å®šä¹‰çš„åˆ«åæ¢æµ‹ç‚¹scheduler.cpu_offå°†å†…æ ¸çš„ä¸¤ä¸ªæ¢æµ‹ç‚¹kernel.trace(&ldquo;sched_switch&rdquo;)å’Œkernel.function(&ldquo;context_switch&rdquo;)çš„å¤„ç†è¡Œä¸ºåˆå¹¶åœ¨äº†ä¸€èµ·ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>kernel.trace(&quot;sched_switch&quot;)</code>è¿™ä¸ªæ¢æµ‹ç‚¹çš„åé¢åŠ ä¸Šäº†<code>!</code>ï¼Œè¿™è¡¨ç¤ºè¿™ä¸ªæ¢æµ‹ç‚¹å¯èƒ½ç”±äºç‰ˆæœ¬çš„å·®å¼‚æ˜¯ä¸å­˜åœ¨çš„ï¼Œä½†æ˜¯ä¸€æ—¦å­˜åœ¨ï¼Œé‚£ä¹ˆå°†ä¸å†è§£æè¿™ä¸ªæ¢æµ‹ç‚¹ä»¥åçš„ä»¥<code>,</code>éš”å¼€çš„å…¶ä»–æ¢æµ‹ç‚¹ï¼Œæ‰€ä»¥<code>!</code>ä¸€å®šç”¨åœ¨å¤šä¸ªä»¥<code>,</code>åˆ†éš”å¼€çš„æ¢æµ‹ç‚¹åˆ—è¡¨ä¸­ã€‚ç›¸åº”åœ°ï¼Œè¿˜æœ‰<code>?</code>åç¼€ï¼Œä¹Ÿæ˜¯è¡¨ç¤ºè¿™ä¸ªæ¢æµ‹ç‚¹å¯èƒ½ä¸å­˜åœ¨ï¼Œä½†æ˜¯ä¸å‰é¢çš„åŒºåˆ«æ˜¯ï¼Œå³ä¾¿å­˜åœ¨è¿™ç§æ¢æµ‹ç‚¹ä¹Ÿä¸å½±å“å…¶ä»–æ¢æµ‹ç‚¹çš„æ£€æµ‹ï¼Œæ‰€ä»¥<code>?</code>åç¼€çš„æ¢æµ‹ç‚¹å¯ä»¥ç‹¬ç«‹å­˜åœ¨ã€‚</p>

<h3 id="æ¢æµ‹ç‚¹åŠ¨æ€å®šä¹‰">æ¢æµ‹ç‚¹åŠ¨æ€å®šä¹‰</h3>

<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥æ ¹æ®å‘½ä»¤è¡Œå‚æ•°æ¥æŒ‡å®šæ¢æµ‹ç‚¹ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>function trace(entry_p)
{
  printf(&quot;%s%s%s\n&quot;,
         thread_indent (entry_p),
         (entry_p&gt;0?&quot;-&gt;&quot;:&quot;&lt;-&quot;),
         ppfunc ())
}

probe $1.call   { trace(1) }
probe $1.return { trace(-1) }
</code></pre>

<p>è¿™ä¸ªè„šæœ¬å¯ä»¥æ ¹æ®è„šæœ¬ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ¥æ‰“å°å…¶è°ƒç”¨æƒ…å†µï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>$ stap callgraph.stp 'kernel.function(&quot;sys_open&quot;)'

     0 nscd(23451):-&gt;SyS_open
     6 nscd(23451):&lt;-SyS_open
     0 nscd(23451):-&gt;SyS_open
     7 nscd(23451):&lt;-SyS_open
     0 roxterm(21323):-&gt;SyS_open
    43 roxterm(21323):&lt;-SyS_open
     0 roxterm(21323):-&gt;SyS_open
  2604 roxterm(21323):&lt;-SyS_open
     0 systemd-udevd(637):-&gt;SyS_open
   268 systemd-udevd(637):&lt;-SyS_open
     0 roxterm(21323):-&gt;SyS_open
    24 roxterm(21323):&lt;-SyS_open
[...]

</code></pre>

<h1 id="å˜é‡">å˜é‡</h1>

<h2 id="ç›®æ ‡å˜é‡-target-variables">ç›®æ ‡å˜é‡ï¼ˆTarget Variablesï¼‰</h2>

<p>ç›®æ ‡å˜é‡æŒ‡çš„æ˜¯å½“å‰ä»£ç ä½ç½®å¯è§çš„å˜é‡ï¼Œå®˜æ–¹æ–‡æ¡£å¯¹è¿™ä¸ªæ¦‚å¿µçš„è§£é‡Šæ˜¯ï¼š</p>

<blockquote>
<p>The probe events that map to actual locations in the code (for example kernel.function(â€œfunctionâ€) and kernel.statement(â€œstatementâ€)) allow the use of target variables to obtain the value of variables visible at that location in the code. You can use the -L option to list the target variable available at a probe point.</p>
</blockquote>

<p>æ¯”å¦‚å‰é¢æè¿‡çš„ï¼Œå¯ä»¥ä½¿ç”¨-Lå‘½ä»¤è¡Œå‚æ•°ï¼Œæ‹¿åˆ°ä¸€ä¸ªæ¢æµ‹ç‚¹çš„ä½ç½®åŠç›¸å…³çš„å˜é‡ï¼š</p>

<pre><code>stap -L 'kernel.function(&quot;vfs_read&quot;)'
kernel.function(&quot;vfs_read@fs/read_write.c:277&quot;) $file:struct file* $buf:char* $count:size_t $pos:loff_t*
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œç»™å‡ºå˜é‡ç›¸å…³ä¿¡æ¯çš„æ—¶å€™ï¼Œæ˜¯ä»¥å¦‚ä¸‹æ ¼å¼ç»™å‡ºçš„ï¼š</p>

<pre><code>$å˜é‡å:å˜é‡ç±»å‹
</code></pre>

<p>æ¯”å¦‚è¿™é‡Œçš„<code>$file:struct file*</code>ã€‚</p>

<h2 id="å…¨å±€å˜é‡">å…¨å±€å˜é‡</h2>

<p>å¦‚æœä¸æ˜¯åœ¨å½“å‰ä»£ç ä½ç½®çš„å˜é‡ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡è¿™ç§æ ¼å¼æ‹¿åˆ°ï¼š</p>

<pre><code>@var(&quot;varname@src/file.c&quot;)
</code></pre>

<p>æ¯”å¦‚ï¼š</p>

<pre><code>// test2.c
#include &lt;stdio.h&gt;

int g = 100;
int func1(int a, int b) {
  g = 102;
  return a+b;
}

int func(int d, const char *n) {
  int a,b,c;

  g = 101;
  a = 1;
  b = 3;
  c = func1(a,b);
  return c;
}

int main() {
  func(100, &quot;test&quot;);
  return 0;
}
</code></pre>

<p>stpè„šæœ¬å¦‚ä¸‹ï¼š</p>

<pre><code>probe process(&quot;./a.out&quot;).function(&quot;func&quot;).call {
	printf(&quot;call func:g=%d\n&quot;, @var(&quot;g@test.c&quot;))
}

probe process(&quot;./a.out&quot;).function(&quot;func&quot;) {
	printf(&quot;func:g=%d\n&quot;, @var(&quot;g@test.c&quot;))
}

probe process(&quot;./a.out&quot;).function(&quot;func&quot;).return {
	printf(&quot;return func:g=%d\n&quot;, @var(&quot;g@test.c&quot;))
}

probe process(&quot;./a.out&quot;).function(&quot;func1&quot;).call {
	printf(&quot;call func1:g=%d\n&quot;, @var(&quot;g@test.c&quot;))
}

probe process(&quot;./a.out&quot;).function(&quot;func1&quot;) {
	printf(&quot;func1:g=%d\n&quot;, @var(&quot;g@test.c&quot;))
}

probe process(&quot;./a.out&quot;).function(&quot;func1&quot;).return {
	printf(&quot;return func1:g=%d\n&quot;, @var(&quot;g@test.c&quot;))
}
</code></pre>

<p>æ‰§è¡Œ<code>sudo stap t.stap -c ./a.out</code>å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p>

<pre><code>call func:g=100
func:g=100
call func1:g=101
func1:g=101
return func1:g=102
return func:g=102
</code></pre>

<h2 id="æ‰“å°ç»“æ„ä½“å†…å®¹">æ‰“å°ç»“æ„ä½“å†…å®¹</h2>

<p>æœ‰ä¸€äº›å˜é‡ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå¦‚æœæƒ³æ‰“å°å…¶æˆå‘˜ä¿¡æ¯ï¼Œä½†æ˜¯åˆä¸çŸ¥é“ç»“æ„ä½“çš„æˆå‘˜åˆ†å¸ƒçš„æƒ…å†µï¼Œå¯ä»¥é¦–å…ˆä½¿ç”¨<code>$å˜é‡å$</code>ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;).return {printf(&quot;%s\n&quot;, $file$); exit(); }'

{.f_u={...}, .f_path={...}, .f_inode=0xffff8eaf11a9ef80, .f_op=0xffff8eafef9a7100, .f_lock={...}, .f_write_hint=0, .f_count={...}, .f_flags=34818, .f_mode=491551, .f_pos_lock={...}, .f_pos=0, .f_owner={...}, .f_cred=0xffff8eafed747f00, .f_ra={...}, .f_version=0, .f_security=0xffff8eafbfb5f708, .private_data=0x0, .f_ep_links={...}, .f_tfile_llink={...}, .f_mapping=0xffff8eaf11a9f0f8, .f_wb_err=0}
</code></pre>

<p>è¿™æ ·å°±ä¸€ç›®äº†ç„¶çŸ¥é“è¿™ä¸ªç»“æ„ä½“çš„æ„æˆäº†ã€‚</p>

<p>è€Œå¦‚æœéœ€è¦æ‰“å°æŸä¸ªæˆå‘˜çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>-&gt;</code>æ“ä½œç¬¦ï¼Œæ³¨æ„åœ¨systemtapä¸­ï¼Œæ— è®ºæ˜¯æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨éƒ½ä½¿ç”¨<code>-&gt;</code>æ¥æŸ¥çœ‹æˆå‘˜ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;).return {printf(&quot;%d\n&quot;, $file-&gt;private_data); exit(); }'

0
</code></pre>

<p>è¿™é‡Œè¿˜æœ‰å¦ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå³ä¸€ä¸ªæˆå‘˜å¯èƒ½åˆæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå¦‚æœè¦ä¸€å±‚ä¸€å±‚â€œæ‰’æ‰â€æˆå‘˜çš„å¤–è¡£ï¼Œå°±éœ€è¦åœ¨åé¢åŠ <code>$</code>ç¬¦å·ï¼Œæ¯å¤šä¸€ä¸ª<code>$</code>ç¬¦å·ï¼Œå°±æ‰’æ‰ä¸€å±‚å¤–è¡£ï¼Œä¾‹å­ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;).return {printf(&quot;%s\n&quot;, $file-&gt;f_pos_lock$); exit(); }' -w
{.owner={...}, .wait_lock={...}, .osq={...}, .wait_list={...}}

$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;).return {printf(&quot;%s\n&quot;, $file-&gt;f_pos_lock$$); exit(); }' -w
{.owner={.counter=-124589570406976}, .wait_lock={&lt;union&gt;={.rlock={.raw_lock={&lt;union&gt;={.val={.counter=0}, &lt;class&gt;={.locked='\000', .pending='\000'}, &lt;class&gt;={.locked_pending=0, .tail=0}}}}}}, .osq={.tail={.counter=0}}, .wait_list={.next=0xffff8eaf34c8cc58, .prev=0xffff8eaf34c8cc58}}

$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;).return {printf(&quot;%s\n&quot;, $file-&gt;f_pos_lock$$$); exit(); }' -w
{.owner={.counter=-124589338874240}, .wait_lock={&lt;union&gt;={.rlock={.raw_lock={&lt;union&gt;={.val={.counter=0}, &lt;class&gt;={.locked='\000', .pending='\000'}, &lt;class&gt;={.locked_pending=0, .tail=0}}}}}}, .osq={.tail={.counter=0}}, .wait_list={.next=0xffff8eaf42b71458, .prev=0xffff8eaf42b71458}}
</code></pre>

<p>ç»“åˆæ‰“å°å…¨å±€å˜é‡å’Œæ‰“å°ç»“æ„ä½“æˆå‘˜è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¦‚æœæƒ³çŸ¥é“å…¨å±€å˜é‡çš„ç»“æ„ä½“æˆå‘˜åˆ†å¸ƒï¼Œå°±éœ€è¦ï¼š</p>

<pre><code>@var(&quot;å…¨å±€å˜é‡å@src/file.c&quot;)$
</code></pre>

<p>æ¯”å¦‚ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;) {
           printf (&quot;current files_stat max_files: %s\n&quot;,
                   @var(&quot;files_stat@fs/file_table.c&quot;)$);
           exit(); }'
current files_stat max_files: {.nr_files=0, .nr_free_files=0, .max_files=774499}
</code></pre>

<p>ç„¶åç”¨è¿™ä¸ªæ ¼å¼æ‰“å°å…¨å±€å˜é‡ç»“æ„ä½“æˆå‘˜æ•°æ®ï¼š</p>

<pre><code>@var(&quot;å…¨å±€å˜é‡å@src/file.c&quot;)-&gt;ç»“æ„ä½“æˆå‘˜åç§°
</code></pre>

<p>æ¯”å¦‚ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;vfs_read&quot;) {
           printf (&quot;current files_stat max_files: %d\n&quot;,
                   @var(&quot;files_stat@fs/file_table.c&quot;)-&gt;max_files);
           exit(); }'
current files_stat max_files: 774499
</code></pre>

<h2 id="ç±»å‹è½¬æ¢-typecasting">ç±»å‹è½¬æ¢ï¼ˆTypecastingï¼‰</h2>

<p>å½“æŒ‡é’ˆä¸ºvoid*æŒ‡é’ˆæ—¶ï¼Œå¦‚æœçŸ¥é“å®ƒçš„ç¡®åˆ‡ç±»å‹ï¼Œå¯ä»¥é€šè¿‡ç±»å‹è½¬æ¢æ¥è¾“å‡ºå…¶ä¿¡æ¯ï¼š</p>

<pre><code>@cast(p, &quot;type_name&quot;[, &quot;module&quot;])-&gt;member
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œ<code>type_name</code>æ˜¯ç±»å‹åç§°ï¼Œè€Œå¯é€‰çš„moduleæ˜¯æ¨¡å—+æ–‡ä»¶ä¿¡æ¯ï¼Œå¥½è®©systemtapçŸ¥é“åˆ°å“ªé‡Œæ‰¾åˆ°è¿™ä¸ªç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>@cast(tv, â€œtimevalâ€, â€œ&lt;sys/time.h&gt;â€)-&gt;tvsec
@cast(task, â€œtaskstructâ€, â€œkernel&lt;linux/sched.h&gt;â€)-&gt;tgid
@cast(task, â€œtaskstructâ€, â€œkernel&lt;linux/sched.h&gt;&lt;linux/fsstruct.h&gt;â€)-&gt;fs-&gt;umask
</code></pre>

<p>æ‰€ä»¥å¯ä»¥å¦‚ä¸‹ä¾‹æ‰“å°ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;do_dentry_open&quot;) {printf(&quot;%d\n&quot;, @cast($f, &quot;file&quot;, &quot;kernel&lt;linux/fs.h&gt;&quot; )-&gt;f_flags); exit(); }'
32768
</code></pre>

<p>åœ¨ä½¿ç”¨<code>@cast</code>è½¬æ¢ç±»å‹ä¹‹åï¼ŒåŒæ ·å¯ä»¥åœ¨åé¢åŠ ä¸Š<code>$</code>æ‰“å°æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼š</p>

<pre><code>$ sudo stap -e 'probe kernel.function(&quot;do_dentry_open&quot;) {printf(&quot;%s\n&quot;, @cast($f, &quot;file&quot;, &quot;kernel&lt;linux/fs.h&gt;&quot;)$); exit(); }'
{.f_u={...}, .f_path={...}, .f_inode=0x0, .f_op=0x0, .f_lock={...}, .f_write_hint=0, .f_count={...}, .f_flags=32768, .f_mode=0, .f_pos_lock={...}, .f_pos=0, .f_owner={...}, .f_cred=0xffff8eafef8f80c0, .f_ra={...}, .f_version=0, .f_security=0xffff8eafeb5c09c0, .private_data=0x0, .f_ep_links={...}, .f_tfile_llink={...}, .f_mapping=0x0, .f_wb_err=0}
</code></pre>

<p><code>@cast</code>æ“ä½œç¬¦åŒæ ·ä¹Ÿå¯ä»¥ç”¨åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>#include &lt;stdio.h&gt;

typedef struct Test {
  int a;
  int b;
} Test;

int func(void *p) {
  printf(&quot;in func\n&quot;);
}

int main() {
  Test t = {.a=101,.b=102};
  func(&amp;t);
  return 0;
}
</code></pre>

<p>å¯ä»¥å¦‚ä¸‹æ‰“å°ï¼š</p>

<pre><code>probe process(&quot;./a.out&quot;).function(&quot;func&quot;).call {
	printf(&quot;call func:g=%d\n&quot;, @cast($p, &quot;Test&quot;)-&gt;a)
}

/*è¾“å‡ºï¼š
in func
call func:g=101
*/
</code></pre>

<h2 id="æ‰“å°å±€éƒ¨å˜é‡">æ‰“å°å±€éƒ¨å˜é‡</h2>

<p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡ ä¸ªå˜é‡æ¥æ‰“å°å‡½æ•°å±€éƒ¨å˜é‡ï¼š</p>

<ul>
<li>$$varsï¼šæ‰“å°å‡½æ•°çš„æ‰€æœ‰å±€éƒ¨å˜é‡ä»¥åŠä¼ é€’è¿›æ¥çš„å‡½æ•°å‚æ•°ã€‚</li>
<li>$$parmsï¼š$$varsçš„å­é›†ï¼Œæ‰“å°å‡½æ•°ä¼ é€’è¿›æ¥çš„å‡½æ•°å‚æ•°ã€‚</li>
<li>$$localsï¼š$$varsçš„å­é›†ï¼Œæ‰“å°å‡½æ•°çš„æ‰€æœ‰å±€éƒ¨å˜é‡ã€‚</li>
</ul>

<p><center>
<img src="https://cdn.jsdelivr.net/gh/lichuang/lichuang.github.io/media/imgs/20200128-systemtap-by-example/vars.png" alt="vars" title="vars" />
</center></p>

<p>åŒæ ·çš„ï¼Œåœ¨è¿™äº›å˜é‡åé¢ä¹Ÿå¯ä»¥åŠ ä¸Š<code>$</code>ç¾è§‚æ‰“å°ï¼š</p>

<pre><code>#include &lt;stdio.h&gt;

int func1(int a, int b) {
  return a+b;
}

int func(int d, const char *n) {
  int a,b,c;

  a = 1;
  b = 3;
  c = func1(a,b);
  return c;
}

int main() {
  func(100, &quot;test&quot;);
  return 0;
}
</code></pre>

<p>è„šæœ¬å¦‚ä¸‹ï¼š</p>

<pre><code>probe process(&quot;./a.out&quot;).function(&quot;func&quot;).call {
	printf(&quot;call func:vars=%s\n&quot;, $$vars)
	printf(&quot;call func:vars=%s\n&quot;, $$vars$)
	printf(&quot;call func:params=%s\n&quot;, $$parms)
	printf(&quot;call func:params=%s\n&quot;, $$parms$)
	printf(&quot;call func:locals=%s\n&quot;, $$locals)
	printf(&quot;call func:locals=%s\n&quot;, $$locals$)
}

/*
sudo stap t.stap -c ./a.out
call func:vars=d=0x64 n=0x4005c4 a=0x0 b=0x4003e0 c=0x0
call func:vars=d=100 n=&quot;test&quot; a=0 b=4195296 c=0
call func:params=d=0x64 n=0x4005c4
call func:params=d=100 n=&quot;test&quot;
call func:locals=a=0x0 b=0x4003e0 c=0x0
call func:locals=a=0 b=4195296 c=0  
 */
</code></pre>

<p>å¦å¤–ï¼Œå¦‚æœéœ€è¦æ‰“å°å‡½æ•°çš„è¿”å›å€¼ï¼Œå¯ä»¥ä½¿ç”¨<code>$$return</code>å˜é‡ï¼Œä½†æ˜¯è¦æ³¨æ„è¿™ä¸ªå˜é‡åªèƒ½åœ¨<code>.return</code>ä¸­ä½¿ç”¨ï¼Œæ¯•ç«Ÿæ—¢ç„¶æ˜¯è¦æ‰“å°å‡½æ•°è¿”å›å€¼ï¼Œå°±è¦åœ¨å‡½æ•°è¿”å›çš„æ—¶å€™æ‰èƒ½çŸ¥é“ï¼Œä½¿ç”¨ä¸‹é¢çš„è„šæœ¬æ¥çœ‹ä¸Šé¢Cç¨‹åºçš„è¿”å›å€¼ï¼š</p>

<pre><code>probe process(&quot;./a.out&quot;).function(&quot;func&quot;).return {
	printf(&quot;call func:return=%s\n&quot;, $$return)
	printf(&quot;call func:return=%s\n&quot;, $$return$)
}

/*
$ sudo stap t.stap -c ./a.out
call func:return=return=0x4
call func:return=return=4
 */
</code></pre>

<h1 id="å…³è”æ•°ç»„-associative-arrays">å…³è”æ•°ç»„ï¼ˆAssociative Arraysï¼‰</h1>

<p>å‡†ç¡®çš„è¯´ï¼Œsystemtapä¸­æ²¡æœ‰æ•°ç»„è¿™ä¸ªæ¦‚å¿µï¼Œå…³è”æ•°ç»„å°±æ˜¯systemtapä¸­çš„å­—å…¸ï¼ˆdictï¼‰ã€‚</p>

<p>å­—å…¸æœ‰å¯èƒ½æ˜¯åµŒå¥—å‹çš„å­—å…¸ï¼Œæ¯”å¦‚C++ä»£ç ä¸­<code>dict[keya][keyb]</code>ï¼Œå³ä¸€ä¸ªå­—å…¸ä¸­çš„å€¼åˆæ˜¯å¦ä¸€ä¸ªå­—å…¸ã€‚systemtapä¸­çš„å…³è”æ•°ç»„ä¹Ÿå¯ä»¥åšåˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œä½†æ˜¯è¯­æ³•ç•¥æœ‰ä¸åŒï¼Œå¤šä¸ªå±‚çº§çš„é”®ä¹‹é—´ä½¿ç”¨<code>,</code>åˆ†éš”ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>bt[execname(),tid(),$mem,sprint_ubacktrace()] = 1
</code></pre>

<p>è¿™æ®µä»£ç ç”¨C++ç±»ä¼¼è¡¨è¾¾å°±æ˜¯ï¼š</p>

<pre><code>bt[execname()][tid()][$mem,sprint_ubacktrace()] = 1
</code></pre>

<p>åœ¨systemtapä¸­ï¼Œæœ€å¤šå…è®¸åµŒå¥—9ä¸ªé”®ã€‚</p>

<p>å…³è”æ•°ç»„çš„å¸¸è§„æ“ä½œï¼Œå¹¶æ— ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>

<pre><code>// èµ‹å€¼
array_name[index_expression] = value

// è¯»å–
delta = gettimeofday_s() - foo[tid()]

// é€’å¢
array_name[index_expression] ++

// åˆ é™¤æ•°ç»„ä¸­çš„æŸä¸€é¡¹
delete array_name[index_expression]

// åˆ é™¤æ•´ä¸ªå…³è”æ•°ç»„
delete array_name
</code></pre>

<h2 id="éå†å…³è”æ•°ç»„">éå†å…³è”æ•°ç»„</h2>

<p>æœ€ç®€å•çš„éå†å…³è”æ•°ç»„çš„æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨<code>foreach</code>è¡¨è¾¾å¼ï¼š</p>

<pre><code>foreach (element in array_name)
  statement
</code></pre>

<p>ä¾‹å­ï¼š</p>

<pre><code>global reads 

// ä»¥è¿›ç¨‹åå­—ä¸ºé”®ï¼Œè®°å½•ä¸‹æ¯ä¸ªè¿›ç¨‹è°ƒç”¨vfs.readçš„æ¬¡æ•°
probe vfs.read {
  reads[execname()] ++ 
} 

// æ¯éš”3ç§’æ‰“å°ä¸€æ¬¡
probe timer.s(3) {
  foreach (count in reads)
    printf(&quot;%s : %d \n&quot;, count, reads[count])
  delete reads 
}
</code></pre>

<p>è¾“å‡ºï¼š</p>

<pre><code>$ sudo stap vfs-read-1.stp -T 4
stapio : 21
docker-containe : 12
dockerd : 12
gmain : 7
rtkit-daemon : 1
compiz : 6
systemd-journal : 1
gdbus : 6
upstart-dbus-br : 4
nm-applet : 3
avahi-daemon : 29
</code></pre>

<p>é™¤äº†å¸¸è§„çš„éå†ä¹‹å¤–ï¼Œ<code>foreach</code>æ“ä½œç¬¦è¿˜å¯ä»¥æŒ‡å®šéå†çš„é¡ºåºï¼Œä»¥åŠéå†çš„æ•°é‡ã€‚</p>

<h3 id="ä¿®æ”¹éå†å…³è”æ•°ç»„é¡ºåº">ä¿®æ”¹éå†å…³è”æ•°ç»„é¡ºåº</h3>

<p>ä¸Šé¢çš„è„šæœ¬æ–‡ä»¶ç¨ä½œä¿®æ”¹ï¼š</p>

<pre><code>global reads 

// ä»¥è¿›ç¨‹åå­—ä¸ºé”®ï¼Œè®°å½•ä¸‹æ¯ä¸ªè¿›ç¨‹è°ƒç”¨vfs.readçš„æ¬¡æ•°
probe vfs.read {
  reads[execname()] ++ 
} 

// æ¯éš”3ç§’æ‰“å°ä¸€æ¬¡
probe timer.s(3) {
  foreach (count in reads+)
    printf(&quot;%s : %d \n&quot;, count, reads[count])
  delete reads 
}
</code></pre>

<p>å³åœ¨<code>foreach</code>æ‰€éå†çš„å…³è”æ•°ç»„åç§°åé¢åŠ ä¸Š<code>+</code>ï¼Œè¡¨ç¤ºæŒ‰ç…§é”®é€’å¢çš„é¡ºåºæ¥éå†æ•°ç»„ï¼Œè¾“å‡ºä¸ºï¼š</p>

<pre><code>$ sudo stap vfs-read-1.stp -T 4
systemd-journal : 1
indicator-datet : 3
gmain : 4
upstart-dbus-br : 5
unity-panel-ser : 6
compiz : 7
docker-containe : 12
dockerd : 12
stapio : 21
gdbus : 23
avahi-daemon : 28
</code></pre>

<p>ç›¸åçš„ï¼Œå¦‚æœä½¿ç”¨<code>-</code>åˆ™è¡¨ç¤ºæ˜¯é€’å‡é¡ºåºæ¥éå†ã€‚</p>

<h3 id="é™å®šéå†å…³è”æ•°ç»„æ•°é‡">é™å®šéå†å…³è”æ•°ç»„æ•°é‡</h3>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åœ¨<code>foreach</code>æ“ä½œç¬¦ä¸­ï¼Œä½¿ç”¨<code>limit æ•°é‡</code>æ¥é™åˆ¶éå†å…³è”æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ï¼š</p>

<pre><code>global reads

// ä»¥è¿›ç¨‹åå­—ä¸ºé”®ï¼Œè®°å½•ä¸‹æ¯ä¸ªè¿›ç¨‹è°ƒç”¨vfs.readçš„æ¬¡æ•°
probe vfs.read {
  reads[execname()] ++
}

// æ¯éš”3ç§’æ‰“å°ä¸€æ¬¡
probe timer.s(3) {
  foreach (count in reads+ limit 2)
    printf(&quot;%s : %d \n&quot;, count, reads[count])
  delete reads
}
</code></pre>

<p>è¾“å‡ºå°±åªæœ‰ä¸¤é¡¹äº†ï¼š</p>

<pre><code>$ sudo stap vfs-read-1.stp -T 4
systemd-journal : 1
systemd-logind : 1
</code></pre>

<h2 id="æµ‹è¯•å…ƒç´ å­˜åœ¨æ€§">æµ‹è¯•å…ƒç´ å­˜åœ¨æ€§</h2>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>in</code>æ“ä½œç¬¦æµ‹è¯•ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨å…³è”æ•°ç»„ä¸­ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>

<pre><code>if([index_expression] in array_name) statement
</code></pre>

<p>ä¾‹å­ï¼š</p>

<pre><code>global reads

probe vfs.read { 
  reads[execname()] ++ 
}

probe timer.s(3) {
  printf(&quot;=======\n&quot;) 
  foreach (count in reads+)
    printf(&quot;%s : %d \n&quot;, count, reads[count]) 
  if([&quot;stapio&quot;] in reads) {
    printf(&quot;stapio read detected, exiting\n&quot;)
    exit() 
  }
}
</code></pre>

<p>è¾“å‡ºï¼š</p>

<pre><code>$ sudo stap vfs-read-1.stp -T 4
=======
systemd-journal : 1
rtkit-daemon : 1
nm-applet : 3
gmain : 4
upstart-dbus-br : 4
compiz : 5
gdbus : 6
docker-containe : 12
dockerd : 12
avahi-daemon : 19
stapio : 21
stapio read detected, exiting
</code></pre>

<h1 id="è®¡ç®—ç»Ÿè®¡é›†åˆ-statistical-aggregates">è®¡ç®—ç»Ÿè®¡é›†åˆï¼ˆStatistical Aggregatesï¼‰</h1>

<h2 id="å¸¸è§„æ“ä½œ">å¸¸è§„æ“ä½œ</h2>

<p>systemtapä¸­çš„å˜é‡ï¼Œé™¤äº†å…·å¤‡å…¶ä»–è¯­è¨€ä¸­å¸¸è§çš„æ“ä½œä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå…¶ä»–è¯­è¨€æ²¡æœ‰çš„ç‰¹è‰²ï¼Œå¯ä»¥ä½œä¸ºç»Ÿè®¡é›†åˆæ¥å­˜å‚¨æ•°æ®ã€‚å³ä¸€ä¸ªå˜é‡ï¼Œå¯ä»¥å­˜å‚¨å¤šä¸ªæ•°æ®ï¼ŒåæœŸå¯ä»¥å¯¹è¿™ä¸ªå˜é‡çš„æ•°æ®è¿›è¡Œå¸¸è§„çš„ç»Ÿè®¡è®¡ç®—ã€‚</p>

<p>ä¸€ä¸ªå˜é‡è¦å­˜å‚¨ç»Ÿè®¡æ•°æ®ï¼Œæ­¤æ—¶ä¸èƒ½ä½¿ç”¨<code>=</code>æ¥èµ‹å€¼ï¼Œéœ€è¦ä½¿ç”¨<code>&lt;&lt;&lt;</code>æ“ä½œç¬¦ã€‚æ¯”å¦‚ï¼š</p>

<pre><code>global reads 

probe vfs.read 
{ 
  reads[execname()] &lt;&lt;&lt; $count 
}
</code></pre>

<p>è¿™é‡Œçš„$countæ˜¯å†…æ ¸ä¸­vfs_readå‡½æ•°ä¼ å…¥çš„å‚æ•°ï¼Œå­˜å‚¨çš„è¯»å–æ•°æ®çš„æ•°é‡ï¼š</p>

<pre><code class="language-C">ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)
</code></pre>

<p>è¿™æ ·ï¼Œè¿™ä¸ªsystemtapè„šæœ¬å°±é’ˆå¯¹åŒä¸€ä¸ªè¿›ç¨‹ï¼Œå°±æŠŠè¿™ä¸ªè¿›ç¨‹æ‰€æœ‰è°ƒç”¨vfs_readå‡½æ•°çš„countå€¼è®°å½•äº†ä¸‹æ¥ã€‚</p>

<p>ä¸‹é¢æ¥å…·ä½“çœ‹çœ‹systemtapéƒ½æä¾›äº†é’ˆå¯¹ç»Ÿè®¡æ•°æ®çš„å“ªäº›æ“ä½œã€‚å¸¸è§„çš„æ“ä½œæœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>

<blockquote>
<p>@count(variable)ï¼šè¿”å›åŒä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨çš„æ•°æ®æ•°é‡ã€‚</p>

<p>@sum(variable)ï¼šè¿”å›åŒä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨çš„æ•°æ®æ€»å’Œã€‚</p>

<p>@min(variable)ï¼šè¿”å›åŒä¸€ä¸ªå˜é‡å­˜å‚¨çš„æœ€å°æ•°æ®ã€‚</p>

<p>@max(variable)ï¼šè¿”å›åŒä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨çš„æœ€å¤§æ•°æ®ã€‚</p>

<p>@avg(variable)ï¼šè¿”å›åŒä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨çš„æ•°æ®å‡å€¼ã€‚</p>

<p>@variance(variable)ï¼šè¿”å›åŒä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨çš„æ•°æ®æ–¹å·®ã€‚</p>
</blockquote>

<p>ä»¥ä¸Šçš„æ“ä½œç¬¦ï¼Œåˆè¢«ç§°ä¸ºæŠ½å–å‡½æ•°ï¼ˆextractor functionï¼‰ï¼Œå³å¯ä»¥è¾“å…¥ä¸€ä¸ªå­˜æœ‰ç»Ÿè®¡æ•°æ®çš„å˜é‡ï¼Œç›¸åº”è¿”å›ä¸€äº›æ•°æ®ã€‚</p>

<h2 id="æ‰“å°æŸ±çŠ¶å›¾æ•°æ®">æ‰“å°æŸ±çŠ¶å›¾æ•°æ®</h2>

<p>è¿˜å¯ä»¥ä½¿ç”¨<code>@hist_log</code>æ¥æ‰“å°ä»¥2ä¸ºåº•æŒ‡æ•°åˆ†å¸ƒçš„ç›´æ–¹å›¾ï¼š</p>

<pre><code>global histogram
 
probe begin {
  printf(&quot;Capturing...\n&quot;)
}
 
probe netdev.receive {
  histogram &lt;&lt;&lt; length
}
 
probe netdev.transmit {
  histogram &lt;&lt;&lt; length
}
 
probe end {
  printf( &quot;\n&quot; )
  print( @hist_log(histogram) )
}
</code></pre>

<p>è¾“å‡ºï¼š</p>

<pre><code>$ sudo stap hist_log.stp -T 2
Capturing...

value |-------------------------------------------------- count
    8 |                                                   0
   16 |                                                   0
   32 |@@                                                 2
   64 |@                                                  1
  128 |                                                   0
  256 |                                                   0
  512 |                                                   0
 1024 |@@@@                                               4
 2048 |                                                   0
 4096 |                                                   0
</code></pre>

<p>é™¤äº†<code>@hist_log</code>ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>@hist_linear(v, start, stop, interval)</code>æ¥æ‰“å°start-stopåŒºé—´intervalé—´éš”çš„ç›´æ–¹å›¾</p>

<pre><code>global reads

probe netdev.receive {
	reads &lt;&lt;&lt; length
}

probe end {
	print(@hist_linear(reads, 0, 1024, 200))
}
</code></pre>

<p>è¿™é‡Œæ‰“å°çš„æ˜¯åˆ†å¸ƒåœ¨[0,1024]ï¼Œå¹¶ä¸”æ¯ä¸ªæŸ±å­çš„æ•°æ®é—´é—´éš”100çš„æŸ±çŠ¶å›¾ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>

<pre><code>$ sudo stap hist_linear.stp -T 2
value |-------------------------------------------------- count
    0 |@@@@@@@@@@@@@                                      13
  200 |@@@@                                                4
  400 |                                                    0
  600 |                                                    0
</code></pre>

<h1 id="å¸¸ç”¨å‡½æ•°">å¸¸ç”¨å‡½æ•°</h1>

<p>æœ¬èŠ‚æ¥ä»‹ç»systemtapä¸­å¸¸ç”¨çš„ä¸€äº›å‡½æ•°ã€‚</p>

<ul>
<li>tid()ï¼šå½“å‰çº¿ç¨‹IDã€‚</li>
<li>uid()ï¼šå½“å‰ç”¨æˆ·IDã€‚</li>
<li>cpu()ï¼šå½“å‰CPUç¼–å·ã€‚</li>
<li>ctime()ï¼šå½“å‰UNIX epochç§’æ•°ã€‚</li>
<li>pp()ï¼šå½“å‰æ¢æµ‹ç‚¹çš„æè¿°å­—ç¬¦ä¸²ã€‚</li>
<li>execname()ï¼šå½“å‰è¿è¡Œçš„è¿›ç¨‹åç§°ã€‚</li>
<li>probefunc()ï¼šæ¢æµ‹ç‚¹å‡½æ•°åç§°ã€‚</li>
<li>target()ï¼šåœ¨stapä½¿ç”¨<code>-c command</code>æˆ–è€…<code>-x process</code>å‘½ä»¤æ—¶ï¼Œtarget()èƒ½æ‹¿åˆ°è¿›ç¨‹çš„pidã€‚</li>
<li>nameï¼šè¿”å›ç³»ç»Ÿè°ƒç”¨çš„åç§°å­—ç¬¦ä¸²ï¼Œä»…èƒ½åœ¨syscallç±»å‹çš„æ¢é’ˆå¤„ç†å‡½æ•°ä¸­ä½¿ç”¨ã€‚</li>
<li>thread_indent(delta)ï¼šå®ƒå¯ä»¥è¾“å‡ºå½“å‰probeæ‰€å¤„çš„å¯æ‰§è¡Œç¨‹åºåç§°ã€çº¿ç¨‹idã€å‡½æ•°æ‰§è¡Œçš„ç›¸å¯¹æ—¶é—´å’Œæ‰§è¡Œçš„æ¬¡æ•°ï¼ˆé€šè¿‡ç©ºæ ¼çš„æ•°é‡ï¼‰ä¿¡æ¯ï¼Œå®ƒçš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å‚æ•°deltaæ˜¯åœ¨æ¯æ¬¡è°ƒç”¨æ—¶å¢åŠ æˆ–ç§»é™¤çš„ç©ºç™½æ•°é‡ã€‚</li>
</ul>

<p>è¿™é‡Œå…¶ä»–çš„éƒ½å¥½ç†è§£ï¼Œthread_indentéœ€è¦ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š</p>

<pre><code>probe kernel.function(&quot;*@net/socket.c&quot;).call
{
  printf (&quot;%s -&gt; %s\n&quot;, thread_indent(1), probefunc())
}
probe kernel.function(&quot;*@net/socket.c&quot;).return
{
  printf (&quot;%s &lt;- %s\n&quot;, thread_indent(-1), probefunc())
}
</code></pre>

<p>è¾“å‡ºï¼š</p>

<pre><code>0 ftp(7223): -&gt; sys_socketcall
1159 ftp(7223):  -&gt; sys_socket
2173 ftp(7223):   -&gt; __sock_create
2286 ftp(7223):    -&gt; sock_alloc_inode
2737 ftp(7223):    &lt;- sock_alloc_inode
3349 ftp(7223):    -&gt; sock_alloc
3389 ftp(7223):    &lt;- sock_alloc
3417 ftp(7223):   &lt;- __sock_create
4117 ftp(7223):   -&gt; sock_create
4160 ftp(7223):   &lt;- sock_create
4301 ftp(7223):   -&gt; sock_map_fd
4644 ftp(7223):    -&gt; sock_map_file
4699 ftp(7223):    &lt;- sock_map_file
4715 ftp(7223):   &lt;- sock_map_fd
4732 ftp(7223):  &lt;- sys_socket
4775 ftp(7223): &lt;- sys_socketcall
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œthread_indent()æ­é…<code>.call</code>å’Œ<code>.return</code>ï¼Œç¾åŒ–è¾“å‡ºäº†å‡½æ•°è°ƒç”¨çš„æµç¨‹ã€‚</p>

<p>ä»¥ä¸‹å†æ¼”ç¤ºä¸€ä¸‹<code>name</code>çš„ä½¿ç”¨ï¼Œè¿™ä¸ªå˜é‡ä»…èƒ½ç”¨åœ¨<code>syscall</code>ç±»çš„æ¢é’ˆä¸­ï¼Œä»¥ä¸‹è„šæœ¬æ¯éš”ä¸€ç§’æ‰“å°å‡ºå½“å‰20ä¸ªè¢«è°ƒç”¨æœ€å¤šçš„ç³»ç»Ÿè°ƒç”¨æ•°é‡ï¼š</p>

<pre><code>global syscalls_count

probe syscall_any {
  syscalls_count[name] &lt;&lt;&lt; 1
}

function print_systop () {
  printf (&quot;%25s %10s\n&quot;, &quot;SYSCALL&quot;, &quot;COUNT&quot;)
  foreach (syscall in syscalls_count- limit 20) {
    printf(&quot;%25s %10d\n&quot;, syscall, @count(syscalls_count[syscall]))
  }
  delete syscalls_count
}

probe timer.s(1) {
  print_systop ()
  printf(&quot;--------------------------------------------------------------\n&quot;)
}
</code></pre>

<p>è¾“å‡ºï¼š</p>

<pre><code>$ sudo stap syscall.stp -T 2
                  SYSCALL      COUNT
                    ioctl        127
               epoll_wait         47
                    futex         42
                 pselect6         29
                     read         28
                    write         17
                  recvmsg         16
                     poll         14
           rt_sigprocmask          8
                    fcntl          6
                   writev          5
                    ppoll          5
                 recvfrom          4
                setitimer          4
        inotify_add_watch          3
                   select          3
                nanosleep          2
          timerfd_settime          2
            clock_gettime          2
                ftruncate          1
--------------------------------------------------------------
</code></pre>

<h1 id="definedå’Œ-choose-defined">@definedå’Œ@choose_defined</h1>

<p>ç”±äºç‰ˆæœ¬å˜åŒ–ï¼Œæœ‰ä¸€äº›å˜é‡å¯èƒ½åœ¨æ–°ç‰ˆæœ¬ä¸­ä¸å­˜åœ¨äº†ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨<code>@define</code>æ¥æ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨ï¼š</p>

<pre><code>probe vm.pagefault = kernel.function(&quot;__handle_mm_fault@mm/memory.c&quot;) ?,
                     kernel.function(&quot;handle_mm_fault@mm/memory.c&quot;) ?
{
  write_access = (@defined($flags) ? $flags &amp; FAULT_FLAG_WRITE : $write_access)
}
</code></pre>

<p>ä¸Šé¢çš„è„šæœ¬æ ¹æ®æ˜¯å¦å­˜åœ¨å˜é‡flagï¼Œæ¥ç»™write_accessä¸åŒçš„èµ‹å€¼ã€‚</p>

<p>æ­¤å¤–è¿˜æœ‰<code>@choose_defined($a,$b)</code>ï¼Œå…¶ä½œç”¨ç›¸å½“äºï¼š<code>@defined($a)? $a : $b</code>ï¼Œä¾‹å­ï¼š</p>

<pre><code>probe vm.pagefault = kernel.function(&quot;handle_mm_fault@mm/memory.c&quot;)
{
  write_access = @choose_defined($write_access, 0)
}
</code></pre>

<h1 id="entry">@entry</h1>

<p>åœ¨<code>.return</code>æ¢é’ˆä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ“ä½œç¬¦<code>@entry</code>ï¼Œç”¨äºå­˜å‚¨è¯¥æ¢é’ˆçš„å…¥å£å¤„çš„è¡¨è¾¾å¼çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ“ä½œç¬¦ï¼Œå®Œæˆæ¯”å¦‚è®¡ç®—æ¢é’ˆå‡½æ•°æ‰§è¡Œæ—¶é—´è®¡ç®—ç­‰å·¥ä½œï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>global sloth = 50
      
probe vfs.open.return {
  time = gettimeofday_us()-@entry(gettimeofday_us())
  if (time &gt;= sloth)
    printf(&quot;%s[%d] %d %s\n&quot;, execname(), tid(), time, pathname)
}
</code></pre>

<p>è¿™ä¸ªè„šæœ¬åœ¨<code>vfs.open.return</code>æ¢é’ˆå¤„ç†å‡½æ•°ä¸­ï¼Œé€šè¿‡<code>@entry</code>æ“ä½œç¬¦ï¼Œè®¡ç®—å®Œæˆvfs.openæ“ä½œçš„æ—¶é—´å·®ï¼Œå¦‚æœè¶…è¿‡è®¾ç½®çš„é˜ˆå€¼50å°±æ‰“å°ç›¸å…³ä¿¡æ¯ã€‚</p>

<h1 id="åµŒå…¥cä»£ç ">åµŒå…¥Cä»£ç </h1>

<p>systemtapä¸­æ”¯æŒåµŒå…¥Cä»£ç ï¼Œä½¿ç”¨guruæ¨¡å¼ï¼ˆ-gå‚æ•°ï¼‰ï¼Œåœ¨â€œ%{â€œå’Œâ€œ%}&ldquo;æ ‡è®°ä¹‹é—´å°±èƒ½åµŒå…¥Cä»£ç ï¼Œå…¶ä¸­è®¿é—®å‚æ•°çš„å€¼ä»¥<code>STAP_ARG_+å‚æ•°å</code>çš„å½¢å¼ï¼Œè€Œè¿”å›å€¼ä»¥<code>STAP_RETVALUE=xxx</code>çš„å½¢å¼ã€‚</p>

<pre><code>%{
	#include &lt;linux/in.h&gt;
	#include &lt;linux/ip.h&gt;
%} /* &lt;-- top level */

function read_iphdr:long(skb:long)
%{
	struct iphdr *iph = ip_hdr((struct sk_buff *)STAP_ARG_skb);
	STAP_RETVALUE = (long)iph;
%}

/* Determines whether an IP packet is TCP, based on the iphdr: */
function is_tcp_packet:long(iphdr)
{
	protocol = @cast(iphdr, &quot;iphdr&quot;)-&gt;protocol
	return (protocol == %{ IPPROTO_TCP %}) /* &lt;-- expression */
}

probe begin {
	printf(&quot;SystemTap start!\n&quot;);
}

probe kernel.function(&quot;ip_local_deliver&quot;) {
	iph = read_iphdr(pointer_arg(1));
	printf(&quot;tcp packet ? %s\n&quot;, is_tcp_packet(iph) ? &quot;yes&quot; : &quot;no&quot;);
}
</code></pre>

<p>è¿™é‡Œçš„read_iphdrå‡½æ•°ï¼Œå…¶å¤„ç†å‡½æ•°å°±ä½¿ç”¨çš„æ˜¯åµŒå…¥Cä»£ç å®Œæˆã€‚</p>

      </div>
      <div class="paginator">
        
        <a class="link" href="https://www.codedump.info/post/20191214-cxx11-memory-model-2/">â† prev</a>
        
        
        <a class="link" href="https://www.codedump.info/post/20200218-linux-traceevent/">next â†’</a>
        
      </div>
      <div class="comment">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lichuang-codedump" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </main>
    <footer id="footer">
  <div>
    <span>Â© 2019</span> - <span>2021</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span></span>
  </div>
</footer>

  </div>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126255685-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
